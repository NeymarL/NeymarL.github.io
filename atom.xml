<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>NIUHE</title>
  
  <subtitle>æ—¥ã€…ç§ãŸã¡ãŒè¿‡ã”ã—ã¦ã„ã‚‹æ—¥å¸¸ã¨ã„ã†ã®ã¯ã€å®Ÿã¯å¥‡è¿¹ã®è¿ç¶šãªã®ã‹ã‚‚ã—ã‚Œã‚“ãª</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.52coding.com.cn/"/>
  <updated>2019-05-05T08:08:02.508Z</updated>
  <id>http://www.52coding.com.cn/</id>
  
  <author>
    <name>NIUHE</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>PyTorchæºç æµ…æ(5)ï¼šPythonæ‰©å±•</title>
    <link href="http://www.52coding.com.cn/2019/05/05/PyTorch5/"/>
    <id>http://www.52coding.com.cn/2019/05/05/PyTorch5/</id>
    <published>2019-05-05T07:58:01.000Z</published>
    <updated>2019-05-05T08:08:02.508Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ˜¯æœ¬ç³»åˆ—æœ€åä¸€ç¯‡åšå®¢äº†ï¼Œä»‹ç»ä¸€ä¸‹å‰é¢çš„C++ä»£ç æ€ä¹ˆä¸Pythonäº¤äº’ï¼Œæˆ–è€…è¯´Pythoné‡Œæ€ä¹ˆè°ƒç”¨C++ä»£ç è¿›è¡Œé«˜æ•ˆçš„è®¡ç®—ã€‚é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹é¢„å¤‡çŸ¥è¯†ï¼Œæ—¢Pythonçš„Cæ‰©å±•é€šå¸¸æ€ä¹ˆå†™ï¼›ç„¶åä»¥æ¯”è¾ƒæ ¸å¿ƒçš„æ•°æ®ç»“æ„ Tensor å’Œ Storage ä¸ºä¾‹çœ‹ä¸€ä¸‹å®ƒä»¬æ€ä¹ˆè½¬æ¢ä¸ºPythonç±»å‹çš„ï¼›æœ€åç¨å¸¦ç‚¹å„¿Pythonè‡ªå¾®åˆ†å‡½æ•°çš„å®ç°ã€‚</p><a id="more"></a><!-- toc --><ul><li><a href="#pythonçš„ccæ‰©å±•">Pythonçš„C/C++æ‰©å±•</a><ul><li><a href="#æ‰©å±•æ¨¡å—">æ‰©å±•æ¨¡å—</a></li><li><a href="#è‡ªå®šä¹‰pythonç±»å‹">è‡ªå®šä¹‰Pythonç±»å‹</a></li></ul></li><li><a href="#torch_c">torch._C</a><ul><li><a href="#storage">Storage</a></li><li><a href="#tensor">Tensor</a></li><li><a href="#nn">NN</a></li></ul></li></ul><!-- tocstop --><h2><span id="pythonçš„ccæ‰©å±•">Pythonçš„C/C++æ‰©å±•</span></h2><h3><span id="æ‰©å±•æ¨¡å—">æ‰©å±•æ¨¡å—</span></h3><p>å¯¹äºç®€å•çš„Cä»£ç ï¼Œæ„å»ºä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•æ¨¡å—æ˜¯å¾ˆå®¹æ˜“çš„ã€‚<code>C/C++</code>éƒ¨åˆ†åŸºæœ¬ä¸Šåªéœ€è¦åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ul><li>åŒ…å«å¤´æ–‡ä»¶ <code>Python.h</code></li><li>æ­£ç¡®çš„å£°æ˜å‡½æ•°ï¼Œå³<ul><li>å‡½æ•°å¿…é¡»æ˜¯ <code>static</code></li><li>è¿”å›ç±»å‹å¿…é¡»æ˜¯ <code>PyObject *</code></li><li>å‚æ•°åˆ—è¡¨å¿…é¡»æ˜¯ <code>PyObject *self, PyObject *args</code></li></ul></li><li>å®šä¹‰ä¸€ä¸ªMethod Tableï¼ŒæŠŠæ¨¡å—éœ€è¦åŒ…æ‹¬çš„å‡½æ•°éƒ½æ”¾è¿›å»</li><li>å®šä¹‰æ¨¡å—å’Œåˆå§‹åŒ–å‡½æ•°</li></ul><p>ä¸¾ä¸ªğŸŒ°ï¼Œä¸‹é¢çš„ä»£ç æ„å»ºäº†ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå‡½æ•°çš„Pythonæ¨¡å—ï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯æ±‚æœ€å¤§å…¬çº¦æ•°ï¼ˆ<code>py_gcd</code>ï¼‰:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Python.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æŠŠæ™®é€šCè¯­è¨€å®ç°çš„gcd()å°è£…æˆPythonå¯ä»¥è°ƒç”¨çš„å‡½æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PyObject *<span class="title">py_gcd</span><span class="params">(PyObject *self, PyObject *args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x, y, result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ä» args é‡Œè§£æå®é™…å‚æ•° */</span></span><br><span class="line">  <span class="keyword">if</span> (!PyArg_ParseTuple(args,<span class="string">"ii"</span>, &amp;x, &amp;y)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* è°ƒç”¨æ™®é€šCè¯­è¨€å®ç°çš„gcd() */</span></span><br><span class="line">  result = gcd(x,y);</span><br><span class="line">  <span class="comment">/* æŠŠ int è½¬åŒ–ä¸º PyObject* */</span></span><br><span class="line">  <span class="keyword">return</span> Py_BuildValue(<span class="string">"i"</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰æ¨¡å—çš„ method table */</span></span><br><span class="line"><span class="keyword">static</span> PyMethodDef SampleMethods[] = &#123;</span><br><span class="line">  &#123;<span class="string">"gcd"</span>,  py_gcd, METH_VARARGS, <span class="string">"Greatest common divisor"</span>&#125;,</span><br><span class="line">  &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰æ¨¡å—ç»“æ„ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyModuleDef</span> <span class="title">samplemodule</span> = &#123;</span></span><br><span class="line">  PyModuleDef_HEAD_INIT,</span><br><span class="line">  <span class="string">"sample"</span>,           <span class="comment">/* name of module */</span></span><br><span class="line">  <span class="string">"A sample module"</span>,  <span class="comment">/* Doc string (may be NULL) */</span></span><br><span class="line">  <span class="number">-1</span>,                 <span class="comment">/* Size of per-interpreter state or -1 */</span></span><br><span class="line">  SampleMethods       <span class="comment">/* Method table */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨¡å—åˆå§‹åŒ–å‡½æ•° */</span></span><br><span class="line"><span class="function">PyMODINIT_FUNC <span class="title">PyInit_sample</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> PyModule_Create(&amp;samplemodule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“ç»†èŠ‚å°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥å‚è€ƒä¸‹é¢çš„é“¾æ¥ã€‚</p><p>è¦ç»‘å®šè¿™ä¸ªæ‰©å±•æ¨¡å—ï¼Œåƒä¸‹é¢è¿™æ ·åˆ›å»ºä¸€ä¸ª <code>setup.py</code> æ–‡ä»¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setup.py</span></span><br><span class="line"><span class="keyword">from</span> distutils.core <span class="keyword">import</span> setup, Extension</span><br><span class="line"></span><br><span class="line">setup(name=<span class="string">'sample'</span>,</span><br><span class="line">      ext_modules=[</span><br><span class="line">        Extension(<span class="string">'sample'</span>,</span><br><span class="line">                  [<span class="string">'pysample.c'</span>],</span><br><span class="line">                  include_dirs = [<span class="string">'/some/dir'</span>],</span><br><span class="line">                  define_macros = [(<span class="string">'FOO'</span>,<span class="string">'1'</span>)],</span><br><span class="line">                  undef_macros = [<span class="string">'BAR'</span>],</span><br><span class="line">                  library_dirs = [<span class="string">'/usr/local/lib'</span>],</span><br><span class="line">                  libraries = [<span class="string">'sample'</span>]</span><br><span class="line">                  )</span><br><span class="line">        ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ„å»ºæœ€ç»ˆçš„å‡½æ•°åº“ï¼Œåªéœ€ç®€å•çš„ä½¿ç”¨ <code>python3 buildlib.py build_ext --inplace</code> å‘½ä»¤å³å¯ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ªåå­—å« <code>sample.so</code> çš„å…±äº«åº“ï¼Œå½“è¢«ç¼–è¯‘åï¼Œä½ å°±èƒ½å°†å®ƒä½œä¸ºä¸€ä¸ªæ¨¡å—å¯¼å…¥è¿›æ¥äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sample</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sample.gcd(<span class="number">35</span>, <span class="number">42</span>)</span><br><span class="line"><span class="number">7</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šè¿™éƒ¨åˆ†ä¸»è¦å‚è€ƒ<a href="https://python3-cookbook.readthedocs.io/zh_CN/latest/c15/p02_write_simple_c_extension_module.html" target="_blank" rel="noopener">Python3-Cookbook</a>.</p></blockquote><h3><span id="è‡ªå®šä¹‰pythonç±»å‹">è‡ªå®šä¹‰Pythonç±»å‹</span></h3><p>åœ¨Pythonä»£ç ä¸­å¦‚æœè¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ç±»ä½¿ç”¨<code>class</code>å…³é”®å­—å³å¯ï¼Œä½†æ˜¯åœ¨Cä»£ç ä¸­å°±æ²¡é‚£ä¹ˆæ–¹ä¾¿äº†ã€‚é¦–å…ˆç®€å•ä»‹ç»ä¸‹Pythonä¸­çš„ç±»å‹ã€‚åœ¨Pythonä¸­ä¸€åˆ‡çš†å¯¹è±¡ï¼ŒPythonä¸­æœ‰ä¸¤ç§å¯¹è±¡ï¼š</p><ul><li>ä¸€ç§æ˜¯ç±»å‹å¯¹è±¡ï¼ˆclasså¯¹è±¡ï¼‰ï¼šè¡¨ç¤ºPythonå®šä¹‰çš„ç±»å‹ï¼Œä¾‹å¦‚<code>int, str, object</code>ç­‰ï¼›</li><li>å¦ä¸€ç§æ˜¯å®ä¾‹å¯¹è±¡ï¼ˆinstanceå¯¹è±¡ï¼‰ï¼šè¡¨ç¤ºç”±classå¯¹è±¡åˆ›å»ºçš„å®ä¾‹ã€‚</li></ul><p>Pythonä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç›´æ¥æˆ–è€…é—´æ¥ç»§æ‰¿<code>object</code>ï¼Œç„¶å<code>object</code>åˆæ˜¯<code>type</code>ç±»å‹ã€‚Pythonå¯¹è±¡çš„Cè¯­è¨€å®ç°ä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†è¡¨ç¤ºå®ä¾‹å¯¹è±¡ï¼Œå­˜å‚¨å¯¹è±¡å®é™…çš„æ•°æ®ï¼›å¦ä¸€éƒ¨åˆ†æ˜¯ç±»å‹å¯¹è±¡ï¼Œå­˜å‚¨å¯¹è±¡çš„å…ƒæ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡ªå®šä¹‰ç±»å‹ä¹Ÿè¦å®ç°è¿™ä¸¤éƒ¨åˆ†ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®ä¾‹å¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line">    <span class="comment">/* ç±»å‹å®é™…çš„æ•°æ®åœ¨è¿™é‡Œå®šä¹‰ */</span></span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">&#125; noddy_NoddyObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç±»å‹å¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">static</span> PyTypeObject noddy_NoddyType = &#123;</span><br><span class="line">    PyVarObject_HEAD_INIT(<span class="literal">NULL</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="string">"noddy.Noddy"</span>,             <span class="comment">/*tp_name*/</span></span><br><span class="line">    <span class="keyword">sizeof</span>(noddy_NoddyObject), <span class="comment">/*tp_basicsize*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_itemsize*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_dealloc*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_print*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_getattr*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_setattr*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_compare*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_repr*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_number*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_sequence*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_mapping*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_hash */</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_call*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_str*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_getattro*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_setattro*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_buffer*/</span></span><br><span class="line">    Py_TPFLAGS_DEFAULT,        <span class="comment">/*tp_flags*/</span></span><br><span class="line">    <span class="string">"Noddy objects"</span>,           <span class="comment">/*tp_doc*/</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºä¸€ä¸ªæ–°æ‰©å±•æ¨¡å—ï¼Œå¹¶å®Œæˆåˆå§‹åŒ–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®šä¹‰æ¨¡å—çš„ method table */</span></span><br><span class="line"><span class="keyword">static</span> PyMethodDef noddy_methods[] = &#123;</span><br><span class="line">    &#123;<span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨¡å—åˆå§‹åŒ–å‡½æ•° */</span></span><br><span class="line"><span class="function">PyMODINIT_FUNC <span class="title">initnoddy</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyObject* m;</span><br><span class="line"><span class="comment">/* tp_new ç›¸å½“äºPythoné‡Œçš„ __new__ */</span></span><br><span class="line">    noddy_NoddyType.tp_new = PyType_GenericNew;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (PyType_Ready(&amp;noddy_NoddyType) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    m = Py_InitModule3(<span class="string">"noddy"</span>, noddy_methods,</span><br><span class="line">                       <span class="string">"Example module"</span>);</span><br><span class="line"></span><br><span class="line">    Py_INCREF(&amp;noddy_NoddyType);</span><br><span class="line">  <span class="comment">/* å‘æ¨¡å—æ·»åŠ ç±»å‹ */</span></span><br><span class="line">    PyModule_AddObject(m, <span class="string">"Noddy"</span>, (PyObject*)&amp;noddy_NoddyType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šè¿™éƒ¨åˆ†ä»‹ç»çš„æ¯”è¾ƒç®€ç•¥ï¼Œè¯¦ç»†è¯·å‚è€ƒ <a href="http://www.xefan.com/archives/84091.html" class="uri" target="_blank" rel="noopener">http://www.xefan.com/archives/84091.html</a>.</p></blockquote><h2><span id="torch_c">torch._C</span></h2><p>æœ‰äº†ä¸Šé¢çš„é¢„å¤‡çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½çœ‹ATenè¿˜æœ‰autogradç­‰æ¨¡å—çš„ä»£ç æ˜¯æ€ä¹ˆå¯¼å…¥Pythonäº†ã€‚æ„å»ºPythonæ‰©å±•æ¨¡å—çš„ä»£ç åœ¨ <code>torch/csrc/Module.cpp</code> é‡Œï¼Œä¸»è¦éƒ¨åˆ†å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/* method table */</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;PyMethodDef&gt; methods;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–æ¨¡å— */</span></span><br><span class="line"><span class="function">PyObject* <span class="title">initModule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  HANDLE_TH_ERRORS</span><br><span class="line">  THInferNumThreads();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å‘ method table æ·»åŠ å‡½æ•° */</span></span><br><span class="line">  THPUtils_addPyMethodDefs(methods, TorchMethods);</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, DataLoaderMethods);</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, </span><br><span class="line">                           torch::autograd::python_functions());</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, </span><br><span class="line">                       torch::multiprocessing::python_functions());</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* æ„å»º torch._C æ¨¡å— */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PY_MAJOR_VERSION == 2</span></span><br><span class="line">  ASSERT_TRUE(<span class="keyword">module</span> = Py_InitModule(<span class="string">"torch._C"</span>, methods.data()));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyModuleDef</span> <span class="title">torchmodule</span> = &#123;</span></span><br><span class="line">      PyModuleDef_HEAD_INIT, <span class="string">"torch._C"</span>, <span class="literal">nullptr</span>, <span class="number">-1</span>, </span><br><span class="line">      methods.data()</span><br><span class="line">  &#125;;</span><br><span class="line">  ASSERT_TRUE(<span class="keyword">module</span> = PyModule_Create(&amp;torchmodule));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* å„ç§åˆå§‹åŒ– */</span></span><br><span class="line">  ASSERT_TRUE(THPWrapper_init(<span class="keyword">module</span>));</span><br><span class="line">  ...</span><br><span class="line">  torch::autograd::initNNFunctions(<span class="keyword">module</span>);<span class="comment">// åˆå§‹åŒ–è‡ªå¾®åˆ†ç›¸å…³API</span></span><br><span class="line">  torch::autograd::init_legacy_variable(<span class="keyword">module</span>);<span class="comment">// åˆå§‹åŒ–Tensorç±»å‹</span></span><br><span class="line">  torch::python::init_bindings(<span class="keyword">module</span>);<span class="comment">// åˆå§‹åŒ–NNç›¸å…³å‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_CUDA</span></span><br><span class="line">  torch::cuda::initModule(<span class="keyword">module</span>);<span class="comment">// åˆå§‹åŒ–CUDAæ¨¡å—</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">/* åˆå§‹åŒ–å„ç§Storageç±»å‹ */</span></span><br><span class="line">  ASSERT_TRUE(THPDoubleStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPFloatStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPHalfStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPLongStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPIntStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPShortStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPCharStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPByteStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPBoolStorage_init(<span class="keyword">module</span>));</span><br><span class="line"> </span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">module</span>;</span><br><span class="line">  END_HANDLE_TH_ERRORS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šæ‰€æœ‰C/C++å®ç°çš„APIéƒ½è¢«ç»‘å®šåœ¨ <code>torch._C</code> æ‰©å±•æ¨¡å—ä¸­ï¼Œä¸‹é¢ä»¥Storageå’ŒTensorä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ <code>torch.Storage</code>å’Œ<code>torch.Tensor</code> ç±»å‹çš„ç»‘å®šæ–¹æ³•ï¼Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯å®ƒä»¬ä¸¤ä¸ªçš„ç»‘å®šæ–¹å¼åŒºåˆ«è¿˜æŒºå¤§çš„ã€‚</p><h3><span id="storage">Storage</span></h3><p>ä»ä¸Šé¢çš„ <code>initModule()</code> å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢æœ‰è®¸å¤šåˆå§‹åŒ–å„ç§Storageç±»å‹çš„ä»£ç ï¼Œå®ƒä»¬çš„ç›®çš„å°±æ˜¯åˆ›å»ºå„ç§Storageç±»å‹ï¼Œå¦‚ <code>torch._C._FloatStorageBase</code>, <code>torch._C._LongStorageBase</code>ç­‰ï¼Œè€Œ <code>torch.FloatStorage</code> ç­‰ç±»å‹æ˜¯ä»Pythonç«¯åˆ›å»ºçš„ï¼Œç»§æ‰¿è‡ª <code>torch._C._FloatStorageBase</code> ç­‰ç±»å‹ï¼Œè¿™éƒ¨åˆ†ä»£ç å¯ä»¥åœ¨<code>torch/__init__.py</code>ä¸­æ‰¾åˆ°ã€‚</p><p>å›åˆ°ç»‘å®šè¿‡ç¨‹ï¼Œ<code>THPDoubleStorage_init()</code> ç­‰å‡½æ•°å…¶å®æ˜¯ç”¨CèŒƒå¼ç”Ÿæˆçš„ï¼Œå’Œ<a href="è¦åŠ é“¾æ¥">ç¬¬ä¸€ç¯‡</a>é‡Œçš„THåº“ä¸­ç”¨çš„æ–¹æ³•ä¸€æ ·ã€‚å®ƒå®é™…è°ƒç”¨çš„å‡½æ•°æ˜¯ <code>bool THPStorage_(init)(PyObject *module)</code>ï¼Œå®ç° <code>torch/csrc/generic/Storage.cpp</code>é‡Œï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ä¸åŒç±»å‹å±•å¼€ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">THPStorage_</span><span class="params">(init)</span><span class="params">(PyObject *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;PyMethodDef&gt; methods;</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, THPStorage_(methods));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> THD_GENERIC_FILE</span></span><br><span class="line">  THPUtils_addPyMethodDefs(methods, THPStorage_(sharingMethods));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ç»‘å®šç±»æ–¹æ³• */</span></span><br><span class="line">  THPStorageType.tp_methods = methods.data();</span><br><span class="line">  <span class="comment">/* ç»‘å®šç±»æˆå‘˜ */</span></span><br><span class="line">  THPStorageType.tp_members = THPStorage_(members);</span><br><span class="line">  <span class="keyword">if</span> (PyType_Ready(&amp;THPStorageType) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  Py_INCREF(&amp;THPStorageType);</span><br><span class="line">  <span class="comment">/* å‘æ¨¡å—æ·»åŠ  THPStorage ç±»å‹ */</span></span><br><span class="line">  PyModule_AddObject(<span class="keyword">module</span>, THPStorageBaseStr, </span><br><span class="line">                     (PyObject*)&amp;THPStorageType);</span><br><span class="line">  THPStorage_(initCopyMethods)();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–äº† <code>THPStorageType</code> ç±»å‹å¹¶æ·»åŠ åˆ°<code>torch._C</code>æ¨¡å—ä¸­ï¼Œè¯¥ç±»å‹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®ä¾‹å¯¹è±¡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THPStorage</span> &#123;</span></span><br><span class="line">  PyObject_HEAD</span><br><span class="line">  <span class="comment">/* THWStorage ä¸ºå®å®šä¹‰ï¼Œä¼šè½¬æ¢ä¸º THxxxStorage */</span></span><br><span class="line">  THWStorage *cdata;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç±»å‹å¯¹è±¡ */</span></span><br><span class="line">PyTypeObject THPStorageType = &#123;</span><br><span class="line">  PyVarObject_HEAD_INIT(<span class="literal">nullptr</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="string">"torch._C."</span> THPStorageBaseStr,         <span class="comment">/* tp_name */</span></span><br><span class="line">  <span class="keyword">sizeof</span>(THPStorage),                    <span class="comment">/* tp_basicsize */</span></span><br><span class="line">  <span class="number">0</span>,                                     <span class="comment">/* tp_itemsize */</span></span><br><span class="line">  (destructor)THPStorage_(dealloc),      <span class="comment">/* tp_dealloc */</span></span><br><span class="line">  ...</span><br><span class="line">  THPStorage_(pynew),                    <span class="comment">/* tp_new */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Pythoné‡Œç±»å‹çš„åå­—ç”± <code>tp_name</code> åŸŸç¡®å®šï¼Œä¹Ÿå°±æ˜¯ <code>&quot;torch._C.&quot; THPStorageBaseStr</code>ï¼Œåè€…ä¸€çœ‹å°±æ˜¯å®å®šä¹‰ï¼Œå®ƒå±•å¼€åä¼šå˜æˆ <code>_xxxStorageBase</code>ï¼Œå…¶ä¸­<code>xxx</code>ä¸ºå„ç§ç±»å‹ï¼Œæ‰€ä»¥æœ€åå°±å˜æˆäº† <code>torch._C._FloatStorageBase</code> ç­‰ç±»å‹ã€‚</p><h3><span id="tensor">Tensor</span></h3><p><code>torch.Tensor</code>çš„å®ç°å°±ä¸<code>torch.Storage</code> ä¸ä¸€æ ·äº†ï¼Œå› ä¸ºATençš„å­˜åœ¨ï¼Œç»‘å®šçš„è¯ä¹Ÿæ˜¯ç»‘å®šATené‡Œçš„Tensorï¼Œä¸ä¼šç»‘å®šTHTensorã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œå°±æ˜¯Pythoné‡Œçš„Tensorå’ŒVariableåˆå¹¶äº†ï¼Œæ‰€ä»¥<code>torch.Tensor</code>ç›´æ¥å’Œ <code>autograd::Variable</code> ç»‘å®šåœ¨ä¸€èµ·äº†ã€‚ä¸è¿‡å‡†ç¡®æ¥è¯´æ˜¯ <code>torch._C._TensorBase</code> å’Œ <code>autograd::Variable</code> ç»‘å®šåœ¨ä¸€èµ·äº†ï¼Œè€Œ <code>torch.Tensor</code> ç»§æ‰¿è‡ª <code>torch._C._TensorBase</code>ã€‚</p><p>ç»‘å®šçš„ä»£ç åœ¨ <code>torch/csrc/autograd/python_variable.cpp</code>ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// python_variable.h</span></span><br><span class="line"><span class="comment">/* å®ä¾‹å¯¹è±¡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THPVariable</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line">    <span class="comment">// Payload</span></span><br><span class="line">    torch::autograd::Variable cdata;</span><br><span class="line">    PyObject* backward_hooks = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// python_variable.cpp</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">/* ç±»å‹å¯¹è±¡ */</span></span><br><span class="line">PyTypeObject THPVariableType = &#123;</span><br><span class="line">  PyVarObject_HEAD_INIT(<span class="literal">nullptr</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="string">"torch._C._TensorBase"</span>,                <span class="comment">/* tp_name */</span></span><br><span class="line">  <span class="keyword">sizeof</span>(THPVariable),                   <span class="comment">/* tp_basicsize */</span></span><br><span class="line">  <span class="number">0</span>,                                     <span class="comment">/* tp_itemsize */</span></span><br><span class="line">  (destructor)THPVariable_dealloc,       <span class="comment">/* tp_dealloc */</span></span><br><span class="line">  ...</span><br><span class="line">  THPVariable_pynew                      <span class="comment">/* tp_new */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–ç±»å‹ */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">THPVariable_initModule</span><span class="params">(PyObject *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* è·å– method table */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;PyMethodDef&gt; methods;</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, </span><br><span class="line">                           torch::autograd::variable_methods);</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, extra_methods);</span><br><span class="line">  <span class="comment">/* ç»‘å®šç±»æ–¹æ³• */</span></span><br><span class="line">  THPVariableType.tp_methods = methods.data();</span><br><span class="line">  <span class="keyword">if</span> (PyType_Ready(&amp;THPVariableType) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  Py_INCREF(&amp;THPVariableType);</span><br><span class="line">  <span class="comment">/* å‘æ¨¡å—ä¸­æ·»åŠ ç±»å‹ */</span></span><br><span class="line">  PyModule_AddObject(<span class="keyword">module</span>, <span class="string">"_TensorBase"</span>, </span><br><span class="line">                     (PyObject *)&amp;THPVariableType);</span><br><span class="line">  torch::autograd::initTorchFunctions(<span class="keyword">module</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°ï¼Œè¿™é‡Œåªç»‘å®šäº† <code>_TensorBase</code> ä¸€ç§ç±»å‹ï¼Œè€Œä¸åƒStorageé‚£æ ·åˆ©ç”¨å®æŠŠå„ç§ç±»å‹çš„StorageBaseéƒ½å®šä¹‰äº†ã€‚</p><p>å…¶ä»–ç±»å‹çš„Tensorï¼Œå¦‚ <code>torch.FloatTensor</code> ç­‰åœ¨ <code>torch/tensor/python_tensor.cpp</code> ä¸­çš„ <code>initialize_python_bindings()</code> å‡½æ•°é‡ŒåŠ¨æ€ç»‘å®šï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initialize_python_bindings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* æŠŠATené‡Œçš„Tensorç±»å‹è½¬åŒ–ä¸ºPythoné‡Œçš„PyTypeObject */</span></span><br><span class="line">  initialize_aten_types(tensor_types);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* åˆå§‹åŒ–ä¸Šé¢è½¬åŒ–æ¥çš„PyTypeObject */</span></span><br><span class="line">  py_initialize_metaclass(metaclass);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è·å– torch.Tensor çš„æ‰€æœ‰æ–¹æ³• */</span></span><br><span class="line">  <span class="keyword">auto</span> tensor_dict = get_tensor_dict();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* æŠŠtorch.Tensorçš„æ–¹æ³•å¤åˆ¶ç»™æ¯ä¸ªç±»å‹ï¼Œå¦‚torch.FloatTensorç­‰ */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; tensor_type : tensor_types) &#123;</span><br><span class="line">    py_initialize_tensor_type(tensor_type.py_type, </span><br><span class="line">                              tensor_type.name, tensor_dict.get());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å‘torchæ¨¡å—ç»‘å®šè¿™äº›å„ç§ç±»å‹çš„Tensor */</span></span><br><span class="line">  py_bind_tensor_types(tensor_types);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è®¾ç½® torch.Tensor çš„é»˜è®¤ç±»å‹ä¸º torch.FloatTensor */</span></span><br><span class="line">  set_default_tensor_type(at::globalContext().getVariableType(</span><br><span class="line">    at::Backend::CPU, at::kFloat));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ç”±Pythonè°ƒç”¨ï¼Œè°ƒç”¨çš„ä»£ç åœ¨ <code>torch/__init__.py</code> ä¸­ï¼ˆ<code>_C._initExtension()</code>ï¼‰ã€‚è°ƒç”¨æ—¶ <code>torch.Tensor</code> å·²ç»å®šä¹‰ï¼Œè¿™ä¸ªå‡½æ•°è¦åšçš„å°±æ˜¯å®šä¹‰å…¶ä»–Tensorç±»å‹ï¼Œç„¶åæŠŠTensorç±»å‹çš„æ–¹æ³•ç›´æ¥æ‹·è´ç»™å®ƒä»¬ï¼Œæœ€ååœ¨è®¾ç½®ä¸€ä¸‹é»˜è®¤ç±»å‹çš„Tensorã€‚ä¸ºä»€ä¹ˆæ•°æ®ç±»å‹ä¸åŒå´å¯ä»¥ç›´æ¥æ‹·è´ï¼Ÿå› ä¸º <code>at::Tensor</code> å¯ä»¥é’ˆå¯¹ä¸åŒæ•°æ®ç±»å‹è°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œç±»å‹å¤šæ€å·²ç»åœ¨ATenå†…éƒ¨å®ç°äº†ã€‚</p><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒTensor ç»‘å®šçš„æ–¹æ³•æ¥è‡ª <code>torch::autograd::variable_methods</code>ï¼Œè¿™ä¸ªåˆ—è¡¨åœ¨ <code>csrc/autograd/generated/python_variable_methods.cpp</code> ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PyMethodDef variable_methods[] = &#123;</span><br><span class="line">  &#123;<span class="string">"__add__"</span>, (PyCFunction)THPVariable_add, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__radd__"</span>, (PyCFunction)THPVariable_add, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__iadd__"</span>, (PyCFunction)THPVariable_add_, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__rmul__"</span>, (PyCFunction)THPVariable_mul, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__mul__"</span>, (PyCFunction)THPVariable_mul, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__imul__"</span>, (PyCFunction)THPVariable_mul_, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__sub__"</span>, (PyCFunction)THPVariable_sub, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"addcmul"</span>, (PyCFunction)THPVariable_addcmul, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æ–‡ä»¶è·¯å¾„å¯ä»¥çœ‹å‡ºè¿™ä¹Ÿæ˜¯æ ¹æ® <code>derivatives.yaml</code> è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œæ‹¿ <code>addcmul</code> ä¸¾ä¸ªä¾‹å­çœ‹çœ‹è¿™äº›å‡½æ•°çš„å®ç°æ–¹æ³•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PyObject * <span class="title">THPVariable_addcmul</span><span class="params">(PyObject* self_, PyObject* args, PyObject* kwargs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HANDLE_TH_ERRORS</span><br><span class="line">  <span class="function"><span class="keyword">static</span> PythonArgParser <span class="title">parser</span><span class="params">(&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"addcmul(Scalar value, Tensor tensor1, Tensor tensor2)|deprecated"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"addcmul(Tensor tensor1, Tensor tensor2, *, Scalar value=1)"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, <span class="comment">/*traceable=*/</span><span class="literal">true</span>)</span></span>;</span><br><span class="line">  <span class="comment">/* è·å–autograd::Variableå®ä¾‹ */</span></span><br><span class="line">  <span class="keyword">auto</span>&amp; self = <span class="keyword">reinterpret_cast</span>&lt;THPVariable*&gt;(self_)-&gt;cdata;</span><br><span class="line">  <span class="comment">/* è§£æå‡½æ•°å‚æ•° */</span></span><br><span class="line">  ParsedArgs&lt;<span class="number">4</span>&gt; parsed_args;</span><br><span class="line">  <span class="keyword">auto</span> r = parser.parse(args, kwargs, parsed_args);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è°ƒç”¨ dispatch */</span></span><br><span class="line">  <span class="keyword">if</span> (r.idx == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> wrap(dispatch_addcmul(self, r.scalar(<span class="number">0</span>), r.tensor(<span class="number">1</span>), r.tensor(<span class="number">2</span>)));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.idx == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> wrap(dispatch_addcmul(self, r.tensor(<span class="number">0</span>), r.tensor(<span class="number">1</span>), r.scalar(<span class="number">2</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  Py_RETURN_NONE;</span><br><span class="line">  END_HANDLE_TH_ERRORS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå‡½æ•°è°ƒç”¨äº† <code>dispatch_addcmul()</code> è¿›è¡Œä¸‹ä¸€æ­¥è®¡ç®—ï¼Œè¯¥å‡½æ•°åœ¨åŒæ–‡ä»¶å¤¹çš„ <code>python_variable_methods_dispatch.h</code> ï¼Œå¯è§è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> Tensor <span class="title">dispatch_addcmul</span><span class="params">(Tensor &amp; self, Scalar value, <span class="keyword">const</span> Tensor &amp; tensor1, <span class="keyword">const</span> Tensor &amp; tensor2)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* é‡Šæ”¾GILé” */</span></span><br><span class="line">  AutoNoGIL no_gil;</span><br><span class="line">  <span class="comment">/* è°ƒç”¨ autograd::Variable.addcmul */</span></span><br><span class="line">  <span class="keyword">return</span> self.addcmul(tensor1, tensor2, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é¦–å…ˆè·å–äº†GILé”ï¼Œç„¶åè°ƒç”¨C++å‰ç«¯ <code>Variable.addcmul()</code> è¿›è¡Œè®¡ç®—ï¼Œç”±äºåè€…å®ç°äº†è‡ªåŠ¨å¾®åˆ†ï¼Œæ‰€ä»¥Pythonè°ƒç”¨ä¹Ÿå…·æœ‰è‡ªåŠ¨å¾®åˆ†åŠŸèƒ½ã€‚ä¸ºä»€ä¹ˆè¦é‡Šæ”¾GILé”ï¼Ÿå› ä¸ºè¿™æ ·æ‰èƒ½ä½¿å…¶ä¸Pythonè§£é‡Šå™¨ä¸­çš„å…¶ä»–è¿›ç¨‹ä¸€èµ·æ­£ç¡®çš„æ‰§è¡Œã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒPython Tensorçš„æ–¹æ³•çš„å°è£…æ€è·¯æ˜¯ï¼š</p><ul><li>ç”Ÿæˆdispatchç³»åˆ—å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºé‡Šæ”¾GILé”ï¼Œç„¶åè°ƒç”¨Variableçš„å¯¹åº”å®ç°</li><li>ç”Ÿæˆå¯è¢«Pythonè°ƒç”¨çš„APIï¼Œè¯¥å‡½æ•°è§£æPythonå‚æ•°ï¼Œå¹¶è°ƒç”¨dispatchç³»åˆ—å‡½æ•°è¿›è¡Œå®é™…è®¡ç®—</li></ul><h3><span id="nn">NN</span></h3><p>ç¥ç»ç½‘ç»œçš„éƒ¨åˆ†å‡½æ•°ä¹Ÿæœ‰éƒ¨åˆ†å‡½æ•°æ˜¯ç›´æ¥ä» ATen ç»‘å®šè€Œæ¥ï¼Œç»‘å®šåˆ° <code>torch._C._nn</code> æ¨¡å—ä¸­ï¼Œä»£ç åœ¨ <code>csrc/autograd/generate/python_nn_functions.cpp</code> ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> PyMethodDef nn_functions[] = &#123;</span><br><span class="line">  &#123;<span class="string">"_parse_to"</span>, (PyCFunction)THPVariable__parse_to, METH_VARARGS | METH_KEYWORDS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_avg_pool2d"</span>, (PyCFunction)THPVariable_adaptive_avg_pool2d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_avg_pool3d"</span>, (PyCFunction)THPVariable_adaptive_avg_pool3d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_max_pool2d"</span>, (PyCFunction)THPVariable_adaptive_max_pool2d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_max_pool3d"</span>, (PyCFunction)THPVariable_adaptive_max_pool3d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"avg_pool2d"</span>, (PyCFunction)THPVariable_avg_pool2d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"avg_pool3d"</span>, (PyCFunction)THPVariable_avg_pool3d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"binary_cross_entropy"</span>, (PyCFunction)THPVariable_binary_cross_entropy, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"elu"</span>, (PyCFunction)THPVariable_elu, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"elu_"</span>, (PyCFunction)THPVariable_elu_, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> initNNFunctions(PyObject* <span class="keyword">module</span>) &#123;</span><br><span class="line">#<span class="keyword">if</span> PY_MAJOR_VERSION == <span class="number">2</span></span><br><span class="line">  PyObject* nn = Py_InitModule(<span class="string">"torch._C._nn"</span>, nn_functions);</span><br><span class="line">  Py_XINCREF(nn);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyModuleDef</span> <span class="title">def</span> = &#123;</span></span><br><span class="line">     PyModuleDef_HEAD_INIT,</span><br><span class="line">     <span class="string">"torch._C._nn"</span>,</span><br><span class="line">     <span class="literal">NULL</span>,</span><br><span class="line">     <span class="number">-1</span>,</span><br><span class="line">     nn_functions</span><br><span class="line">  &#125;;</span><br><span class="line">  PyObject* nn = PyModule_Create(&amp;def);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (!nn) &#123;</span><br><span class="line">    <span class="keyword">throw</span> python_error();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (PyModule_AddObject(<span class="keyword">module</span>, <span class="string">"_nn"</span>, nn) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> python_error();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢æœ‰pooling, loss, convç­‰ç›¸å…³å‡½æ•°ï¼Œä¾›Pythoné‡Œçš„<code>nn.functional</code>è°ƒç”¨ã€‚</p><p>æ­¤å¤–ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨Pythonä¸­è‡ªå®šä¹‰çš„è‡ªå¾®åˆ†çš„å‡½æ•°ï¼ŒPythoné‡Œä¹Ÿå®ç°äº†ä¸Šä¸€ç¯‡å¯¹åº”çš„Functionï¼š<code>torch.autograd.Function</code>ã€‚ç»§æ‰¿å®ƒï¼Œé‡è½½ <code>forward()</code> å’Œ <code>backward()</code> æ–¹æ³•å°±å¯ä»¥ç”¨Pythonå®ç°è‡ªå®šä¹‰çš„è‡ªå¾®åˆ†å‡½æ•°ï¼Œè¯¦è§<a href="https://pytorch.org/docs/stable/notes/extending.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚</p><p><code>torch.autograd.Function</code> çš„å®šä¹‰åœ¨ <code>torch/autograd/function.py</code> ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Function</span><span class="params">(with_metaclass<span class="params">(FunctionMeta, _C._FunctionBase, _ContextMethodMixin, _HookMixin)</span>)</span>:</span></span><br><span class="line">    <span class="comment"># only for backward compatibility</span></span><br><span class="line">    __call__ = _C._FunctionBase._do_forward</span><br><span class="line"></span><br><span class="line">    <span class="comment"># for the tracer</span></span><br><span class="line">    is_traceable = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(ctx, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span><span class="params">(ctx, *grad_outputs)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br></pre></td></tr></table></figure><p>å®ƒç»§æ‰¿è‡ª <code>torch._C.FunctionBase</code>ï¼Œè¯¥ç±»å‹åœ¨ <code>csrc/autograd/python_function.cpp</code>ä¸­ç»‘å®šï¼Œå®ç°çš„é€»è¾‘å’Œ <code>autograd::Function</code> ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨å‰å‘è®¡ç®—æ—¶å»ºç«‹åå‘è®¡ç®—å›¾ï¼Œè¿™é‡Œå°±ä¸è¯»èµ˜è¿°äº†ã€‚ç»‘å®šéƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THPFunction</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line"></span><br><span class="line">    PyObject *needs_input_grad;</span><br><span class="line">    PyObject *to_save;</span><br><span class="line">    PyObject *non_differentiable;</span><br><span class="line">    PyObject *dirty_tensors;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;torch::autograd::VariableInfo&gt; output_info;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;torch::autograd::VariableInfo&gt; input_info;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;torch::autograd::SavedVariable&gt; saved_variables;</span><br><span class="line">    <span class="comment">// For each input, true if the input is a THPVariable</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; is_variable_input;</span><br><span class="line">    <span class="keyword">char</span> has_freed_buffers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* PyFunctionç»§æ‰¿è‡ªFunctionï¼Œå®é™…è°ƒç”¨æœ€ç»ˆè½¬å‘åˆ°Functionä¸­ */</span></span><br><span class="line">    torch::autograd::PyFunction cdata;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyGetSetDef</span> <span class="title">THPFunction_properties</span>[] = &#123;</span></span><br><span class="line">  &#123;<span class="string">"saved_tensors"</span>, (getter)THPFunction_saved_tensors, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"saved_variables"</span>, (getter)THPFunction_saved_variables, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"next_functions"</span>, (getter)THPFunction_next_functions, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  ...</span><br><span class="line">  &#123;<span class="literal">nullptr</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyMethodDef</span> <span class="title">THPFunction_methods</span>[] = &#123;</span></span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"apply"</span>, (PyCFunction)THPFunction_apply, METH_CLASS | METH_VARARGS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"_do_forward"</span>, (PyCFunction)THPFunction_do_forward, METH_VARARGS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"_do_backward"</span>, (PyCFunction)THPFunction_do_backward, METH_VARARGS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"_register_hook_dict"</span>, (PyCFunction)THPFunction__register_hook_dict, METH_O, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"register_hook"</span>, (PyCFunction)THPFunction_register_hook, METH_O, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="literal">nullptr</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PyTypeObject THPFunctionType = &#123;</span><br><span class="line">  PyVarObject_HEAD_INIT(<span class="literal">nullptr</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="string">"torch._C._FunctionBase"</span>,              <span class="comment">/* tp_name */</span></span><br><span class="line">  <span class="keyword">sizeof</span>(THPFunction),                   <span class="comment">/* tp_basicsize */</span></span><br><span class="line">  <span class="number">0</span>,                                     <span class="comment">/* tp_itemsize */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">THPFunction_initModule</span><span class="params">(PyObject *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (PyType_Ready(&amp;THPFunctionType) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  Py_INCREF(&amp;THPFunctionType);</span><br><span class="line">  PyModule_AddObject(<span class="keyword">module</span>, <span class="string">"_FunctionBase"</span>, </span><br><span class="line">                     (PyObject *)&amp;THPFunctionType);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li><p><code>THPFunction</code> = <code>_C._FunctionBase</code></p></li><li><p>Pythonçš„ <code>autograd.Function</code> ç»§æ‰¿è‡ªä¸Šé¢å®ç°è‡ªåŠ¨å¾®åˆ†</p></li></ul><p>å®Œ</p><table><thead><tr class="header"><th style="text-align: left;">ä¸Šä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch4/">Autograd</a></th><th style="text-align: right;"></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"></td><td style="text-align: right;"></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æ˜¯æœ¬ç³»åˆ—æœ€åä¸€ç¯‡åšå®¢äº†ï¼Œä»‹ç»ä¸€ä¸‹å‰é¢çš„C++ä»£ç æ€ä¹ˆä¸Pythonäº¤äº’ï¼Œæˆ–è€…è¯´Pythoné‡Œæ€ä¹ˆè°ƒç”¨C++ä»£ç è¿›è¡Œé«˜æ•ˆçš„è®¡ç®—ã€‚é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹é¢„å¤‡çŸ¥è¯†ï¼Œæ—¢Pythonçš„Cæ‰©å±•é€šå¸¸æ€ä¹ˆå†™ï¼›ç„¶åä»¥æ¯”è¾ƒæ ¸å¿ƒçš„æ•°æ®ç»“æ„ Tensor å’Œ Storage ä¸ºä¾‹çœ‹ä¸€ä¸‹å®ƒä»¬æ€ä¹ˆè½¬æ¢ä¸ºPythonç±»å‹çš„ï¼›æœ€åç¨å¸¦ç‚¹å„¿Pythonè‡ªå¾®åˆ†å‡½æ•°çš„å®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="C++" scheme="http://www.52coding.com.cn/tags/C/"/>
    
      <category term="PyTorch" scheme="http://www.52coding.com.cn/tags/PyTorch/"/>
    
      <category term="Pythonæ‰©å±•" scheme="http://www.52coding.com.cn/tags/Python%E6%89%A9%E5%B1%95/"/>
    
  </entry>
  
  <entry>
    <title>PyTorchæºç æµ…æ(4)ï¼šAutograd</title>
    <link href="http://www.52coding.com.cn/2019/05/05/PyTorch4/"/>
    <id>http://www.52coding.com.cn/2019/05/05/PyTorch4/</id>
    <published>2019-05-05T07:57:01.000Z</published>
    <updated>2019-05-05T08:07:27.766Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡åšå®¢ä»‹ç» PyTorch ä¸­è‡ªåŠ¨å¾®åˆ†å¼•æ“çš„å®ç°ï¼Œä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šé¦–å…ˆç®€è¦ä»‹ç»ä¸€ä¸‹è®¡ç®—å›¾çš„åŸç†ï¼›ç„¶åä»‹ç» PyTorch ä¸­ä¸ autograd çš„ç›¸å…³æ•°æ®ç»“æ„å’Œ <code>backward()</code> å‡½æ•°çš„å®ç°ï¼Œæ•°æ®ç»“æ„åŒ…æ‹¬ <code>torch::autograd::Variable</code>, <code>torch::autograd::Function</code> ç­‰ï¼›æœ€åè®²ä¸€ä¸‹åŠ¨æ€å»ºç«‹è®¡ç®—å›¾çš„å®ç°ï¼Œè¿™éƒ¨åˆ†ä»£ç æ¶‰åŠåˆ°åŠ¨æ€æ´¾å‘æœºåˆ¶ï¼Œè€Œä¸”éƒ½æ˜¯ç”¨è„šæœ¬ç”Ÿæˆçš„ï¼Œä¸å¤ªå®¹æ˜“ç†è§£ã€‚</p><a id="more"></a><!-- toc --><ul><li><a href="#è®¡ç®—å›¾ç®€ä»‹">è®¡ç®—å›¾ç®€ä»‹</a></li><li><a href="#autograd-engine">Autograd Engine</a><ul><li><a href="#variable">Variable</a></li><li><a href="#autogradmeta">AutogradMeta</a></li><li><a href="#function-edge">Function &amp; Edge</a></li><li><a href="#engine">Engine</a></li></ul></li><li><a href="#åŠ¨æ€å»ºç«‹è®¡ç®—å›¾">åŠ¨æ€å»ºç«‹è®¡ç®—å›¾</a></li></ul><!-- tocstop --><h2><span id="è®¡ç®—å›¾ç®€ä»‹">è®¡ç®—å›¾ç®€ä»‹</span></h2><p>è®¡ç®—å›¾æ˜¯ä¸€ä¸ªæœ‰å‘å›¾ï¼Œå®ƒçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚åŠ å‡ä¹˜é™¤ç­‰ï¼‰æˆ–è€…è¾“å…¥æ•°æ®ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰ã€‚è®¡ç®—å›¾çš„è¾¹ä»£è¡¨æ•°æ®æµå‘ï¼šæŒ‡å‘æŸä¸ªèŠ‚ç‚¹çš„è¾¹ä¸ºè¯¥èŠ‚ç‚¹çš„è¾“å…¥ï¼Œç”±è¯¥èŠ‚ç‚¹æµå‡ºçš„è¾¹è¡¨ç¤ºå®ƒçš„è¾“å‡ºã€‚è®¡ç®—å›¾å¯ä»¥ç”¨æ¥æè¿°ç¥ç»ç½‘ç»œçš„è®¡ç®—ï¼Œå¦‚ä¸‹å›¾æè¿°äº† <span class="math inline">\(y = \sin(xa+b)â€‹\)</span> çš„è®¡ç®—è¿‡ç¨‹ï¼š</p><p><img src="/images/pytorch/comp_graph.png"></p><p>è®¡ç®—å›¾çš„æ±‚å€¼åˆ†ä¸ºå‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ï¼Œåˆ†åˆ«ç”¨äºè®¡ç®—è¾“å‡ºå’Œæ¢¯åº¦ã€‚å‰å‘ä¼ æ’­çš„è¿‡ç¨‹å°±æ˜¯ä»å¶å­èŠ‚ç‚¹å¼€å§‹éå†è®¡ç®—å›¾ï¼Œç›´åˆ°æ•´ä¸ªå›¾éƒ½è¢«éå†è¿‡ï¼›è€Œåå‘ä¼ æ’­å°±æ˜¯ä»è¾“å‡ºèŠ‚ç‚¹å¼€å§‹éå†ï¼ŒèŠ‚ç‚¹è¡¨ç¤ºçš„å‡½æ•°ä¹Ÿå˜ä¸ºåŸå‡½æ•°å¯¹è¾“å…¥çš„å¯¼æ•°ã€‚ä¸¾ä¸ªæ —å­ï¼Œä¸‹é¢æ˜¯<code>addcmul()</code>å‡½æ•°çš„è®¡ç®—å›¾çš„å‰å‘å’Œåå‘è®¡ç®—è¿‡ç¨‹ï¼š</p><p><img src="/images/pytorch/forward.gif"></p><h2><span id="autograd-engine">Autograd Engine</span></h2><p>ä»‹ç»å®Œäº†æ ‡å‡†çš„è®¡ç®—å›¾ç»“æ„ï¼Œé‚£ä¹ˆPyTorché‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿåœ¨å›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰é¦–å…ˆè¦çœ‹å‡ ä¸ªç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«æ˜¯<code>Variable</code>, <code>AutogradMeta</code>, <code>Function</code>, å’Œ <code>Edge</code>ã€‚</p><h3><span id="variable">Variable</span></h3><p>ç›¸ä¿¡ç”¨è¿‡è€ç‰ˆæœ¬çš„PyTorchçš„å°ä¼™ä¼´å¯¹<code>Variable</code>ä¸€å®šä¸ä¼šé™Œç”Ÿï¼Œå®ƒæ˜¯ç”¨æ¥å®ç°è‡ªåŠ¨å¾®åˆ†çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œä»£ç åœ¨<code>torch/csrc/autograd/variable.h</code>ã€‚<code>Variable</code> å¯ä»¥è¡¨ç¤ºè®¡ç®—å›¾ä¸­çš„å¶å­èŠ‚ç‚¹ï¼Œå¦‚æƒé‡ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºå›¾ä¸­çš„ä¸­é—´å˜é‡ï¼Œè™½ç„¶åœ¨æ–°ç‰ˆæœ¬ä¸­ <code>Tensor</code> ä¸ <code>Variable</code> åˆå¹¶äº†ï¼Œåœ¨å‰ç«¯ä¸­å¯ä»¥ç›´æ¥ç”¨ <code>Tensor</code> ä»£æ›¿ <code>Variable</code>ï¼Œä½†æ˜¯ <code>Variable</code> å¹¶æ²¡æœ‰æ¶ˆå¤±ã€‚</p><p>å®ƒçš„å®ç°ç¡®å®æ”¹å˜äº†ï¼Œä½†åŠŸèƒ½ä¾æ—§ã€‚<code>Variable</code> ç»§æ‰¿è‡ª <code>at::Tensor</code>ï¼Œé‡è½½äº†<code>Tensor</code>é‡Œä¸æ¢¯åº¦è®¡ç®—ç›¸å…³çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†å’Œ <code>Tensor</code> éšå¼è½¬æ¢çš„æ„é€ å‡½æ•°ã€‚</p><p><code>Variable</code> çš„åº•å±‚å®ç° <code>Variable::Impl</code> ä¹Ÿç»§æ‰¿ <code>at::TensorImpl</code>ï¼Œè¿™ä¸ªç±»åœ¨<a href="">æ­¤ç³»åˆ—çš„ç¬¬ä¸€ç¯‡</a>ä¸­ä»‹ç»è¿‡ï¼Œå®ƒé‡Œé¢æœ‰ä¸€ä¸ªæˆå‘˜ <code>bool is_variable</code>ï¼Œç”¨äºè¯†åˆ«è¿™ä¸ª Tensor åˆ°åº•æ˜¯ <code>at::Tensor</code> è¿˜æ˜¯ <code>Variable</code>ã€‚<code>TensorImpl</code> é‡Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æˆå‘˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;c10::AutogradMetaInterface&gt; autograd_meta_=<span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure><p><code>autograd_meta_</code> è®°å½•äº†å½“å‰ä¸ <code>Variable</code> ç›¸å…³çš„è®¡ç®—å›¾ä¿¡æ¯ï¼Œåœ¨<code>Variable::Impl</code>é‡Œå®ƒè¢«å¼ºåˆ¶è½¬æ¢æˆ <code>AutogradMeta*</code> ç±»å‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Variable::<span class="function">AutogradMeta* <span class="title">get_autograd_meta</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;Variable::AutogradMeta*&gt;(autograd_meta());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>AutogradMeta</code> ç±»å‹å®ç°äº† <code>c10::AutogradMetaInterface</code> æ¥å£ã€‚</p><h3><span id="autogradmeta">AutogradMeta</span></h3><p><code>AutogradMeta</code> çš„å£°æ˜ä¹Ÿåœ¨ <code>variable.h</code> ä¸­ï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TORCH_API</span> <span class="title">Variable</span>:</span>:AutogradMeta : <span class="keyword">public</span> c10::AutogradMetaInterface &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> name;</span><br><span class="line"></span><br><span class="line">  Variable grad_;<span class="comment">// å­˜å‚¨æ¢¯åº¦</span></span><br><span class="line">  <span class="comment">// åå‘ä¼ æ’­å‡½æ•° for ä¸­é—´èŠ‚ç‚¹</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Function&gt; grad_fn_;</span><br><span class="line">  <span class="comment">// åå‘ä¼ æ’­å‡½æ•° for å¶èŠ‚ç‚¹ï¼ˆæƒé‡ï¼‰ï¼Œåªæ˜¯æŠŠæ¢¯åº¦ç´¯åŠ èµ·æ¥ç”¨æ¥æ›´æ–°</span></span><br><span class="line">  <span class="built_in">std</span>::weak_ptr&lt;Function&gt; grad_accumulator_;</span><br><span class="line"></span><br><span class="line">  VariableVersion version_counter_;</span><br><span class="line">  <span class="comment">// é¢„å¤„ç†</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;FunctionPreHook&gt;&gt; hooks_;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> requires_grad_;</span><br><span class="line">  <span class="keyword">bool</span> is_view_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è‹¥è¯¥Variableæ˜¯æŸä¸ªå‡½æ•°çš„è¾“å‡ºï¼Œé‚£ä¹ˆoutput_nr_è®°å½•å®ƒæ˜¯ç¬¬å‡ ä¸ªè¾“å‡º</span></span><br><span class="line">  <span class="keyword">uint32_t</span> output_nr_;</span><br><span class="line">  PyObject* pyobj_ = <span class="literal">nullptr</span>; <span class="comment">// weak reference</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::mutex mutex_;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_requires_grad</span><span class="params">(<span class="keyword">bool</span> requires_grad, at::TensorImpl* self_impl)</span> override </span>&#123;</span><br><span class="line"><span class="comment">/* check */</span></span><br><span class="line">    requires_grad_ = requires_grad;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">requires_grad</span><span class="params">()</span> <span class="keyword">const</span> override </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> requires_grad_ || grad_fn_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Variable&amp; <span class="title">grad</span><span class="params">()</span> override </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> grad_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">const</span> Variable&amp; <span class="title">grad</span><span class="params">()</span> <span class="keyword">const</span> override </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> grad_;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»å£°æ˜ä¸­å¯ä»¥çœ‹å‡º <code>AutogradMeta</code> ä¸ä½†å­˜å‚¨äº†æ¢¯åº¦ï¼Œè¿˜å­˜å‚¨äº†è¯¥<code>Variable</code>å¯¹åº”çš„åå‘ä¼ æ’­å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—å›¾çš„èŠ‚ç‚¹ã€‚</p><p>PyTorchåªå»ºç«‹åå‘ä¼ æ’­çš„è®¡ç®—å›¾ï¼Œå› ä¸ºå…¶å®å‰å‘ä¼ æ’­æ˜¯ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ï¼Œä¸ç”¨PyTorchå¹²ä»€ä¹ˆã€‚ä½†æ˜¯åœ¨ç”¨æˆ·åœ¨å®šä¹‰å‰å‘è¿æ¥çš„æ—¶å€™ï¼ŒPyTorchéœ€è¦å·å·å»ºç«‹åå‘è¿æ¥ï¼Œå…·ä½“æ€ä¹ˆæ“ä½œè§ä¸‹ä¸€èŠ‚ã€‚PyTorché‡Œè®¡ç®—å›¾çš„èŠ‚ç‚¹å…¨éƒ¨éƒ½æ˜¯<code>Function</code>ï¼Œç”±äºåªè®¡ç®—å›¾åªç”¨äºåå‘ä¼ æ’­ï¼Œæ‰€ä»¥ <code>Function</code> å®ç°éƒ½æ˜¯åå‘ä¼ æ’­å‡½æ•°ã€‚å¯¹äºè®¡ç®—å›¾ä¸­çš„ä¸­é—´ç»“æœï¼Œå¯¹åº”çš„ <code>grad_fn_</code> æ˜¯ç›¸åº”çš„åå‘ä¼ æ’­å‡½æ•°ï¼›è€Œå¯¹äºå¶èŠ‚ç‚¹ï¼ˆæƒé‡ï¼‰ï¼Œå¯¹åº”çš„ <code>grad_fn_</code> ä¸º <code>nullptr</code>ï¼Œè€Œ <code>grad_accumulator_</code> ä¸ºå…¶ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œå°±æ˜¯æŠŠæ¢¯åº¦ç´¯åŠ å­˜å‚¨åˆ° <code>grad_</code> é‡Œã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸éœ€è¦æ¢¯åº¦çš„è¾“å…¥æ˜¯ä¸ä¼šè¿›å…¥è®¡ç®—å›¾ä¸­çš„ã€‚</p><p>ä»”ç»†è§‚å¯Ÿæˆ‘ä»¬ä¼šå‘ç°ï¼Œ<code>Variable</code>é‡Œæ‹¥æœ‰<code>AutogradMeta</code>ï¼Œè€Œåè€…é‡Œç”¨æœ‰ <code>Function</code>ï¼Œæ‰€ä»¥å®é™…ä¸Š <code>Variable</code> å’Œå®ƒçš„ <code>grad_fn_</code> æ˜¯ç»‘å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª <code>Variable</code> åªèƒ½æœ‰ä¸€ä¸ª <code>grad_fn_</code>ï¼Œä½†åè¿‡æ¥åˆ™ä¸ä¸€å®šï¼Œä¸€ä¸ª <code>grad_fn_</code> ä¹Ÿå¯èƒ½å±äºå¤šä¸ª <code>Variable</code>ï¼ˆå¦‚æœæ­£å‘ä¼ æ’­å‡½æ•°è¾“å‡ºå¾ˆå¤šçš„è¯ï¼Œé‚£ä¹ˆè¿™äº›è¾“å‡ºå…±äº«ä¸€ä¸ªåå‘ä¼ æ’­å‡½æ•°ï¼‰ã€‚</p><h3><span id="function-amp-edge">Function &amp; Edge</span></h3><p><code>Function</code> å’Œ <code>Edge</code> å®ç°æ˜¯ç´§å¯†ç›¸è¿çš„ï¼Œ<code>Function</code> æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œå¯ä»¥å½“ä½œåå‘ä¼ æ’­çš„å‡½æ•°æ¥ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ<code>Function</code> é‡Œè¿˜æœ‰ä¸€ä¸ªæˆå‘˜ <code>edge_list next_edges_;</code>ï¼Œæ˜¯ä¸è¯¥èŠ‚ç‚¹ç›¸è¿çš„è¾¹ã€‚PyTorchçš„è®¡ç®—å›¾ä¸­çš„è¾¹å…¶å®å°±æ˜¯ <code>{function, input_nr}</code> pairï¼šå‰è€…è¡¨ç¤ºè¿™æ¡è¾¹æŒ‡å‘å“ªä¸ªèŠ‚ç‚¹ï¼Œåè€…è¡¨ç¤ºæœ¬èŠ‚ç‚¹æ˜¯ç›®æ ‡èŠ‚ç‚¹çš„ç¬¬å‡ ä¸ªè¾“å…¥ï¼ˆä»0å¼€å§‹ï¼‰ã€‚</p><p><code>Function</code> çš„å®ç°åœ¨ <code>csrc/autograd/function.h</code>ï¼Œå¤§è‡´å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TORCH_API</span> <span class="title">Function</span> :</span> <span class="built_in">std</span>::enable_shared_from_this&lt;Function&gt; &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/* æ„é€ å‡½æ•°ç•¥ */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸å¯æ‹·è´æˆ–ç§»åŠ¨</span></span><br><span class="line">  Function(<span class="keyword">const</span> Function&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">  Function(Function&amp;&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">  Function&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> Function&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">  Function&amp; <span class="keyword">operator</span>=(Function&amp;&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">  <span class="keyword">virtual</span> ~Function() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡è½½()è¿ç®—ç¬¦å®ç°å‡½æ•°å¯¹è±¡åŠŸèƒ½ï¼Œéœ€é‡è½½applyå‡½æ•°</span></span><br><span class="line">  <span class="comment">// è¯¥å‡½æ•°æ¥æ”¶ä¸€ç³»åˆ—variableï¼Œè¿”å›ä¸€ç³»åˆ—variable</span></span><br><span class="line">  <span class="function">variable_list <span class="title">operator</span><span class="params">()</span><span class="params">(variable_list&amp;&amp; inputs)</span> </span>&#123;</span><br><span class="line">    profiler::<span class="function">RecordFunction <span class="title">rec</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> apply(<span class="built_in">std</span>::move(inputs));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ‰å…³è®¡ç®—å›¾çš„ API</span></span><br><span class="line">  <span class="comment">//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">const</span> Edge&amp; <span class="title">next_edge</span><span class="params">(<span class="keyword">size_t</span> index)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> next_edges_[index];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_next_edge</span><span class="params">(<span class="keyword">size_t</span> index, Edge edge)</span> </span>&#123;</span><br><span class="line">    next_edges_[index] = <span class="built_in">std</span>::move(edge);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">add_next_edge</span><span class="params">(Edge edge)</span> </span>&#123;</span><br><span class="line">    next_edges_.push_back(<span class="built_in">std</span>::move(edge));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_next_edges</span><span class="params">(edge_list&amp;&amp; next_edges)</span> </span>&#123;</span><br><span class="line">    next_edges_ = <span class="built_in">std</span>::move(next_edges);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">const</span> edge_list&amp; <span class="title">next_edges</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> next_edges_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">edge_list&amp; <span class="title">next_edges</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> next_edges_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> num_outputs() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> next_edges_.size();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">  </span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> uint64_t&amp; <span class="title">get_next_sequence_nr</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éœ€è¦é‡è½½çš„applyå‡½æ•°ï¼Œå®ç°å®é™…åŠŸèƒ½</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> variable_list <span class="title">apply</span><span class="params">(variable_list&amp;&amp; inputs)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">variable_list <span class="title">traced_apply</span><span class="params">(variable_list inputs)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‡½æ•°åºåˆ—å·</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">uint64_t</span> sequence_nr_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜é‚»è¾¹</span></span><br><span class="line">  edge_list next_edges_;</span><br><span class="line">  PyObject* pyobj_ = <span class="literal">nullptr</span>; <span class="comment">// weak reference</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;AnomalyMetadata&gt; anomaly_metadata_ = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;FunctionPreHook&gt;&gt; pre_hooks_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;FunctionPostHook&gt;&gt; post_hooks_;</span><br><span class="line">  at::SmallVector&lt;InputMetadata, <span class="number">2</span>&gt; input_metadata_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>Edge</code> çš„å£°æ˜åœ¨ <code>csrc/autograd/edge.h</code>ï¼Œå®ƒçš„å£°æ˜å°±å¾ˆç®€å•äº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">  Edge() <span class="keyword">noexcept</span> : function(<span class="literal">nullptr</span>), input_nr(<span class="number">0</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  Edge(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Function&gt; function_, <span class="keyword">uint32_t</span> input_nr_) <span class="keyword">noexcept</span></span><br><span class="line">      : function(<span class="built_in">std</span>::move(function_)), input_nr(input_nr_) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convenience method to test if an edge is valid.</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_valid</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> function != <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Required for use in associative containers.</span></span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Edge&amp; other) <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;function == other.function &amp;&amp; <span class="keyword">this</span>-&gt;input_nr == other.input_nr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span>!=(<span class="keyword">const</span> Edge&amp; other) <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !(*<span class="keyword">this</span> == other);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›®æ ‡å‡½æ•°</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Function&gt; function;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¬¬å‡ ä¸ªè¾“å…¥</span></span><br><span class="line">  <span class="keyword">uint32_t</span> input_nr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>Variable</code>ï¼Œ<code>AutogradMeta</code>ï¼Œ<code>Function</code>ï¼Œå’Œ<code>Edge</code> çš„å¤§è‡´å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/pytorch/Variable.svg"></p><h3><span id="engine">Engine</span></h3><p>æˆ‘ä»¬å…ˆä¸çœ‹æ€ä¹ˆå»ºç«‹è®¡ç®—å›¾ï¼Œè€Œæ˜¯å…ˆå‡è®¾å›¾å·²ç»å»ºç«‹å¥½ï¼Œè€ƒè™‘å…·ä½“æ€ä¹ˆæ‰§è¡Œåå‘ä¼ æ’­ã€‚ä½ å¯èƒ½è§‰å¾—ç­”æ¡ˆå·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œä¸å°±æ˜¯å¯¹å›¾è¿›è¡Œéå†ä¹ˆï¼Œæ²¡é”™ï¼Œæ˜¯å¯¹å›¾è¿›è¡Œéå†ï¼Œä½†è€ƒè™‘åˆ°æ•ˆç‡ä»¥åŠè¦åœ¨ä¸åŒè®¾å¤‡ä¸Šè®¡ç®—ï¼Œå®é™…æ“ä½œèµ·æ¥è¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦çš„ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¸»è¦ç”± <code>autograd::Engine</code>å®ç°ï¼Œå£°æ˜å’Œå®ç°åˆ†åˆ«åœ¨ <code>csrc/autograd/engine.h</code> å’Œ <code>csrc/autograd/engine.cpp</code> ä¸­ã€‚</p><p>ç”¨ PyTorch å»ºç«‹ç¥ç»ç½‘ç»œçš„æ—¶å€™ï¼Œç›¸ä¿¡ä½ ä¸€å®šç”¨è¿‡ <code>loss.backward()</code> æ¥è¿›è¡Œåå‘ä¼ æ’­ï¼Œé‚£å°±ä»<code>Variable::backward()</code> å‡½æ•°å¼€å§‹ä¸€æ­¥ä¸€æ­¥çœ‹åå‘ä¼ æ’­æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Variable::backward(</span><br><span class="line">    c10::optional&lt;Tensor&gt; gradient,</span><br><span class="line">    <span class="keyword">bool</span> keep_graph,</span><br><span class="line">    <span class="keyword">bool</span> create_graph) <span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="comment">// è·å– AutogradMeta</span></span><br><span class="line">  <span class="keyword">auto</span> autograd_meta = get_autograd_meta();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ„é€ èµ·å§‹è¾¹ï¼Œåšä¸ºéå†çš„èµ·ç‚¹ï¼ˆå›¾çš„rootï¼‰</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Edge&gt; edges;</span><br><span class="line">  edges.emplace_back(autograd_meta-&gt;grad_fn_, autograd_meta-&gt;output_nr_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„é€ è¾“å…¥ï¼švariable list</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Variable&gt; inputs;</span><br><span class="line">  inputs.push_back(<span class="built_in">std</span>::move(as_variable_ref(*gradient)));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è°ƒç”¨ execute è¿›è¡Œåå‘ä¼ æ’­</span></span><br><span class="line">  Engine::get_default_engine().execute(edges, inputs, keep_graph, create_graph);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°é¦–å…ˆæ„é€ éå†çš„èµ·ç‚¹å’Œè¾“å…¥ï¼Œç„¶åè°ƒç”¨ <code>Engine::execute()</code> è¿›è¡Œè®¡ç®—ï¼Œå…¶ä¸­ <code>Engine::get_default_engine()</code> è¿”å›çš„æ˜¯ <code>Engine</code> çš„å®ä¾‹ã€‚</p><p>æ¥ç€ç ”ç©¶ <code>Engine::execute()</code>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> Engine::execute(<span class="keyword">const</span> edge_list&amp; roots,</span><br><span class="line">                     <span class="keyword">const</span> variable_list&amp; inputs,</span><br><span class="line">                     <span class="keyword">bool</span> keep_graph,</span><br><span class="line">                     <span class="keyword">bool</span> create_graph,</span><br><span class="line">                     <span class="keyword">const</span> edge_list&amp; outputs) -&gt; variable_list &#123;</span><br><span class="line">  <span class="comment">// å¯åŠ¨å¤šçº¿ç¨‹ï¼ˆæ¯ä¸ªè®¾å¤‡ä¸€ä¸ªçº¿ç¨‹ï¼‰</span></span><br><span class="line">  <span class="built_in">std</span>::call_once(start_threads_flag, &amp;Engine::start_threads, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* éªŒè¯outputs */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®°å½•è®¡ç®—å›¾çš„ä»»åŠ¡</span></span><br><span class="line">  <span class="function">GraphTask <span class="title">graph_task</span><span class="params">(keep_graph, create_graph)</span></span>;</span><br><span class="line">  <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(graph_task.mutex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éå†ä¸€éè®¡ç®—å›¾ï¼Œè®¡ç®—æ¯ä¸ªå‡½æ•°çš„ä¾èµ–</span></span><br><span class="line">  <span class="comment">// æ‰€è°“æŸå‡½æ•°çš„ä¾èµ–å°±æ˜¯æœ‰å‡ æ¡è¾¹æŒ‡å‘è¯¥å‡½æ•°ï¼Œç”¨å›¾çš„æœ¯è¯­è¯´å°±æ˜¯èŠ‚ç‚¹çš„å…¥åº¦</span></span><br><span class="line">  <span class="comment">// ä¾èµ–å¤§äºé›¶ï¼ˆå…¥åº¦&gt;0ï¼‰çš„èŠ‚ç‚¹ä¸èƒ½å¤Ÿæ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">auto</span> graph_root = <span class="built_in">std</span>::make_shared&lt;GraphRoot&gt;(roots, inputs);</span><br><span class="line">  compute_dependencies(graph_root.get(), graph_task);</span><br><span class="line">  <span class="keyword">if</span> (!outputs.empty()) &#123;</span><br><span class="line">    graph_task.init_to_execute(*graph_root, outputs);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æŠŠrootåŠ å…¥å‡†å¤‡é˜Ÿåˆ—ï¼Œæ¯ä¸ªè®¾å¤‡æœ‰ä¸€ä¸ªå‡†å¤‡é˜Ÿåˆ—ï¼Œ-1ä»£è¡¨CPU</span></span><br><span class="line">  ready_queue(<span class="number">-1</span>).push(FunctionTask(&amp;graph_task, <span class="built_in">std</span>::move(graph_root), InputBuffer(<span class="number">0</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (worker_device == NO_DEVICE) &#123;</span><br><span class="line">    <span class="comment">// éå·¥ä½œçº¿ç¨‹ï¼šè€è€å®å®ç­‰å¾…å›¾è®¡ç®—å®Œæ¯•</span></span><br><span class="line">    graph_task.not_done.wait(lock, [&amp;graph_task]&#123;</span><br><span class="line">      <span class="keyword">return</span> graph_task.outstanding_tasks.load() == <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å·¥ä½œçº¿ç¨‹ï¼š996!</span></span><br><span class="line">    graph_task.owner = worker_device;</span><br><span class="line">    lock.unlock();</span><br><span class="line">    <span class="comment">// çº¿ç¨‹ä¸»å¾ªç¯</span></span><br><span class="line">    thread_main(&amp;graph_task);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check exceptions */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> graph_task.captured_vars;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Engine::execute()</code> é‡Œåšäº†è¿™å‡ ä»¶äº‹ï¼ˆå¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªå…¬å¸ï¼‰ï¼š</p><ul><li>æ‹›è˜å‘˜å·¥ï¼ˆå¯åŠ¨å¤šçº¿ç¨‹ï¼‰</li><li>æ˜ç¡®æ•´ä½“ä»»åŠ¡ï¼ˆè®¡ç®—ä¾èµ–ï¼‰</li><li>å‡†å¤‡ç¬¬ä¸€ä»½å·¥ä½œï¼ˆæŠŠrootåŠ å…¥å‡†å¤‡é˜Ÿåˆ—ï¼‰</li><li>å¼€å§‹å·¥ä½œï¼</li></ul><p>é¦–å…ˆçœ‹å¯åŠ¨å¤šçº¿ç¨‹çš„ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> Engine::start_threads() -&gt; <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// è·å–GPUæ•°ç›®</span></span><br><span class="line">  <span class="keyword">int</span> num_devices = at::getNumGPUs();</span><br><span class="line">  <span class="comment">// çº¿ç¨‹æ•° = GPUæ•° + 1 (for CPU)</span></span><br><span class="line">  <span class="keyword">int</span> num_threads = num_devices + <span class="number">1</span>;</span><br><span class="line">  ready_queues = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ReadyQueue&gt;&gt;(num_threads);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; <span class="built_in">queue</span> : ready_queues)</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ¯ä¸ªè®¾å¤‡çš„å‡†å¤‡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">queue</span>.reset(<span class="keyword">new</span> ReadyQueue());</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num_threads; ++i) &#123;</span><br><span class="line">    <span class="comment">// èµ‹äºˆæ¯ä¸ªçº¿ç¨‹å¯¹åº”çš„ deviceï¼Œç„¶åè¿›å…¥ thread_main()</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t</span><span class="params">(&amp;Engine::thread_init, <span class="keyword">this</span>, i - <span class="number">1</span>)</span></span>;</span><br><span class="line">    t.detach();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹å¦‚ä½•è®¡ç®—ä¾èµ–ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> Engine::compute_dependencies(Function* root, GraphTask&amp; task) -&gt; <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// è®°å½•å·²è®¿é—®è¿‡èŠ‚ç‚¹</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unordered_set</span>&lt;Function*&gt; seen;</span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹é˜Ÿåˆ—ï¼Œç”¨äºBFS</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Function*&gt; <span class="built_in">queue</span> &#123; root &#125;;</span><br><span class="line"><span class="comment">// è®°å½•ä¾èµ–çš„æ•°æ®ç»“æ„ï¼Œç±»å‹ä¸º unordered_map&lt;Function*, int&gt;</span></span><br><span class="line">  <span class="keyword">auto</span>&amp; dependencies = task.dependencies;</span><br><span class="line">  <span class="comment">// BFS</span></span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">queue</span>.empty()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> fn = <span class="built_in">queue</span>.back(); <span class="built_in">queue</span>.pop_back();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; edge : fn-&gt;next_edges()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span> next_ptr = edge.function.get()) &#123;</span><br><span class="line">        <span class="comment">// ç›®æ ‡èŠ‚ç‚¹çš„ä¾èµ–+1</span></span><br><span class="line">        dependencies[next_ptr] += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">bool</span> was_inserted = seen.insert(next_ptr).second;</span><br><span class="line">        <span class="keyword">if</span> (was_inserted) <span class="built_in">queue</span>.push_back(next_ptr);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ¥çœ‹æœ€ä¸»è¦çš„ <code>thread_main()</code>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> Engine::thread_main(GraphTask *graph_task) -&gt; <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// è·å–å½“å‰è¿›ç¨‹çš„å‡†å¤‡é˜Ÿåˆ—</span></span><br><span class="line">  <span class="keyword">auto</span> <span class="built_in">queue</span> = ready_queues[worker_device + <span class="number">1</span>];</span><br><span class="line">  <span class="comment">// å·¥ä½œæ²¡å®Œæˆä¹‹å‰ä¸èƒ½ä¸‹ç­ï¼š</span></span><br><span class="line">  <span class="keyword">while</span> (!graph_task || graph_task-&gt;outstanding_tasks &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–æœ€æ–°å·¥ä½œï¼Œpop()æ˜¯é˜»å¡çš„ï¼Œåªæœ‰æ¥å·¥ä½œäº†æ‰ä¼šç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</span></span><br><span class="line">    FunctionTask task = <span class="built_in">queue</span>-&gt;pop();</span><br><span class="line">    <span class="keyword">if</span> (task.fn &amp;&amp; !task.base-&gt;has_error.load()) &#123;</span><br><span class="line">      GradMode::set_enabled(task.base-&gt;grad_mode);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œè¯¥ä»»åŠ¡</span></span><br><span class="line">        evaluate_function(task);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="built_in">std</span>::exception&amp; e) &#123;</span><br><span class="line">        thread_on_exception(task, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰¾åˆ°å‘å¸ƒä»»åŠ¡çš„äºº</span></span><br><span class="line">    <span class="keyword">auto</span> base_owner = task.base-&gt;owner;</span><br><span class="line">    <span class="comment">// è‹¥è¯¥ä»»åŠ¡æ¥è‡ªéå·¥ä½œçº¿ç¨‹ï¼ˆi.e.s é¢†å¯¼çº¿ç¨‹ï¼Œå‘å·æ–½ä»¤ï¼‰ï¼š</span></span><br><span class="line">    <span class="keyword">if</span> (base_owner == NO_DEVICE) &#123;</span><br><span class="line">      <span class="comment">// è‡ªå‡å‰©ä½™ä»»åŠ¡æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (--task.base-&gt;outstanding_tasks == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰ä»»åŠ¡å®Œæ¯•ï¼Œé€šçŸ¥å¤§ä¼™ä¸‹ç­</span></span><br><span class="line">        <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(task.base-&gt;mutex);</span><br><span class="line">        task.base-&gt;not_done.notify_all();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœä»»åŠ¡å‘å¸ƒè€…æ˜¯è‡ªå·±ï¼š</span></span><br><span class="line">      <span class="keyword">if</span> (base_owner == worker_device) &#123;</span><br><span class="line">        <span class="comment">// è‡ªå‡å‰©ä½™ä»»åŠ¡æ•°</span></span><br><span class="line">        --task.base-&gt;outstanding_tasks;</span><br><span class="line">      <span class="comment">// å¦‚æœä»»åŠ¡å‘å¸ƒè‡ªå…¶ä»–å·¥äººï¼š</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (base_owner != worker_device) &#123;</span><br><span class="line">        <span class="comment">// è‡ªå‡å‰©ä½™ä»»åŠ¡æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (--task.base-&gt;outstanding_tasks == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// æé†’ä»–ä»¬é‚£ä¸ªä»»åŠ¡åšå®Œäº†</span></span><br><span class="line">          <span class="built_in">std</span>::atomic_thread_fence(<span class="built_in">std</span>::memory_order_release);</span><br><span class="line">          ready_queue(base_owner).push(FunctionTask(task.base, <span class="literal">nullptr</span>, InputBuffer(<span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>thread_main()</code> é‡Œæ²¡æœ‰å…·ä½“æ‰§è¡Œä»»åŠ¡çš„ä»£ç ï¼Œè€Œæ˜¯æŠŠå®ƒå•ç‹¬æŠ½å‡ºå˜æˆä¸€ä¸ªæ–¹æ³•ï¼Œä¸‹é¢çœ‹è¯¥æ–¹æ³•éƒ½å¹²äº†ä»€ä¹ˆï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> Engine::evaluate_function(FunctionTask&amp; task) -&gt; <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">/* exec info blabla... */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è°ƒç”¨ task é‡Œçš„å‡½æ•°è·å–è¾“å‡ºï¼ŒåŸºæœ¬ç›¸å½“äº (*task.fn)()</span></span><br><span class="line">  <span class="keyword">auto</span> outputs = call_function(task);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span>&amp; fn = *task.fn;</span><br><span class="line">  <span class="comment">// å¦‚æœä¸ä¿ç•™å›¾çš„è¯å°±æŠŠå½“å‰èŠ‚ç‚¹é‡Šæ”¾äº†</span></span><br><span class="line">  <span class="keyword">if</span> (!task.base-&gt;keep_graph) &#123;</span><br><span class="line">    fn.release_variables();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–è¾“å‡ºä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">int</span> num_outputs = outputs.size();</span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰è¾“å‡ºè¿™ä¸ªä»»åŠ¡å°±å®Œæˆäº†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (num_outputs == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(task.base-&gt;mutex);</span><br><span class="line">  <span class="comment">// éå†æ¯ä¸ªè¾“å‡ºï¼ˆéå†ä¸ä¹‹ç›¸é‚»çš„èŠ‚ç‚¹ï¼‰ï¼š</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num_outputs; ++i) &#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; output = outputs[i];</span><br><span class="line">    <span class="comment">// è·å–ç¬¬iæ¡è¾¹ï¼ˆæŒ‡å‘ç¬¬iä¸ªè¾“å‡ºæ‰€å¯¹åº”çš„å‡½æ•°ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; next = fn.next_edge(i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!next.is_valid()) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¿™æ¡è¾¹æ˜¯å¦å‡†å¤‡å¥½ï¼ˆä¾èµ–æ˜¯å¦ä¸º0ï¼‰</span></span><br><span class="line">    <span class="keyword">bool</span> is_ready = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">auto</span>&amp; dependencies = task.base-&gt;dependencies;</span><br><span class="line">    <span class="comment">// è·å–è¿™æ¡è¾¹çš„ä¾èµ–æ•°</span></span><br><span class="line">    <span class="keyword">auto</span> it = dependencies.find(next.function.get());</span><br><span class="line">    <span class="keyword">if</span> (it == dependencies.end()) &#123;</span><br><span class="line">      <span class="comment">/* æ²¡æ‰¾åˆ°ï¼ŒæŠ›å‡ºå¼‚å¸¸ */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (--it-&gt;second == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// ä¾èµ–è‡ªå‡åç­‰äºé›¶ï¼Œè¯´æ˜è¯¥ä»»åŠ¡å·²å‡†å¤‡å¥½</span></span><br><span class="line">      dependencies.erase(it);</span><br><span class="line">      is_ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–/åˆ›å»ºè¯¥èŠ‚ç‚¹çš„ input_buffer</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; not_ready = task.base-&gt;not_ready;</span><br><span class="line">    <span class="keyword">auto</span> not_ready_it = not_ready.find(next.function.get());</span><br><span class="line">    <span class="comment">// è¿˜æ²¡æœ‰ä¸ºè¯¥èŠ‚ç‚¹åˆ†é… input_buffer:</span></span><br><span class="line">    <span class="keyword">if</span> (not_ready_it == not_ready.end()) &#123;</span><br><span class="line">      <span class="comment">/* è·³è¿‡é‚£äº›ä¸è¯¥è¢«æ‰§è¡Œçš„å‡½æ•° */</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ç”¨ output æ„é€ è¯¥èŠ‚ç‚¹çš„ input_buffer</span></span><br><span class="line">      <span class="function">InputBuffer <span class="title">input_buffer</span><span class="params">(next.function-&gt;num_inputs())</span></span>;</span><br><span class="line">      input_buffer.add(next.input_nr, <span class="built_in">std</span>::move(output));</span><br><span class="line">      <span class="keyword">if</span> (is_ready) &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡å¥½å°±åŠ å…¥å‡†å¤‡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">auto</span>&amp; <span class="built_in">queue</span> = ready_queue(input_buffer.device());</span><br><span class="line">        <span class="built_in">queue</span>.push(FunctionTask(task.base, next.function, <span class="built_in">std</span>::move(input_buffer)));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡å‡†å¤‡å¥½å°±ç¼“å­˜ input_buffer</span></span><br><span class="line">        not_ready.emplace(next.function.get(), <span class="built_in">std</span>::move(input_buffer));</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">// è¯¥èŠ‚ç‚¹å·²æœ‰ input_buffer:</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å‘å·²æœ‰ input_buffer é‡Œæ·»åŠ æ–°çš„è¾“å…¥</span></span><br><span class="line">      <span class="keyword">auto</span> &amp;input_buffer = not_ready_it-&gt;second;</span><br><span class="line">      input_buffer.add(next.input_nr, <span class="built_in">std</span>::move(output));</span><br><span class="line">      <span class="keyword">if</span> (is_ready) &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡å¥½å°±åŠ å…¥å‡†å¤‡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">auto</span>&amp; <span class="built_in">queue</span> = ready_queue(input_buffer.device());</span><br><span class="line">        <span class="built_in">queue</span>.push(FunctionTask(task.base, next.function, <span class="built_in">std</span>::move(input_buffer)));</span><br><span class="line">        <span class="comment">// ä»è¾“å…¥ç¼“å­˜é‡Œåˆ é™¤è¯¥èŠ‚ç‚¹</span></span><br><span class="line">        not_ready.erase(not_ready_it);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½ï¼Œè‡³æ­¤æ‰§è¡Œè®¡ç®—å›¾çš„ä»£ç å°±æ¢³ç†å®Œäº†ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li>æŠŠè°ƒç”¨ <code>backward()</code> çš„èŠ‚ç‚¹è®¾ä¸ºæ ¹èŠ‚ç‚¹ï¼Œä»è¯¥èŠ‚ç‚¹å¼€å§‹éå†</li><li>é¦–å…ˆBFSä¸€éè®¡ç®—å›¾ï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ä¾èµ–</li><li>ä¸ºæ¯ä¸ªè®¾å¤‡å»ºç«‹ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹é‡Œæœ‰ä¸€ä¸ªå‡†å¤‡é˜Ÿåˆ—<ul><li>æ¯ä¸ªçº¿ç¨‹ç­‰å¾…ä»»åŠ¡åˆ°æ¥ç›´åˆ°ä»»åŠ¡å…¨éƒ¨å®Œæˆ</li><li>å®Œæˆä¸€ä¸ªä»»åŠ¡åéå†ä¸ä¹‹ç›¸é‚»çš„èŠ‚ç‚¹ï¼Œæ›´æ–°ä»–ä»¬çš„ä¾èµ–(-1)ï¼Œè‹¥ä¾èµ–ä¸º0åˆ™åŠ å…¥å‡†å¤‡é˜Ÿåˆ—</li></ul></li></ul><h2><span id="åŠ¨æ€å»ºç«‹è®¡ç®—å›¾">åŠ¨æ€å»ºç«‹è®¡ç®—å›¾</span></h2><p>è¿™ä¸€å°èŠ‚ä»‹ç» PyTorch æ˜¯æ€ä¹ˆå»ºç«‹ç”¨äºåå‘ä¼ æ’­çš„è®¡ç®—å›¾çš„ã€‚æ ¹æ®å‰é¢çš„åˆ†æï¼Œè®¡ç®—å›¾ä¸€å®šæ˜¯åœ¨å®šä¹‰å‰å‘ä¼ æ’­æ˜¯å»ºç«‹çš„ï¼Œé‚£ä¹ˆæœºå¯†ä¸€å®šæ˜¯è—åœ¨å‰å‘ä¼ æ’­APIé‡Œäº†ï¼Œè¿™ä¸ªçŒœæƒ³æ˜¯æ²¡é”™ï¼Œä½†æ˜¯ç”±äº ATen å¤æ‚çš„åŠ¨æ€æ´¾å‘æœºåˆ¶ä»¥åŠä½¿ç”¨è„šæœ¬ç”Ÿæˆä»£ç ï¼Œæˆ‘ä¹Ÿæ˜¯è´¹äº†ä¹ç‰›äºŒè™ä¹‹åŠ›æ‰æ‰¾åˆ°å…·ä½“å®ç°ä»¥åŠç†è§£å…¶ä¸­çš„é€»è¾‘ã€‚</p><p>ç¥ç»ç½‘ç»œçš„å…·ä½“è®¡ç®—ï¼šæ¯ä¸€å±‚çš„å‰å‘å’Œåå‘ä¼ æ’­ï¼Œå…¶å®éƒ½æ˜¯åœ¨ ATen é‡Œå®ç°çš„ï¼Œä½†å›å»çœ‹ ATen çš„APIå®ç°ï¼Œå¹¶æ²¡æœ‰å‘ç°å…¶ä¸­æœ‰ä»»ä½•å»ºç«‹è®¡ç®—å›¾çš„ä»£ç ã€‚è¿™å…¶ä¸­çš„æœºå¯†å®é™…åœ¨ <code>tools/autograd</code> ç›®å½•é‡Œã€‚è¿™ä¸ªç›®å½•é‡Œæœ‰ <code>derivatives.yaml</code> å’Œç”¨äºç”Ÿæˆä»£ç çš„è„šæœ¬ï¼Œå‰è€…è®°å½•äº†æ‰€æœ‰éœ€è¦è‡ªåŠ¨å¾®åˆ†çš„ATen APIï¼Œåè€…ä¸ºå®ƒä»¬ç”Ÿæˆä¸€å±‚wrapperä»£ç ï¼Œè¿™äº›ä»£ç ä¸»è¦å¹²ä¸¤ä»¶äº‹ï¼š</p><ul><li>æŠŠATençš„åå‘ä¼ æ’­APIè½¬æ¢æˆ <code>Function</code></li><li>åœ¨ATençš„æ­£å‘ä¼ æ’­APIä¸­åŠ å…¥å»ºå›¾è¿‡ç¨‹</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>derivatives.yaml</code> ç¬¬119è¡Œçš„ <code>addcmul()</code> APIï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">addcmul(Tensor</span> <span class="string">self,</span> <span class="string">Tensor</span> <span class="string">tensor1,</span> <span class="string">Tensor</span> <span class="string">tensor2,</span> <span class="string">*,</span> <span class="string">Scalar</span> <span class="string">value)</span></span><br><span class="line"><span class="attr">  self:</span> <span class="string">grad</span></span><br><span class="line"><span class="attr">  tensor1:</span> <span class="string">grad</span> <span class="string">*</span> <span class="string">tensor2</span> <span class="string">*</span> <span class="string">value</span></span><br><span class="line"><span class="attr">  tensor2:</span> <span class="string">grad</span> <span class="string">*</span> <span class="string">tensor1</span> <span class="string">*</span> <span class="string">value</span></span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‡æ˜äº†å‡½æ•°åã€å‚æ•°ã€åå‘è®¡ç®—æ–¹æ³•ã€‚æ‰§è¡Œ <code>gen_autograd.py</code> å¯ä»¥è‡ªåŠ¨ä¸ºå…¶ç”Ÿæˆä»£ç ï¼Œç”Ÿæˆçš„ä»£ç åœ¨ <code>torch/csrc/autograd/generated</code> ä¸­ï¼Œæœ‰å…³ <code>addcmul()</code> çš„å‰å‘ä¼ æ’­çš„ä»£ç åœ¨ <code>VariableType0.cpp</code> ä¸­ï¼Œ åå‘ä¼ æ’­çš„ä»£ç åœ¨ <code>Functions.h</code> å’Œ <code>Functionss.cpp</code> ä¸­ã€‚</p><p><strong>å‰å‘ä¼ æ’­</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Tensor VariableType::addcmul(<span class="keyword">const</span> Tensor &amp; self, <span class="keyword">const</span> Tensor &amp; tensor1, <span class="keyword">const</span> Tensor &amp; tensor2, Scalar value) <span class="keyword">const</span> </span><br><span class="line">&#123;</span><br><span class="line">  profiler::<span class="function">RecordFunction <span class="title">profiler</span><span class="params">(<span class="string">"addcmul"</span>, Function::peek_at_next_sequence_nr())</span></span>;</span><br><span class="line">  <span class="comment">// è·å–è¾“å…¥</span></span><br><span class="line">  <span class="keyword">auto</span>&amp; self_ = unpack(self, <span class="string">"self"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">auto</span>&amp; tensor1_ = unpack(tensor1, <span class="string">"tensor1"</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">auto</span>&amp; tensor2_ = unpack(tensor2, <span class="string">"tensor2"</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;AddcmulBackward&gt; grad_fn;</span><br><span class="line">  <span class="keyword">if</span> (compute_requires_grad( self, tensor1, tensor2 )) &#123;</span><br><span class="line">    <span class="comment">// å»ºç«‹åå‘ä¼ æ’­èŠ‚ç‚¹ AddcmulBackward</span></span><br><span class="line">    grad_fn = <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;AddcmulBackward&gt;(<span class="keyword">new</span> AddcmulBackward(), deleteFunction);</span><br><span class="line">    <span class="comment">// æ–°å»ºè¾¹æŒ‡å‘ä¸ self, tensor1, tensor2 ç»‘å®šçš„èŠ‚ç‚¹</span></span><br><span class="line">    grad_fn-&gt;set_next_edges(collect_next_edges(self, tensor1, </span><br><span class="line">                                               tensor2));</span><br><span class="line">    <span class="keyword">if</span> (grad_fn-&gt;should_compute_output(<span class="number">1</span>)) &#123;</span><br><span class="line">      grad_fn-&gt;tensor2_ = SavedVariable(tensor2, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    grad_fn-&gt;value = value;</span><br><span class="line">    <span class="keyword">if</span> (grad_fn-&gt;should_compute_output(<span class="number">2</span>)) &#123;</span><br><span class="line">      grad_fn-&gt;tensor1_ = SavedVariable(tensor1, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è°ƒç”¨ ATen API è¿›è¡Œå®é™…è®¡ç®—</span></span><br><span class="line">  <span class="keyword">auto</span> tmp = ([&amp;]() &#123;</span><br><span class="line">    at::AutoNonVariableTypeMode non_var_type_mode(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> baseType-&gt;addcmul(self_, tensor1_, tensor2_, value);</span><br><span class="line">  &#125;)();</span><br><span class="line">  <span class="keyword">auto</span> result = as_variable(tmp);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æŠŠ grad_fn ä¸è¾“å‡ºç»‘å®š</span></span><br><span class="line">  set_history(flatten_tensor_args(result), grad_fn);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯å‰å‘è®¡ç®—çš„APIï¼Œåœ¨å…·ä½“è®¡ç®—ä¹‹å‰å…ˆå»ºç«‹åå‘ä¼ æ’­å‡½æ•°ï¼ˆèŠ‚ç‚¹ï¼‰ï¼Œå¹¶ä¸”æŠŠè¯¥èŠ‚ç‚¹ä¸<strong>è¾“å…¥</strong>çš„èŠ‚ç‚¹ç›¸è¿ï¼›ç„¶åè°ƒç”¨ä¸‹å±‚APIè®¡ç®—ç»“æœï¼›æœ€åæŠŠç»“æœå’Œæ–°å»ºç«‹çš„èŠ‚ç‚¹ç»‘å®šï¼Œè¿™æ ·ç”¨äºåå‘ä¼ æ’­çš„è®¡ç®—å›¾å°±å»ºç«‹å®Œæˆäº†ã€‚ç”±äºè¿™æ˜¯åå‘ä¼ æ’­è®¡ç®—å›¾ï¼Œæ‰€ä»¥å‰å‘ä¼ æ’­ä¸­çš„è¾“å…¥èŠ‚ç‚¹å˜æˆåå‘çš„è¾“å‡ºï¼Œå‰å‘çš„è¾“å‡ºèŠ‚ç‚¹å˜æˆåå‘çš„è¾“å…¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/images/pytorch/addcmul.png"></p><p><strong>åå‘ä¼ æ’­</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜åœ¨ Functions.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AddcmulBackward</span> :</span> <span class="keyword">public</span> TraceableFunction &#123;</span><br><span class="line">  <span class="keyword">using</span> TraceableFunction::TraceableFunction;</span><br><span class="line">  <span class="function">variable_list <span class="title">apply</span><span class="params">(variable_list&amp;&amp; grads)</span> override</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">name</span><span class="params">()</span> <span class="keyword">const</span> override </span>&#123; <span class="keyword">return</span> <span class="string">"AddcmulBackward"</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">release_variables</span><span class="params">()</span> override </span>&#123;</span><br><span class="line">    tensor2_.reset_data();</span><br><span class="line">    tensor2_.reset_grad_function();</span><br><span class="line">    tensor1_.reset_data();</span><br><span class="line">    tensor1_.reset_grad_function();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SavedVariable tensor2_;</span><br><span class="line">  Scalar value;</span><br><span class="line">  SavedVariable tensor1_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°åœ¨ Functions.cpp</span></span><br><span class="line"><span class="comment">// é‡è½½ Function::apply å®ç°æ¢¯åº¦è®¡ç®—</span></span><br><span class="line">variable_list AddcmulBackward::apply(variable_list&amp;&amp; grads) &#123;</span><br><span class="line">  IndexRangeGenerator gen;</span><br><span class="line">  <span class="keyword">auto</span> self_ix = gen.range(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">auto</span> tensor1_ix = gen.range(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">auto</span> tensor2_ix = gen.range(<span class="number">1</span>);</span><br><span class="line">  <span class="function">variable_list <span class="title">grad_inputs</span><span class="params">(gen.size())</span></span>;</span><br><span class="line">  <span class="keyword">auto</span>&amp; grad = grads[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">auto</span> tensor2 = tensor2_.unpack();</span><br><span class="line">  <span class="keyword">auto</span> tensor1 = tensor1_.unpack();</span><br><span class="line">  <span class="comment">// è®¡ç®—æ¢¯åº¦ï¼Œä¸ derivatives.yaml ä¸­çš„å®šä¹‰ç›¸åŒ</span></span><br><span class="line">  <span class="keyword">if</span> (should_compute_output(&#123; self_ix &#125;)) &#123;</span><br><span class="line">    <span class="keyword">auto</span> grad_result = grad;</span><br><span class="line">    copy_range(grad_inputs, self_ix, grad_result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (should_compute_output(&#123; tensor1_ix &#125;)) &#123;</span><br><span class="line">    <span class="keyword">auto</span> grad_result = grad * tensor2 * value;</span><br><span class="line">    copy_range(grad_inputs, tensor1_ix, grad_result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (should_compute_output(&#123; tensor2_ix &#125;)) &#123;</span><br><span class="line">    <span class="keyword">auto</span> grad_result = grad * tensor1 * value;</span><br><span class="line">    copy_range(grad_inputs, tensor2_ix, grad_result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> grad_inputs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™äº›ä»£ç ç¡®ç¡®å®å®æŠŠ ATen API è½¬æ¢æˆäº†è®¡ç®—å›¾èŠ‚ç‚¹ <code>Function</code>ã€‚</p><p><strong>åŠ¨æ€æ´¾å‘</strong></p><p>æœ€åè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä»£ç ä¸­è°ƒç”¨çš„APIæ˜¯ <code>torch.addcmul()</code> æˆ– <code>variable.addcmul()</code> æ€ä¹ˆå°±ä¼šæ‰§è¡Œåˆ°ä¸Šé¢çš„ <code>VariableType::addcmul()</code> å‘¢ï¼Ÿè¿™å°±è¦å½’åŠŸäº ATen çš„åŠ¨æ€æ´¾å‘äº†ï¼Œä»¥ç¬¬äºŒç§è°ƒç”¨ä¸¾ä¾‹åˆ†æä¸€ä¸‹ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ä¸€ä¸ª<code>Variable</code>ç±»å‹å˜é‡è°ƒç”¨<code>addcmul()</code>ã€‚</p><p>é¦–å…ˆï¼Œä¸Šä¸€ç¯‡è¯´è¿‡ï¼ŒATen çš„APIéƒ½è®°å½•åœ¨<code>ATen/native/native_functions.yaml</code>é‡Œï¼Œè¿™äº›APIå¦‚æœæœ‰ç”Ÿæˆ method çš„éœ€æ±‚çš„è¯ï¼Œä¼šæŠŠå£°æ˜é€šè¿‡è„šæœ¬è‡ªåŠ¨æ·»åŠ åˆ° <code>at::Tensor</code> ç±»é‡Œï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ <code>tensor.addcmul()</code> è°ƒç”¨è¯¥APIï¼Œè€Œ <code>Variable</code> ç»§æ‰¿è‡ª <code>at::Tensor</code>ï¼Œè‡ªç„¶ä¹Ÿå°±æ‹¥æœ‰äº†è¯¥æ–¹æ³•ã€‚</p><p>ä½†è¿™è¿˜æ²¡å®Œï¼Œå¦‚æœæŸ¥çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¼šå‘ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> Tensor Tensor::addcmul(<span class="keyword">const</span> Tensor &amp; tensor1, <span class="keyword">const</span> Tensor &amp; tensor2, Scalar value) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> type().addcmul(*<span class="keyword">this</span>, tensor1, tensor2, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒè°ƒç”¨äº† <code>type()</code> çš„ç›¸åº”æ–¹æ³•ï¼Œè¿™ä¸ª <code>type()</code> è¿”å›çš„æ˜¯ <code>Type</code> ç±»å‹çš„å®ä¾‹ã€‚<code>Type</code> ç±»å‹åŒæ ·å£°æ˜äº†æ‰€æœ‰ ATen APIï¼Œå¹¶ä¸”æœ‰ <code>TensorType</code> å’Œ <code>VariableType</code> ç»§æ‰¿è‡ªå®ƒã€‚æ ¹æ®ATençš„åŠ¨æ€æ´¾å‘æœºåˆ¶ï¼Œå¦‚æœè°ƒç”¨è€…æ˜¯ <code>Tensor</code> çš„è¯ï¼Œå¹¶ä¸”<code>is_variable == False</code>ï¼Œå°±ä¼šè¿”å› <code>TensorType</code> å®ä¾‹ï¼›å¦‚æœè°ƒç”¨è€…æ˜¯ <code>Variable</code> çš„è¯ï¼Œæˆ–è€…<code>is_variable == True</code>ï¼Œå°±ä¼šè¿”å›ä¸Šè¿°çš„ <code>VariableType</code> å®ä¾‹ã€‚æ‰€ä»¥ä¸€ä¸ª<code>Variable</code>ç±»å‹çš„å˜é‡è°ƒç”¨ <code>addcmul()</code> çš„è¯å®é™…ä¼šæ‰§è¡Œ <code>VariableType::addcmul()</code>ã€‚</p><p>ã¤ã¥ã</p><table><thead><tr class="header"><th style="text-align: left;">ä¸Šä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch3/">NN</a></th><th style="text-align: right;">ä¸‹ä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch5/">Pythonæ‰©å±•</a></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"></td><td style="text-align: right;"></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡åšå®¢ä»‹ç» PyTorch ä¸­è‡ªåŠ¨å¾®åˆ†å¼•æ“çš„å®ç°ï¼Œä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šé¦–å…ˆç®€è¦ä»‹ç»ä¸€ä¸‹è®¡ç®—å›¾çš„åŸç†ï¼›ç„¶åä»‹ç» PyTorch ä¸­ä¸ autograd çš„ç›¸å…³æ•°æ®ç»“æ„å’Œ &lt;code&gt;backward()&lt;/code&gt; å‡½æ•°çš„å®ç°ï¼Œæ•°æ®ç»“æ„åŒ…æ‹¬ &lt;code&gt;torch::autograd::Variable&lt;/code&gt;, &lt;code&gt;torch::autograd::Function&lt;/code&gt; ç­‰ï¼›æœ€åè®²ä¸€ä¸‹åŠ¨æ€å»ºç«‹è®¡ç®—å›¾çš„å®ç°ï¼Œè¿™éƒ¨åˆ†ä»£ç æ¶‰åŠåˆ°åŠ¨æ€æ´¾å‘æœºåˆ¶ï¼Œè€Œä¸”éƒ½æ˜¯ç”¨è„šæœ¬ç”Ÿæˆçš„ï¼Œä¸å¤ªå®¹æ˜“ç†è§£ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="PyTorch" scheme="http://www.52coding.com.cn/tags/PyTorch/"/>
    
      <category term="Autograd" scheme="http://www.52coding.com.cn/tags/Autograd/"/>
    
      <category term="è‡ªåŠ¨å¾®åˆ†å¼•æ“" scheme="http://www.52coding.com.cn/tags/%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86%E5%BC%95%E6%93%8E/"/>
    
      <category term="Variable" scheme="http://www.52coding.com.cn/tags/Variable/"/>
    
  </entry>
  
  <entry>
    <title>PyTorchæºç æµ…æ(3)ï¼šNN</title>
    <link href="http://www.52coding.com.cn/2019/05/05/PyTorch3/"/>
    <id>http://www.52coding.com.cn/2019/05/05/PyTorch3/</id>
    <published>2019-05-05T07:55:01.000Z</published>
    <updated>2019-05-05T08:07:04.555Z</updated>
    
    <content type="html"><![CDATA[<p>THNNæ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€å®ç°çš„ç¥ç»ç½‘ç»œæ¨¡å—çš„åº“ï¼Œæä¾›çš„åŠŸèƒ½éå¸¸åº•å±‚ã€‚å®ƒå®ç°äº†è®¸å¤šåŸºç¡€çš„ç¥ç»ç½‘ç»œæ¨¡å—ï¼ŒåŒ…æ‹¬çº¿æ€§å±‚ï¼Œå·ç§¯å±‚ï¼ŒSigmoidç­‰å„ç§æ¿€æ´»å±‚ï¼Œä¸€äº›åŸºæœ¬çš„losså‡½æ•°ï¼Œè¿™äº›APIéƒ½å£°æ˜åœ¨<code>THNN/generic/THNN.h</code>ä¸­ã€‚æ¯ä¸ªæ¨¡å—éƒ½å®ç°äº†å‰å‘ä¼ å¯¼ï¼ˆforwardï¼‰å’Œåå‘ä¼ å¯¼ï¼ˆbackwardï¼‰çš„åŠŸèƒ½ã€‚THCUNNåˆ™æ˜¯å¯¹åº”æ¨¡å—çš„CUDAå®ç°ã€‚</p><a id="more"></a><!-- toc --><ul><li><a href="#thnn-thcunn">THNN &amp; THCUNN</a><ul><li><a href="#tanh">Tanh</a></li><li><a href="#2d-convolution">2D Convolution</a><ul><li><a href="#å‰å‘ä¼ æ’­">å‰å‘ä¼ æ’­</a></li><li><a href="#åå‘ä¼ æ’­">åå‘ä¼ æ’­</a></li></ul></li></ul></li><li><a href="#aten">ATen</a></li></ul><!-- tocstop --><h2><span id="thnn-amp-thcunn">THNN &amp; THCUNN</span></h2><p>æˆ‘ä»¬é€šè¿‡å‡ ä¸ªä¾‹å­å…·ä½“çœ‹ä¸€ä¸‹å‡ ç§æ¨¡å—æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><h3><span id="tanh">Tanh</span></h3><p>é¦–å…ˆä»æœ€ç®€å•çš„æ¿€æ´»å±‚å¼€å§‹çœ‹ï¼Œä»¥ <span class="math inline">\(\tanhâ€‹\)</span> ä¸ºä»£è¡¨ï¼Œä»£ç åœ¨ <code>THNN/generic/Tanh.c</code>ã€‚è¿™ä¸ªæ¨¡å—åªæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ <code>THNN_(Tanh_updateOutput)()</code> å’Œ <code>THNN_(Tanh_updateGradInput)()</code>ï¼Œå…¶ä¸­å‰è€…å®ç°äº†å‰å‘ä¼ æ’­ï¼Œåè€…å®ç°äº†åå‘ä¼ æ’­ã€‚æ³¨æ„åˆ°å‡½æ•°çš„å‘½åæ–¹å¼ï¼Œä¾æ—§æ˜¯ä½¿ç”¨å®å®ç°èŒƒå¼ï¼Œ<code>THNN_</code> æ˜¯å®å®šä¹‰ï¼Œ<code>Tanh_</code>æ˜¯å…·ä½“æ¨¡å—åï¼Œ<code>updateOutput</code> è¡¨ç¤ºå‰å‘ä¼ æ’­ï¼Œ<code>updateGradInput</code>è¡¨ç¤ºåå‘ä¼ æ’­ï¼Œä¸ä¹‹å‰ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œåªéœ€ç”Ÿæˆæµ®ç‚¹ç±»å‹ï¼ˆ <code>float</code> å’Œ <code>double</code> ï¼‰çš„å®ç°å³å¯ã€‚</p><p>å‰å‘ä¼ æ’­çš„å®ç°å¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨ä¹‹å‰å®ç°çš„tanhå‡½æ•°å°±è¡Œäº†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THNN_</span><span class="params">(Tanh_updateOutput)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          THNNState *state,</span></span></span><br><span class="line"><span class="function"><span class="params">          THTensor *input,</span></span></span><br><span class="line"><span class="function"><span class="params">          THTensor *output)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  THTensor_(<span class="built_in">tanh</span>)(output, input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯THNNçŠ¶æ€ï¼ˆæš‚ä¸çŸ¥æœ‰ä½•ç”¨ï¼‰ï¼Œæœ¬å±‚çš„è¾“å…¥ï¼ˆ<code>input</code>ï¼‰å’Œæœ¬å±‚çš„è¾“å‡ºï¼ˆ<code>output</code>ï¼‰ï¼Œè¾“å‡ºå­˜å‚¨åœ¨<code>output</code>å‚æ•°ä¸­ã€‚</p><p>åå‘ä¼ æ’­çš„å®ç°ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THNN_</span><span class="params">(Tanh_updateGradInput)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          THNNState *state,</span></span></span><br><span class="line"><span class="function"><span class="params">          THTensor *gradOutput,</span></span></span><br><span class="line"><span class="function"><span class="params">          THTensor *gradInput,</span></span></span><br><span class="line"><span class="function"><span class="params">          THTensor *output)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  THNN_CHECK_SHAPE(output, gradOutput);</span><br><span class="line">  THTensor_(resizeAs)(gradInput, output);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* output, gradInput, å’Œ gradOutput çš„å†…å­˜æ˜¯è¿ç»­çš„ */</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    TH_TENSOR_APPLY3(<span class="keyword">scalar_t</span>, gradInput, <span class="keyword">scalar_t</span>, gradOutput,</span><br><span class="line">                     <span class="keyword">scalar_t</span>, output,</span><br><span class="line">      <span class="keyword">scalar_t</span> z = *output_data;            \</span><br><span class="line">      *gradInput_data = *gradOutput_data * (<span class="number">1.</span> - z*z);</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">scalar_t</span>* ptr_gradOutput = gradOutput-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;();</span><br><span class="line">    <span class="keyword">scalar_t</span>* ptr_gradInput  = gradInput-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;();</span><br><span class="line">    <span class="keyword">scalar_t</span>* ptr_output     = output-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;();</span><br><span class="line">    <span class="keyword">int64_t</span> i;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for private(i)</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; THTensor_(nElement)(gradInput); i++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">scalar_t</span> z = ptr_output[i];</span><br><span class="line">      ptr_gradInput[i] = ptr_gradOutput[i] * (<span class="number">1.</span> - z*z);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åå‘ä¼ æ’­æ¥æ”¶5ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯THNNçŠ¶æ€ï¼Œä»åé¢ä¼ å›æ¥çš„æ¢¯åº¦ï¼ˆ<code>gradOutput</code>ï¼‰ï¼Œæœ¬å±‚å¾€å›ä¼ çš„æ¢¯åº¦ï¼ˆ<code>gradInput</code>ï¼‰ï¼Œæœ¬å±‚å‰å‘ä¼ æ’­çš„è¾“å‡ºï¼ˆ<code>output</code>ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°è®¡ç®—çš„æ˜¯æœ¬å±‚çš„æ¢¯åº¦ï¼Œç„¶åå­˜å‚¨åœ¨<code>gradInput</code>ä¸­ã€‚</p><p><span class="math inline">\(\tanh\)</span> çš„å¯¼æ•°ä¸ºï¼š <span class="math display">\[f(z) = \tanh(z)\\f&#39;(z) = 1 - (f(z))^2\]</span> å…¶ä¸­ï¼Œ<span class="math inline">\(f(z)â€‹\)</span> å°±æ˜¯å‰å‘ä¼ æ’­æ—¶æœ¬å±‚çš„è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯ <code>output</code> å‚æ•°ï¼ˆå¾ªç¯é‡Œçš„<code>z</code>ï¼‰ï¼Œæ ¹æ®é“¾å¼æ³•åˆ™ï¼Œå†ä¹˜ä»¥åé¢å±‚ä¼ å›æ¥çš„æ¢¯åº¦ï¼ˆ<code>gradOutput</code>ï¼‰å°±æ˜¯æœ¬å±‚åº”è¯¥å¾€å›ä¼ çš„æ¢¯åº¦äº†ï¼ˆç›¸å¯¹äºæœ¬å±‚è¾“å…¥çš„æ¢¯åº¦ï¼‰ï¼Œæ‰€ä»¥å¾ªç¯é‡Œçš„ä»£ç ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*gradInput_data = *gradOutput_data * (<span class="number">1.</span> - z*z);</span><br></pre></td></tr></table></figure><p>æ³¨ï¼š<code>_data</code> åç¼€è¡¨ç¤ºæ•°æ®æŒ‡é’ˆï¼Œå…·ä½“å¯ä»¥çœ‹<a href="æ­¤å¤„åº”è¯¥åŠ ç¬¬ä¸€ç¯‡çš„é“¾æ¥">Applyå®</a>çš„å®ç°ã€‚</p><h3><span id="2d-convolution">2D Convolution</span></h3><p>æœ€æ™®é€šçš„2Då·ç§¯ï¼ŒCPUå®ç°åœ¨<code>THNN/generic/SpatialConvolutionMM.c</code>ï¼ŒCUDAå®ç°åœ¨<code>THCUNN/generic/SpatialConvolutionMM.cu</code>ï¼Œå¤§ä½“çš„ç®—æ³•æ˜¯æŠŠè¾“å…¥å±•å¼€æˆä¸€ä¸ªç‰¹æ®Šçš„çŸ©é˜µï¼Œç„¶åæŠŠå·ç§¯è½¬åŒ–ä¸ºçŸ©é˜µç›¸ä¹˜ï¼ˆMM = Matrix Multiplicationï¼‰ã€‚æ¨¡å—é‡Œä¸»è¦åŒ…å«ä¸‰ä¸ªå‡½æ•°ï¼Œå‰å‘ä¼ æ’­ï¼ˆ<code>THNN_(SpatialConvolutionMM_updateOutput)()</code>ï¼‰ï¼Œåå‘ä¼ æ’­ï¼ˆ<code>THNN_(SpatialConvolutionMM_updateGradInput)()</code>ï¼‰ï¼Œå’Œæ›´æ–°å±‚å†…å‚æ•°ï¼ˆ<code>THNN_(SpatialConvolutionMM_accGradParameters)()</code>ï¼‰ã€‚</p><h4><span id="å‰å‘ä¼ æ’­">å‰å‘ä¼ æ’­</span></h4><p>PyTorchå®ç°å·ç§¯çš„åšæ³•æ˜¯ç”¨im2colç®—æ³•æŠŠè¾“å…¥å±•å¼€æˆä¸€ä¸ªå¤§çŸ©é˜µï¼Œç„¶åç”¨kernelä¹˜ä»¥è¿™ä¸ªå¤§çŸ©é˜µï¼Œå°±å¾—äº†å·ç§¯çš„ç»“æœã€‚è¿™é‡Œä¸å…·ä½“ä»‹ç»im2colç®—æ³•æ˜¯æ€ä¹ˆåšçš„ï¼Œä½†ä¼šè§£é‡Šä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆåšã€‚</p><p>é¦–å…ˆå®šä¹‰ç¬¦å·ï¼Œä¸ºäº†å’Œä»£ç ä¸­çš„ç¬¦å·ä¸€è‡´ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸‹updateOutputçš„å£°æ˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THNN_</span><span class="params">(SpatialConvolutionMM_updateOutput)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           THCState *state,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *input,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *output,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *weight,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *bias,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *columns,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *ones,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> kW, <span class="keyword">int</span> kH,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> dW, <span class="keyword">int</span> dH,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> padW, <span class="keyword">int</span> padH)</span></span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ</p><ul><li><code>input</code> æ˜¯è¾“å…¥çš„4D Tensorï¼Œå¤§å°ä¸º <span class="math inline">\(\text{batch}\times\text{nInputPlane}\times\text{inputHeight}\times\text{inputWidth}\)</span>ï¼Œbatchç»´ä¹Ÿå¯ä»¥æ²¡æœ‰ï¼Œå°±å˜ä¸º3D Tensorï¼›</li><li><code>output</code> æ˜¯è¾“å‡ºçš„4Dæˆ–3D Tensorï¼Œå¤§å°ä¸º <span class="math inline">\(\text{batch}\times\text{nOutputPlane}\times\text{outputHeight}\times\text{outputWidth}\)</span>ï¼Œå…¶ä¸­ï¼Œ</li></ul><p><span class="math display">\[\text{outputHeight}=\frac{\text{inputHeight}+2*\text{padH}-\text{kH}}{\text{dH}}+1\\\text{outputWidth}=\frac{\text{inputWidth}+2*\text{padW}-\text{kW}}{\text{dW}}+1\]</span></p><ul><li><code>weight</code> æ˜¯æƒé‡ï¼Œä¹Ÿå°±æ˜¯å·ç§¯æ ¸ï¼Œå¤§å°ä¸º <span class="math inline">\(\text{nOutputPlane}\times\text{nInputPlane}\times\text{kH}\times\text{kW}\)</span>ï¼›</li><li><code>bias</code> æ˜¯åç½®ï¼Œå¤§å°ä¸º <span class="math inline">\(\text{nOutputPlane}\times1\times1\times1\)</span>ï¼›</li><li><code>columns</code> ç”¨äºå­˜å‚¨im2colçš„ç»“æœï¼›</li><li><code>ones</code> æ˜¯ä¸€ä¸ªå€¼å…¨ä¸º1çš„çŸ©é˜µï¼Œå¤§å°ä¸º <span class="math inline">\(\text{outputHeight}\times\text{outputWidth}\)</span>ï¼Œç”¨äºè®¡ç®—åç½®ï¼›</li><li><code>kW</code> å’Œ <code>kH</code> æ˜¯å·ç§¯æ ¸ï¼ˆkernelï¼‰çš„å®½å’Œé«˜ï¼›</li><li><code>dW</code> å’Œ <code>dH</code> æ˜¯æ­¥é•¿ï¼ˆstrideï¼‰ï¼›</li><li><code>padW</code> å’Œ <code>padH</code> æ˜¯è¡¥é›¶çš„å®½å’Œé«˜ã€‚</li></ul><p>å®šä¹‰å¥½äº†ç¬¦å·ä¹‹åæ¥çœ‹ä¸€ä¸‹å·ç§¯æ˜¯æ€ä¹ˆè½¬åŒ–ä¸ºä¸€ä¸ªçŸ©é˜µä¹˜æ³•çš„ã€‚é¦–å…ˆæ¥çœ‹å·ç§¯æ˜¯æ€ä¹ˆåšçš„ï¼Œä¸‹å›¾æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå…¶ä¸­è¾“å…¥å’Œè¾“å‡ºæ·±åº¦ <span class="math inline">\(\text{nInputPlane}=\text{nOutputPlane}=1â€‹\)</span>ï¼Œå·ç§¯æ ¸å¤§å° <span class="math inline">\(\text{kH}=\text{kW}=3â€‹\)</span>ï¼Œè¾“å…¥å¤§å° <span class="math inline">\(\text{inputHeight}=\text{inputWidth}=7â€‹\)</span>ï¼Œæ­¥é•¿ <span class="math inline">\(\text{dW}=\text{dH}=2â€‹\)</span>ï¼Œè¡¥é›¶ <span class="math inline">\(\text{padW}=\text{padH}=1â€‹\)</span>ï¼Œå¯ä»¥ç®—å‡º <span class="math inline">\(\text{outputHeight}=\text{outputWidth}=3â€‹\)</span>ã€‚</p><p><img src="/images/pytorch/conv.png"></p><p>è¦æƒ³æŠŠå·ç§¯å˜æˆä¸€æ¬¡çŸ©é˜µä¹˜æ³•è¿ç®—ï¼Œå°±éœ€è¦<strong>æŠŠè¾“å…¥ä¸­æ¯ä¸ªå·ç§¯çª—å£å˜ä¸ºå•ç‹¬ä¸€åˆ—</strong>ï¼Œè¿™ä¹Ÿå°±æ˜¯im2colåšçš„äº‹æƒ…ï¼Œè§ä¸‹å›¾ï¼š</p><p><img src="/images/pytorch/im2col.png"></p><p>ä¸Šå›¾ä¸­å³è¾¹çŸ©é˜µçš„æ¯ä¸€åˆ—éƒ½æ˜¯åŸè¾“å…¥çŸ©é˜µçš„ä¸€ä¸ªå·ç§¯çª—å£ï¼Œè½¬æ¢åçš„çŸ©é˜µå¤§å°ä¸º <span class="math display">\[(\text{nInputPlane}\times\text{kH}\times\text{kW})\times(\text{outputHeight}\times\text{outputWidth})\]</span> å¾—åˆ°ä¸Šè¿°çŸ©é˜µä¹‹åï¼Œåªéœ€æŠŠkernelçš„å¤§å°ä¹Ÿresizeæˆ <span class="math display">\[(\text{nOutputPlane})\times(\text{nInputPlane}\times\text{kH}\times\text{kW})\]</span> å°±å¯ä»¥ç›´æ¥ç”¨kernelä¹˜ä»¥è¯¥çŸ©é˜µå¾—åˆ°å·ç§¯ç»“æœäº†ï¼Œè§ä¸‹å›¾ã€‚</p><p><img src="/images/pytorch/convmm.png"></p><p><strong>ä»£ç </strong>ï¼ˆCUDAç‰ˆï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THNN_</span><span class="params">(SpatialConvolutionMM_updateOutput)</span><span class="params">(<span class="comment">/* å‚æ•°åˆ—è¡¨å‰é¢æœ‰ */</span>)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* çœç•¥äº†ä¸€äº›å¸¸è§„check */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* resize å·ç§¯æ ¸ */</span></span><br><span class="line">  weight = THNN_(newViewWeightMM2d)(state, weight);</span><br><span class="line">  <span class="comment">/* å¯¹è¾“å…¥çš„ç»´åº¦è¿›è¡Œcheck */</span></span><br><span class="line">  THNN_(SpatialConvolutionMM_shapeCheck)</span><br><span class="line">       (state, input, <span class="literal">NULL</span>, weight, bias, kH, kW, dH, dW, padH, </span><br><span class="line">        padW, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> ndim = input-&gt;dim();</span><br><span class="line">  <span class="keyword">int</span> dimf = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> dimh = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> dimw = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ndim == <span class="number">4</span>) &#123;<span class="comment">/* å¦‚æœè¾“å…¥æ˜¯4Dçš„è¯ï¼Œç¬¬0ç»´æ˜¯batch size */</span></span><br><span class="line">    dimf++;</span><br><span class="line">    dimh++;</span><br><span class="line">    dimw++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è®¡ç®—è¾“å…¥è¾“å‡ºå¤§å° */</span></span><br><span class="line">  <span class="keyword">int64_t</span> nInputPlane = input-&gt;size(dimf);</span><br><span class="line">  <span class="keyword">int64_t</span> inputHeight  = input-&gt;size(dimh);</span><br><span class="line">  <span class="keyword">int64_t</span> inputWidth   = input-&gt;size(dimw);</span><br><span class="line">  <span class="keyword">int64_t</span> nOutputPlane = weight-&gt;size(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">int64_t</span> outputHeight = (inputHeight + <span class="number">2</span>*padH - kH) / dH + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int64_t</span> outputWidth  = (inputWidth + <span class="number">2</span>*padW - kW) / dW + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  input = THCTensor_(newContiguous)(state, input);</span><br><span class="line">  <span class="keyword">int</span> is_batch = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (input-&gt;dim() == <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="comment">/* å¼ºè¡ŒåŠ å…¥ batch ç»´åº¦ï¼ŒæŠŠè¾“å…¥å˜ä¸º4D Tensorï¼ˆbatch size = 1ï¼‰*/</span></span><br><span class="line">    is_batch = <span class="number">0</span>;</span><br><span class="line">    THCTensor_(resize4d)(state, input, <span class="number">1</span>, input-&gt;size(<span class="number">0</span>), </span><br><span class="line">                         input-&gt;size(<span class="number">1</span>), input-&gt;size(<span class="number">2</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è·å– batch size */</span></span><br><span class="line">  <span class="keyword">int64_t</span> batchSize = input-&gt;size(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Resize output</span></span><br><span class="line">  THCTensor_(resize4d)(state, output, batchSize, nOutputPlane,</span><br><span class="line">                       outputHeight, outputWidth);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Resize columns çŸ©é˜µ */</span></span><br><span class="line">  THCTensor_(resize2d)(state, columns, nInputPlane*kW*kH,</span><br><span class="line">                       outputHeight*outputWidth);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å®šä¹‰ buffer `ones`ï¼Œä»£ç ç•¥ */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Helpers</span></span><br><span class="line">  THCTensor *input_n = THCTensor_(<span class="keyword">new</span>)(state);</span><br><span class="line">  THCTensor *output_n = THCTensor_(<span class="keyword">new</span>)(state);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å¯¹æ¯ä¸ªbatchå•ç‹¬è®¡ç®—ï¼š */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> elt = <span class="number">0</span>; elt &lt; batchSize; elt ++) &#123;</span><br><span class="line">    <span class="comment">/* å–å‡ºå¯¹åº”batchçš„è¾“å…¥å’Œè¾“å‡ºbuffer */</span></span><br><span class="line">    <span class="comment">/* input_n = input[elt] */</span></span><br><span class="line">    THCTensor_(select)(state, input_n, input, <span class="number">0</span>, elt);</span><br><span class="line">    THCTensor_(select)(state, output_n, output, <span class="number">0</span>, elt);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é¦–å…ˆè®¡ç®—åç½® biasï¼Œå³æŠŠ bias å­˜åˆ° output_n ä¸­ */</span></span><br><span class="line">    <span class="comment">// M,N,K are dims of matrix A and B</span></span><br><span class="line">    <span class="keyword">int64_t</span> m_ = nOutputPlane;</span><br><span class="line">    <span class="keyword">int64_t</span> n_ = outputHeight * outputWidth;</span><br><span class="line">    <span class="keyword">int64_t</span> k_ = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è°ƒç”¨ GEMM è®¡ç®— output_n = 1 * ones * bias + 0 * output_n */</span></span><br><span class="line">    <span class="keyword">if</span> (bias) &#123;</span><br><span class="line">      <span class="meta">#<span class="meta-keyword">ifdef</span> THC_REAL_IS_FLOAT</span></span><br><span class="line">      THCudaBlas_Sgemm(</span><br><span class="line">      #elif defined(THC_REAL_IS_HALF)</span><br><span class="line">      THCudaBlas_Hgemm(</span><br><span class="line">      #elif defined(THC_REAL_IS_DOUBLE)</span><br><span class="line">      THCudaBlas_Dgemm(</span><br><span class="line">      #endif</span><br><span class="line">          state,</span><br><span class="line">          <span class="string">'t'</span>, <span class="string">'n'</span>,</span><br><span class="line">          n_, m_, k_,</span><br><span class="line">          ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">1</span>),</span><br><span class="line">          THCTensor_(data)(state, ones), k_,</span><br><span class="line">          THCTensor_(data)(state, bias), k_,</span><br><span class="line">          ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">0</span>),</span><br><span class="line">          THCTensor_(data)(state, output_n), n_</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/* å¦‚æœæ²¡æœ‰ bias å°±æŠŠ output_n å¡«é›¶ */</span></span><br><span class="line">      THCTensor_(zero)(state, output_n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ç”¨ im2col æŠŠè¾“å…¥ input_n è½¬åŒ–ä¸ºåˆ—çŸ©é˜µå­˜å‚¨åœ¨ columns */</span></span><br><span class="line">    im2col(</span><br><span class="line">      THCState_getCurrentStream(state),</span><br><span class="line">      THCTensor_(data)(state, input_n),</span><br><span class="line">      nInputPlane, inputHeight, inputWidth,</span><br><span class="line">      outputHeight, outputWidth,</span><br><span class="line">      kH, kW, padH, padW, dH, dW,</span><br><span class="line">      <span class="number">1</span>, <span class="number">1</span>, THCTensor_(data)(state, columns)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¥ä¸‹æ¥è®¡ç®— kernel * columns: */</span></span><br><span class="line">    <span class="keyword">int64_t</span> m = nOutputPlane;</span><br><span class="line">    <span class="keyword">int64_t</span> n = columns-&gt;size(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int64_t</span> k = nInputPlane*kH*kW;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¡ç®— output_n = 1 * weight * columns + 1 * bias */</span></span><br><span class="line">    <span class="comment">/* ä»£ç ä¸­ columns åœ¨ weight å‰é¢æ˜¯å› ä¸º GEMM å‡è®¾çŸ©é˜µæ˜¯åˆ—ä¸»åº */</span></span><br><span class="line">    #ifdef THC_REAL_IS_FLOAT</span><br><span class="line">    THCudaBlas_Sgemm(</span><br><span class="line">    #elif defined(THC_REAL_IS_HALF)</span><br><span class="line">    THCudaBlas_Hgemm(</span><br><span class="line">    #elif defined(THC_REAL_IS_DOUBLE)</span><br><span class="line">    THCudaBlas_Dgemm(</span><br><span class="line">    #endif</span><br><span class="line">        state,</span><br><span class="line">        <span class="string">'n'</span>, <span class="string">'n'</span>,</span><br><span class="line">        n, m, k,</span><br><span class="line">        ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">1</span>),</span><br><span class="line">        THCTensor_(data)(state, columns), n,</span><br><span class="line">        THCTensor_(data)(state, weight), k,</span><br><span class="line">        ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">1</span>),</span><br><span class="line">        THCTensor_(data)(state, output_n), n</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* free ä¸´æ—¶å˜é‡ input_n, output_n ç­‰ */</span></span><br><span class="line">  <span class="comment">/* resize è¾“å‡ºçŸ©é˜µï¼Œä»£ç ç•¥ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="åå‘ä¼ æ’­">åå‘ä¼ æ’­</span></h4><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å·ç§¯å±‚åå‘ä¼ æ’­çš„å…¬å¼ï¼Œè®¾ç¬¬ <span class="math inline">\(l\)</span> å±‚çš„è¾“å…¥ä¸º <span class="math inline">\(a^{l-1}\)</span>ï¼Œå·ç§¯æ ¸ä¸º <span class="math inline">\(W\)</span>ï¼Œåç½®ä¸º <span class="math inline">\(b\)</span>ï¼Œè¾“å‡ºä¸º <span class="math inline">\(z^l = a^{l-1}*W+b\)</span>ï¼Œç›¸å¯¹äºè¾“å‡ºçš„è¯¯å·®æ¢¯åº¦ä¸º <span class="math inline">\(\delta^l = \frac{\partial \text{Loss}}{\partial z^l}\)</span>ï¼Œåˆ™ç›¸å¯¹äºè¾“å…¥çš„æ¢¯åº¦ä¸ºï¼š <span class="math display">\[\delta^{l-1}=\delta^l*\text{rot180}(W^l)\]</span> ç›¸å¯¹äºæƒé‡å’Œåç½®çš„æ¢¯åº¦ä¸ºï¼š <span class="math display">\[\frac{\partial\text{Loss}}{\partial W^l}=\frac{\partial\text{Loss}}{\partial z^l}\frac{\partial z^l}{\partial W^l}=a^{l-1}*\delta^l\\\frac{\partial\text{Loss}}{\partial b^l}=\sum_{u,v}(\delta^l)_{u,v}\]</span> <strong>æ³¨</strong>ï¼š<span class="math inline">\(*\)</span> ä¸ºå·ç§¯çš„æ„æ€ï¼Œ<span class="math inline">\(\text{rot180}(x)\)</span> ä¸ºæŠŠçŸ©é˜µ <span class="math inline">\(x\)</span> æ—‹è½¬180åº¦çš„æ„æ€ã€‚å…¬å¼æ¨å¯¼å¯ä»¥çœ‹<a href="https://www.cnblogs.com/pinard/p/6494810.html" target="_blank" rel="noopener">è¿™ç¯‡åšå®¢</a>ã€‚</p><p>ä»å…¬å¼å¯ä»¥çœ‹å‡ºåå‘ä¼ æ’­åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šè®¡ç®—å¯¹è¾“å…¥çš„æ¢¯åº¦å’Œè®¡ç®—å¯¹å‚æ•°çš„æ¢¯åº¦ï¼Œè¿™ä¸¤éƒ¨åˆ†ä¹Ÿåˆ†åˆ«å¯¹åº”äº†æ¨¡å—é‡Œçš„ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªåˆ†æã€‚</p><p><strong>THNN_(SpatialConvolutionMM_updateGradInput)</strong></p><p>è¿™éƒ¨åˆ†æ˜¯è®¡ç®—å¯¹è¾“å…¥çš„æ¢¯åº¦ï¼Œè™½ç„¶å…¬å¼æ‘†åœ¨äº†é‚£é‡Œï¼Œä½†Torchçš„ä»£ç å®ç°å¹¶ä¸æ˜¯ç›´æ¥ç¿»è¯‘å…¬å¼ï¼Œæˆ‘ä¹Ÿä¸€ç›´æ²¡èƒ½æŠŠè¿™éƒ¨åˆ†çš„å®ç°å’Œå…¬å¼å¯¹ä¸Šï¼Œä¸è¿‡å€’æ˜¯å¯ä»¥é€šè¿‡å›¾ç¤ºçš„æ–¹å¼æ¥ç†è§£ï¼Œæœ‰ç‚¹åƒå‰å‘ä¼ æ’­çš„é€†è¿‡ç¨‹ï¼ŒæŠŠå·ç§¯åçš„æ¢¯åº¦åˆ†é…å›å·ç§¯å‰ã€‚</p><p>åœ¨ç”»å›¾ä¹‹å‰è¿˜æ˜¯å…ˆå®šä¹‰ä¸€äº›ç¬¦å·ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THNN_</span><span class="params">(SpatialConvolutionMM_updateGradInput)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           THCState *state,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *input,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *gradOutput,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *gradInput,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *weight,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *gradColumns,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *ones,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> kW, <span class="keyword">int</span> kH,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> dW, <span class="keyword">int</span> dH,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> padW, <span class="keyword">int</span> padH)</span></span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ˆä¸å‰å‘ä¼ æ’­ç›¸åŒçš„å‚æ•°å°±ä¸é‡å¤ä»‹ç»äº†ï¼‰ï¼Œ</p><ul><li><code>gradOutput</code> æ˜¯ç›¸å¯¹äºè¾“å‡ºçš„æ¢¯åº¦ï¼Œå³ <span class="math inline">\(\delta^l\)</span>ï¼Œå¤§å°ä¸å‰å‘ä¼ æ’­çš„è¾“å‡º <code>output</code> ç›¸åŒï¼›</li><li><code>gradInput</code> æ˜¯ç›¸å¯¹äºè¾“å…¥çš„æ¢¯åº¦ï¼Œå³ <span class="math inline">\(\delta^{l-1}\)</span>ï¼Œæ˜¯è¿™ä¸ªå‡½æ•°éœ€è¦è®¡ç®—çš„å¯¹è±¡ï¼Œå¤§å°ä¸è¾“å…¥ <code>input</code> ç›¸åŒï¼›</li><li><code>gradColumns</code> æ˜¯ä¸ªåˆ—çŸ©é˜µï¼Œç”¨äºå­˜å‚¨ä¸´æ—¶çš„æ¢¯åº¦ï¼Œå¤§å°ä¸º <span class="math inline">\((\text{nInputPlane}\times\text{kH}\times\text{kW})\times(\text{outputHeight}\times\text{outputWidth})\)</span>ï¼›</li></ul><p>ä»£ç çš„å®ç°é€»è¾‘æ˜¯ç”¨æƒé‡çš„è½¬ç½®ä¹˜ä»¥è¾“å‡ºæ¢¯åº¦ï¼Œå¾—åˆ°<code>gradColumns</code>ï¼Œç„¶åé€šè¿‡col2imè¿˜åŸåˆ°è¾“å…¥çš„å¤§å°ï¼Œå³å¾—åˆ°äº†ç›¸å¯¹è¾“å…¥çš„æ¢¯åº¦ <code>gradInput</code>ã€‚è¿™ä¸ªæ“ä½œçœ‹èµ·æ¥å°±æ˜¯å‰å‘ä¼ æ’­çš„é€†æ“ä½œï¼Œä½†æ˜¯æä¸æ‡‚ä¸ºä»€ä¹ˆè¿™æ ·å°±å®ç°äº† <span class="math inline">\(\delta^l*\text{rot180}(W^l)\)</span>ï¼Œ<strong>å¦‚æœæœ‰å¤§ä½¬çŸ¥é“å¸Œæœ›è¯„è®ºåŒºæŒ‡ç‚¹ä¸€ä¸‹</strong>ã€‚ä½¿ç”¨å‰é¢ä¾‹å­çš„è®¾å®šï¼Œè¿™æ³¢æ“ä½œçš„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/images/pytorch/convmm2.png"></p><p><img src="/images/pytorch/col2im.png"></p><p><strong>æ ¸å¿ƒéƒ¨åˆ†ä»£ç </strong>ï¼ˆå…¶ä½™éƒ¨åˆ†ä¸å‰å‘ä¼ æ’­ç±»ä¼¼ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å¾ªç¯å–æ¯ä¸ªæ‰¹æ¬¡ï¼š */</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> elt = <span class="number">0</span>; elt &lt; batchSize; elt ++) &#123;</span><br><span class="line">  <span class="comment">/* gradInput_n = gradInput[elt]; gradInput_n åŒç† */</span></span><br><span class="line">  THCTensor_(select)(state, gradInput_n, gradInput, <span class="number">0</span>, elt);</span><br><span class="line">  THCTensor_(select)(state, gradOutput_n, gradOutput, <span class="number">0</span>, elt);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// M,N,K are dims of matrix A and B</span></span><br><span class="line">  <span class="keyword">int64_t</span> m = nInputPlane*kW*kH;</span><br><span class="line">  <span class="keyword">int64_t</span> n = gradColumns-&gt;size(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">int64_t</span> k = nOutputPlane;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è°ƒç”¨GEMMè®¡ç®— gradColumns = weight' * gradOutput_n */</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">ifdef</span> THC_REAL_IS_FLOAT</span></span><br><span class="line">  THCudaBlas_Sgemm(</span><br><span class="line">  #elif defined(THC_REAL_IS_HALF)</span><br><span class="line">  THCudaBlas_Hgemm(</span><br><span class="line">  #elif defined(THC_REAL_IS_DOUBLE)</span><br><span class="line">  THCudaBlas_Dgemm(</span><br><span class="line">  #endif</span><br><span class="line">      state,</span><br><span class="line">      <span class="string">'n'</span>, <span class="string">'t'</span>,</span><br><span class="line">      n, m, k,</span><br><span class="line">      ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">1</span>),</span><br><span class="line">      THCTensor_(data)(state, gradOutput_n), n,</span><br><span class="line">      THCTensor_(data)(state, weight), m,</span><br><span class="line">      ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">0</span>),</span><br><span class="line">      THCTensor_(data)(state, gradColumns), n</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è°ƒç”¨ col2im æŠŠ gradColumns è¿˜åŸä¸º gradInput_n */</span></span><br><span class="line">  col2im&lt;<span class="keyword">scalar_t</span>, accreal&gt;(</span><br><span class="line">    THCState_getCurrentStream(state),</span><br><span class="line">    THCTensor_(data)(state, gradColumns),</span><br><span class="line">    nInputPlane, inputHeight, inputWidth, outputHeight,</span><br><span class="line">    outputWidth, kH, kW, padH, padW, dH, dW,</span><br><span class="line">    <span class="number">1</span>, <span class="number">1</span>, THCTensor_(data)(state, gradInput_n)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>THNN_(SpatialConvolutionMM_accGradParameters)</strong></p><p>æ¥ä¸‹æ¥çœ‹è®¡ç®—å‚æ•°æ¢¯åº¦çš„éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†ç›¸å¯¹å¥½ç†è§£ï¼Œå› ä¸ºä»£ç å’Œå…¬å¼ä¸€æ ·ï¼Œè¿˜æ˜¯å…ˆçœ‹å‡½æ•°å£°æ˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THNN_</span><span class="params">(SpatialConvolutionMM_accGradParameters)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           THCState *state,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *input,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *gradOutput,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *gradWeight,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *gradBias,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *columns,</span></span></span><br><span class="line"><span class="function"><span class="params">           THCTensor *ones,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> kW, <span class="keyword">int</span> kH,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> dW, <span class="keyword">int</span> dH,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> padW, <span class="keyword">int</span> padH,</span></span></span><br><span class="line"><span class="function"><span class="params">           accreal scale_)</span></span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ</p><ul><li><code>gradWeight</code> æ˜¯æƒé‡çš„æ¢¯åº¦ï¼Œæ˜¯è¿™ä¸ªå‡½æ•°éœ€è¦è®¡ç®—çš„å¯¹è±¡ï¼Œå¤§å°å’Œæƒé‡ç›¸åŒï¼›</li><li><code>gradBias</code> æ˜¯åç½®çš„æ¢¯åº¦ï¼Œä¹Ÿæ˜¯å‡½æ•°éœ€è¦è®¡ç®—çš„å¯¹è±¡ï¼Œå¤§å°ä¸åç½®ç›¸åŒï¼ˆå°±æ˜¯ä¸€ä¸ªVectorï¼‰</li><li><code>columns</code> æ˜¯ç”¨æ¥å­˜å‚¨ im2col çš„ç»“æœï¼Œå› ä¸ºè¦è®¡ç®—å·ç§¯ï¼Œæ‰€ä»¥è¦æŠŠè¾“å…¥å±•å¼€</li><li><code>scale_</code> æ˜¯å­¦ä¹ é€Ÿç‡ï¼ˆlearning rateï¼‰</li></ul><p>å·²çŸ¥<strong>æƒé‡æ¢¯åº¦</strong>çš„è®¡ç®—å…¬å¼ä¸º <span class="math inline">\(\frac{\partial\text{Loss}}{\partial W^l}=a^{l-1}*\delta^l\)</span>ï¼Œè¿™ä¸ªå·ç§¯çš„è®¡ç®—æ–¹å¼å’Œå‰å‘ä¼ æ’­ç›¸åŒï¼šé¦–å…ˆæŠŠè¾“å…¥ï¼ˆ<span class="math inline">\(a^{l-1}\)</span>ï¼‰é€šè¿‡im2colå±•å¼€ä¸ºåˆ—çŸ©é˜µï¼Œå­˜å‚¨åˆ°<code>columns</code>é‡Œï¼Œç„¶åç”¨ <code>gradOutput</code> ä¹˜ä»¥ <code>columns</code> è®¡ç®—å·ç§¯ã€‚è€Œ<strong>åç½®æ¢¯åº¦</strong>çš„è®¡ç®—å°±æ˜¯æŠŠ <code>gradOutput</code> ç´¯åŠ æˆä¸€ä¸ªé•¿åº¦ä¸º <span class="math inline">\(\text{nOutputPlane}â€‹\)</span> çš„ Tensor å³å¯ã€‚</p><p><strong>æ ¸å¿ƒä»£ç </strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THNN_</span><span class="params">(SpatialConvolutionMM_accGradParameters)</span><span class="params">(<span class="comment">/* ç•¥ */</span>)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* å¾ªç¯å–æ¯ä¸ªbatchï¼š */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> elt = <span class="number">0</span>; elt &lt; batchSize; elt ++) &#123;</span><br><span class="line">    <span class="comment">/* gradOutput_n = gradOutput[elt] */</span></span><br><span class="line">    THCTensor_(select)(state, gradOutput_n, gradOutput, <span class="number">0</span>, elt);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¡ç®—æƒé‡æ¢¯åº¦ */</span></span><br><span class="line">    <span class="keyword">if</span> (gradWeight) &#123;</span><br><span class="line">      <span class="comment">/* input_n = input[elt] */</span></span><br><span class="line">      THCTensor_(select)(state, input_n, input, <span class="number">0</span>, elt);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* æŠŠ input_n å±•å¼€ä¸º columns */</span></span><br><span class="line">      im2col(</span><br><span class="line">        THCState_getCurrentStream(state),</span><br><span class="line">        THCTensor_(data)(state, input_n),</span><br><span class="line">        nInputPlane, inputHeight, inputWidth,</span><br><span class="line">        outputHeight, outputWidth,</span><br><span class="line">        kH, kW, padH, padW, dH, dW,</span><br><span class="line">        <span class="number">1</span>, <span class="number">1</span>, THCTensor_(data)(state, columns)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">int64_t</span> m = nOutputPlane;</span><br><span class="line">      <span class="keyword">int64_t</span> n = nInputPlane*kW*kH;</span><br><span class="line">      <span class="keyword">int64_t</span> k = columns-&gt;size(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* è°ƒç”¨GEMMè®¡ç®—gradWeight += scale * gradOutput_n * columns'*/</span></span><br><span class="line">      <span class="meta">#<span class="meta-keyword">ifdef</span> THC_REAL_IS_FLOAT</span></span><br><span class="line">      THCudaBlas_Sgemm(</span><br><span class="line">      #elif defined(THC_REAL_IS_HALF)</span><br><span class="line">      THCudaBlas_Hgemm(</span><br><span class="line">      #elif defined(THC_REAL_IS_DOUBLE)</span><br><span class="line">      THCudaBlas_Dgemm(</span><br><span class="line">      #endif</span><br><span class="line">          state,</span><br><span class="line">          <span class="string">'t'</span>, <span class="string">'n'</span>,</span><br><span class="line">          n, m, k,</span><br><span class="line">          scale,</span><br><span class="line">          THCTensor_(data)(state, columns), k,</span><br><span class="line">          THCTensor_(data)(state, gradOutput_n), k,</span><br><span class="line">          ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">1</span>),</span><br><span class="line">          THCTensor_(data)(state, gradWeight), n</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¡ç®—åç½®æ¢¯åº¦ */</span></span><br><span class="line">    <span class="keyword">if</span> (gradBias) &#123;</span><br><span class="line">     </span><br><span class="line">      <span class="keyword">int64_t</span> m_ = nOutputPlane;</span><br><span class="line">      <span class="keyword">int64_t</span> k_ = outputHeight * outputWidth;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* è°ƒç”¨GEMVè®¡ç®— gradBias += scale * gradOutput_n * ones */</span></span><br><span class="line">      #<span class="keyword">if</span> defined(THC_REAL_IS_FLOAT) || defined(THC_REAL_IS_DOUBLE)</span><br><span class="line">      #ifdef THC_REAL_IS_FLOAT</span><br><span class="line">      THCudaBlas_Sgemv(</span><br><span class="line">      #elif defined(THC_REAL_IS_DOUBLE)</span><br><span class="line">      THCudaBlas_Dgemv(</span><br><span class="line">      #endif</span><br><span class="line">          state,</span><br><span class="line">          <span class="string">'t'</span>,</span><br><span class="line">          k_, m_,</span><br><span class="line">          scale,</span><br><span class="line">          THCTensor_(data)(state, gradOutput_n), k_,</span><br><span class="line">          THCTensor_(data)(state, ones), <span class="number">1</span>,</span><br><span class="line">          ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">1</span>),</span><br><span class="line">          THCTensor_(data)(state, gradBias), <span class="number">1</span></span><br><span class="line">      );</span><br><span class="line">      #endif</span><br><span class="line">      #ifdef THC_REAL_IS_HALF</span><br><span class="line">      THCudaBlas_Hgemm(</span><br><span class="line">          state,</span><br><span class="line">          <span class="string">'t'</span>, <span class="string">'n'</span>,</span><br><span class="line">          m_, <span class="number">1</span>, k_,</span><br><span class="line">          scale,</span><br><span class="line">          THCTensor_(data)(state, gradOutput_n), k_,</span><br><span class="line">          THCTensor_(data)(state, ones), k_,</span><br><span class="line">          ScalarConvert&lt;<span class="keyword">int</span>, <span class="keyword">scalar_t</span>&gt;::to(<span class="number">1</span>),</span><br><span class="line">          THCTensor_(data)(state, gradBias), m_</span><br><span class="line">      );</span><br><span class="line">      #endif</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="aten">ATen</span></h2><p>çœ‹äº†<code>THNN.h</code>çš„è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼ŒTHNNå’ŒTHCUNNåªå®šä¹‰äº†å°‘é‡çš„ç¥ç»ç½‘ç»œç›¸å…³çš„å‡½æ•°ï¼Œå…¶å®å¤§éƒ¨åˆ†éƒ½å®šä¹‰åœ¨ATenä¸­ï¼Œè¿™ä¸ªATenæ˜¯æŒ‡<code>pytorch/aten/src/ATen</code>æ–‡ä»¶å¤¹ï¼ˆä¸‹åŒï¼‰ã€‚è¯´åˆ°åº•ï¼ŒTHç³»åˆ—åº“éƒ½æ˜¯torch luaæ—¶ä»£ç•™ä¸‹çš„äº§ç‰©ï¼Œæ˜¯ç”¨Cè¯­è¨€å®ç°çš„ï¼Œåæ¥PyTorchå¼€å‘è€…è§‰å¾—cppå¤§æ³•å¥½ï¼Œå°±ç”¨C++å†™äº†ATenï¼ŒæŠŠTHé‡Œçš„æ¥å£éƒ½å°è£…äº†ï¼ŒåŒæ—¶æ–°çš„APIç›´æ¥åœ¨ATené‡Œå®ç°ã€‚</p><p>è¿™ä¸ªATenæœ‰ç‚¹æ„æ€ï¼Œå®ƒå¤§æ¦‚å¹²äº†è¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>åœ¨<code>ATen/core/Tensor.h</code>å®šä¹‰äº† <code>at::Tensor</code> ç±»å‹ï¼Œè¿™ä¸ªæ˜¯C++å‰ç«¯ä»¥åŠæ›´ä¸Šå±‚çš„APIéƒ½åœ¨ç”¨çš„Tensorç±»å‹ï¼Œå®ƒçš„æˆå‘˜å†…æœ‰ä¸€ä¸ª<code>TensorImpl impl_</code>ï¼Œæä¾›åº•å±‚å®ç°ï¼›</li><li>å®ç°å’Œå°è£…äº†æœ‰å…³Tensorçš„æ‰€æœ‰æ“ä½œï¼Œå¹¶æ ¹æ®æ•°æ®ç±»å‹å’Œè®¾å¤‡è¿›è¡Œè‡ªåŠ¨æ´¾å‘ï¼›</li><li>ä½¿ç”¨Pythonè„šæœ¬ç”ŸæˆATen APIã€‚</li></ul><p>å…¶ä¸­ä»THï¼ˆåŒ…æ‹¬THCã€THNNç­‰ï¼‰é‡Œå°è£…çš„å‡½æ•°å«åš legacyå‡½æ•°ï¼Œè€Œåœ¨ATenç›´æ¥å®ç°çš„å‡½æ•°å« nativeå‡½æ•°ã€‚nativeå‡½æ•°çš„å®ç°å…¨åœ¨ <code>ATen/native</code> æ–‡ä»¶å¤¹ä¸­ï¼Œå®ç°äº†THNNé‡Œæ²¡æœ‰çš„ç¥ç»ç½‘ç»œå’ŒTensoræ“ä½œï¼Œæ¯”å¦‚RNNä»€ä¹ˆçš„ï¼ŒAPIåˆ—è¡¨åœ¨<code>ATen/native/native_functions.yaml</code>é‡Œï¼Œæ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥è‡ªå·±é˜…è¯»ã€‚</p><p>äº†è§£äº†ç¥ç»ç½‘ç»œæ¯ä¸€å±‚çš„å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­çš„å®ç°ä¹‹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æ§åˆ¶æ‰§è¡Œé¡ºåºäº†ï¼Œä¹Ÿå°±æ˜¯è‡ªåŠ¨å¾®åˆ†ï¼ˆAutogradï¼‰ï¼Œä¸‹ä¸€ç« å°†ä»‹ç»PyTorchè‡ªåŠ¨å¾®åˆ†çš„å®ç°ã€‚</p><p>ã¤ã¥ã</p><table><thead><tr class="header"><th style="text-align: left;">ä¸Šä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch2/">THC</a></th><th style="text-align: right;">ä¸‹ä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch4/">Autograd</a></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"></td><td style="text-align: right;"></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;THNNæ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€å®ç°çš„ç¥ç»ç½‘ç»œæ¨¡å—çš„åº“ï¼Œæä¾›çš„åŠŸèƒ½éå¸¸åº•å±‚ã€‚å®ƒå®ç°äº†è®¸å¤šåŸºç¡€çš„ç¥ç»ç½‘ç»œæ¨¡å—ï¼ŒåŒ…æ‹¬çº¿æ€§å±‚ï¼Œå·ç§¯å±‚ï¼ŒSigmoidç­‰å„ç§æ¿€æ´»å±‚ï¼Œä¸€äº›åŸºæœ¬çš„losså‡½æ•°ï¼Œè¿™äº›APIéƒ½å£°æ˜åœ¨&lt;code&gt;THNN/generic/THNN.h&lt;/code&gt;ä¸­ã€‚æ¯ä¸ªæ¨¡å—éƒ½å®ç°äº†å‰å‘ä¼ å¯¼ï¼ˆforwardï¼‰å’Œåå‘ä¼ å¯¼ï¼ˆbackwardï¼‰çš„åŠŸèƒ½ã€‚THCUNNåˆ™æ˜¯å¯¹åº”æ¨¡å—çš„CUDAå®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="Neural Network" scheme="http://www.52coding.com.cn/tags/Neural-Network/"/>
    
      <category term="PyTorch" scheme="http://www.52coding.com.cn/tags/PyTorch/"/>
    
      <category term="THNN" scheme="http://www.52coding.com.cn/tags/THNN/"/>
    
      <category term="CONV" scheme="http://www.52coding.com.cn/tags/CONV/"/>
    
  </entry>
  
  <entry>
    <title>PyTorchæºç æµ…æ(2)ï¼šTHC</title>
    <link href="http://www.52coding.com.cn/2019/05/05/PyTorch2/"/>
    <id>http://www.52coding.com.cn/2019/05/05/PyTorch2/</id>
    <published>2019-05-05T07:53:01.000Z</published>
    <updated>2019-05-05T08:06:43.284Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡ä¸»è¦çœ‹ Torch CUDA éƒ¨åˆ†ï¼Œå¯¹åº”æºç ç›®å½• <code>aten/src/THC</code>ï¼Œé‡Œé¢åŒ…å«äº†è®¸å¤šC++å’ŒCUDAä»£ç ã€‚è¿™éƒ¨åˆ†å®ç°äº†æ“ä½œ THCTensor å’Œ THCStorage çš„æ¥å£ï¼Œä¸è¿‡åº•å±‚ç”¨çš„æ•°æ®ç»“æ„è¿˜æ˜¯ <code>TensorImpl</code> å’Œ <code>StorageImpl</code>ã€‚THCé‡Œçš„æ¥å£ä¹Ÿæ˜¯é€šè¿‡Cè¯­è¨€èŒƒå¼å®ç°çš„ï¼Œä½†æ˜¯Applyç³»åˆ—æ“ä½œä¸å†ç”±å®æ¥å®ç°ï¼Œè€Œæ˜¯ä½¿ç”¨äº†C++æ¨¡æ¿ã€‚å…¶ä»–çš„åŒºåˆ«è¿˜æœ‰allocatorä¸åŒï¼Œä»¥åŠå¤šäº† THCState ç»“æ„ã€‚</p><a id="more"></a><p>è®°å·ï¼š</p><ul><li>TH = TorcH</li><li>THC = TorcH Cuda</li></ul><!-- toc --><ul><li><a href="#thcstate">THCState</a></li><li><a href="#thcallocator">THCAllocator</a><ul><li><a href="#thccachingallocator">THCCachingAllocator</a></li><li><a href="#thccachinghostallocator">THCCachingHostAllocator</a></li></ul></li><li><a href="#thcapply">THCApply</a></li><li><a href="#æ€»ç»“">æ€»ç»“</a></li></ul><!-- tocstop --><h2><span id="thcstate">THCState</span></h2><p>é€šè¿‡è§‚å¯ŸTHCé‡Œé¢å®ç°çš„æ¥å£ä¸éš¾å‘ç°ï¼Œå‡ ä¹æ¯ä¸ªæ¥å£éƒ½éœ€è¦ä¼ å…¥ä¸€ä¸ª <code>THCState*</code> å‚æ•°ï¼Œè€Œè¿™æ˜¯åœ¨THä¸­æ²¡æœ‰çš„ï¼Œè¿™ä¸ªTHCStateçš„å£°æ˜åœ¨<code>THCGeneral.hpp</code>ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THCState</span> &#123;</span></span><br><span class="line">  <span class="comment">// è²Œä¼¼æ˜¯ç”¨æ¥ç”Ÿæˆéšæœºæ•°çš„</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">THCRNGState</span>* <span class="title">rngState</span>;</span></span><br><span class="line"><span class="comment">// è®°å½•æ¯ä¸ªCUDAè®¾å¤‡çš„cuBLASå¥æŸ„å’ŒcuSparseå¥æŸ„</span></span><br><span class="line">  THCCudaResourcesPerDevice* resourcesPerDevice;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// cudaè®¾å¤‡ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">int</span> numDevices; </span><br><span class="line"></span><br><span class="line">  at::Allocator* cudaHostAllocator;<span class="comment">// å†…å­˜åˆ†é…å™¨</span></span><br><span class="line">  at::Allocator* cudaDeviceAllocator;<span class="comment">// æ˜¾å­˜åˆ†é…å™¨</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// äºŒç»´æ•°ç»„ï¼Œå¤§å°ä¸º numDevices * numDevices</span></span><br><span class="line">  <span class="comment">// æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹ i, j è®°å½•äº† CUDA_i èƒ½å¦ç›´æ¥ä» CUDA_j å¤åˆ¶æ•°æ®</span></span><br><span class="line">  <span class="comment">// å¦‚æœå€¼ä¸º 1 ä»£è¡¨å…è®¸æ‹·è´ï¼Œ0 ä»£è¡¨ä¸å…è®¸ï¼Œ-1 ä»£è¡¨ä¸çŸ¥é“ï¼ˆé»˜è®¤å€¼ï¼‰</span></span><br><span class="line">  <span class="keyword">int</span>** p2pAccessEnabled;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>THCStateæ˜¯ä¸€ä¸ªå…¨å±€CUDAçŠ¶æ€ï¼Œè®°å½•äº†CUDAè®¾å¤‡çš„æ‰€æœ‰æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå®ƒçš„åˆå§‹åŒ–åœ¨<code>THCGeneral.cpp</code>ä¸­ï¼Œä»£ç å¹¶ä¸éš¾ç†è§£ã€‚</p><blockquote><p>æ³¨ <strong>hostå’Œdevice</strong>ï¼šåœ¨CUDAç¼–ç¨‹ä¸­ï¼Œ<em>host</em> æŒ‡çš„æ˜¯CPUå’Œå®ƒçš„å†…å­˜ï¼Œè€Œ <em>device</em> æŒ‡GPUåŠå…¶æ˜¾å­˜ã€‚åœ¨ <em>host</em> ä¸Šè¿è¡Œçš„ä»£ç å¯ä»¥æ“æ§å†…å­˜å’Œæ˜¾å­˜ï¼Œè¿˜å¯ä»¥å¯åŠ¨ <em>kernels</em> åœ¨GPUä¸Šè®¡ç®—ã€‚å› ä¸ºCUDAç¼–ç¨‹çš„è¿™äº›ç‰¹æ€§ï¼Œä¸€ä¸ªå…¸å‹CUDAç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸ºï¼š</p><ol type="1"><li>åˆ†é…å†…å­˜å’Œæ˜¾å­˜ç©ºé—´</li><li>åˆå§‹åŒ–å†…å­˜æ•°æ®ï¼ˆhostï¼‰</li><li>æŠŠæ•°æ®ä»å†…å­˜ (host) ä¼ é€åˆ°æ˜¾å­˜ (device)</li><li>æ‰§è¡Œ kernels</li><li>æŠŠç»“æœä»æ˜¾å­˜ (device) ä¼ å›å†…å­˜ (host)</li></ol></blockquote><h2><span id="thcallocator">THCAllocator</span></h2><h3><span id="thccachingallocator">THCCachingAllocator</span></h3><p>æŸ¥çœ‹THCStateåˆå§‹åŒ–çš„ä»£ç ä¸éš¾å‘ç°ï¼Œæ˜¾å­˜åˆ†é…å™¨<code>cudaDeviceAllocator</code>çš„ç±»å‹ä¸º<code>CudaCachingAllocator</code>ï¼Œå®ƒçš„å®ç°åœ¨<code>c10/cuda/CUDACachingAllocator.cpp</code>ä¸­ã€‚è¿›ä¸€æ­¥è§‚å¯Ÿåå‘ç°ï¼Œ<code>CudaCachingAllocator</code>è°ƒç”¨çš„åˆ†é…å†…å­˜å‡½æ•°å®é™…ä¸Šæ˜¯<code>THCCachingAllocator</code>å®ç°çš„ï¼Œ<code>THCCachingAllocator</code>ä¸å…‰å‘ç³»ç»Ÿè¯·æ±‚åˆ†é…æ˜¾å­˜ï¼Œè¿˜å®ç°äº†ç¼“å­˜ç®¡ç†ç³»ç»Ÿï¼Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹ä¸€ä¸‹<code>THCCachingAllocator</code>çš„å®ç°ã€‚</p><p>é¦–å…ˆå£°æ˜ä¸€ä¸ªå†…å­˜åŒºå—çš„ç»“æ„ä½“ï¼Œé‡Œé¢å­˜å‚¨è®¾å¤‡ã€streamã€åŒºå—å¤§å°ç­‰ä¿¡æ¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Block</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span>           device;      <span class="comment">// gpu</span></span><br><span class="line">  cudaStream_t  stream;      <span class="comment">// allocation stream</span></span><br><span class="line">  stream_set    stream_uses; <span class="comment">// streams on which the block was used</span></span><br><span class="line">  <span class="keyword">size_t</span>        size;        <span class="comment">// block size in bytes</span></span><br><span class="line">  <span class="keyword">char</span>*         ptr;         <span class="comment">// memory address</span></span><br><span class="line">  <span class="keyword">bool</span>          allocated;   <span class="comment">// in-use flag      </span></span><br><span class="line">  <span class="keyword">int</span>           event_count; <span class="comment">// number of outstanding CUDA events</span></span><br><span class="line">  <span class="comment">// prev block if split from a larger allocation</span></span><br><span class="line">  Block*        prev;</span><br><span class="line">  <span class="comment">// next block if split from a larger allocation</span></span><br><span class="line">  Block*        next;</span><br><span class="line">  </span><br><span class="line">  Block(<span class="keyword">int</span> device, cudaStream_t stream, <span class="keyword">size_t</span> size) :</span><br><span class="line">      device(device), stream(stream), stream_uses(), size(size),</span><br><span class="line">      ptr(ptr), allocated(<span class="number">0</span>), prev(<span class="literal">NULL</span>), next(<span class="literal">NULL</span>),</span><br><span class="line">      event_count(<span class="number">0</span>) &#123; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿æ¯”è¾ƒæŸ¥æ‰¾ï¼Œä¸º<code>Block</code>å®šä¹‰æ¯”è¾ƒå¤§å°çš„æ–¹æ³•ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">BlockComparator</span><span class="params">(<span class="keyword">const</span> Block* a, <span class="keyword">const</span> Block* b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// é¦–å…ˆæ¯”è¾ƒè®¾å¤‡ID</span></span><br><span class="line">  <span class="keyword">if</span> (a-&gt;device != b-&gt;device) &#123;</span><br><span class="line">    <span class="keyword">return</span> a-&gt;device &lt; b-&gt;device;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å†æ¯”è¾ƒstream id</span></span><br><span class="line">  <span class="keyword">if</span> (a-&gt;stream != b-&gt;stream) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)a-&gt;stream &lt; (<span class="keyword">uintptr_t</span>)b-&gt;stream;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å†æ¯”è¾ƒåŒºå—å¤§å°</span></span><br><span class="line">  <span class="keyword">if</span> (a-&gt;size != b-&gt;size) &#123;</span><br><span class="line">    <span class="keyword">return</span> a-&gt;size &lt; b-&gt;size;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æœ€åæ¯”è¾ƒå†…å­˜åœ°å€å¤§å°</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)a-&gt;ptr &lt; (<span class="keyword">uintptr_t</span>)b-&gt;ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ­¤æ¯”è¾ƒå‡½æ•°çš„è¯ <code>Block(device, NULL, 0)</code> å°±æ˜¯è®¾å¤‡deviceä¸ŠåŒºå—å¤§å°çš„ä¸‹é™ï¼Œè€Œ<code>Block(device + 1, NULL, 0)</code>åˆ™æ˜¯è®¾å¤‡deviceä¸Šçš„åŒºå—å¤§å°ä¸Šé™ã€‚</p><p>æ¥ä¸‹æ¥çœ‹<code>THCCachingAllocator</code>å®šä¹‰çš„å±æ€§ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THCCachingAllocator</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">typedef</span> <span class="title">bool</span> <span class="params">(*Comparison)</span><span class="params">(<span class="keyword">const</span> Block*, <span class="keyword">const</span> Block*)</span></span>;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="built_in">std</span>::<span class="built_in">set</span>&lt;Block*, Comparison&gt; FreeBlocks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// device statistics</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;DeviceStats&gt; device_stats;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lock around all operations</span></span><br><span class="line">  <span class="built_in">std</span>::mutex mutex;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// lock around calls to cudaFree (to prevent deadlocks with NCCL)</span></span><br><span class="line">  <span class="built_in">std</span>::mutex cuda_free_mutex;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cached blocks larger than 1 MB</span></span><br><span class="line">  FreeBlocks large_blocks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cached blocks 1 MB or smaller</span></span><br><span class="line">  FreeBlocks small_blocks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allocated blocks by device pointer</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="keyword">void</span>*, Block*&gt; allocated_blocks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// outstanding cuda events</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">deque</span>&lt;<span class="built_in">std</span>::pair&lt;cudaEvent_t, Block*&gt;&gt; cuda_events;</span><br><span class="line"></span><br><span class="line">  THCCachingAllocator() :</span><br><span class="line">      large_blocks(BlockComparator),</span><br><span class="line">      small_blocks(BlockComparator) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªå±æ€§æ˜¯å¹²ä»€ä¹ˆçš„æ³¨é‡Šå·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œæ³¨æ„åˆ°<code>FreeBlocks</code>ç±»å‹æ˜¯Blockçš„æœ‰åºé›†åˆï¼Œæ›¾ç»åˆ†é…è¿‡ä½†æ˜¯ç”¨å®Œäº†çš„å†…å­˜ä¼šè¢«ç¼“å­˜èµ·æ¥ï¼Œå¤§äº1Mçš„åˆ†å—ä¼šè¿›å…¥<code>large_blocks</code>ï¼Œå°äºç­‰äº1Mçš„åˆ†å—è¿›å…¥<code>small_blocks</code>ã€‚ä¹‹åå†å‘åˆ†é…å™¨ç”³è¯·å†…å­˜æ—¶ä¼šå…ˆä»ç¼“å­˜é‡Œé¢åˆ†é…ï¼Œåˆ†é…ç­–ç•¥ä¸ºBest-fitï¼Œå³è¿”å›å¤§äºç­‰äºæ‰€éœ€å¤§å°çš„æœ€å°åˆ†å—ï¼ˆä½¿ç”¨<code>set::lower_bound</code>å®ç°ï¼‰ã€‚å¦‚æœç¼“å­˜ä¸­çš„æ‰€æœ‰åˆ†å—éƒ½å°äºç›®æ ‡å¤§å°ï¼Œé‚£ä¹ˆä¼šå°è¯•<code>cudaMalloc</code>åˆ†é…ç›®æ ‡å¤§å°çš„å†…å­˜ï¼Œå¦‚æœè¿˜æ˜¯å¤±è´¥çš„è¯å°±æŠŠç¼“å­˜releaseäº†å†è¯•<code>cudaMalloc</code>ï¼Œå¦‚æœè¿˜æ˜¯åˆ†é…å¤±è´¥å°±ä¼šæŠ¥å†…ï¼ˆæ˜¾ï¼‰å­˜ä¸è¶³çš„é”™è¯¯ã€‚</p><p>å¦‚æœä¸Šé¢æŸä¸€æ­¥åˆ†é…å†…å­˜æˆåŠŸäº†ï¼Œç”±äºåˆ†é…çš„å—å¾ˆæœ‰å¯èƒ½æ¯”å®é™…éœ€è¦çš„sizeå¤§ï¼Œæ‰€ä»¥è¿˜è¦è¿›è¡Œåˆ‡å‰²æ“ä½œã€‚åˆ‡å‰²æ“ä½œå°±æ˜¯åˆ¤æ–­å¤šä½™çš„å¤§å°æ˜¯å¦å¤§äº1Mï¼Œå¦‚æœå¤§äº1Må°±æ’å…¥åˆ°<code>large_blocks</code>ï¼Œå¦åˆ™æ’å…¥åˆ°<code>small_blocks</code>ä¸­ï¼Œç„¶åå†è®¾ç½®ä¸€ä¸‹<code>prev</code>å’Œ<code>next</code>æŒ‡é’ˆå³å¯ã€‚</p><p>åˆ†é…å†…å­˜çš„ï¼ˆç®€ç•¥ï¼‰å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * allocates a block which is safe to use from the provided stream </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> THCCachingAllocator::<span class="built_in">malloc</span>(<span class="keyword">void</span>** devPtr, <span class="keyword">size_t</span> size, cudaStream_t stream)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// åŠ é”ï¼Œå‡½æ•°è¿”å›æ—¶è‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line">  <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line"><span class="comment">// è·å–è®¾å¤‡ID</span></span><br><span class="line">  <span class="keyword">int</span> device;</span><br><span class="line">  C10_CUDA_CHECK(cudaGetDevice(&amp;device));</span><br><span class="line"><span class="comment">// ç±»ä¼¼å››èˆäº”å…¥</span></span><br><span class="line">  size = round_size(size);</span><br><span class="line">  <span class="keyword">bool</span> small = size &lt;= kSmallAlloc;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœç´¢ç›®æ ‡</span></span><br><span class="line">  <span class="function">Block <span class="title">search_key</span><span class="params">(device, stream, size)</span></span>;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­åº”è¯¥ä»å“ªä¸ªé›†åˆåˆ†é…</span></span><br><span class="line">  <span class="keyword">auto</span>&amp; free_blocks = small ? small_blocks : large_blocks;</span><br><span class="line"></span><br><span class="line">  Block* block = <span class="literal">NULL</span>;</span><br><span class="line">  Block* remaining = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœç´¢å¤§äºç­‰äºç›®æ ‡çš„ç¬¬ä¸€ä¸ªå—</span></span><br><span class="line">  <span class="keyword">auto</span> it = free_blocks.lower_bound(&amp;search_key);</span><br><span class="line">  <span class="keyword">if</span> (it != free_blocks.end() &amp;&amp; (*it)-&gt;device == device &amp;&amp; (*it)-&gt;stream == stream) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœdeviceå’Œstreamå’Œç›®æ ‡ç›¸åŒçš„è¯å°±åˆ†é…è¯¥å—å†…å­˜</span></span><br><span class="line">    block = *it;</span><br><span class="line">    free_blocks.erase(it);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">void</span>* ptr;</span><br><span class="line">    <span class="keyword">size_t</span> alloc_size = small ? kSmallAlloc : size;</span><br><span class="line">    <span class="comment">// å°è¯•å‘ç³»ç»Ÿç”³è¯·å†…å­˜</span></span><br><span class="line">    cudaError_t err = cuda_malloc_retry(device, &amp;ptr, alloc_size);</span><br><span class="line">    <span class="keyword">if</span> (err != cudaSuccess) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err == cudaErrorMemoryAllocation) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; stats = get_stats_for_device(device);</span><br><span class="line"><span class="comment">// æŠ¥é”™ï¼šåˆ†é…å†…å­˜å¤±è´¥ï¼</span></span><br><span class="line">        AT_ERROR(<span class="string">"CUDA out of memory. Tried to allocate"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        C10_CUDA_CHECK(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    block = <span class="keyword">new</span> Block(device, stream, alloc_size, (<span class="keyword">char</span>*)ptr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (block-&gt;size - size &gt;= (small? kRoundSmall : kSmallAlloc+<span class="number">1</span>)) &#123;</span><br><span class="line">    remaining = block;</span><br><span class="line"><span class="comment">// åˆ‡å‰²å¤šä½™å†…å­˜å—</span></span><br><span class="line">    block = <span class="keyword">new</span> Block(device, stream, size, block-&gt;ptr);</span><br><span class="line">    block-&gt;prev = remaining-&gt;prev;</span><br><span class="line">    <span class="keyword">if</span> (block-&gt;prev) &#123;</span><br><span class="line">      block-&gt;prev-&gt;next = block;</span><br><span class="line">    &#125;</span><br><span class="line">    block-&gt;next = remaining;</span><br><span class="line"></span><br><span class="line">    remaining-&gt;prev = block;</span><br><span class="line">    remaining-&gt;ptr += size;</span><br><span class="line">    remaining-&gt;size -= size;</span><br><span class="line">    <span class="comment">// æŠŠå‰©ä½™å—æ’å…¥ç¼“å­˜</span></span><br><span class="line">    free_blocks.insert(remaining);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  block-&gt;allocated = <span class="literal">true</span>;</span><br><span class="line">  allocated_blocks[block-&gt;ptr] = block;</span><br><span class="line"></span><br><span class="line">  *devPtr = (<span class="keyword">void</span>*)block-&gt;ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾å†…å­˜çš„æ—¶å€™ä¸ä¼šæŠŠå†…å­˜ç›´æ¥è¿˜ç»™ç³»ç»Ÿï¼Œè€Œæ˜¯ç¼“å­˜èµ·æ¥æ ¹æ®å—å¤§å°æ’å…¥<code>large_blocks</code>æˆ–<code>small_blocks</code>ï¼Œåœ¨æ’å…¥ä¹‹å‰è¿˜ä¼šæ£€æŸ¥èƒ½å¦å’Œä¹‹å‰è¢«åˆ‡å‰²çš„éƒ¨åˆ†åˆå¹¶ã€‚</p><blockquote><p>æ³¨ <strong>CUDAæ¶æ„</strong>ï¼šä»ç¡¬ä»¶ä¸Šçœ‹ï¼ŒCUDAè®¾å¤‡å«æœ‰ SP (Streaming Processor) å’Œ SM (Streaming Multiprocessor)ï¼›ä»è½¯ä»¶ä¸Šçœ‹ï¼Œæœ‰ thread, block, grid, å’Œ warp ç­‰æ¦‚å¿µã€‚</p><ul><li>SPï¼šæœ€åŸºæœ¬çš„å¤„ç†å•å…ƒï¼Œæœ€åå…·ä½“çš„æŒ‡ä»¤éƒ½æ˜¯åœ¨SPä¸Šå¤„ç†çš„ã€‚</li><li>SMï¼šå¤šä¸ªSPåŠ ä¸Šå…¶ä»–èµ„æºï¼Œå¦‚ï¼šwarp scheduler, register, shared memoryç­‰ç»„æˆçš„å¤§æ ¸ï¼Œç›¸å½“äºCPUçš„æ ¸å¿ƒã€‚</li><li>threadï¼šæ™®é€šçš„çº¿ç¨‹ï¼Œè¿è¡Œåœ¨SPä¸Šã€‚</li><li>blockï¼šå¤šä¸ªçº¿ç¨‹ä¼šç»„æˆä¸€ä¸ªblockï¼ŒåŒä¸€ä¸ªblockä¸­çš„çº¿ç¨‹å¯ä»¥é€šè¿‡shared memoryé€šä¿¡ã€‚åŒä¸€ä¸ªblockä¸­çš„çº¿ç¨‹åœ¨åŒä¸€ä¸ªSMä¸­æ‰§è¡Œã€‚</li><li>gridï¼šå¤šä¸ªblockæ„æˆä¸€ä¸ªgridã€‚</li><li>warpï¼šè°ƒåº¦å’Œè¿è¡Œçš„åŸºæœ¬å•å…ƒï¼ŒåŒ…å«å¤šä¸ªçº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œç›¸åŒæŒ‡ä»¤ï¼Œä½†æ˜¯æ•°æ®ä¸åŒï¼ˆSIMTï¼‰ã€‚ä¸€ä¸ªwarpéœ€è¦å ç”¨ä¸€ä¸ªSMè¿è¡Œï¼Œå¤šä¸ªwarpséœ€è¦è½®æµè¿›å…¥SMã€‚</li><li>streamï¼šä¸€ä¸ªGPUæ“ä½œé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä¸­çš„æ“ä½œå°†ä»¥æ·»åŠ åˆ°æµä¸­çš„å…ˆåé¡ºåºè€Œä¾æ¬¡æ‰§è¡Œã€‚</li></ul><p><img src="/images/pytorch/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/cuda.png"></p></blockquote><h3><span id="thccachinghostallocator">THCCachingHostAllocator</span></h3><p><code>THCState</code>ä¸­è¿˜æœ‰ä¸€ä¸ªå†…å­˜åˆ†é…å™¨<code>cudaHostAllocator</code>ç”¨æ¥åˆ†é…main memoryï¼Œè¿™ä¸ªåˆ†é…å™¨æŒ‡é’ˆæŒ‡å‘<code>HostAllocator</code>ï¼Œå®ç°åœ¨<code>aten/src/THC/THCCachingHostAllocator.cpp</code>ä¸­ã€‚è¿™ä¸ªåˆ†é…å™¨çš„å®ç°å’Œä¸Šé¢çš„ç±»ä¼¼ï¼Œä¹Ÿæä¾›äº†ç¼“å­˜åŠŸèƒ½ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®ƒå‘ç³»ç»Ÿåˆ†é…å†…å­˜æ˜¯ç”¨çš„<code>cudaHostAlloc()</code>å‡½æ•°ï¼Œè¿™æ˜¯cudaåº“å‡½æ•°ï¼Œå®ƒä¸<code>malloc()</code>ä¸åŒã€‚<code>malloc()</code>åˆ†é…çš„æ ‡å‡†çš„ã€å¯åˆ†é¡µçš„ä¸»æœºå†…å­˜ï¼Œè€Œ<code>cudaHostAlloc()</code>åˆ†é…çš„æ˜¯é¡µé”å®šçš„ä¸»æœºå†…å­˜ï¼Œä¹Ÿç§°ä½œå›ºå®šå†…å­˜ (pinned memory)ã€‚å®ƒçš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯æ“ä½œç³»ç»Ÿå°†ä¸ä¼šå¯¹è¿™å—å†…å­˜åˆ†é¡µå¹¶äº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œä»è€Œä¿è¯äº†å†…å­˜å§‹ç»ˆé©»ç•™åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚ç”±äºGPUçŸ¥é“å†…å­˜çš„ç‰©ç†åœ°å€ï¼Œå› æ­¤å°±å¯ä»¥ä½¿ç”¨DMAæŠ€æœ¯æ¥åœ¨GPUå’ŒCPUä¹‹é—´å¤åˆ¶æ•°æ®ï¼ŒåŠ å¿«å¤åˆ¶é€Ÿåº¦ã€‚</p><p><img src="/images/pytorch/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/cpugpu.png"></p><h2><span id="thcapply">THCApply</span></h2><p>å’ŒTHä¸­ä¸€æ ·ï¼ŒTHCä¹Ÿæœ‰Applyç³»åˆ—å‡½æ•°ï¼Œä¸åŒçš„æ˜¯THCä¸­çš„Applyä¸å†ç”¨å®å®ç°ï¼Œè€Œæ˜¯ç”¨C++æ¨¡æ¿å‡½æ•°å®ç°ï¼Œä»£ç åœ¨<code>src/THC/THCApply.cuh</code>ã€‚</p><p>é¦–å…ˆæ¥çœ‹ç›´æ¥è¿è¡Œåœ¨GPUä¸Šçš„kernelçš„å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Op,</span><br><span class="line">          <span class="keyword">typename</span> Ta,</span><br><span class="line">          <span class="keyword">typename</span> IndexType,</span><br><span class="line">          <span class="keyword">int</span> ADims&gt;</span><br><span class="line">__global__ <span class="keyword">void</span></span><br><span class="line">kernelPointwiseApply1(<span class="keyword">const</span> OffsetInfo&lt;Ta, IndexType, ADims&gt; a,</span><br><span class="line">                      IndexType totalElements,</span><br><span class="line">                      Op op) &#123;</span><br><span class="line">  <span class="keyword">for</span> (IndexType linearIndex = (IndexType) blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">       linearIndex &lt; totalElements;</span><br><span class="line">       linearIndex += (IndexType) gridDim.x * blockDim.x) &#123;</span><br><span class="line">    op(a.get(linearIndex));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„kernelå®ç°äº†å¯¹Tensorçš„ä¸€å…ƒæ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹Tensorä¸­çš„æ¯ä¸€ä¸ªéƒ½æ•°æ®éƒ½æ‰§è¡Œ<code>op</code>æ“ä½œï¼ŒäºŒå…ƒå’Œä¸‰å…ƒæ“ä½œä¸ä¸€å…ƒæ“ä½œä»£ç ç±»ä¼¼ï¼Œå°±ä¸åˆ—å‡ºäº†ã€‚è¿™æ®µç†è§£èµ·æ¥ä¸éš¾ï¼Œåªæœ‰ä¸‰ç‚¹éœ€è¦ç‰¹æ®Šè¯´æ˜ä¸€ä¸‹ï¼š</p><p><strong>å‡½æ•°å¯¹è±¡</strong></p><p>æ¨¡æ¿å‚æ•°ä¸­çš„ <code>Op</code> æ˜¯<a href="https://www.wikiwand.com/zh-hans/%E5%87%BD%E6%95%B0%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener">å‡½æ•°å¯¹è±¡</a>ç±»å‹ï¼Œå®ƒå®ç°äº† <code>operator()</code> æ–¹æ³•ï¼Œè¿™æ ·çš„è¯å®ƒçš„å®ä¾‹å¯¹è±¡å°±å¯ä»¥ç›´æ¥å½“å‡½æ•°æ¥ç”¨ï¼Œå¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IntComparator</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> &amp;a, <span class="keyword">const</span> <span class="keyword">int</span> &amp;b)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a &lt; b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„ç”¨æ¥æ¯”è¾ƒæ•´æ•°å¤§å°çš„å‡½æ•°å¯¹è±¡ç±»å‹ï¼Œå®ƒå¯ä»¥è¿™æ ·ç”¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IntComparator op;</span><br><span class="line">op(<span class="number">1</span>, <span class="number">2</span>);<span class="comment">// true</span></span><br></pre></td></tr></table></figure><p>å‡½æ•°å¯¹è±¡ç±»ä¼¼äºå‡½æ•°æŒ‡é’ˆï¼Œä½†æœ‰ä¸¤ä¸ªä¼˜ç‚¹ï¼šç¬¬ä¸€æ˜¯ç¼–è¯‘å™¨å¯ä»¥å†…è”æ‰§è¡Œå‡½æ•°å¯¹è±¡çš„è°ƒç”¨ï¼›ç¬¬äºŒæ˜¯å‡½æ•°å¯¹è±¡å†…éƒ¨å¯ä»¥ä¿æŒçŠ¶æ€ã€‚</p><p><strong>å¾ªç¯ä¸‹æ ‡</strong></p><p>å¾ªç¯çš„ä¸‹æ ‡æ¯æ¬¡å¢åŠ  <code>gridDim.x * blockDim.x</code>ï¼Œè€Œä¸æ˜¯é€šå¸¸çš„<code>1</code>ï¼Œè¿™å°±æ¶‰åŠåˆ°kernelæ˜¯å¦‚ä½•æ‰§è¡Œçš„äº†ã€‚é¦–å…ˆkernelè¢«åˆ†é…åˆ°å¤šä¸ªGridä¸Šæ‰§è¡Œï¼Œæ¯ä¸ªGridé‡Œæœ‰å¤šä¸ªBlockï¼Œæ¯ä¸ªBlocké‡Œæœ‰å¤šä¸ªThreadï¼Œè¿™äº›çº¿ç¨‹(Thread)éƒ½æ‰§è¡Œç›¸åŒçš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯kernelã€‚ä¸ºäº†è®©è¿™äº›çº¿ç¨‹åˆ†å·¥åˆä½œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è®°å½•äº†<code>gridDim</code>, <code>blockDim</code>, <code>blockIdx</code>, å’Œ <code>threadIdx</code>ï¼Œåˆ†åˆ«ä»£è¡¨Gridç»´åº¦ï¼ŒBlockç»´åº¦ï¼ŒBlock IDï¼Œå’ŒThread IDã€‚åœ¨è¿™é‡Œï¼ŒGridå’ŒBlockéƒ½æ˜¯ä¸€ç»´çš„ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹çš„å…¨å±€IDå¯ä»¥é€šè¿‡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blockIdx.x * blockDim.x + threadIdx.x</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ï¼Œå…¶ä¸­ <code>blockIdx.x</code> è¡¨ç¤ºç¬¬å‡ ä¸ªBlockï¼Œ<code>blockDim.x</code> æ˜¯ä¸€ä¸ªBlockå†…æœ‰å¤šå°‘çº¿ç¨‹ï¼Œ<code>threadIdx.x</code> æ˜¯è¯¥çº¿ç¨‹åœ¨Blockå†…çš„IDã€‚</p><p>å†çœ‹ä¸‹æ ‡é€’å¢çš„é—´éš” <code>gridDim.x * blockDim.x</code> å®é™…ä¸Šæ˜¯æ‰§è¡Œè¿™ä¸ªkernelçš„çº¿ç¨‹ä¸ªæ•°ï¼Œå³ä¸€ä¸ªGridå†…çš„Blockæ•° <span class="math inline">\(\times\)</span> ä¸€ä¸ªBlockå†…çº¿ç¨‹æ•°ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœä¸åŒçº¿ç¨‹è¦è¯»å–çš„å†…å­˜æ˜¯è¿ç»­çš„ï¼Œåˆ™è¿™äº›å†…å­˜è¯»å–å¯ä»¥æ†ç»‘åˆ°ä¸€èµ·è¿›è¡Œï¼ŒåŠ å¿«äº†å†…å­˜è¯»å–é€Ÿåº¦ï¼Œå¦‚ä¸‹å›¾ã€‚</p><p><img src="/images/pytorch/coalesced.png"></p><p><strong>OffsetInfo</strong></p><p>æ³¨æ„åˆ°å¾ªç¯ä½“é‡Œåªæœ‰ä¸€å¥ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">op(a.get(linearIndex));</span><br></pre></td></tr></table></figure><p>æ„æ€å¯¹ç¬¬<code>linearIndex</code>ä¸ªæ•°æ®è¿›è¡Œ<code>op</code>æ“ä½œã€‚ç”±äº<code>linearIndex</code>æ˜¯çº¿æ€§åœ°å€ï¼Œå¹¶ä¸æ˜¯æ•°æ®çœŸæ­£çš„å†…å­˜åç§»ï¼Œæ‰€ä»¥ <code>a.get()</code> çš„ä½œç”¨æ˜¯æŠŠçº¿æ€§åœ°å€è½¬æ¢ä¸ºå®é™…æ•°æ®çš„å­˜å‚¨åœ°å€ï¼Œè€Œ <code>a</code> çš„ç±»å‹æ˜¯ <code>OffsetInfo&lt;Ta, IndexType, Dims&gt;</code>ã€‚</p><p>è½¬æ¢çš„ç®—æ³•å…¶å®å¾ˆç®€å•ï¼Œçº¿æ€§åœ°å€å°±æ˜¯ç¬¬å‡ ä¸ªæ•°æ®ï¼Œæ¯”å¦‚<code>x[0][0]</code>æ˜¯ç¬¬0ä¸ªæ•°æ®ï¼Œçº¿æ€§åœ°å€å°±æ˜¯0ï¼Œ<code>x[0][1]</code> çš„çº¿æ€§åœ°å€å°±æ˜¯1ï¼Œ<code>x[i][j]</code> çš„çº¿æ€§åœ°å€å°±æ˜¯ <code>i * size[0] + j</code>ã€‚è€Œä¸”æˆ‘ä»¬çŸ¥é“ <code>x[i][j]</code> çš„å†…å­˜åç§»ä¸º <code>i * strides[0] + j * strides[1]</code>ï¼Œé‚£ä¹ˆè½¬æ¢ç®—æ³•è¦åšçš„å°±æ˜¯æŠŠçº¿æ€§åœ°å€è½¬æ¢ä¸º <code>ijk</code> ä¸‹æ ‡ï¼Œç„¶åå†æŠŠä¸‹æ ‡è½¬åŒ–ä¸ºå†…å­˜åœ°å€ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> IndexType&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IndexToOffset</span>&lt;T, IndexType, -1&gt; &#123;</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">inline</span> __host__ __<span class="function">device__ IndexType <span class="title">get</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IndexType linearId,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> TensorInfo&lt;T, IndexType&gt;&amp; info)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    IndexType offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»æœ€å¤–å›´ä¸‹æ ‡å¼€å§‹è®¡ç®—</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = info.dims - <span class="number">1</span>; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">    <span class="comment">// æ±‚å‡ºç¬¬iç»´ä¸‹æ ‡</span></span><br><span class="line">      IndexType curDimIndex = linearId % info.sizes[i];</span><br><span class="line">      <span class="comment">// è½¬æ¢ä¸ºå†…å­˜åç§»</span></span><br><span class="line">      IndexType curDimOffset = curDimIndex * info.strides[i];</span><br><span class="line">      <span class="comment">// å’Œæ€»åç§»ç›¸åŠ </span></span><br><span class="line">      offset += curDimOffset;</span><br><span class="line">      <span class="comment">// è®¡ç®—ç¬¬i-1ç»´çš„çº¿æ€§åœ°å€</span></span><br><span class="line">      linearId /= info.sizes[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> offset + linearId * info.strides[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»†å¿ƒçš„è¯»è€…å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œä¸Šé¢çš„å‡½æ•°æ˜¯ <code>IndexToOffset</code> çš„æ–¹æ³•ï¼Œå¹¶ä¸æ˜¯ <code>OffsetInfo</code> çš„ï¼Œå®é™…ä¸Šåè€…å¯¹éè´Ÿæ•´æ•°é™¤æ³•å’Œå–ä½™è¿›è¡Œäº†ä¼˜åŒ–ï¼ŒæŠŠé™¤æ³•è½¬æ¢ä¸ºä¸€ç³»åˆ—ä¹˜æ³•ï¼Œä»è€ŒåŠ å¿«è®¡ç®—é€Ÿåº¦ã€‚</p><p>å¤§è‡´æ€æƒ³æ˜¯è¿™æ ·çš„ï¼Œå‡è®¾æˆ‘ä»¬è¦è®¡ç®— <span class="math inline">\(\lfloor\frac{n}{d}\rfloor\)</span>ï¼Œå¯¹ä»»æ„Nä½éè´Ÿæ•´æ•°<span class="math inline">\(d\)</span>ï¼Œæ€»å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª magic number <span class="math inline">\(m\)</span> å’Œ <span class="math inline">\(s\)</span>ï¼Œä½¿å¾—ï¼š <span class="math display">\[\lfloor\frac{n}{d}\rfloor=\lfloor\frac{m\times n}{2^{N+s}}\rfloor\]</span> è¿™æ ·å°±æŠŠé™¤æ³•æ“ä½œè½¬åŒ–ä¸ºä¹˜æ³•å’Œå³ç§»äº†ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆæ‰¾ <span class="math inline">\(m\)</span> å’Œ <span class="math inline">\(s\)</span> å‘¢ï¼Œéå¸¸ç®€å•ï¼š <span class="math display">\[s=\lceil\log_2 d\rceil \\m = \lfloor 2^N\times\frac{(2^s-d)}{d}\rfloor+2^N+1\]</span> å¯¹äºå›ºå®šçš„é™¤æ•° <span class="math inline">\(d\)</span>ï¼Œè¿™ä¸¤ä¸ªå‚æ•°æ˜¯ä¸ä¼šå˜çš„ï¼Œå¦‚æœéœ€è¦å¤šæ¬¡é™¤ä»¥ <span class="math inline">\(d\)</span>ï¼Œåˆ™å¯ä»¥æå‰è®¡ç®—å¥½ <span class="math inline">\(m\)</span> å’Œ <span class="math inline">\(s\)</span>ï¼Œåœ¨è®¡ç®—æ—¶åŠ å¿«é€Ÿåº¦ã€‚æ³¨æ„åˆ°è®¡ç®— <span class="math inline">\(m\)</span> æ—¶ä¹Ÿæ˜¯éœ€è¦é™¤æ³•è¿ç®—çš„ï¼Œæ‰€ä»¥å¦‚æœè¿™ä¸ªé™¤æ•°åªç”¨ä¸€æ¬¡çš„è¯ï¼Œé‚£ä¹ˆç”¨å¿«é€Ÿé™¤æ³•æ˜¯æ²¡æ„ä¹‰çš„ï¼ˆé™¤é<span class="math inline">\(m\)</span>æ˜¯åœ¨ç¼–è¯‘æœŸè®¡ç®—çš„ï¼‰ã€‚å…³äºè¿™ä¸ªå¼å­çš„è¯æ˜å’Œæ¨å¯¼çœ‹<a href="http://ridiculousfish.com/blog/posts/labor-of-division-episode-i.html" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><p>ä»£ç ä¸­ï¼Œ<code>OffsetInfo</code> çš„å®ç°å®é™…ä¸Šæ˜¯è·Ÿæ¨¡æ¿å‚æ•° <code>Dims</code> ç›¸å…³çš„ï¼Œå¦‚æœç»´åº¦èƒ½åœ¨ç¼–è¯‘æœŸç»™å‡ºçš„è¯ï¼ˆå€¼é-1ï¼‰ï¼Œåˆ™åœ¨ç”Ÿæˆ <code>OffsetInfo</code> å¯¹è±¡æ—¶è®¡ç®— <span class="math inline">\(m\)</span> å’Œ <span class="math inline">\(s\)</span>ï¼Œä»¥å¤‡ä¹‹åä½¿ç”¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> IndexType, <span class="keyword">int</span> Dims&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OffsetInfo</span> &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">OffsetInfo</span><span class="params">(<span class="keyword">const</span> TensorInfo&lt;T, IndexType&gt;&amp; tinfo)</span> </span>&#123;</span><br><span class="line">    assert(tinfo.dims == Dims);</span><br><span class="line">    data = tinfo.data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Dims; ++i) &#123;</span><br><span class="line">    <span class="comment">// æå‰è®¡ç®— m, s (å®ç°åœ¨ IntDivider ç±»ä¸­)</span></span><br><span class="line">      sizes[i] = IntDivider&lt;IndexType&gt;(tinfo.sizes[i]);</span><br><span class="line">      strides[i] = tinfo.strides[i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  __host__ __<span class="function">device__ T* <span class="title">get</span><span class="params">(IndexType linearIndex)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    IndexType offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = Dims - <span class="number">1</span>; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨å¿«é€Ÿé™¤æ³•</span></span><br><span class="line">      DivMod&lt;IndexType&gt; divmod = sizes[i].divmod(linearIndex);</span><br><span class="line">      linearIndex = divmod.div;</span><br><span class="line">      offset += divmod.mod * strides[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;data[offset + linearIndex * strides[<span class="number">0</span>]];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  T* data;</span><br><span class="line">  <span class="comment">// Dims æ˜¯ç¼–è¯‘æœŸå¸¸é‡ï¼Œæ‰€ä»¥ sizes å’Œ strides æ˜¯é™æ€åˆ†é…çš„</span></span><br><span class="line">  IntDivider&lt;IndexType&gt; sizes[Dims];</span><br><span class="line">  IndexType strides[Dims];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœåˆ›å»º <code>OffsetInfo</code> æ—¶ï¼Œ<code>Dims</code> çš„å€¼ä¸º-1çš„è¯ï¼Œä»£è¡¨Tensorçš„å¤§å°ä¸æ˜¯å›ºå®šçš„ï¼Œè¿™æ ·çš„è¯ <code>OffsetInfo::sizes</code> å’Œ <code>OffsetInfo::strides</code> æ˜¯åŠ¨æ€åˆ†é…çš„ï¼Œå°±ä¼šè§¦å‘NVCCçš„ä¸€ä¸ªbugï¼š<em>if a kernel argument contains an array that is dynamically accessed, the whole array is first copied into the local memory. Pre-computation makes it worse because now we have more data to copy.</em></p><p>æ‰€ä»¥å¯¹äºå¤§å°ä¸å›ºå®šï¼ˆç¼–è¯‘æœŸä¸èƒ½ç»™å‡ºå…·ä½“ç»´åº¦ï¼‰çš„Tensoré‡‡ç”¨ä¹‹å‰çš„åŠæ³•è®¡ç®—ï¼Œè¿™é‡Œä½¿ç”¨äº†ç‰¹åŒ–æ¨¡æ¿åŒ¹é… <code>Dims</code> ä¸º-1çš„æƒ…å†µï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> IndexType&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OffsetInfo</span>&lt;T, IndexType, -1&gt; &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">OffsetInfo</span><span class="params">(<span class="keyword">const</span> TensorInfo&lt;T, IndexType&gt;&amp; tinfo)</span></span></span><br><span class="line">    : tinfo(tinfo) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  __host__ __<span class="function">device__ T* <span class="title">get</span><span class="params">(IndexType linearIndex)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ç›´æ¥è°ƒç”¨ä¹‹å‰åˆ—å‡ºçš„ IndexToOffset::get æ–¹æ³•</span></span><br><span class="line">    IndexType offset = IndexToOffset&lt;T, IndexType, <span class="number">-1</span>&gt;::get(linearIndex, tinfo);</span><br><span class="line">    <span class="keyword">return</span> &amp;tinfo.data[offset];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  TensorInfo&lt;T, IndexType&gt; tinfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p>æ€»ç»“ä¸€ä¸‹ï¼ŒTHCä¸­çš„APIçš„å£°æ˜å’Œå®ç°éƒ½åœ¨ <code>generic</code> ç›®å½•ä¸‹ï¼ŒAPIçš„å½¢å¼æ˜¯Cé£æ ¼èŒƒå¼ï¼š<code>THCTensor_(xxx)(...)</code> ã€‚è¿™äº›å‡½æ•°å‡ ä¹éƒ½ä¼šè°ƒç”¨ apply ç³»åˆ—å‡½æ•°æ¥åœ¨GPUä¸­å®ç°å…·ä½“åŠŸèƒ½ï¼Œè€Œ apply å‡½æ•°çš„æ ¸å¿ƒåœ¨äºä¼ å…¥çš„OPï¼Œè¿™äº›OPéƒ½å®šä¹‰åœ¨ <code>THC/</code> æ ¹ç›®å½•ä¸‹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¥çœ‹ä¸€ä¸‹ <code>THCTensor_fill(state, self, value)</code> æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯æŠŠ <code>self</code> Tensor çš„æ¯ä¸ªå…ƒç´ èµ‹å€¼ä¸º <code>value</code>ã€‚è¿™ä¸ªAPIçš„å®šä¹‰åœ¨ <code>THC/generic/THCTensorMath.cu</code>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THCTensor_</span><span class="params">(fill)</span><span class="params">(THCState* state, THCTensor *self_, <span class="keyword">scalar_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  THCAssertSameGPU(THCTensor_(checkGPU)(state, <span class="number">1</span>, self_));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!THC_pointwiseApply1&lt;<span class="keyword">scalar_t</span>&gt;(</span><br><span class="line">        state, self_, TensorFillOp&lt;<span class="keyword">scalar_t</span>&gt;(value))) &#123;</span><br><span class="line">    THArgCheck(<span class="literal">false</span>, <span class="number">1</span>, CUTORCH_DIM_WARNING);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  THCudaCheck(cudaGetLastError());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">THC_pointwiseApply1&lt;<span class="keyword">scalar_t</span>&gt;(state, self_, TensorFillOp&lt;<span class="keyword">scalar_t</span>&gt;(value))</span><br></pre></td></tr></table></figure><p>è¿™å¥è¯è°ƒç”¨ä¸€å…ƒ apply å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°ä¸º THCState, è¦æ“ä½œçš„Tensorå’Œç›¸åº”OPã€‚<code>THC_pointwiseApply1()</code> ä¼šè¿›è¡Œä¸€äº›ç‰¹æ®Šæƒ…å†µçš„å¤„ç†å’Œä¼˜åŒ–ï¼Œæœ€åè°ƒç”¨ä¹‹å‰åˆ—å‡ºçš„apply kernelæ‰§è¡Œç›¸åº”OPã€‚</p><p><code>TensorFillOp</code> å®šä¹‰åœ¨ <code>THC/THCTensorMath.cu</code> ä¸­ï¼Œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TensorFillOp</span> &#123;</span></span><br><span class="line">  TensorFillOp(T v) : val(v) &#123;&#125;</span><br><span class="line">  __device__ __<span class="function">forceinline__ <span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(T* v)</span> </span>&#123; *v = val; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> T val;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°å¡«å…¥Tensorçš„å€¼è¢«ä¿å­˜ä¸ºç±»çš„å¸¸é‡ï¼Œè€Œä¸æ˜¯ä½œä¸º <code>operator()</code> çš„å‚æ•°ï¼Œè¿™æ ·æ‰èƒ½ç»Ÿä¸€æ¥å£ï¼Œæ‰èƒ½è¢« <code>kernelPointwiseApply1()</code> ç›´æ¥è°ƒç”¨ã€‚</p><p>è°ƒç”¨è¿‡ç¨‹çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/images/pytorch/THCTensor_fill.png"></p><p>ã¤ã¥ã</p><table><thead><tr class="header"><th style="text-align: left;">ä¸Šä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch1/">THTensor</a></th><th style="text-align: right;">ä¸‹ä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch3/">NN</a></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"></td><td style="text-align: right;"></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡ä¸»è¦çœ‹ Torch CUDA éƒ¨åˆ†ï¼Œå¯¹åº”æºç ç›®å½• &lt;code&gt;aten/src/THC&lt;/code&gt;ï¼Œé‡Œé¢åŒ…å«äº†è®¸å¤šC++å’ŒCUDAä»£ç ã€‚è¿™éƒ¨åˆ†å®ç°äº†æ“ä½œ THCTensor å’Œ THCStorage çš„æ¥å£ï¼Œä¸è¿‡åº•å±‚ç”¨çš„æ•°æ®ç»“æ„è¿˜æ˜¯ &lt;code&gt;TensorImpl&lt;/code&gt; å’Œ &lt;code&gt;StorageImpl&lt;/code&gt;ã€‚THCé‡Œçš„æ¥å£ä¹Ÿæ˜¯é€šè¿‡Cè¯­è¨€èŒƒå¼å®ç°çš„ï¼Œä½†æ˜¯Applyç³»åˆ—æ“ä½œä¸å†ç”±å®æ¥å®ç°ï¼Œè€Œæ˜¯ä½¿ç”¨äº†C++æ¨¡æ¿ã€‚å…¶ä»–çš„åŒºåˆ«è¿˜æœ‰allocatorä¸åŒï¼Œä»¥åŠå¤šäº† THCState ç»“æ„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="PyTorch" scheme="http://www.52coding.com.cn/tags/PyTorch/"/>
    
      <category term="Tensor" scheme="http://www.52coding.com.cn/tags/Tensor/"/>
    
      <category term="CUDA" scheme="http://www.52coding.com.cn/tags/CUDA/"/>
    
      <category term="THC" scheme="http://www.52coding.com.cn/tags/THC/"/>
    
  </entry>
  
  <entry>
    <title>PyTorchæºç æµ…æ(1)ï¼šTHTensor</title>
    <link href="http://www.52coding.com.cn/2019/05/05/PyTorch1/"/>
    <id>http://www.52coding.com.cn/2019/05/05/PyTorch1/</id>
    <published>2019-05-05T07:51:01.000Z</published>
    <updated>2019-05-05T08:13:05.281Z</updated>
    
    <content type="html"><![CDATA[<p>PyTorchä¸­Tensorçš„å­˜å‚¨å’Œè¡¨ç¤ºåˆ†å¼€ï¼Œå¤šä¸ªTHTensorå¯èƒ½å…±äº«ä¸€ä¸ªTHStorageï¼Œæ¯ä¸ªTHTensorå¯èƒ½æ‹¥æœ‰ä¸åŒçš„viewï¼ˆe.g. size, strideï¼‰ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œæœ‰æ—¶çœ‹èµ·æ¥ä¸ä¸€æ ·çš„æ•°æ®åº•å±‚æ˜¯å…±äº«çš„ï¼Œæ¯”å¦‚çŸ©é˜µä¸çŸ©é˜µçš„è½¬ç½®ã€äºŒç»´çŸ©é˜µä¸äºŒç»´çŸ©é˜µå˜æˆä¸€ç»´æ—¶çš„çŸ©é˜µã€‚è¿™éƒ¨åˆ†çš„ä¸»åŠ›å®ç°åœ¨ <code>pytorch/aten</code> æ–‡ä»¶å¤¹ä¸­ï¼Œè¿™é‡Œé¢æ—¢å®ç°äº†åº•å±‚çš„Tensoræ“ä½œåº“ï¼Œä¹Ÿå°è£…äº†åä¸º <strong>ATen</strong> çš„ C++11æ¥å£ã€‚</p><a id="more"></a><p><code>aten/src</code>é‡Œæœ‰å‡ ä¸ªé‡è¦çš„æ–‡ä»¶å¤¹ï¼Œå®ƒä»¬å®ç°çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">â”œâ”€â”€ ATen        # Tensoræ“ä½œçš„C++11æ¥å£</span><br><span class="line">â”œâ”€â”€ TH          # CPU Tensor çš„åº•å±‚å®ç°ï¼ˆæœ¬ç¯‡å†…å®¹ï¼‰</span><br><span class="line">â”œâ”€â”€ THC         # GPU Tensor (CUDA) çš„åº•å±‚å®ç°ï¼ˆåœ¨ä¸‹ä¸€ç¯‡è®²ï¼‰</span><br><span class="line">â”œâ”€â”€ THCUNN      # CUDAç‰ˆåº•å±‚ç¥ç»ç½‘ç»œå®ç°(ä¸‹ä¸‹ç¯‡è®²)</span><br><span class="line">â””â”€â”€ THNN        # CPUç‰ˆåº•å±‚ç¥ç»ç½‘ç»œå®ç°(ä¸‹ä¸‹ç¯‡è®²)</span><br></pre></td></tr></table></figure><p>è¿™ç¯‡è®²çš„ä¸»è¦ä»£ç ä¹Ÿéƒ½åœ¨THæ–‡ä»¶å¤¹å†…ã€‚</p><p>ç›®å½•</p><!-- toc --><ul><li><a href="#thtensor-thstorage">THTensor &amp; THStorage</a><ul><li><a href="#tensorimpl">TensorImpl</a></li><li><a href="#storageimpl">StorageImpl</a></li></ul></li><li><a href="#æ™ºèƒ½æŒ‡é’ˆ-intrusive_ptr">æ™ºèƒ½æŒ‡é’ˆ Intrusive_ptr</a></li><li><a href="#tensor-apply-dynamic-dispatch">Tensor Apply &amp; Dynamic Dispatch</a></li></ul><!-- tocstop --><h2><span id="thtensor-amp-thstorage">THTensor &amp; THStorage</span></h2><p> THé‡Œé¢çš„æ ¸å¿ƒç±»å‹å°±æ˜¯<code>THTensor</code>å’Œ<code>THStorage</code>äº†ï¼Œå‰è€…æ˜¯Tensorçš„viewï¼Œåè€…æ˜¯Tensoræ•°æ®çš„å­˜å‚¨åœ°å€ã€‚ç”±äºTensorçš„æ•°æ®ç±»å‹å¯ä»¥æ˜¯å¤šç§å¤šæ ·çš„ï¼Œè€Œæ¯ç§ç±»å‹çš„APIéƒ½ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°èŒƒå‹æ¥å‡å°‘é‡å¤ä»£ç ï¼ŒTHä¸­æ˜¯ä½¿ç”¨å®å®ç°èŒƒå‹åŠŸèƒ½ï¼ˆå› ä¸ºTorchä¸€å¼€å§‹æ˜¯ç”¨Cå®ç°çš„ï¼‰ï¼Œä¸äº†è§£çš„è¯»è€…å¯ä»¥å…ˆå‚è€ƒä¸€ä¸‹<a href="https://zhuanlan.zhihu.com/p/34496542" target="_blank" rel="noopener">è¿™ç¯‡çŸ¥ä¹ä¸“æ </a>ã€‚</p><p><code>THTensor</code>çš„å®šä¹‰åœ¨<code>aten/src/TH/generic/THTensor.h</code>ä¸­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THTensor at::TensorImpl</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THFloatTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THDoubleTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THHalfTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THByteTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THCharTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THShortTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THIntTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THLongTensor THTensor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THBoolTensor THTensor</span></span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œ<code>THStorage</code>çš„å®šä¹‰åœ¨<code>Aten/src/TH/generic/THStorage.h</code>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THStorage at::StorageImpl</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THFloatStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THDoubleStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THHalfStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THByteStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THCharStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THShortStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THIntStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THLongStorage THStorage</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THBoolStorage THStorage</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>THTensor.h</code>ä¸­æœ‰å¾ˆå¤šç±»ä¼¼è¿™æ ·çš„APIå£°æ˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TH_API THStorage* <span class="title">THTensor_</span><span class="params">(storage)</span><span class="params">(<span class="keyword">const</span> THTensor *self)</span></span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>THTensor_</code>çš„å®å®šä¹‰ä¸º</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THTensor_(NAME)   TH_CONCAT_4(TH,Real,Tensor_,NAME)</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ <code>TH_CONCAT_4</code> å®å°±æ˜¯æŠŠå®ƒçš„å››ä¸ªå‚æ•°è¿æ¥èµ·æ¥ï¼Œå…¶ä¸­ <code>Real</code> ä¼šè¢«å®šä¹‰ä¸ºå®é™…ç±»å‹ï¼ˆFloat, Boolç­‰ï¼‰ï¼Œæ‰€ä»¥ä¸Šé¢çš„APIä¼šè¢«å±•å¼€æˆï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">at::<span class="function">StorageImpl <span class="title">THFloatTensor_storage</span><span class="params">(<span class="keyword">const</span> at::TensorImpl *self)</span></span>;</span><br><span class="line">at::<span class="function">StorageImpl <span class="title">THBoolTensor_storage</span><span class="params">(<span class="keyword">const</span> at::TensorImpl *self)</span></span>;</span><br><span class="line">at::<span class="function">StorageImpl <span class="title">THLongTensor_storage</span><span class="params">(<span class="keyword">const</span> at::TensorImpl *self)</span></span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>åœ¨è¿™äº›APIä¸­è¿˜ä¼šç”¨åˆ° <code>scalar_t</code> ç±»å‹ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªå®ï¼Œç‰¹åŒ–çš„æ—¶å€™ä¼šä¼ å…¥å…·ä½“çš„ç±»å‹ï¼ˆå¦‚ç”¨æ¥ç¡®ä¿ <code>THFloatTensor</code> é‡Œçš„ <code>StorageImpl</code> å­˜å‚¨çš„floatç±»å‹ï¼‰ã€‚</p><p>ä¸éš¾å‘ç°ï¼Œæ‰€æœ‰çš„THTensorç±»å‹æœ€ç»ˆéƒ½ä¼šæ›¿æ¢æˆ <code>at::TensorImpl</code>ï¼Œæ‰€æœ‰çš„THStorageç±»å‹ä¹Ÿéƒ½ä¼šæ›¿æ¢æˆ <code>at::StorageImpl</code>ï¼Œå‰è€…çš„å®ç°åœ¨<code>c10/core/TensorImpl.h</code>ä¸­ï¼Œåè€…çš„å®ç°åœ¨<code>c10/core/StorageImpl.h</code>ä¸­ã€‚è¿™ä¸¤ä¸ªç±»å‹çš„å®ç°åœ¨c10ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´Tensorç±»å‹çš„å®ç°è½¬ç§»åˆ°äº†c10ä¸­ï¼Œä½†APIçš„å®ç°ä¾ç„¶åœ¨THä¸­ã€‚</p><h3><span id="tensorimpl">TensorImpl</span></h3><p>æ¥ç€å…·ä½“æ¥çœ‹ä¸€ä¸‹<code>TensorImpl</code>çš„å®ç°ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„å£°æ˜å’Œå±æ€§ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C10_API</span> <span class="title">TensorImpl</span> :</span> <span class="keyword">public</span> c10::intrusive_ptr_target &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  <span class="comment">// æŒ‡å‘å®é™…æ•°æ®å­˜å‚¨ä½ç½®ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘StorageImpl</span></span><br><span class="line">  Storage storage_;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// ç”¨äºè‡ªåŠ¨å¾®åˆ†ï¼Œåªå¯¹Variableé€‚ç”¨</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;c10::AutogradMetaInterface&gt; autograd_meta_ = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  SmallVector&lt;<span class="keyword">int64_t</span>,<span class="number">5</span>&gt; sizes_;  <span class="comment">// Tensorçš„å®é™…å¤§å°</span></span><br><span class="line">  SmallVector&lt;<span class="keyword">int64_t</span>,<span class="number">5</span>&gt; strides_;<span class="comment">// å„ä¸ªç»´åº¦ç›´æ¥çš„é—´éš”</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int64_t</span> storage_offset_ = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int64_t</span> numel_ = <span class="number">1</span>;<span class="comment">// Tensorä¸­å…ƒç´ ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯sizes_æ•°ç»„ä¸­å…ƒç´ çš„ä¹˜ç§¯</span></span><br><span class="line"></span><br><span class="line">  caffe2::TypeMeta data_type_;<span class="comment">// æ•°æ®ç±»å‹</span></span><br><span class="line"></span><br><span class="line">  TensorTypeId type_id_;</span><br><span class="line">  <span class="keyword">bool</span> is_contiguous_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">bool</span> is_variable_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> is_wrapped_number_ = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">bool</span> allow_tensor_metadata_change_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">bool</span> reserved_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TensorImpl</code>ç»§æ‰¿è‡ª<code>intrusive_ptr_target</code>ï¼Œåè€…æ˜¯ä¸ºäº†é€šè¿‡ä½¿ç”¨<code>intrusive_ptr&lt;T&gt;</code>å®ç°å¼•ç”¨è®¡æ•°è€Œè®¾è®¡çš„åŸºç±»ï¼Œéœ€è¦å®ç°å¼•ç”¨è®¡æ•°çš„ç±»åªéœ€ç»§æ‰¿å®ƒå³å¯ã€‚<code>TensorImpl</code>ä¸­çš„æ¯ä¸ªæˆå‘˜æ˜¯å¹²ä»€ä¹ˆçš„åŸºæœ¬éƒ½æœ‰æ³¨é‡Šï¼Œå…¶ä¸­<code>strides_</code>æ˜¯ç”¨æ¥å®ç°å†…å­˜å¯»å€çš„ï¼Œå³æŸä¸ªijkè„šæ ‡å¯¹åº”çš„å†…å­˜åœ°å€ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storage_offset_ + i * strides_[<span class="number">0</span>] + j * strides_[<span class="number">1</span>] + k * strides_[<span class="number">2</span>]</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æƒ…å†µä¸‹ç”¨<code>sizes_</code>ä»£æ›¿<code>strides_</code>å¯ä»¥å®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰çš„Tensoræ˜¯ç”±è¾ƒå¤§çš„Tensoråˆ†å‰²è€Œæ¥ï¼Œç»´åº¦ä¹‹é—´çš„é—´éš”ä¸æ˜¯<code>sizes_</code>ï¼Œæ‰€ä»¥éœ€è¦ç”¨å¦ä¸€ä¸ªæ•°ç»„<code>strides_</code>å­˜å‚¨ç»´åº¦é—´éš”ã€‚</p><p><code>TensorImpl</code>ä¸­çš„æ–¹æ³•è¾ƒå¤šï¼Œå°±ä¸ä¸€ä¸€åˆ—å‡ºäº†ï¼Œå®ç°äº†å¯¹Tensorï¼ˆå’ŒVariableï¼‰çš„åŸºæœ¬æ“ä½œï¼ŒAtenä¸­çš„APIä¹Ÿæ˜¯åŸºäºè¿™äº›åŸºæœ¬æ“ä½œå®ç°çš„ã€‚</p><p><strong><code>Variable</code>ä¸<code>Tensor</code>çš„åˆå¹¶</strong></p><p>åœ¨æ—©æœŸçš„PyTorchç‰ˆæœ¬ä¸­ï¼ŒVariableä¸Tensoræ˜¯ä¸åŒçš„ç±»ï¼ŒVariableç”¨æ¥ä¿å­˜éœ€è¦è®¡ç®—æ¢¯åº¦çš„Tensorï¼Œä½†Variableçš„å®ç°å¹¶ä¸ç¾å¥½ï¼šä¸€æ–¹é¢<code>Variable::Impl</code>æ˜¯Tensorçš„å­ç±»ï¼Œè€Œå®ƒçš„æˆå‘˜é‡Œåˆæ‹¥æœ‰ä¸€ä¸ªTensorï¼ˆå­˜å‚¨æ•°æ®ï¼‰ï¼Œè¿™è¿åäº†<a href="https://www.wikiwand.com/zh-hans/%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99" target="_blank" rel="noopener">é‡Œæ°æ›¿æ¢åŸåˆ™</a>ï¼Œè€Œä¸”è®©Tensorçš„å®ç°å˜å¾—å¾ˆå¤æ‚ã€‚è€Œåœ¨ç°ç‰ˆæœ¬ä¸­ï¼Œå·²ç»æŠŠVariableå˜æˆTensoräº†ï¼ŒæŠŠä¸€äº›<code>Variable</code>ç‰¹æœ‰çš„æ–¹æ³•ï¼ˆe.g. <code>set_requires_grad</code>, <code>requires_grad</code>ï¼‰ç§»åˆ°äº†<code>TensorImpl</code>é‡Œã€‚</p><h3><span id="storageimpl">StorageImpl</span></h3><p><code>StorageImpl</code>çš„å£°æ˜å’Œå±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C10_API</span> <span class="title">StorageImpl</span> <span class="title">final</span> :</span> <span class="keyword">public</span> c10::intrusive_ptr_target &#123;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  caffe2::TypeMeta data_type_;  <span class="comment">// æ•°æ®ç±»å‹</span></span><br><span class="line">  DataPtr data_ptr_;            <span class="comment">// æŒ‡å‘å­˜å‚¨æ•°æ®çš„å†…å­˜å—</span></span><br><span class="line">  <span class="keyword">int64_t</span> numel_;               <span class="comment">// æ•°æ®æ€»æ•°</span></span><br><span class="line">  <span class="keyword">bool</span> resizable_;</span><br><span class="line">  Allocator* allocator_;        <span class="comment">// å†…å­˜åˆ†é…å™¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>caffe2::TypeMeta data_type_</code> å­˜å‚¨äº†æ•°æ®ç±»å‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šç±»å‹idã€å¤§å°ã€ç±»å‹åå­—ç­‰ï¼›<code>DataPtr</code> å…¶å®å°±æ˜¯ <em>unique_ptr</em>ï¼Œä½†æŒ‡é’ˆç±»å‹å›ºå®šä¸º <code>void*</code>ã€‚</p><p><strong>åˆ†é…å†…å­˜</strong></p><p>åœ¨ <code>Allocator.cpp</code> ä¸­å®šä¹‰äº†å…¨å±€å˜é‡ <code>allocator_array</code> æ¥å­˜å‚¨æ‰€æœ‰çš„ allocatorï¼Œæ¯ä¸ªè®¾å¤‡ç±»å‹å¯¹åº”ä¸€ä¸ªï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C10_API at::Allocator* allocator_array[at::COMPILE_TIME_MAX_DEVICE_TYPES];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetAllocator</span><span class="params">(at::DeviceType t, at::Allocator* alloc)</span> </span>&#123;</span><br><span class="line">  allocator_array[<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(t)] = alloc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">at::<span class="function">Allocator* <span class="title">GetAllocator</span><span class="params">(<span class="keyword">const</span> at::DeviceType&amp; t)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span>* alloc = allocator_array[<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(t)];</span><br><span class="line">  AT_ASSERTM(alloc, <span class="string">"Allocator for "</span>, t, <span class="string">" is not set."</span>);</span><br><span class="line">  <span class="keyword">return</span> alloc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶é…å¤‡äº† <code>SetAllocator</code> å’Œ <code>GetAllocator</code> æ¥è®¾ç½®å’Œè·å–ç›¸åº”çš„åˆ†é…å™¨ã€‚</p><p><code>Allocator</code> æ˜¯ä¸€ä¸ªè™šåŸºç±»ï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C10_API</span> <span class="title">Allocator</span> &#123;</span></span><br><span class="line">  <span class="keyword">virtual</span> ~Allocator() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> DataPtr <span class="title">allocate</span><span class="params">(<span class="keyword">size_t</span> n)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡è½½è¿™ä¸ªå‡½æ•°å¾ˆå…³é”®ï¼Œç”¨æ¥é‡Šæ”¾ç”³è¯·åˆ°çš„å†…å­˜</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> DeleterFnPtr <span class="title">raw_deleter</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span>* <span class="title">raw_allocate</span><span class="params">(<span class="keyword">size_t</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> dptr = allocate(n);</span><br><span class="line">    AT_ASSERT(dptr.get() == dptr.get_context());</span><br><span class="line">    <span class="keyword">return</span> dptr.release_context();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">raw_deallocate</span><span class="params">(<span class="keyword">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> d = raw_deleter();</span><br><span class="line">    AT_ASSERT(d);</span><br><span class="line">    d(ptr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåˆ†é…å™¨æœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ³•ï¼Œç¬¬ä¸€ç§å°±æ˜¯ç›´æ¥è°ƒç”¨ <code>raw_allocate</code> å’Œ <code>raw_deallocate</code> åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯è°ƒç”¨ <code>Allocator::allocate</code>ï¼Œè¿™ä¸ªæ–¹æ³•å°†è¿”å›ä¸€ä¸ª <code>DataPtr</code> ç±»å‹çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ <em>unique_ptr</em>ï¼Œç”±äºdeleterå­˜å‚¨åœ¨æŒ‡é’ˆä¸­ï¼Œåœ¨é‡Šæ”¾æŒ‡é’ˆçš„æ—¶å€™ä¼šé‡Šæ”¾ç›¸åº”çš„å†…å­˜ã€‚ä¸è¿‡ä¸¤ç§æ–¹æ³•çš„æ­£ç¡®æ€§éƒ½ä¾èµ–äº <code>Allocator::raw_deleter</code> èƒ½æ­£ç¡®è¿”å›ç›¸åº”çš„é‡Šæ”¾å™¨ï¼ˆdeleterï¼‰ï¼Œå¦åˆ™ä¸¤ç§æ–¹æ³•éƒ½ä¸èƒ½æ­£ç¡®é‡Šæ”¾å†…å­˜ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡Šæ”¾å™¨ï¼ˆdeleterï¼‰æœªå¿…å°±æ˜¯Cåº“å‡½æ•°<code>free</code>ï¼šæ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒï¼Œä¹Ÿå¯èƒ½æ˜¯ <code>_aligned_free</code>ï¼›æ ¹æ®è®¾å¤‡çš„ä¸åŒä¹Ÿå¯èƒ½æ˜¯å…¶ä»–å‡½æ•°ã€‚</p><p>ä¸‹é¢æ˜¯åœ¨CPUä¸Šå†…å­˜åˆ†é…çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C10_API</span> <span class="title">DefaultCPUAllocator</span> <span class="title">final</span> :</span> at::Allocator &#123;</span><br><span class="line">  ...</span><br><span class="line">      </span><br><span class="line">  at::<span class="function">DataPtr <span class="title">allocate</span><span class="params">(<span class="keyword">size_t</span> nbytes)</span> <span class="keyword">const</span> override </span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* data = alloc_cpu(nbytes);</span><br><span class="line">    <span class="keyword">if</span> (FLAGS_caffe2_report_cpu_memory_usage &amp;&amp; nbytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      getMemoryAllocationReporter().New(data, nbytes);</span><br><span class="line">      <span class="keyword">return</span> &#123;data, data, &amp;ReportAndDelete, </span><br><span class="line">              at::Device(at::DeviceType::CPU)&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™å››ä¸ªå‚æ•°ç”¨æ¥æ„é€ ä¸€ä¸ªDataPtr</span></span><br><span class="line">    <span class="keyword">return</span> &#123;data, data, &amp;free_cpu, </span><br><span class="line">            at::Device(at::DeviceType::CPU)&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  at::<span class="function">DeleterFnPtr <span class="title">raw_deleter</span><span class="params">()</span> <span class="keyword">const</span> override </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FLAGS_caffe2_report_cpu_memory_usage) &#123;</span><br><span class="line">      <span class="keyword">return</span> &amp;ReportAndDelete;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;free_cpu;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">alloc_cpu</span><span class="params">(<span class="keyword">size_t</span> nbytes)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (nbytes == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span>* data;</span><br><span class="line">  <span class="comment">// åˆ†é…64å­—èŠ‚å¯¹é½çš„è¿ç»­å†…å­˜å—</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID__</span></span><br><span class="line">  data = memalign(gAlignment, nbytes);<span class="comment">// gAlignment = 64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_MSC_VER)</span></span><br><span class="line">  data = _aligned_malloc(nbytes, gAlignment);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  CAFFE_ENFORCE_EQ(posix_memalign(&amp;data, gAlignment, nbytes), <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç§»åŠ¨æ•°æ®åˆ°çº¿ç¨‹çš„NUMAèŠ‚ç‚¹ä¸­</span></span><br><span class="line">  NUMAMove(data, nbytes, GetCurrentNUMANode());</span><br><span class="line"><span class="comment">// å¡«å……å†…å­˜</span></span><br><span class="line">  <span class="keyword">if</span> (FLAGS_caffe2_cpu_allocator_do_zero_fill) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(data, <span class="number">0</span>, nbytes);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FLAGS_caffe2_cpu_allocator_do_junk_fill) &#123;</span><br><span class="line">    memset_junk(data, nbytes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_cpu</span><span class="params">(<span class="keyword">void</span>* data)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line">  _aligned_free(data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="built_in">free</span>(data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†é…æ—¶ä½¿ç”¨ <code>memalign/_aligned_malloc/posix_memalign</code> å‡½æ•°ç¡®ä¿å†…å­˜æ˜¯64å­—èŠ‚å¯¹é½çš„ã€‚</p><h2><span id="æ™ºèƒ½æŒ‡é’ˆ-intrusive_ptr">æ™ºèƒ½æŒ‡é’ˆ Intrusive_ptr</span></h2><p>PyTorchä¸­ä½¿ç”¨intrusive_ptræ¥ç®¡ç†THTensorå’ŒTHStorageçš„å¼•ç”¨è®¡æ•°ï¼Œå…¶ä¸­å¼•ç”¨åˆ†ä¸ºå¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ï¼ˆå¼±å¼•ç”¨ä¸ºäº†è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼‰ï¼Œå¯¹åº”çš„ç±»åä¸º <code>intrusive_ptr</code> å’Œ <code>weak_intrusive_ptr</code>ã€‚ç”±äºå¼±å¼•ç”¨å’Œå¼ºå¼•ç”¨çš„å®ç°ç±»ä¼¼ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘æŠŠå¼±å¼•ç”¨çš„ä»£ç éƒ½å»æ‰äº†ï¼Œç®€åŒ–intrusive_ptrçš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">intrusive_ptr_target</span> &#123;</span></span><br><span class="line">  <span class="keyword">mutable</span> <span class="built_in">std</span>::atomic&lt;<span class="keyword">size_t</span>&gt; refcount_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å£°æ˜å‹å…ƒç±»ä½¿å¾—åªèƒ½æŒ‡é’ˆå¯ä»¥è®¿é—® refcount_</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">intrusive_ptr</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="comment">// éšè—ææ„å‡½æ•°ï¼Œé˜²æ­¢ç›´æ¥ææ„å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">virtual</span> ~intrusive_ptr_target() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  constexpr intrusive_ptr_target() noexcept : refcount_(0) &#123;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line"><span class="comment">// åœ¨æ‘§æ¯å¯¹è±¡æ—¶ä¼šè°ƒç”¨æ¬¡å‡½æ•°é‡Šæ”¾èµ„æº</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">release_resources</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">TTarget</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">intrusive_ptr</span> <span class="title">final</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  TTarget* target_;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¢åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">retain_</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">size_t</span> new_refcount = ++target_-&gt;refcount_;</span><br><span class="line">      AT_ASSERTM(new_refcount != <span class="number">1</span>,</span><br><span class="line">                 <span class="string">"intrusive_ptr:Cannot increase refcount after it"</span></span><br><span class="line">                 <span class="string">"reached zero."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”€æ¯æ™ºèƒ½æŒ‡é’ˆï¼Œå‡å°‘å¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶æ‘§æ¯å¯¹è±¡</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">reset_</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target_ != <span class="literal">nullptr</span> &amp;&amp; --target_-&gt;refcount_ == <span class="number">0</span>) &#123;</span><br><span class="line">      target_-&gt;release_resources();</span><br><span class="line">      <span class="keyword">delete</span> target_;</span><br><span class="line">    &#125;</span><br><span class="line">    target_ = <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éšè—é€šè¿‡æ™®é€šæŒ‡é’ˆåˆå§‹åŒ–çš„æ„é€ å‡½æ•°ï¼ˆåªèƒ½é€šè¿‡make_intrusiveè°ƒç”¨ï¼‰</span></span><br><span class="line">  explicit intrusive_ptr(TTarget* target) noexcept : target_(target) &#123;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  intrusive_ptr() <span class="keyword">noexcept</span> : intrusive_ptr(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡å…¶ä»–æ™ºèƒ½æŒ‡é’ˆåˆå§‹åŒ–ï¼Œéœ€å¢åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line">  intrusive_ptr(<span class="keyword">const</span> intrusive_ptr&amp; rhs) : target_(rhs.target_) &#123;</span><br><span class="line">  retain_(); </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ~intrusive_ptr() <span class="keyword">noexcept</span> &#123; reset_(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">TTarget* <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> target_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡è½½è¿ç®—ç¬¦ä½¿å…¶èƒ½å½“ä½œæ­£å¸¸æŒ‡é’ˆä½¿ç”¨</span></span><br><span class="line">  <span class="keyword">const</span> TTarget&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> *target_; &#125;</span><br><span class="line">  TTarget&amp; <span class="keyword">operator</span>*() <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> *target_; &#125;</span><br><span class="line">  <span class="keyword">const</span> TTarget* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> target_; &#125;</span><br><span class="line">  TTarget* <span class="keyword">operator</span>-&gt;() <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> target_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> target_ != <span class="literal">nullptr</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">  <span class="keyword">size_t</span> use_count() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (target_ == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target_-&gt;refcount_.load();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠæ™®é€šæŒ‡é’ˆè½¬æ¢ä¸ºæ™ºèƒ½æŒ‡é’ˆï¼ˆå¢åŠ å¼•ç”¨è®¡æ•°ï¼‰</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span>... <span class="title">Args</span>&gt;</span></span><br><span class="line"><span class="class">  <span class="title">static</span> <span class="title">intrusive_ptr</span> <span class="title">make</span>(<span class="title">Args</span>&amp;&amp;... <span class="title">args</span>) &#123;</span></span><br><span class="line">    <span class="keyword">auto</span> result = intrusive_ptr(<span class="keyword">new</span> TTarget(<span class="built_in">std</span>::forward&lt;Args&gt;(args)...));</span><br><span class="line">    ++result.target_-&gt;refcount_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æŠŠæ™ºèƒ½æŒ‡é’ˆè½¬æ¢ä¸ºæ™®é€šæŒ‡é’ˆ</span></span><br><span class="line">  <span class="function">TTarget* <span class="title">release</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    TTarget* result = target_;</span><br><span class="line">    target_ = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æŠŠæ™®é€šæŒ‡é’ˆè½¬æ¢ä¸ºæ™ºèƒ½æŒ‡é’ˆï¼ˆä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼‰</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> intrusive_ptr <span class="title">reclaim</span><span class="params">(TTarget* owning_ptr)</span> </span>&#123;</span><br><span class="line">    AT_ASSERTM(</span><br><span class="line">        owning_ptr == <span class="literal">nullptr</span> || owning_ptr-&gt;refcount_.load() &gt; <span class="number">0</span>,</span><br><span class="line">        <span class="string">"intrusive_ptr: Can only intrusive_ptr::reclaim() owning pointers that were created using intrusive_ptr::release()."</span>);</span><br><span class="line">    <span class="keyword">return</span> intrusive_ptr(owning_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºæ„é€ æ™ºèƒ½æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">TTarget</span>, <span class="title">class</span>... <span class="title">Args</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">inline</span> <span class="title">intrusive_ptr</span>&lt;TTarget&gt; <span class="title">make_intrusive</span>(<span class="title">Args</span>&amp;&amp;... <span class="title">args</span>) &#123;</span></span><br><span class="line">  <span class="keyword">return</span> intrusive_ptr&lt;TTarget&gt;::make(<span class="built_in">std</span>::forward&lt;Args&gt;(args)...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>intrusive_ptr_target</code> æ˜¯è¢«å¼•ç”¨å¯¹è±¡çš„çˆ¶ç±»ï¼Œ<code>TensorImpl</code> å’Œ <code>StorageImpl</code> éƒ½ç»§æ‰¿è‡ªå®ƒï¼Œä¸»è¦å·¥ä½œæ˜¯å£°æ˜äº†ä¸€ä¸ªå¼•ç”¨è®¡æ•° <code>refcount_</code>ï¼Œå¹¶ä¸”æŠŠæ™ºèƒ½æŒ‡é’ˆç±»å£°æ˜ä¸ºå‹å…ƒç±»ï¼Œè¿™æ ·åœ¨ <code>intrusive_ptr</code>é‡Œé¢å°±å¯ä»¥ç›´æ¥æ“ä½œ <code>refcount_</code>äº†ã€‚</p><p>å†æ¥çœ‹<code>intrusive_ptr</code>çš„å®ç°ï¼Œå®ƒæœ‰ä¸€ä¸ªç§æœ‰æˆå‘˜<code>TTarget* target_</code>ï¼Œæ˜¯è¢«å¼•ç”¨å¯¹è±¡çš„æ™®é€šæŒ‡é’ˆï¼›è¿˜æœ‰ä¸¤ä¸ªç§æœ‰æ–¹æ³•<code>retain_</code>å’Œ<code>reset_</code>ï¼Œåˆ†åˆ«ç”¨æ¥å¢åŠ å’Œå‡å°‘å¼•ç”¨è®¡æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šé€šè¿‡æ™®é€šæŒ‡é’ˆåˆå§‹åŒ–<code>intrusive_ptr</code>çš„æ„é€ å‡½æ•°ä¹Ÿæ˜¯ç§æœ‰çš„ï¼Œä¸èƒ½è¢«å¤–éƒ¨è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡é™æ€å‡½æ•°<code>make</code>æ¥è°ƒç”¨ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼›åœ¨é€šè¿‡å…¶ä»–æ™ºèƒ½æŒ‡é’ˆåˆå§‹åŒ–çš„æ—¶å€™éœ€è¦å¢åŠ å¼•ç”¨è®¡æ•°ã€‚</p><p>æœ€åè¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•<code>release</code>å’Œ<code>reclaim</code>ï¼Œå®ƒä»¬å®ç°äº†æ™®é€šæŒ‡é’ˆå’Œæ™ºèƒ½æŒ‡é’ˆé—´çš„ç›¸äº’è½¬æ¢ï¼Œç”¨äºCé£æ ¼çš„APIä¸­ï¼ˆåœ¨Atenä¸­ç»å¸¸ç”¨åˆ°ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ<code>intrusive_ptr</code>é‡Œè¿˜é‡è½½äº†è®¸å¤šè¿ç®—ç¬¦ï¼Œè®©å®ƒå¯ä»¥åƒæ™®é€šæŒ‡é’ˆä¸€æ ·ä½¿ç”¨ï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æ–¹æ³•å°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p><p><strong>åˆ›å»ºTensor</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">THTensor *<span class="title">THTensor_</span><span class="params">(<span class="keyword">new</span>)</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> c10::make_intrusive&lt;at::TensorImpl&gt;(</span><br><span class="line">    <span class="comment">// ä¸‹é¢ä¸‰ä¸ªå‚æ•°å°†é€šè¿‡intrusive_ptr::makeä¼ ç»™TensorImplçš„æ„é€ å‡½æ•°ï¼Œç„¶å</span></span><br><span class="line">    <span class="comment">// é€šè¿‡TensorImplçš„æŒ‡é’ˆæ„é€ intrusive_ptr</span></span><br><span class="line">    c10::intrusive_ptr&lt;at::StorageImpl&gt;::reclaim(THStorage_(<span class="keyword">new</span>)()),<span class="comment">// Storage&amp;&amp; storage</span></span><br><span class="line">    at::CPUTensorId(),<span class="comment">// TensorTypeId type_id</span></span><br><span class="line">    <span class="literal">false</span><span class="comment">// bool is_variable</span></span><br><span class="line">  ).release();<span class="comment">// releaseè¿”å›æ™®é€šæŒ‡é’ˆï¼ŒTensorImpl*</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">THStorage* <span class="title">THStorage_</span><span class="params">(<span class="keyword">new</span>)</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> THStorage_new(caffe2::TypeMeta::Make&lt;<span class="keyword">scalar_t</span>&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">THStorage* <span class="title">THStorage_new</span><span class="params">(caffe2::TypeMeta data_type)</span> </span>&#123;</span><br><span class="line">  THStorage* storage = c10::make_intrusive&lt;at::StorageImpl&gt;(</span><br><span class="line">    <span class="comment">// åŒç†ä¸‹é¢å››ä¸ªå‚æ•°å°†é€šè¿‡intrusive_ptr::makeä¼ ç»™StorageImplçš„æ„é€ å‡½</span></span><br><span class="line">      <span class="comment">// æ•°ï¼Œç„¶åé€šè¿‡StorageImplçš„æŒ‡é’ˆæ„é€ intrusive_ptr</span></span><br><span class="line">      data_type,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      getTHDefaultAllocator(),</span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">  ).release();</span><br><span class="line">  <span class="keyword">return</span> storage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æ–°å»ºä¸€ä¸ªtensorçš„è¿‡ç¨‹ï¼Œé€šè¿‡<code>c10::make_instrusive</code>æ„é€ æ™ºèƒ½æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨<code>release</code>è¿”å›æ™®é€šæŒ‡é’ˆã€‚ä¼ å…¥çš„ä¸‰ä¸ªå‚æ•°ï¼šstorageæ™ºèƒ½æŒ‡é’ˆï¼Œtensortypeï¼Œis_variableä¼šè¢«è½¬å‘åˆ°<code>intrusive_ptr::make</code>å‡½æ•°ä¸­ï¼Œç„¶åç”¨è¿™ä¸‰ä¸ªå‚æ•°æ„é€ ä¸€ä¸ª<code>TensorImpl</code>å¯¹è±¡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TensorImpl(Storage&amp;&amp; storage, TensorTypeId type_id, <span class="keyword">bool</span> is_variable);</span><br></pre></td></tr></table></figure><p>å†ç”¨è¯¥å¯¹è±¡çš„æŒ‡é’ˆåˆå§‹åŒ–æ™ºèƒ½æŒ‡é’ˆï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intrusive_ptr(TTarget* target);</span><br></pre></td></tr></table></figure><p>åŒæ—¶å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œæœ€å<code>make_intrusive</code>è¿”å›æ™ºèƒ½æŒ‡é’ˆã€‚THStorageçš„æ„é€ è¿‡ç¨‹åŒç†ã€‚</p><h2><span id="tensor-apply-amp-dynamic-dispatch">Tensor Apply &amp; Dynamic Dispatch</span></h2><p>THä¸­çš„Tensor Applyå°±ç›¸å½“äºmapå‡½æ•°ï¼ŒæŠŠä¸€ä¸ªå‡½æ•°åº”ç”¨åˆ°tensorçš„æ¯ä¸ªæ•°æ®ä¸­ã€‚ä¸¾ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹<code>THTensor_(cadd)</code>çš„å…·ä½“å®ç°ï¼ˆç®€åŒ–è¿‡çš„ï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THTensor_</span><span class="params">(cadd)</span><span class="params">(THTensor *r_, THTensor *t, <span class="keyword">scalar_t</span> value, THTensor *src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  THTensor_(resizeAs)(r_, t);</span><br><span class="line">  <span class="keyword">int64_t</span> r_Size = THTensor_(nElement)(r_);</span><br><span class="line">  <span class="keyword">int64_t</span> srcSize = THTensor_(nElement)(src);</span><br><span class="line">  <span class="keyword">int</span> r_Contig = THTensor_(isContiguous)(r_);</span><br><span class="line">  <span class="keyword">int</span> tContig = THTensor_(isContiguous)(t);</span><br><span class="line">  <span class="keyword">int</span> srcContig = THTensor_(isContiguous)(src);</span><br><span class="line">  <span class="keyword">int</span> serial_path = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (srcSize == r_Size)&#123;</span><br><span class="line">    <span class="keyword">if</span> (r_Contig &amp;&amp; tContig &amp;&amp; srcContig) &#123;</span><br><span class="line">  TH_TENSOR_APPLY3_CONTIG(<span class="keyword">scalar_t</span>, r_, <span class="keyword">scalar_t</span>, t, <span class="keyword">scalar_t</span>, src, THVector_(cadd)(r__data, t_data, src_data, value, r__len););</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      serial_path = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    serial_path = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (serial_path) &#123;</span><br><span class="line">    TH_TENSOR_APPLY3(</span><br><span class="line">      <span class="keyword">scalar_t</span>, r_, <span class="keyword">scalar_t</span>, t, <span class="keyword">scalar_t</span>, src, </span><br><span class="line">      *r__data = *t_data + value * *src_data;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å®ç°çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯ <code>*r_ = *t + value * *src</code>ï¼ŒæŠŠ<code>src</code>çš„å€¼ä¹˜ä»¥<code>value</code>ç„¶åå’Œ<code>t</code>ç›¸åŠ ï¼Œæœ€åèµ‹å€¼ç»™<code>r_</code>ï¼Œå…¶ä¸­<code>r_, t, src</code>éƒ½æ˜¯THTensorã€‚å‡½æ•°é¦–å…ˆè·å–å…ƒç´ ä¸ªæ•°å’Œæ˜¯å¦è¿ç»­ç­‰ä¿¡æ¯ï¼Œå¦‚æœè¿ç»­çš„è¯è°ƒç”¨<code>TH_TENSOR_APPLY3_CONTIG</code>æ¥å¤„ç†ï¼Œå¦åˆ™è°ƒç”¨<code>TH_TENSOR_APPLY3</code>å¤„ç†ã€‚åè€…å¤ªå¤æ‚äº†ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹å‰è€…çš„å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _OPENMP</span></span><br><span class="line"><span class="comment">// å¤šçº¿ç¨‹åŠ é€Ÿ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_TENSOR_APPLY3_CONTIG(TYPE1, TENSOR1, TYPE2, TENSOR2, TYPE3, TENSOR3, CODE) \ </span></span><br><span class="line">&#123; \ </span><br><span class="line">  <span class="keyword">int</span> inOmp = omp_in_parallel(); \</span><br><span class="line">  <span class="keyword">ptrdiff_t</span> TH_TENSOR_size = THTensor_(nElement)(TENSOR1); \ </span><br><span class="line">  # å¯åŠ¨ OpenMP å¤šçº¿ç¨‹</span><br><span class="line">  PRAGMA(omp parallel <span class="keyword">if</span> ((TH_TENSOR_size &gt; TH_OMP_OVERHEAD_THRESHOLD) &amp;&amp; (!inOmp))) \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">size_t</span> num_threads = omp_get_num_threads(); \</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">size_t</span> tid = omp_get_thread_num(); \</span><br><span class="line">    <span class="comment">// è®¡ç®—å¼€å§‹å’Œç»“å°¾</span></span><br><span class="line">    <span class="keyword">ptrdiff_t</span> TH_TENSOR_offset = tid*(TH_TENSOR_size/num_threads);\</span><br><span class="line">    <span class="keyword">ptrdiff_t</span> TH_TENSOR_end =(tid==num_threads<span class="number">-1</span>)?TH_TENSOR_size: \</span><br><span class="line">      TH_TENSOR_offset + TH_TENSOR_size / num_threads; \</span><br><span class="line">    <span class="comment">// æ¯ä¸ªçº¿ç¨‹è´Ÿè´£ TH_TENSOR_offset åˆ° TH_TENSOR_end ä¹‹é—´çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">ptrdiff_t</span> TENSOR1##_len = TH_TENSOR_end - TH_TENSOR_offset; \</span><br><span class="line">    <span class="comment">// è·å–Tensorçš„æ•°æ®</span></span><br><span class="line">    TYPE1 *TENSOR1##_data = TENSOR1-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;() + TH_TENSOR_offset; \</span><br><span class="line">    TYPE2 *TENSOR2##_data = TENSOR2-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;() + TH_TENSOR_offset; \</span><br><span class="line">    TYPE3 *TENSOR3##_data = TENSOR3-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;() + TH_TENSOR_offset; \</span><br><span class="line">    CODE \</span><br><span class="line">  &#125; \</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// æ™®é€šå®ç°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TH_TENSOR_APPLY3_CONTIG(TYPE1, TENSOR1, TYPE2, TENSOR2, TYPE3, TENSOR3, CODE) \ </span></span><br><span class="line">&#123; \</span><br><span class="line">  <span class="comment">// è·å–Tensorçš„æ•°æ®</span></span><br><span class="line">  TYPE1 *TENSOR1##_data = TENSOR1-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;(); \</span><br><span class="line">  TYPE2 *TENSOR2##_data = TENSOR2-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;(); \</span><br><span class="line">  TYPE3 *TENSOR3##_data = TENSOR3-&gt;data&lt;<span class="keyword">scalar_t</span>&gt;(); \</span><br><span class="line">  <span class="keyword">ptrdiff_t</span> TENSOR1##_len = THTensor_(nElement)(TENSOR1); \</span><br><span class="line">  <span class="comment">// æ‰§è¡Œä¼ å…¥çš„ä»£ç </span></span><br><span class="line">  CODE \</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>ä¸ŠåŠéƒ¨åˆ†çš„å®ç°ä¸ºOPENMPçš„å¤šçº¿ç¨‹åŠ é€Ÿç‰ˆï¼Œä¸‹é¢æ˜¯æ™®é€šç‰ˆã€‚è¿™ä¸ªå®æ¥æ”¶7ä¸ªå‚æ•°ï¼šä¸‰ä¸ªTensorå’Œå¯¹åº”ç±»å‹ï¼Œè¿˜æœ‰è¦æ‰§è¡Œçš„æ“ä½œã€‚<code>THTensor_(cadd)</code>ä¸­ä¼ å…¥çš„æ“ä½œæ˜¯<code>THVector_(cadd)(r__data, t_data, src_data, value, r__len);</code>ï¼Œå®ƒçš„å®šä¹‰ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// THVectorDispatch.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THVector_</span><span class="params">(cadd)</span><span class="params">(<span class="keyword">scalar_t</span> *z, <span class="keyword">const</span> <span class="keyword">scalar_t</span> *x, <span class="keyword">const</span> <span class="keyword">scalar_t</span> *y, <span class="keyword">const</span> <span class="keyword">scalar_t</span> c, <span class="keyword">const</span> <span class="keyword">ptrdiff_t</span> n)</span> </span>&#123;</span><br><span class="line">  THVector_(cadd_DISPATCHPTR)(z, x, y, c, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åŠ¨æ€æ´¾å‘å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">void</span> <span class="params">(*THVector_(cadd_DISPATCHPTR))</span><span class="params">(<span class="keyword">scalar_t</span> *, <span class="keyword">const</span> <span class="keyword">scalar_t</span> *, <span class="keyword">const</span> <span class="keyword">scalar_t</span> *, <span class="keyword">const</span> <span class="keyword">scalar_t</span>, <span class="keyword">const</span> <span class="keyword">ptrdiff_t</span>)</span> </span>= &amp;THVector_(cadd_DEFAULT);</span><br><span class="line"><span class="comment">// å¯¹å„ç§å‘é‡åŒ–æŒ‡ä»¤çš„æ”¯æŒ</span></span><br><span class="line">static FunctionDescription THVector_(cadd_DISPATCHTABLE)[] = &#123;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined(__NEON__)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(TH_REAL_IS_FLOAT)</span></span><br><span class="line">      FUNCTION_IMPL(THVector_(cadd_NEON), SIMDExtension_NEON),</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined(USE_AVX2)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(TH_REAL_IS_DOUBLE) || defined(TH_REAL_IS_FLOAT)</span></span><br><span class="line">      FUNCTION_IMPL(THVector_(cadd_AVX2), SIMDExtension_AVX2),</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined(USE_AVX)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(TH_REAL_IS_DOUBLE) || defined(TH_REAL_IS_FLOAT)</span></span><br><span class="line">      FUNCTION_IMPL(THVector_(cadd_AVX), SIMDExtension_AVX),</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  FUNCTION_IMPL(THVector_(cadd_DEFAULT), SIMDExtension_DEFAULT)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// THVectorDefault.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">THVector_</span><span class="params">(cadd_DEFAULT)</span><span class="params">(<span class="keyword">scalar_t</span> *z, <span class="keyword">const</span> <span class="keyword">scalar_t</span> *x, <span class="keyword">const</span> <span class="keyword">scalar_t</span> *y, <span class="keyword">const</span> <span class="keyword">scalar_t</span> c, <span class="keyword">const</span> <span class="keyword">ptrdiff_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ptrdiff_t</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(; i&lt;n<span class="number">-4</span>; i+=<span class="number">4</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    z[i] = x[i] + c * y[i];</span><br><span class="line">    z[i+<span class="number">1</span>] = x[i+<span class="number">1</span>] + c * y[i+<span class="number">1</span>];</span><br><span class="line">    z[i+<span class="number">2</span>] = x[i+<span class="number">2</span>] + c * y[i+<span class="number">2</span>];</span><br><span class="line">    z[i+<span class="number">3</span>] = x[i+<span class="number">3</span>] + c * y[i+<span class="number">3</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(; i&lt;n; i++)</span><br><span class="line">    z[i] = x[i] + c * y[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¶‰åŠåˆ°å¯¹SIMDå‘é‡åŒ–æŒ‡ä»¤çš„æ”¯æŒå’ŒåŠ¨æ€æ´¾å‘ï¼Œå¯ä»¥çœ‹åˆ°<code>THVector_(cadd)</code>å‡½æ•°é‡Œè°ƒç”¨çš„æ˜¯<code>THVector_(cadd_DISPATCHPTR)</code>ï¼Œè€Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œé»˜è®¤æŒ‡å‘<code>THVector_(cadd_DEFAULT)</code>ï¼Œè¿™ä¸ªæ˜¯ä¸æ”¯æŒå‘é‡åŒ–æŒ‡ä»¤çš„å®ç°ã€‚ä»£ç ä¸­é—´éƒ¨åˆ†çš„æ•°ç»„<code>FunctionDescription THVector_(cadd_DISPATCHTABLE)[]</code>è®°å½•å„ç§å‘é‡åŒ–æŒ‡ä»¤çš„å®ç°ï¼Œæœ€åæ˜¯é»˜è®¤çš„å®ç°ã€‚</p><p>åŠ¨æ€æ´¾å‘çš„å®ç°åœ¨<code>TH/vector/simd.h</code>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_DISPATCH_PTR(OP)                                     \ </span></span><br><span class="line">  <span class="keyword">do</span> &#123;                                                            \ </span><br><span class="line">    <span class="keyword">size_t</span> i;                                                     \ </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(THVector_(OP ## _DISPATCHTABLE)) /     \ </span><br><span class="line">                         <span class="keyword">sizeof</span>(FunctionDescription); ++i) &#123;      \</span><br><span class="line">      THVector_(OP ## _DISPATCHPTR) =                             \</span><br><span class="line">  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">decltype</span>(THVector_(OP ## _DISPATCHPTR))&gt; \</span><br><span class="line">  (THVector_(OP ## _DISPATCHTABLE)[i].function);            \</span><br><span class="line">      <span class="keyword">if</span> (THVector_(OP ## _DISPATCHTABLE)[i].supportedSimdExt     \</span><br><span class="line">        &amp; hostSimdExts) &#123;                                       \</span><br><span class="line">        <span class="keyword">break</span>;                                                    \</span><br><span class="line">      &#125;                                                           \</span><br><span class="line">    &#125;                                                             \</span><br><span class="line">  &#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FunctionDescription</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *function;</span><br><span class="line">  <span class="keyword">uint32_t</span> supportedSimdExt;</span><br><span class="line">&#125; FunctionDescription;</span><br></pre></td></tr></table></figure><p><code>INIT_DISPATCH_PTR</code> è¿™ä¸ªå®åšçš„äº‹å°±æ˜¯éå†<code>THVector_(cadd_DISPATCHTABLE)</code>æ•°ç»„ï¼Œå¾ªç¯å†…æŠŠåŠ¨æ€æ´¾å‘æŒ‡é’ˆï¼ˆ<code>THVector_(cadd_DISPATCHPTR)</code>ï¼‰èµ‹ç»™å½“å‰æ•°ç»„å…ƒç´ æ‰€å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆï¼Œæœ€ååˆ¤æ–­ä¸€ä¸‹å½“å‰æ¶æ„æ˜¯å¦æ”¯æŒè¯¥æŒ‡ä»¤é›†ï¼Œå¦‚æœæ”¯æŒå°±é€€å‡ºå¾ªç¯ï¼›å¦‚æœå‘é‡åŒ–æŒ‡ä»¤é›†éƒ½ä¸æ”¯æŒçš„è¯ï¼Œæœ€åè¿˜ä¼šæŒ‡å‘é»˜è®¤å®ç°çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>ã¤ã¥ã</p><table><thead><tr><th style="text-align:left">ä¸Šä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch0/">ç®€ä»‹</a></th><th style="text-align:right">ä¸‹ä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch2/">THC</a></th></tr></thead><tbody><tr><td style="text-align:left"></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;PyTorchä¸­Tensorçš„å­˜å‚¨å’Œè¡¨ç¤ºåˆ†å¼€ï¼Œå¤šä¸ªTHTensorå¯èƒ½å…±äº«ä¸€ä¸ªTHStorageï¼Œæ¯ä¸ªTHTensorå¯èƒ½æ‹¥æœ‰ä¸åŒçš„viewï¼ˆe.g. size, strideï¼‰ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œæœ‰æ—¶çœ‹èµ·æ¥ä¸ä¸€æ ·çš„æ•°æ®åº•å±‚æ˜¯å…±äº«çš„ï¼Œæ¯”å¦‚çŸ©é˜µä¸çŸ©é˜µçš„è½¬ç½®ã€äºŒç»´çŸ©é˜µä¸äºŒç»´çŸ©é˜µå˜æˆä¸€ç»´æ—¶çš„çŸ©é˜µã€‚è¿™éƒ¨åˆ†çš„ä¸»åŠ›å®ç°åœ¨ &lt;code&gt;pytorch/aten&lt;/code&gt; æ–‡ä»¶å¤¹ä¸­ï¼Œè¿™é‡Œé¢æ—¢å®ç°äº†åº•å±‚çš„Tensoræ“ä½œåº“ï¼Œä¹Ÿå°è£…äº†åä¸º &lt;strong&gt;ATen&lt;/strong&gt; çš„ C++11æ¥å£ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="PyTorch" scheme="http://www.52coding.com.cn/tags/PyTorch/"/>
    
      <category term="Tensor" scheme="http://www.52coding.com.cn/tags/Tensor/"/>
    
      <category term="THTensor" scheme="http://www.52coding.com.cn/tags/THTensor/"/>
    
      <category term="THStorage" scheme="http://www.52coding.com.cn/tags/THStorage/"/>
    
  </entry>
  
  <entry>
    <title>PyTorchæºç æµ…æï¼šç®€ä»‹</title>
    <link href="http://www.52coding.com.cn/2019/05/05/PyTorch0/"/>
    <id>http://www.52coding.com.cn/2019/05/05/PyTorch0/</id>
    <published>2019-05-05T07:49:01.000Z</published>
    <updated>2019-05-05T08:09:12.625Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªç³»åˆ—æ–‡ç« è‡ªåº•å‘ä¸Šé’ˆå¯¹PyTorchæ ¸å¿ƒæºç è¿›è¡Œæµ…æï¼Œä»Tensoråº“<span class="math inline">\(\rightarrowâ€‹\)</span>ç¥ç»ç½‘ç»œ<span class="math inline">\(\rightarrowâ€‹\)</span>è‡ªåŠ¨å¾®åˆ†<span class="math inline">\(\rightarrowâ€‹\)</span>Pythonæ‰©å±•ï¼Œä¸€å…±äº”ç¯‡ã€‚</p><a id="more"></a><h2><span id="ç›®å½•">ç›®å½•</span></h2><blockquote><h3><span id="1-thtensor"></span></h3><p>PyTorchä¸­Tensorçš„å­˜å‚¨å’Œè¡¨ç¤ºåˆ†å¼€ï¼Œå¤šä¸ªTHTensorå¯èƒ½å…±äº«ä¸€ä¸ªTHStorageï¼Œæ¯ä¸ªTHTensorå¯èƒ½æ‹¥æœ‰ä¸åŒçš„viewï¼ˆe.g. size, strideï¼‰ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œæœ‰æ—¶çœ‹èµ·æ¥ä¸ä¸€æ ·çš„æ•°æ®åº•å±‚æ˜¯å…±äº«çš„ï¼Œæ¯”å¦‚çŸ©é˜µä¸çŸ©é˜µçš„è½¬ç½®ã€äºŒç»´çŸ©é˜µä¸äºŒç»´çŸ©é˜µå˜æˆä¸€ç»´æ—¶çš„çŸ©é˜µã€‚è¿™éƒ¨åˆ†çš„ä¸»åŠ›å®ç°åœ¨ <code>pytorch/aten</code> æ–‡ä»¶å¤¹ä¸­ï¼Œè¿™é‡Œé¢æ—¢å®ç°äº†åº•å±‚çš„Tensoræ“ä½œåº“ï¼Œä¹Ÿå°è£…äº†åä¸º <strong>ATen</strong> çš„ C++11æ¥å£ã€‚</p></blockquote><blockquote><h3><span id="2-thc"></span></h3><p>è¿™ç¯‡ä¸»è¦çœ‹ Torch CUDA éƒ¨åˆ†ï¼Œå¯¹åº”æºç ç›®å½• <code>aten/src/THC</code>ï¼Œé‡Œé¢åŒ…å«äº†è®¸å¤šC++å’ŒCUDAä»£ç ã€‚è¿™éƒ¨åˆ†å®ç°äº†æ“ä½œ THCTensor å’Œ THCStorage çš„æ¥å£ï¼Œä¸è¿‡åº•å±‚ç”¨çš„æ•°æ®ç»“æ„è¿˜æ˜¯ <code>TensorImpl</code> å’Œ <code>StorageImpl</code>ã€‚THCé‡Œçš„æ¥å£ä¹Ÿæ˜¯é€šè¿‡Cè¯­è¨€èŒƒå¼å®ç°çš„ï¼Œä½†æ˜¯Applyç³»åˆ—æ“ä½œä¸å†ç”±å®æ¥å®ç°ï¼Œè€Œæ˜¯ä½¿ç”¨äº†C++æ¨¡æ¿ã€‚å…¶ä»–çš„åŒºåˆ«è¿˜æœ‰allocatorä¸åŒï¼Œä»¥åŠå¤šäº† THCState ç»“æ„ã€‚</p></blockquote><blockquote><h3><span id="3-nn"></span></h3><p>THNNæ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€å®ç°çš„ç¥ç»ç½‘ç»œæ¨¡å—çš„åº“ï¼Œæä¾›çš„åŠŸèƒ½éå¸¸åº•å±‚ã€‚å®ƒå®ç°äº†è®¸å¤šåŸºç¡€çš„ç¥ç»ç½‘ç»œæ¨¡å—ï¼ŒåŒ…æ‹¬çº¿æ€§å±‚ï¼Œå·ç§¯å±‚ï¼ŒSigmoidç­‰å„ç§æ¿€æ´»å±‚ï¼Œä¸€äº›åŸºæœ¬çš„losså‡½æ•°ï¼Œè¿™äº›APIéƒ½å£°æ˜åœ¨<code>THNN/generic/THNN.h</code>ä¸­ã€‚æ¯ä¸ªæ¨¡å—éƒ½å®ç°äº†å‰å‘ä¼ å¯¼ï¼ˆforwardï¼‰å’Œåå‘ä¼ å¯¼ï¼ˆbackwardï¼‰çš„åŠŸèƒ½ã€‚THCUNNåˆ™æ˜¯å¯¹åº”æ¨¡å—çš„CUDAå®ç°ã€‚</p></blockquote><blockquote><h3><span id="4-autograd"></span></h3><p>è¿™ç¯‡åšå®¢ä»‹ç» PyTorch ä¸­è‡ªåŠ¨å¾®åˆ†å¼•æ“çš„å®ç°ï¼Œä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šé¦–å…ˆç®€è¦ä»‹ç»ä¸€ä¸‹è®¡ç®—å›¾çš„åŸç†ï¼›ç„¶åä»‹ç» PyTorch ä¸­ä¸ autograd çš„ç›¸å…³æ•°æ®ç»“æ„å’Œ <code>backward()</code> å‡½æ•°çš„å®ç°ï¼Œæ•°æ®ç»“æ„åŒ…æ‹¬ <code>torch::autograd::Variable</code>, <code>torch::autograd::Function</code> ç­‰ï¼›æœ€åè®²ä¸€ä¸‹åŠ¨æ€å»ºç«‹è®¡ç®—å›¾çš„å®ç°ï¼Œè¿™éƒ¨åˆ†ä»£ç æ¶‰åŠåˆ°åŠ¨æ€æ´¾å‘æœºåˆ¶ï¼Œè€Œä¸”éƒ½æ˜¯ç”¨è„šæœ¬ç”Ÿæˆçš„ï¼Œä¸å¤ªå®¹æ˜“ç†è§£ã€‚</p></blockquote><blockquote><h3><span id="5-pythonæ‰©å±•"></span></h3><p>è¿™ç¯‡æ˜¯æœ¬ç³»åˆ—æœ€åä¸€ç¯‡åšå®¢äº†ï¼Œä»‹ç»ä¸€ä¸‹å‰é¢çš„C++ä»£ç æ€ä¹ˆä¸Pythonäº¤äº’ï¼Œæˆ–è€…è¯´Pythoné‡Œæ€ä¹ˆè°ƒç”¨C++ä»£ç è¿›è¡Œé«˜æ•ˆçš„è®¡ç®—ã€‚é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹é¢„å¤‡çŸ¥è¯†ï¼Œæ—¢Pythonçš„Cæ‰©å±•é€šå¸¸æ€ä¹ˆå†™ï¼›ç„¶åä»¥æ¯”è¾ƒæ ¸å¿ƒçš„æ•°æ®ç»“æ„ Tensor å’Œ Storage ä¸ºä¾‹çœ‹ä¸€ä¸‹å®ƒä»¬æ€ä¹ˆè½¬æ¢ä¸ºPythonç±»å‹çš„ï¼›æœ€åç¨å¸¦ç‚¹å„¿Pythonè‡ªå¾®åˆ†å‡½æ•°çš„å®ç°ã€‚</p></blockquote><h2><span id="æºç ç›®å½•ç»“æ„">æºç ç›®å½•ç»“æ„</span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pytorch</span><br><span class="line">â”œâ”€â”€ aten<span class="comment"># ATen: C++ Tensoråº“</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ CMakeLists.txt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ conda</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ src</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ATen<span class="comment"># C++ bindings</span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TH              <span class="comment"># torch tensor</span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ THC    <span class="comment"># torch cuda</span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ THCUNN <span class="comment"># torch cuda nn</span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ THNN<span class="comment"># torch nn</span></span><br><span class="line">â”‚Â Â  â””â”€â”€ tools</span><br><span class="line">â”œâ”€â”€ c10 <span class="comment"># è¿™é‡Œé¢ä¹ŸåŒ…å«ä¸€äº›Tensorå®ç°</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ CMakeLists.txt</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ core</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cuda</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ hip</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ macros</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ <span class="built_in">test</span></span><br><span class="line">â”‚Â Â  â””â”€â”€ util</span><br><span class="line">â”œâ”€â”€ caffe2<span class="comment"># caffe2</span></span><br><span class="line">â”œâ”€â”€ tools</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ autograd<span class="comment"># ç”Ÿæˆè‡ªå¾®åˆ†ç›¸å…³å‡½æ•°çš„å·¥å…·</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ...</span><br><span class="line">â”‚Â Â  â””â”€â”€ shared</span><br><span class="line">â”œâ”€â”€ torch    <span class="comment"># Pythonæ¨¡å—</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ autograd</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ csrc<span class="comment"># C++ç›¸å…³æºç </span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ autograd<span class="comment"># è‡ªåŠ¨å¾®åˆ†å¼•æ“å®ç°</span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cuda</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ distributed</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ generic</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ jit</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ multiprocessing</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nn</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ tensor</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ utils</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ...</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ utils.h</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cuda</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ nn</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ...</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ storage.py</span><br><span class="line">â”‚Â Â  â””â”€â”€ tensor.py</span><br><span class="line">â”œâ”€â”€ ...</span><br><span class="line">â””â”€â”€ ubsan.supp</span><br></pre></td></tr></table></figure><h2><span id="ä»£ç ç»Ÿè®¡">ä»£ç ç»Ÿè®¡</span></h2><table><thead><tr class="header"><th style="text-align: center;">è¯­è¨€</th><th style="text-align: center;">æ–‡ä»¶æ•°</th><th style="text-align: center;">ç©ºè¡Œ</th><th style="text-align: center;">æ³¨é‡Š</th><th style="text-align: center;">ä»£ç </th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">C++</td><td style="text-align: center;">464</td><td style="text-align: center;">25230</td><td style="text-align: center;">9855</td><td style="text-align: center;"><strong>330222</strong></td></tr><tr class="even"><td style="text-align: center;">C/C++ Header</td><td style="text-align: center;">1692</td><td style="text-align: center;">40380</td><td style="text-align: center;">51884</td><td style="text-align: center;"><strong>251915</strong></td></tr><tr class="odd"><td style="text-align: center;">Python</td><td style="text-align: center;">776</td><td style="text-align: center;">27277</td><td style="text-align: center;">31616</td><td style="text-align: center;"><strong>117105</strong></td></tr><tr class="even"><td style="text-align: center;">CUDA</td><td style="text-align: center;">307</td><td style="text-align: center;">7126</td><td style="text-align: center;">4140</td><td style="text-align: center;">40207</td></tr><tr class="odd"><td style="text-align: center;">...</td><td style="text-align: center;">...</td><td style="text-align: center;">...</td><td style="text-align: center;">...</td><td style="text-align: center;">...</td></tr><tr class="even"><td style="text-align: center;">æ€»è®¡</td><td style="text-align: center;">3382</td><td style="text-align: center;">104221</td><td style="text-align: center;">101689</td><td style="text-align: center;"><strong>825756</strong></td></tr></tbody></table><p><strong>æ³¨</strong>ï¼šä»…ç»Ÿè®¡äº† <code>torch</code> å’Œ <code>aten</code> ä¸¤ä¸ªæ ¸å¿ƒæ–‡ä»¶å¤¹ã€‚</p><h2><span id="æ„Ÿå—">æ„Ÿå—</span></h2><p>ä¸€å¼€å§‹åªæ˜¯å¿ƒè¡€æ¥æ½®è§‰å¾—è¿™å­¦æœŸåæ­£ä¸æ˜¯å¾ˆå¿™å°±ç«‹äº†ä¸ªflagå†³å®šå­¦æœŸå†…æŠŠPyTorchæºç çœ‹ä¸€éï¼Œçœ‹çš„è¿‡ç¨‹å¾ˆå—è‹¦ï¼Œåº†å¹¸æœ€ç»ˆè¿˜æ˜¯åšæŒä¸‹æ¥äº†ï¼Œæ”¶è·ä¹Ÿå¾ˆå¤§ã€‚é™¤äº†ç†è§£äº†PyTorchæ˜¯å¦‚ä½•è¿è¡Œçš„ã€è¾“å‡ºè¿™äº”ç¯‡åšå®¢ä¹‹å¤–ï¼Œæˆ‘å¯¹C++çš„ç†è§£ä¹Ÿæœ‰æ˜¾è‘—æå‡ï¼Œå› ä¸ºPyTorchå¤§éƒ¨åˆ†ä»£ç æ˜¯ç”¨C++å†™çš„ï¼Œå„ç§æ–°ç‰¹æ€§ç®€ç›´åˆ·æ–°äº†æˆ‘å¯¹è¿™é—¨è¯­è¨€çš„è®¤è¯†ï¼Œç”±æ­¤ä¹Ÿä¸“é—¨è®°äº†ä¸€ç¯‡<a href="https://www.52coding.com.cn/2019/05/05/C++/">å…³äºC++çš„ç¬”è®°</a>ã€‚</p><p>ç®€å•è¯´ä¸€ä¸‹æˆ‘çš„é˜…è¯»æ–¹æ³•ã€‚é¢å¯¹è¿™ä¹ˆå¤šçš„ä»£ç å’Œæ–‡ä»¶ï¼Œä¸€ä¸‹å­è‚¯å®šä¸çŸ¥æ‰€æªï¼Œå°¤å…¶æ˜¯é˜…è¯»æ–°æ¨¡å—çš„æ—¶å€™ï¼Œæˆ‘é¦–å…ˆä¼šå°è¯•æ‰¾åˆ°è¯¥æ¨¡å—çš„è¯´æ˜ï¼Œé€šè¿‡ <code>README.md</code> æˆ–å‰äººçš„åšå®¢æˆ–APIæ–‡æ¡£äº†è§£ä¸‹è¯¥æ¨¡å—å¤§æ¦‚åŠŸèƒ½å’Œç»“æ„ï¼Œç„¶åæ•´ä½“ï¼ˆç²—ç•¥ï¼‰æµè§ˆä¸€éè¯¥æ¨¡å—çš„ä»£ç ï¼Œå¯¹æ¯ä¸ªæ–‡ä»¶é‡Œçš„ä»£ç æ˜¯åšä»€ä¹ˆçš„æœ‰ä¸ªå¤§è‡´æ¦‚å¿µï¼Œæœ€åå†æ ¹æ®è‡ªå·±çš„ç†è§£é€‰æ‹©æ€§åœ°è¿›è¡Œç²¾è¯»ã€‚</p><p>ã¤ã¥ã</p><table><thead><tr class="header"><th style="text-align: left;"></th><th style="text-align: right;">ä¸‹ä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch1/">THTensor</a></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"></td><td style="text-align: right;"></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ä¸ªç³»åˆ—æ–‡ç« è‡ªåº•å‘ä¸Šé’ˆå¯¹PyTorchæ ¸å¿ƒæºç è¿›è¡Œæµ…æï¼Œä»Tensoråº“&lt;span class=&quot;math inline&quot;&gt;\(\rightarrowâ€‹\)&lt;/span&gt;ç¥ç»ç½‘ç»œ&lt;span class=&quot;math inline&quot;&gt;\(\rightarrowâ€‹\)&lt;/span&gt;è‡ªåŠ¨å¾®åˆ†&lt;span class=&quot;math inline&quot;&gt;\(\rightarrowâ€‹\)&lt;/span&gt;Pythonæ‰©å±•ï¼Œä¸€å…±äº”ç¯‡ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="PyTorch" scheme="http://www.52coding.com.cn/tags/PyTorch/"/>
    
      <category term="Tensor" scheme="http://www.52coding.com.cn/tags/Tensor/"/>
    
      <category term="NN" scheme="http://www.52coding.com.cn/tags/NN/"/>
    
      <category term="Autograd" scheme="http://www.52coding.com.cn/tags/Autograd/"/>
    
  </entry>
  
  <entry>
    <title>C++ç¬”è®°</title>
    <link href="http://www.52coding.com.cn/2019/05/05/C++/"/>
    <id>http://www.52coding.com.cn/2019/05/05/C++/</id>
    <published>2019-05-05T07:40:01.000Z</published>
    <updated>2019-05-05T07:43:09.037Z</updated>
    
    <content type="html"><![CDATA[<p>C++è¿™é—¨è¯­è¨€çœŸçš„æ˜¯åšå¤§ç²¾æ·±ï¼Œåœ¨é˜…è¯»PyTorchæºç çš„æ—¶å€™æ„Ÿè§¦å°¤ä¸ºæ·±åˆ»ï¼Œåœ¨æ­¤è®°å½•ä¸€äº›æˆ‘è®¤ä¸ºå¾ˆå¥½çš„ç¼–ç¨‹å®è·µä»¥åŠä¸€äº›C++çš„â€œæ–°â€ç‰¹æ€§ã€‚</p><a id="more"></a><h3><span id="æ¡ä»¶æ£€æŸ¥">æ¡ä»¶æ£€æŸ¥</span></h3><p>åœ¨ç¨‹åºéœ€è¦åˆ¤æ–­ä¸€äº›æ¡ä»¶æ‰èƒ½æ‰§è¡ŒæŸäº›æ“ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå†™å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond == <span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// error, or throw exception</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">do</span> something ...</span><br></pre></td></tr></table></figure><p>è¿™äº›<code>if</code>è¯­å¥å¯ä»¥ç®€æ´ä¸ºä¸€è¡Œä»£ç ï¼Œå¦‚ä½¿ç”¨<code>assert</code>è¯­å¥ï¼Œä½†å¦‚æœä½ ä¸å¸Œæœ›ç¨‹åºå°±æ­¤ç»ˆæ­¢çš„è¯ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç›¸åº”çš„å¤„ç†å‡½æ•°æˆ–å®ï¼Œå¦‚æœéœ€è¦æ£€æŸ¥çš„æ¡ä»¶å¾ˆå¤šçš„è¯ï¼Œè¿™æ ·è¿›è¡Œæ›¿æ¢å°±ä¼šä½¿ä»£ç æ•´æ´è®¸å¤šã€‚ä¸‹é¢æ˜¯åœ¨<code>pytorch/c10</code>ä¸­çš„æ¡ä»¶åˆ¤æ–­å¤„ç†å®ï¼ˆä»…ä¾›å‚è€ƒï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AT_ERROR(...) \</span></span><br><span class="line">  <span class="keyword">throw</span> ::c10::Error(&#123;__func__, __FILE__, <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(__LINE__)&#125;, ::c10::str(__VA_ARGS__))</span><br><span class="line"></span><br><span class="line">#define AT_CHECK(cond, ...)            \</span><br><span class="line">  <span class="keyword">if</span> (!(cond)) &#123;                       \</span><br><span class="line">    AT_ERROR(::c10::str(__VA_ARGS__)); \</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3><span id="ç‰¹æ€§æµ‹è¯•">ç‰¹æ€§æµ‹è¯•</span></h3><p>å®å®šä¹‰çš„è¿ç”¨åœ¨C/C++ä¸­è‡³å…³é‡è¦ï¼Œå®å¯ä»¥ç”¨æ¥è§£å†³ä¸€äº›å…¼å®¹æ€§çš„é—®é¢˜ï¼Œå¹¶ä¸”ä½¿ä»£ç ä¿æŒç»Ÿä¸€ã€‚å¦‚<code>constexpr</code>å…³é”®å­—åœ¨ä¸åŒç‰ˆæœ¬çš„C++ä¸­èŒƒå›´ä¸åŒï¼Œé‚£ä¹ˆå·²çŸ¥ä¸€ä¸ªå‡½æ•°å¯ä»¥åœ¨C++14åŠä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­å£°æ˜<code>constexpr</code>ä½†åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¸è¡Œï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸€ä¸ªæ—¢èƒ½å…¼å®¹ä¸åŒç¼–è¯‘å™¨åˆèƒ½ä¿æŒä»£ç æ•´æ´ç»Ÿä¸€çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨å®å®šä¹‰ï¼Œå¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">AT_CPP14_CONSTEXPR <span class="keyword">const</span> T&amp; <span class="title">front</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    AT_CHECK(!empty(), <span class="string">"ArrayRef: attempted to access front() of empty list"</span>);</span><br><span class="line">    <span class="keyword">return</span> Data[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AT_CPP14_CONSTEXPR</code>çš„å®šä¹‰ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__cpp_constexpr) &amp;&amp; __cpp_constexpr &gt;= 201304</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> AT_CPP14_CONSTEXPR constexpr</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> AT_CPP14_CONSTEXPR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<a href="https://zh.cppreference.com/w/cpp/feature_test" target="_blank" rel="noopener">ç‰¹æ€§æµ‹è¯•</a>æ£€æŸ¥ç‰¹æ€§çš„æŒ‡å®šç‰ˆæœ¬æ¥åˆ¤æ–­èƒ½å¦ä½¿ç”¨è¯¥å…³é”®å­—ï¼Œå¦‚æœç‰ˆæœ¬å¤§äºæˆ‘ä»¬çš„è¦æ±‚ï¼Œåˆ™æŠŠå®å®šä¹‰ä¸ºè¯¥å…³é”®å­—ï¼Œå¦åˆ™å®šä¹‰ä¸ºç©ºã€‚</p><h3><span id="ä½¿ç”¨-nullptr-è€Œä¸æ˜¯-null">ä½¿ç”¨ nullptr è€Œä¸æ˜¯ NULL</span></h3><p>åœ¨C++ä¸­ï¼Œå®<code>NULL</code>åªæ˜¯å­—é¢é‡0ï¼Œè€Œ<code>nullptr</code>æ‰æ˜¯å­—é¢é‡ç©ºæŒ‡é’ˆã€‚</p><h3><span id="å‡½æ•°ä¸è¦å¤ªé•¿">å‡½æ•°ä¸è¦å¤ªé•¿</span></h3><p>åœ¨PyTorchä¸­ï¼Œå‡½æ•°éƒ½å¾ˆçŸ­ï¼Œä¸€èˆ¬ä¸è¶…è¿‡30è¡Œï¼Œå°½é‡æŠŠå‡½æ•°å˜å¾—ç²¾ç®€ã€‚</p><h3><span id="ampamp">&amp;&amp;</span></h3><p>å½“ <code>&amp;&amp;</code> å‡ºç°åœ¨å‚æ•°åˆ—è¡¨ä¸­æˆ–å‡½æ•°è¿”å›å€¼å¤„æ—¶è¡¨ç¤º<strong>å³å€¼å¼•ç”¨</strong>(RValue-Reference)ã€‚æ‰€è°“å³å€¼å¼•ç”¨å°±æ˜¯å¯¹å³å€¼çš„å¼•ç”¨ï¼Œè€Œå³å€¼å°±æ˜¯åªèƒ½å‡ºç°åœ¨ç­‰å·å³è¾¹çš„å€¼ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæ²¡æœ‰å†…å­˜åœ°å€çš„å€¼ã€‚å¦‚æ•°å­—å­—é¢é‡ï¼Œ<code>a+1</code>(<code>int a;</code>) ç­‰éƒ½æ˜¯å³å€¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ª<code>&amp;&amp;</code>ç”¨æ³•çš„ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>&amp;&amp; a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Some magical code...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    foo(b); <span class="comment">//Error. An rValue reference cannot be pointed to a lValue.</span></span><br><span class="line">    foo(<span class="number">5</span>); <span class="comment">//Compiles with no error.</span></span><br><span class="line">    foo(b+<span class="number">3</span>); <span class="comment">//Compiles with no error.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>&amp;&amp; c = b; <span class="comment">//Error. An rValue reference cannot be pointed to a lValue.</span></span><br><span class="line">    <span class="keyword">int</span>&amp;&amp; d = <span class="number">5</span>; <span class="comment">//Compiles with no error.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="default-å’Œ-delete">=default å’Œ = delete</span></h3><p>è¯¦è§ï¼šhttps://www.ibm.com/developerworks/cn/aix/library/1212_lufang_c11new/index.html</p><p>ç®€å•æ¥è¯´ï¼Œæ„é€ å‡½æ•°ã€ææ„å‡½æ•°ç­‰ç‰¹æ®Šå‡½æ•°å¯ä»¥ç”¨ <code>=default</code> æ¥è®©ç¼–è¯‘å™¨ä¸ºå…¶æä¾›é»˜è®¤æ„é€ å‡½æ•°æˆ–é»˜è®¤ææ„å‡½æ•°ã€‚è€Œ <code>=delete</code> å¯ä»¥ç¦ç”¨æŸä¸ªå‡½æ•°ï¼Œå¦‚ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span>&#123;</span>            </span><br><span class="line">  <span class="keyword">public</span>: </span><br><span class="line">X(); </span><br><span class="line">X(<span class="keyword">const</span> X&amp;) = <span class="keyword">delete</span>;  <span class="comment">// å£°æ˜æ‹·è´æ„é€ å‡½æ•°ä¸º deleted å‡½æ•°</span></span><br><span class="line">  <span class="comment">// å£°æ˜æ‹·è´èµ‹å€¼æ“ä½œç¬¦ä¸º deleted å‡½æ•°</span></span><br><span class="line">X&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> X &amp;) = <span class="keyword">delete</span>; </span><br><span class="line">&#125;; </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123; </span><br><span class="line">X x1; </span><br><span class="line">  X x2=x1;   <span class="comment">// é”™è¯¯ï¼Œæ‹·è´æ„é€ å‡½æ•°è¢«ç¦ç”¨</span></span><br><span class="line">X x3; </span><br><span class="line">x3=x1;     <span class="comment">// é”™è¯¯ï¼Œæ‹·è´èµ‹å€¼æ“ä½œç¬¦è¢«ç¦ç”¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</span></h3><h4><span id="unique_ptr">Unique_Ptr</span></h4><p>åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆå¯¹è±¡æŒ‡å‘æŸå—å†…å­˜ã€‚</p><p>ç‰¹æ€§ï¼š</p><ol type="1"><li><p>æ— æ³•è¿›è¡Œå¤åˆ¶æ„é€ ä¸èµ‹å€¼æ“ä½œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; ap(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">88</span> );</span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; one (ap) ; <span class="comment">// error</span></span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; two = one; <span class="comment">// error</span></span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥è¿›è¡Œç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; GetVal() &#123;</span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; up(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">88</span>));</span><br><span class="line"><span class="keyword">return</span> up;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; uPtr = GetVal();   <span class="comment">//ok</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; up(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">88</span>));</span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; uPtr2 = <span class="built_in">std</span>:move(up); <span class="comment">// ok</span></span><br></pre></td></tr></table></figure></li></ol><h4><span id="shared_ptr">Shared_Ptr</span></h4><p><code>shared_ptr</code>æ˜¯è‡ªå¸¦å¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆï¼Œæ¯ä¸€ä¸ª`<code>shared_ptr</code>çš„æ‹·è´éƒ½æŒ‡å‘ç›¸åŒçš„å†…å­˜ã€‚æ¯ä½¿ç”¨ä»–ä¸€æ¬¡ï¼Œå†…éƒ¨çš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œæ¯ææ„ä¸€æ¬¡ï¼Œå†…éƒ¨çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œå‡ä¸º0æ—¶ï¼Œåˆ é™¤æ‰€æŒ‡å‘çš„å †å†…å­˜ã€‚<code>shared_ptr</code>å†…éƒ¨çš„å¼•ç”¨è®¡æ•°æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å¯¹è±¡çš„è¯»å–éœ€è¦åŠ é”ï¼Œ<a href="https://www.cnblogs.com/jiayayao/p/6128877.html" target="_blank" rel="noopener">é˜…è¯»æ›´å¤š</a>ã€‚</p><h4><span id="weak_ptr">Weak_Ptr</span></h4><p><code>weak_ptr</code> ç”¨æ¥è¡¨è¾¾ä¸´æ—¶æ‰€æœ‰æƒçš„æ¦‚å¿µï¼šå½“æŸä¸ªå¯¹è±¡åªæœ‰å­˜åœ¨æ—¶æ‰éœ€è¦è¢«è®¿é—®ï¼Œè€Œä¸”éšæ—¶å¯èƒ½è¢«ä»–äººåˆ é™¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>weak_ptr</code> æ¥è·Ÿè¸ªè¯¥å¯¹è±¡ã€‚éœ€è¦è·å¾—ä¸´æ—¶æ‰€æœ‰æƒæ—¶ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸º <code>shared_ptr</code>ï¼Œæ­¤æ—¶å¦‚æœåŸæ¥çš„ <code>shared_ptr</code> è¢«é”€æ¯ï¼Œåˆ™è¯¥å¯¹è±¡çš„ç”Ÿå‘½æœŸå°†è¢«å»¶é•¿è‡³è¿™ä¸ªä¸´æ—¶çš„ <code>shared_ptr</code> åŒæ ·è¢«é”€æ¯ä¸ºæ­¢ã€‚</p><p><code>weak_ptr</code>æ˜¯ä¸ºäº†é…åˆ<code>shared_ptr</code>è€Œå¼•å…¥çš„ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªç”±<code>shared_ptr</code>ç®¡ç†çš„å¯¹è±¡è€Œä¸å½±å“æ‰€æŒ‡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯å°†ä¸€ä¸ª<code>weak_ptr</code>ç»‘å®šåˆ°ä¸€ä¸ª<code>shared_ptr</code>ä¸ä¼šæ”¹å˜<code>shared_ptr</code>çš„å¼•ç”¨è®¡æ•°ã€‚ä¸è®ºæ˜¯å¦æœ‰<code>weak_ptr</code>æŒ‡å‘ï¼Œä¸€æ—¦æœ€åä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„<code>shared_ptr</code>è¢«é”€æ¯ï¼Œå¯¹è±¡å°±ä¼šè¢«é‡Šæ”¾ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼Œ<code>weak_ptr</code>æ›´åƒæ˜¯<code>shared_ptr</code>çš„ä¸€ä¸ªåŠ©æ‰‹è€Œä¸æ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚C++ä¸­æä¾›äº†<code>lock</code>å‡½æ•°æ¥å®ç°è®¿é—®åŠŸèƒ½ã€‚å¦‚æœå¯¹è±¡å­˜åœ¨ï¼Œ<code>lock()</code>å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘å…±äº«å¯¹è±¡çš„<code>shared_ptr</code>ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©º<code>shared_ptr</code>ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() : a(<span class="number">3</span>) &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"A Constructor..."</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"A Destructor..."</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">shared_ptr</span>&lt;A&gt; sp(<span class="keyword">new</span> A());</span><br><span class="line">    weak_ptr&lt;A&gt; wp(sp);</span><br><span class="line">    <span class="comment">//sp.reset();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">shared_ptr</span>&lt;A&gt; pa = wp.lock())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; pa-&gt;a &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"wpæŒ‡å‘å¯¹è±¡ä¸ºç©º"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/Xiejingfa/article/details/50772571" target="_blank" rel="noopener">é˜…è¯»æ›´å¤š</a>ã€‚</p><h3><span id="å˜å‚æ¨¡æ¿">å˜å‚æ¨¡æ¿</span></h3><p>å˜å‚æ¨¡æ¿å£°æ˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span>... <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">f</span>(<span class="title">T</span>... <span class="title">args</span>);</span></span><br></pre></td></tr></table></figure><p>çœç•¥å·çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p><ol type="1"><li>å£°æ˜ä¸€ä¸ªå‚æ•°åŒ… <code>Tâ€¦ args</code>ï¼Œè¿™ä¸ªå‚æ•°åŒ…ä¸­å¯ä»¥åŒ…å«0åˆ°ä»»æ„ä¸ªæ¨¡æ¿å‚æ•°ï¼›</li><li>åœ¨æ¨¡æ¿å®šä¹‰çš„å³è¾¹ï¼Œå¯ä»¥å°†å‚æ•°åŒ…å±•å¼€æˆä¸€ä¸ªä¸€ä¸ªç‹¬ç«‹çš„å‚æ•°ã€‚</li></ol><p><strong>åŸºæœ¬ç”¨æ³•</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span>... <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">f</span>(<span class="title">T</span>... <span class="title">args</span>)</span></span><br><span class="line"><span class="class">&#123;</span>    </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="keyword">sizeof</span>...(args) &lt;&lt; <span class="built_in">endl</span>; <span class="comment">//æ‰“å°å˜å‚çš„ä¸ªæ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f();        <span class="comment">//0</span></span><br><span class="line">f(<span class="number">1</span>, <span class="number">2</span>);    <span class="comment">//2</span></span><br><span class="line">f(<span class="number">1</span>, <span class="number">2.5</span>, <span class="string">""</span>);    <span class="comment">//3</span></span><br></pre></td></tr></table></figure><p><strong>é€’å½’å±•å¼€</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">sum</span><span class="params">(T t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ... Types&gt;</span><br><span class="line"><span class="function">T <span class="title">sum</span> <span class="params">(T first, Types ... rest)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> first + sum&lt;T&gt;(rest...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sum(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>); <span class="comment">//10</span></span><br></pre></td></tr></table></figure><p><strong>åˆå§‹åŒ–åˆ—è¡¨+é€—å·è¡¨è¾¾å¼å±•å¼€</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">printarg</span>(<span class="title">T</span> <span class="title">t</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; t &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> ...<span class="title">Args</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">expand</span>(<span class="title">Args</span>... <span class="title">args</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="keyword">int</span> arr[] = &#123;(printarg(args), <span class="number">0</span>)...&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">expand(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­å°†åˆ†åˆ«æ‰“å°å‡º1,2,3,4å››ä¸ªæ•°å­—ã€‚è¿™ç§å±•å¼€å‚æ•°åŒ…çš„æ–¹å¼ï¼Œä¸éœ€è¦é€šè¿‡é€’å½’ç»ˆæ­¢å‡½æ•°ï¼Œæ˜¯ç›´æ¥åœ¨<code>expand</code>å‡½æ•°ä½“ä¸­å±•å¼€çš„, <code>printarg</code>ä¸æ˜¯ä¸€ä¸ªé€’å½’ç»ˆæ­¢å‡½æ•°ï¼Œåªæ˜¯ä¸€ä¸ªå¤„ç†å‚æ•°åŒ…ä¸­æ¯ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚</p><p><code>expand</code>å‡½æ•°ä¸­çš„é€—å·è¡¨è¾¾å¼ï¼š<code>(printarg(args), 0)</code>ï¼Œå…ˆæ‰§è¡Œ<code>printarg(args)</code>ï¼Œå†å¾—åˆ°é€—å·è¡¨è¾¾å¼çš„ç»“æœ<code>0</code>ã€‚åŒæ—¶è¿˜ç”¨åˆ°äº†C++11çš„å¦å¤–ä¸€ä¸ªç‰¹æ€§â€”â€”åˆå§‹åŒ–åˆ—è¡¨ï¼Œé€šè¿‡åˆå§‹åŒ–åˆ—è¡¨æ¥åˆå§‹åŒ–ä¸€ä¸ªå˜é•¿æ•°ç»„, <code>{(printarg(args), 0)â€¦}</code>å°†ä¼šå±•å¼€æˆ<code>((printarg(arg1),0), (printarg(arg2),0), (printarg(arg3),0), ...)</code>ï¼Œæœ€ç»ˆä¼šåˆ›å»ºä¸€ä¸ªå…ƒç´ å€¼éƒ½ä¸º<code>0</code>çš„æ•°ç»„<code>int arr[sizeof...(Args)]</code>ã€‚ç”±äºæ˜¯é€—å·è¡¨è¾¾å¼ï¼Œåœ¨åˆ›å»ºæ•°ç»„çš„è¿‡ç¨‹ä¸­ä¼šå…ˆæ‰§è¡Œé€—å·è¡¨è¾¾å¼å‰é¢çš„éƒ¨åˆ†<code>printarg(args)</code>æ‰“å°å‡ºå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ„é€ intæ•°ç»„çš„è¿‡ç¨‹ä¸­å°±å°†å‚æ•°åŒ…å±•å¼€äº†ï¼Œè¿™ä¸ªæ•°ç»„çš„ç›®çš„çº¯ç²¹æ˜¯ä¸ºäº†åœ¨æ•°ç»„æ„é€ çš„è¿‡ç¨‹å±•å¼€å‚æ•°åŒ…ã€‚</p><p><strong>å®Œç¾è½¬å‘</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">F</span>, <span class="title">class</span>... <span class="title">Args</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">expand</span>(<span class="title">const</span> <span class="title">F</span>&amp; <span class="title">f</span>, <span class="title">Args</span>&amp;&amp;...<span class="title">args</span>) </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="built_in">initializer_list</span>&lt;<span class="keyword">int</span>&gt;&#123;(f(<span class="built_in">std</span>::forward&lt;Args&gt;(args)), <span class="number">0</span>)...&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// èŒƒå‹Lambdaè¡¨è¾¾å¼</span></span><br><span class="line">expand([](<span class="keyword">auto</span> i)&#123;<span class="built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="built_in">endl</span>;&#125;, <span class="number">1</span>, <span class="number">2.0</span>, â€testâ€);</span><br></pre></td></tr></table></figure><p><code>std::forward</code>å¯ä»¥ä¿æŒå‚æ•°çš„å·¦å€¼æˆ–å³å€¼æ€§è´¨ï¼Œæ‰€ä»¥å«å®Œç¾è½¬å‘ã€‚</p><h3><span id="å‡½æ•°è¿”å›å€¼ç±»å‹åç½®">å‡½æ•°è¿”å›å€¼ç±»å‹åç½®</span></h3><p>ä¾‹å­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> ReadyQueue::push(FunctionTask item) -&gt; <span class="keyword">void</span> &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</span><br><span class="line">    ++item.base-&gt;outstanding_tasks;</span><br><span class="line">    heap.push(<span class="built_in">std</span>::move(item));</span><br><span class="line">  &#125;</span><br><span class="line">  not_empty.notify_one();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æï¼šhttps://blog.csdn.net/fjb2080/article/details/7527349</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;C++è¿™é—¨è¯­è¨€çœŸçš„æ˜¯åšå¤§ç²¾æ·±ï¼Œåœ¨é˜…è¯»PyTorchæºç çš„æ—¶å€™æ„Ÿè§¦å°¤ä¸ºæ·±åˆ»ï¼Œåœ¨æ­¤è®°å½•ä¸€äº›æˆ‘è®¤ä¸ºå¾ˆå¥½çš„ç¼–ç¨‹å®è·µä»¥åŠä¸€äº›C++çš„â€œæ–°â€ç‰¹æ€§ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="C++" scheme="http://www.52coding.com.cn/tags/C/"/>
    
      <category term="template" scheme="http://www.52coding.com.cn/tags/template/"/>
    
      <category term="æ™ºèƒ½æŒ‡é’ˆ" scheme="http://www.52coding.com.cn/tags/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/"/>
    
  </entry>
  
  <entry>
    <title>Microeconomics - The Costs of Production</title>
    <link href="http://www.52coding.com.cn/2019/04/10/The%20Costs%20of%20Production/"/>
    <id>http://www.52coding.com.cn/2019/04/10/The Costs of Production/</id>
    <published>2019-04-10T03:23:45.000Z</published>
    <updated>2019-04-12T07:10:35.318Z</updated>
    
    <content type="html"><![CDATA[<p>In this chapter, we examine firm behavior in more detail. This topic will give you a better understanding of the decisions behind the supply curve. In addition, it will introduce you to a part of economics called <em>industrial organization</em> â€” the study of how firmsâ€™ decisions about prices and quantities depend on the market conditions they face.</p><a id="more"></a><h2><span id="what-are-costs">WHAT ARE COSTS?</span></h2><p>We begin our discussion of costs at a Cookie factory. By examining some of the issues that the owner faces in his/her business, we can learn some lessons about costs that apply to all firms in an economy.</p><h3><span id="total-revenue-total-cost-and-profit">Total Revenue, Total Cost, and Profit</span></h3><p>The amount that the firm receives for the sale of its output is called its <strong>total revenue</strong>. The amount that the firm pays to buy inputs is called its <strong>total cost</strong>. <strong>Profit</strong> is a firmâ€™s total revenue minus its total cost:</p><p><span class="math display">\[\text{Profit} = \text{Total revenue} - \text{Total cost}\]</span></p><p>To see how a firm goes about maximizing profit, we must consider fully how to measure its total revenue and its total cost. Total revenue is the easy part: It equals the <em>quantity</em> of output the firm produces <em>times</em> the <em>price</em> at which it sells its output. By contrast, the measurement of a firmâ€™s total cost is more subtle.</p><h3><span id="costs-as-opportunity-costs">Costs As Opportunity Costs</span></h3><p><strong>explicit costs</strong>: input costs that require an outlay of money by the firm <strong>implicit costs</strong>: input costs that do not require an outlay of money by the firm</p><p>Imagine that the owner of the cookie factory is skilled with computers and could earn Â¥100 per hour working as a programmer. For every hour that she works at her cookie factory, she gives up Â¥100 in income, and this forgone income is also part of her costs. The total cost of her business is the sum of the explicit costs and the implicit costs.</p><h3><span id="the-cost-of-capital-as-an-opportunity-cost">The Cost of Capital as An Opportunity Cost</span></h3><p>An important implicit cost of almost every business is the opportunity cost of the financial capital that has been invested in the business. Suppose, for instance, that the owner of the cookie factory used Â¥300,000 of her savings to buy her cookie factory from its previous owner. If she had instead left this money deposited in a savings account that pays an interest rate of 5 percent, she would have earned Â¥15,000 per year. To own her cookie factory, therefore, Caroline has given up Â¥15,000 a year in interest income. This forgone Â¥15,000 is one of the <strong>implicit opportunity costs</strong> of Carolineâ€™s business.</p><h3><span id="economic-profit-versus-accounting-profit">Economic Profit Versus Accounting Profit</span></h3><p>Now letâ€™s return to the firmâ€™s objective: <strong>profit</strong>. An economist measures a firmâ€™s <strong>economic profit</strong> as the firmâ€™s total revenue minus all the opportunity costs (explicit and implicit) of producing the goods and services sold. An accountant measures the firmâ€™s <strong>accounting profit</strong> as the firmâ€™s total revenue minus only the firmâ€™s explicit costs as shown in Figure 1.</p><p><img src="/images/costandprod/DraggedImage.jpg"></p><p>Economic profit is an important concept because it is what motivates the firms that supply goods and services. As we will see, <em>a firm making positive economic profit will stay in business</em>. It is covering all its opportunity costs and has some revenue left to reward the firm owners. When a firm is making economic losses, the business owners are failing to earn enough revenue to cover all the costs of production. Unless conditions change, the firm owners will eventually close down the business and exit the industry. To understand business decisions, we need to keep an eye on economic profit.</p><p><strong>Economic profit equals to zero</strong> means your business is running well and you pay yourself the same amount as you get paid somewhere else.</p><h2><span id="production-and-costs">PRODUCTION AND COSTS</span></h2><p><img src="/images/costandprod/DraggedImage-1.jpg"></p><p>Table 1 shows how the quantity of cookies produced per hour at the cookie factory depends on the number of workers. This relationship between the <em>quantity of inputs</em> (workers) and <em>quantity of output</em> (cookies) is called the <strong>production function</strong>.</p><p><img src="/images/costandprod/DraggedImage-2.jpg"></p><p>To take a step toward understanding these decisions, the third column in the table gives the <strong>marginal product</strong> of a worker. Notice that as the number of workers increases, the marginal product declines. The second worker has a marginal product of 40 cookies, the third worker has a marginal product of 30 cookies, and the fourth worker has a marginal product of 20 cookies. This property is called <strong>diminishing marginal product</strong>.</p><p>Diminishing marginal product is also apparent in Figure 2. The production functionâ€™s slope tells us the change in the factoryâ€™s output of cookies for each additional input of labor. That is, the <strong>slope of the production function</strong> measures the <em>marginal product</em> of a worker. As the number of workers increases, the marginal product declines, and the production function becomes flatter.</p><h3><span id="from-the-production-function-to-the-total-cost-curve">From The Production Function To The Total-Cost Curve</span></h3><p>Our goal in the next is to study firmsâ€™ production and pricing decisions. For this purpose, the most important relationship in Table 1 is between quantity produced and total costs. Panel (b) of Figure 2 graphs these two columns of data with the quantity produced on the horizontal axis and total cost on the vertical axis. This graph is called the <strong>total-cost curve</strong>.</p><p>Now compare the total-cost curve in panel (b) with the production function in panel (a). These two curves are opposite sides of the same coin. The total-cost curve gets <em>steeper</em> as the amount produced rises, whereas the production function gets <em>flatter</em> as production rises. These changes in slope occur for the same reason. High production of cookies means that Carolineâ€™s kitchen is crowded with many workers. Because the kitchen is crowded, each additional worker adds less to production, reflecting diminishing marginal product. Therefore, the production function is relatively flat. But now turn this logic around: When the kitchen is crowded, producing an additional cookie requires a lot of additional labor and is thus very costly. Therefore, when the quantity produced is large, the total-cost curve is relatively steep.</p><h2><span id="the-various-measures-of-cost">THE VARIOUS MEASURES OF COST</span></h2><p><img src="/images/costandprod/DraggedImage-3.jpg"></p><p>To see how related measures of cost are derived, we consider the example in Table 2. This table presents cost data on Conradâ€™s Coffee Shop. Figure 3 plots Conradâ€™s total-cost curve. Conradâ€™s total-cost curve becomes steeper as the quantity produced rises, which (as we have discussed) reflects <em>diminishing marginal product</em>.</p><p><img src="/images/costandprod/DraggedImage-4.jpg"></p><h3><span id="fixed-and-variable-costs">Fixed And Variable Costs</span></h3><p><strong>Fixed costs</strong> are costs that do not vary with the <em>quantity of output produced</em>. They are incurred even if the firm produces nothing at all. Conradâ€™s fixed costs include any rent he pays because this cost is the same regardless of how much coffee he produces.</p><p><strong>Variable costs</strong> are costs that change as the firm alters the quantity of output produced. Conradâ€™s variable costs include the cost of coffee beans, milk, sugar, and paper cups: The more cups of coffee Conrad makes, the more of these items he needs to buy.</p><p>A firmâ€™s <strong>total cost</strong> is the sum of fixed and variable costs. In Table 2, total cost in the second column equals fixed cost in the third column plus variable cost in the fourth column.</p><h3><span id="average-and-marginal-cost">Average and Marginal Cost</span></h3><p>Total cost divided by the quantity of output is called <strong>average total cost</strong>. Because total cost is the sum of fixed and variable costs, average total cost can be expressed as the sum of average fixed cost and average variable cost. <strong>Average fixed cost</strong> is the fixed cost divided by the quantity of output, and <strong>average variable cost</strong> is the variable cost divided by the quantity of output.</p><p>Although average total cost tells us the cost of the typical unit, it does not tell us how much total cost will change as the firm alters its level of production. <strong>Marginal cost</strong> is the increase in total cost that arises from an extra unit of production. In the table, the marginal cost appears halfway between two rows because it represents the change in total cost as quantity of output increases from one level to another.</p><p>Mathematically:</p><p><span class="math display">\[ATC = TC/Q \\MC = \triangle TC / \triangle Q\]</span></p><h3><span id="cost-curves-and-their-shapes">Cost Curves And Their Shapes</span></h3><p><img src="/images/costandprod/DraggedImage-5.jpg"></p><p>Figure 4 graphs Conradâ€™s costs using the data from Table 2. The horizontal axis measures the quantity the firm produces, and the vertical axis measures marginal and average costs. The graph shows four curves: average total cost (ATC), average fixed cost (AFC), average variable cost (AVC), and marginal cost (MC).</p><p><strong>Rising Marginal Cost</strong> Conradâ€™s marginal cost rises with the quantity of out- put produced. This reflects the property of diminishing marginal product.</p><p><strong>U-Shaped Average Total Cost</strong> Average total cost is the sum of average fixed cost and average variable cost. Average fixed cost always declines as output rises because the fixed cost is spread over a larger number of units. Average variable cost typically rises as output increases because of diminishing marginal product. Average total cost reflects the shapes of both average fixed cost and average variable cost.</p><p>The bottom of the U-shape occurs at the quantity that minimizes average total cost. This <em>quantity</em> is sometimes called the <strong>efficient scale</strong> of the firm. At the efficient scale, these two forces are balanced to yield the lowest average total cost.</p><p><strong>The Relationship Between Marginal Cost and Average Total Cost</strong> * Whenever marginal cost is less than average total cost, average total cost is falling. * Whenever marginal cost is greater than average total cost, average total cost is rising.</p><p>To see why, consider an analogy. Average total cost is like your cumulative grade point average. Marginal cost is like the grade in the next course you will take. If your grade in your next course is less than your grade point average, your grade point average will fall. If your grade in your next course is higher than your grade point average, your grade point average will rise. The mathematics of average and marginal costs is exactly the same as the mathematics of average and marginal grades.</p><p>This relationship between average total cost and marginal cost has an important corollary: <strong>The marginal-cost curve crosses the average-total-cost curve at its minimum</strong>. As you will see in the next chapter, <strong>minimum average total cost</strong> plays a key role in the analysis of competitive firms.</p><h3><span id="typical-cost-curves">Typical Cost Curves</span></h3><p><img src="/images/costandprod/DraggedImage-6.jpg"></p><p>Actual firms are usually more complicated than what we talked about before. In many firms, marginal product does not start to fall immediately after the first worker is hired. Depending on the production process, the second or third worker might have a higher marginal product than the first because a team of workers can divide tasks and work more productively than a single worker. Firms exhibiting this pattern would experience increasing marginal product for a while before diminishing marginal product set in.</p><p>Figure 5 shows the cost curves for such a firm, including average total cost (ATC), average fixed cost (AFC), average variable cost (AVC), and marginal cost (MC). Despite these differences from our previous example, the cost curves shown here share the three properties that are most important to remember:</p><ul><li>Marginal cost eventually rises with the quantity of output.</li><li>The average-total-cost curve is U-shaped.</li><li>The marginal-cost curve crosses the average-total-cost curve at the <strong>minimum of average total cost</strong>.</li></ul><h2><span id="conclusion">CONCLUSION</span></h2><p><img src="/images/costandprod/DraggedImage-7.jpg"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In this chapter, we examine firm behavior in more detail. This topic will give you a better understanding of the decisions behind the supply curve. In addition, it will introduce you to a part of economics called &lt;em&gt;industrial organization&lt;/em&gt; â€” the study of how firmsâ€™ decisions about prices and quantities depend on the market conditions they face.&lt;/p&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="å¾®è§‚ç»æµå‹åŸç†" scheme="http://www.52coding.com.cn/tags/%E5%BE%AE%E8%A7%82%E7%BB%8F%E6%B5%8E%E5%9E%8B%E5%8E%9F%E7%90%86/"/>
    
      <category term="Marginal Cost" scheme="http://www.52coding.com.cn/tags/Marginal-Cost/"/>
    
      <category term="Profit" scheme="http://www.52coding.com.cn/tags/Profit/"/>
    
  </entry>
  
  <entry>
    <title>Microeconomics - Consumers, Producers, and the Efficiency of Markets</title>
    <link href="http://www.52coding.com.cn/2019/03/20/Consumers,%20Producers,%20and%20the%20Efficiency%20of%20Markets/"/>
    <id>http://www.52coding.com.cn/2019/03/20/Consumers, Producers, and the Efficiency of Markets/</id>
    <published>2019-03-20T08:17:37.000Z</published>
    <updated>2019-04-12T07:10:01.054Z</updated>
    
    <content type="html"><![CDATA[<p>In this chapter, we take up the topic of <strong>welfare economics</strong>, the study of how the allocation of resources affects economic well-being. This analysis leads to a profound conclusion: The equilibrium of supply and demand in a market maximizes the total benefits received by buyers and sellers.</p><a id="more"></a><p><strong>Table of Contents</strong></p><!-- toc --><ul><li><a href="#consumer-surplus">CONSUMER SURPLUS</a><ul><li><a href="#willingness-to-pay">Willingness To Pay</a></li><li><a href="#using-the-demand-curve-to-measure-consumer-surplus">Using The Demand Curve To Measure Consumer Surplus</a></li><li><a href="#how-a-lower-price-raises-consumer-surplus">How A Lower Price Raises Consumer Surplus</a></li><li><a href="#what-does-consumer-surplus-measure">What Does Consumer Surplus Measure?</a></li></ul></li><li><a href="#producer-surplus">PRODUCER SURPLUS</a><ul><li><a href="#cost-and-the-willingness-to-sell">Cost And The Willingness To Sell</a></li><li><a href="#using-the-supply-curve-to-measure-producer-surplus">Using The Supply Curve To Measure Producer Surplus</a></li><li><a href="#how-a-higher-price-raises-producer-surplus">How A Higher Price Raises Producer Surplus</a></li></ul></li><li><a href="#market-efficiency">MARKET EFFICIENCY</a><ul><li><a href="#the-benevolent-social-planner">The Benevolent Social Planner</a></li><li><a href="#evaluating-the-market-equilibrium">Evaluating The Market Equilibrium</a></li></ul></li><li><a href="#conclusion">CONCLUSION</a></li></ul><!-- tocstop --><h2><span id="consumer-surplus">CONSUMER SURPLUS</span></h2><h3><span id="willingness-to-pay">Willingness To Pay</span></h3><p><strong>Willingness to pay</strong> is the maximum amount that a buyer will pay for a good. <strong>Consumer surplus</strong> is the amount a buyer is willing to pay for a good minus the amount the buyer actually pays for it. For example, John is willing to pay Â¥100 for an album but pays only Â¥80 for it. So John receives <em>consumer surplus</em> of Â¥20.</p><h3><span id="using-the-demand-curve-to-measure-consumer-surplus">Using The Demand Curve To Measure Consumer Surplus</span></h3><p>Say John, Paul, George, and Ringo willing to buy an old album. Table 1 shows the maximum price that each of the four possible buyers would pay. The table in Figure 1 shows the demand schedule that corresponds to Table 1.</p><p><img src="/images/surplus/DraggedImage.jpg"> <img src="/images/surplus/DraggedImage-1.jpg"></p><p>Because the demand curve reflects buyersâ€™ willingness to pay, we can also use it to measure consumer surplus. Figure 2 uses the demand curve to compute consumer surplus in our two examples.</p><p><img src="/images/surplus/DraggedImage-2.jpg"></p><p>We can find out that <strong>the area below the demand curve and above the price measures the consumer surplus in a market</strong>. This is true because the height of the demand curve measures the value buyers place on the good, as measured by their willingness to pay for it. The difference between this willingness to pay and the market price is each buyerâ€™s consumer surplus. Thus, the total area below the demand curve and above the price is the sum of the consumer surplus of all buyers in the market for a good or service.</p><h3><span id="how-a-lower-price-raises-consumer-surplus">How A Lower Price Raises Consumer Surplus</span></h3><p><img src="/images/surplus/DraggedImage-3.jpg"></p><p>Figure 3 shows a typical demand curve. In panel (a), consumer surplus at a price of P1 is the area of triangle ABC. Now suppose that the price falls from P1 to P2, as shown in panel (b). The consumer surplus now equals area ADF.</p><p>This increase in consumer surplus is composed of two parts. First, those buyers who were already buying Q1 of the good at the higher price P1 are better off because they now pay less. It equals the area of the rectangle BCDE. Seconds, some new buyers enter the market. The consumer surplus these newcomers receive is the area of the triangle CEF.</p><h3><span id="what-does-consumer-surplus-measure">What Does Consumer Surplus Measure?</span></h3><p>Consumer surplus, the amount that buyers are willing to pay for a good minus the amount they actually pay for it, measures the benefit that buyers reveille from a good as the buyers themselves perceive it. Thus, consumer surplus is a good measure of economic well-being if policymakers want to respect the <strong>preferences of buyers</strong>.</p><h2><span id="producer-surplus">PRODUCER SURPLUS</span></h2><h3><span id="cost-and-the-willingness-to-sell">Cost And The Willingness To Sell</span></h3><p>A sellerâ€™s <strong>cost</strong> of doing a work is the value of everything the seller must give up to produce a good. <strong>Producer surplus</strong> is the amount a seller is paid for a good minus the sellerâ€™s cost of providing it.</p><h3><span id="using-the-supply-curve-to-measure-producer-surplus">Using The Supply Curve To Measure Producer Surplus</span></h3><p>Say there are four painters, Mary, Frida, Georgia, Grandma, compete for painting a house. Table 2 shows the costs of them. <img src="/images/surplus/DraggedImage-4.jpg"></p><p>Producer surplus is closely related to the supply curve. The table in Figure 4 shows the supply schedule that corresponds to the costs in Table 2. The graph in Figure 4 shows the supply curve that corresponds to this supply schedule.</p><p><img src="/images/surplus/DraggedImage-5.jpg"></p><p>Because the supply curve reflects sellersâ€™ cost, we can use it to measure producer surplus, as shown in Figure 5. <strong>The area below the price and above the supply curve measures the producer surplus in a market</strong>. The logic is straightforward: The height of the supply curve measures sellersâ€™ costs, and the difference between the price and the cost of production is each sellerâ€™s producer surplus. Thus, the total area is the sum of the producer surplus of all sellers. <img src="/images/surplus/DraggedImage-6.jpg"></p><h3><span id="how-a-higher-price-raises-producer-surplus">How A Higher Price Raises Producer Surplus</span></h3><p><img src="/images/surplus/DraggedImage-7.jpg"></p><p>Figure 6 shows a typical upward-sloping supply curve that would arise in a market with many sellers. In panel (a), the price is P1, and producer surplus is the area of triangle ABC. Panel (b) shows what happens when the price rises from P1 to P2. Producer surplus now equals area ADF.</p><h2><span id="market-efficiency">MARKET EFFICIENCY</span></h2><h3><span id="the-benevolent-social-planner">The Benevolent Social Planner</span></h3><p>One possible way to measure the economic well-being of a society is the sum of consumer and producer surplus, which we called <strong>total surplus</strong>. Consumer surplus is the benefit that buyers receive from participating in a market, and producer surplus is the benefit that sellers receive. It is therefore natural to use total surplus as a measure of societyâ€™s economic well-being.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Total surplus = Value to buyers - Cost to sellers</span><br></pre></td></tr></table></figure><p>Total surplus in a market is the total value to buyers of the goods, as measured by their willingness to pay, minus the total cost to sellers of providing those goods. If an allocation of resources maximizes total surplus, we say that the allocation exhibits <strong>efficiency</strong>.</p><p>In addition to efficiency, the social planner might also care about <strong>equality</strong>â€” that is, whether the various buyers and sellers in the market have a similar level of economic well-being.</p><h3><span id="evaluating-the-market-equilibrium">Evaluating The Market Equilibrium</span></h3><p><img src="/images/surplus/DraggedImage-8.jpg"></p><p>Figure 7 shows consumer and producer surplus when a market reaches the equilibrium of supply and demand curve. The total area between the supply and demand curves up to the point of equilibrium represents the total surplus in this market. Those buyers who value the good more than the price choose the buy the good; buyers who value it less than the price do not. Similarly, those sellers whose costs are less than the price choose to produce and sell the good.</p><p>These observations lead to three insights about market outcomes: 1. Free markets allocate the supply of goods to the buyers who value them most highly, as measured by their willingness to pay. 2. Free markets allocate the demand for goods to the sellers who can produce them at the least cost. 3. Free markets produce the quantity of goods that maximizes the sum of consumer and producer surplus.</p><p><img src="/images/surplus/DraggedImage-9.jpg"></p><p>Figure 8 illustrates why this is true. At any quantity below the equilibrium level, such as Q1, the value to the marginal buyer exceeds the cost to the marginal seller. As a result, increasing the quantity produced and consumed raises total surplus. This continues to be true until the quantity reaches the equilibrium level. Similar situations happed when the quantity larger than the equilibrium level.</p><p>Therefore, the equilibrium outcome is an <strong>efficient</strong> allocation of resources.</p><h2><span id="conclusion">CONCLUSION</span></h2><p>This chapter introduced the basic tools of welfare economics â€” consumer and producer surplus â€” and used them to evaluate the efficiency of free markets. We showed that the forces of supply and demand allocate resources efficiently.</p><p>A word of warning is in order. To conclude that markets are efficient, we made several assumptions about how markets work. First, our analysis assumed that markets are perfectly competitive. In the world, however, competition is sometimes far from perfect. Second, out analysis assumed that the outcome in a market matters only to the buyers and sellers in that market. Yet, in the world, the decisions of buyers and sellers sometimes affect people who are not participants in the market at all. Pollution is the classic example. Such side effects, called <strong>externalities</strong>, cause welfare in a market to depend on more than just the value to the buyers and the cost to the sellers.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In this chapter, we take up the topic of &lt;strong&gt;welfare economics&lt;/strong&gt;, the study of how the allocation of resources affects economic well-being. This analysis leads to a profound conclusion: The equilibrium of supply and demand in a market maximizes the total benefits received by buyers and sellers.&lt;/p&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="å¾®è§‚ç»æµå‹åŸç†" scheme="http://www.52coding.com.cn/tags/%E5%BE%AE%E8%A7%82%E7%BB%8F%E6%B5%8E%E5%9E%8B%E5%8E%9F%E7%90%86/"/>
    
      <category term="Market Efficiency" scheme="http://www.52coding.com.cn/tags/Market-Efficiency/"/>
    
      <category term="Consumer Surplus" scheme="http://www.52coding.com.cn/tags/Consumer-Surplus/"/>
    
      <category term="Producer Surplus" scheme="http://www.52coding.com.cn/tags/Producer-Surplus/"/>
    
  </entry>
  
  <entry>
    <title>Microeconomics - Elasticity and Its Application</title>
    <link href="http://www.52coding.com.cn/2019/02/22/Elasticity%20and%20Its%20Application/"/>
    <id>http://www.52coding.com.cn/2019/02/22/Elasticity and Its Application/</id>
    <published>2019-02-22T08:02:01.000Z</published>
    <updated>2019-04-12T07:10:06.980Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Table of Contents</strong></p><!-- toc --><ul><li><a href="#the-elasticity-of-demand">The Elasticity of Demand</a><ul><li><a href="#the-price-elasticity-of-demand-and-its-determinants">The Price Elasticity of Demand and Its Determinants</a></li><li><a href="#computing-the-price-elasticity-of-demand">Computing the Price Elasticity of Demand</a></li><li><a href="#the-midpoint-method-a-better-way-to-calculate-percentage-changes-and-elasticities">The Midpoint Method: A Better Way To Calculate Percentage Changes and Elasticities</a></li><li><a href="#the-variety-of-demand-curves">The Variety of Demand Curves</a></li><li><a href="#total-revenue-and-the-price-elasticity-of-demand">Total Revenue and The Price Elasticity of Demand</a></li><li><a href="#elasticity-and-total-revenue-along-a-linear-demand-curve">Elasticity and Total Revenue Along A Linear Demand Curve</a></li><li><a href="#other-demand-elasticities">Other Demand Elasticities</a></li></ul></li><li><a href="#the-elasticity-of-supply">The Elasticity Of Supply</a><ul><li><a href="#the-price-elasticity-of-supply-and-its-determinants">The Price Elasticity of Supply And Its Determinants</a></li><li><a href="#computing-the-price-elasticity-of-supply">Computing The Price Elasticity of Supply</a></li><li><a href="#the-vary-of-supply-curves">The Vary Of Supply Curves</a></li></ul></li><li><a href="#three-applications-of-supply-demand-and-elasticity">Three Applications Of Supply, Demand, And Elasticity</a><ul><li><a href="#can-good-news-for-farming-be-bad-news-for-farmers">Can Good News For Farming Be Bad News For Farmers</a></li><li><a href="#why-did-opec-fail-to-keep-the-price-of-oil-high">Why Did OPEC Fail To Keep The Price Of Oil High?</a></li><li><a href="#does-drug-interdiction-increase-or-decrease-drug-related-crime">Does Drug Interdiction Increase Or Decrease Drug-Related Crime?</a></li></ul></li><li><a href="#the-distributional-effects-of-tax">The Distributional Effects of Tax</a></li></ul><!-- tocstop --><a id="more"></a><h2><span id="the-elasticity-of-demand">The Elasticity of Demand</span></h2><p>To measure how much consumers respond to changes in economic variables, economists use the concept of <strong>elasticity</strong>. Elasticity is a measure of the responsiveness of quantity demanded or quantity supplied to one of its determinants.</p><h3><span id="the-price-elasticity-of-demand-and-its-determinants">The Price Elasticity of Demand and Its Determinants</span></h3><p>The <strong>price elasticity of demand</strong> measures how much the quantity demanded responds to a change in price. Demand for a good is said to be <em>elastic</em> if the quantity demanded responds substantially to changes in the price. Demand is said to be <em>inelastic</em> if the quantity demanded responds only slightly to changes in the price.</p><p>Based on experience, however, we can state some general rules about what determines the price elasticity of demand.</p><ul><li>Availablity of Close Substitutes</li><li>Necessities versus Luxuries</li><li>Definition of the Market</li><li>Time Horizon</li></ul><h3><span id="computing-the-price-elasticity-of-demand">Computing the Price Elasticity of Demand</span></h3><p><strong>Price elasticity of demand</strong> = Percentage change in quantity demanded / Percentage change in price</p><p>For example, suppose that a 10 percent increase in the price of an ice-cream cone causes the amount of ie cream you buy to fall by 20 percent. We calculate your elasticity of demand as</p><p>Price elasticity of demand = 20 percent / 10 percent = 2.</p><p>In this example, the elasticity is 2, reflecting that the change in the quantity demanded is proportionately twice as large as the change in the price. <em>A larger price elasticity implies a greater responsiveness of quantity demanded to price.</em></p><h3><span id="the-midpoint-method-a-better-way-to-calculate-percentage-changes-and-elasticities">The Midpoint Method: A Better Way To Calculate Percentage Changes and Elasticities</span></h3><p>The elasticity from point A to point B seems different from the elasticity from point B to point A. This difference arises because the percentage changes are calculated from a different base.</p><p>One way to avoid this problem is to use the <strong>midpoint method</strong> for calculating elasticities. The midpoint method computes a percentage change by dividing the midpoint of the initial and final levels. The following formula expresses the midpoint method for calculating the price elasticity of demand between two points, denoted (Q1, P1) and (Q2, P2):</p><p><img src="/images/elastic/DraggedImage.jpg"></p><h3><span id="the-variety-of-demand-curves">The Variety of Demand Curves</span></h3><p>Demand is considered <strong>elastic</strong> when the elasticity is greater than 1. Demand is considered <strong>inelastic</strong> when the elasticity is less than 1. Because the price elasticity of demand measures how much quantity demanded responds to changes in the price, it is closely related to the slope of the demand curve. The <strong>flatter</strong> the demand curve that passes through a given point, the <strong>greater</strong> the price elasticity of demand. The <strong>steeper</strong> the demand curve that passes through a given point, the <strong>smaller</strong> the price elasticity of demand. Figure 1 shows five cases.</p><p><img src="/images/elastic/DraggedImage-1.jpg"></p><h3><span id="total-revenue-and-the-price-elasticity-of-demand">Total Revenue and The Price Elasticity of Demand</span></h3><p><strong>Toal revenue</strong> is the amount paid by buyers and received by sellers of the good. In any market, total revenue is P * Q, the price of the good times the quantity of the good sold. We can show total revenue graphically, as in Figure 2.</p><p><img src="/images/elastic/DraggedImage-2.jpg"></p><p>How does total revenue change as one moves along the demand curve? There are some examples in Figure 3.</p><p><img src="/images/elastic/DraggedImage-3.jpg"></p><p>Although the examples in this figure are extreme, they illustrate some general rules:</p><ul><li>When demand is <strong>inelastic</strong>, price and total revenue move in the <strong>same direction</strong>.</li><li>When demand is <strong>elastic</strong>, price and total revenue move in <strong>opposite directions</strong>.</li><li>If demand is <strong>unit elastic</strong> (a price elasticity exactly equal to 1), total revenue <strong>remains constant</strong> when the price changes.</li></ul><h3><span id="elasticity-and-total-revenue-along-a-linear-demand-curve">Elasticity and Total Revenue Along A Linear Demand Curve</span></h3><p><img src="/images/elastic/DraggedImage-4.jpg"></p><p>Even though the slope of a linear demand curve is constant, the elasticity is not. This is true because the slope is the ratio of <em>changes</em> in the two variables, whereas the elasticity is the ratio of <em>percentage changes</em> in the two variables. At points with a low price and high quantity, the demand curve is inelastic. At points with a high price and low quantity, the demand curve is elastic.</p><p>The linear demand curve illustrates that the price elasticity of demand need not be the same at all points on a demand curve. A constant elasticity is possible, but it is not always the case.</p><h3><span id="other-demand-elasticities">Other Demand Elasticities</span></h3><p><strong>The Income Elasticity of Demand</strong> measures how the quantity demanded changes as consumer income changes.</p><p><img src="/images/elastic/DraggedImage-5.jpg"></p><p>Most of goods are <em>normal goods</em>: Higher income raises the quantity demanded, which have positive income elasticities. A few goods, such as bus rides, are <em>inferior goods</em>: Higher income lowers the quantity demanded, which have negative income elasticities.</p><p><strong>The Cross-Price Elasticity of Demand</strong> measures how the quantity demanded of one good responds to a change in the price of another good.</p><p><img src="/images/elastic/DraggedImage-6.jpg"></p><p>Substitutes are goods that are typically used in place of one another, whose cross-price elasticity is positive. Conversely, complements are goods that are typically used together, whose cross-price elasticity is negative.</p><h2><span id="the-elasticity-of-supply">The Elasticity Of Supply</span></h2><h3><span id="the-price-elasticity-of-supply-and-its-determinants">The Price Elasticity of Supply And Its Determinants</span></h3><p>The <strong>price elasticity of supply</strong> measures how much the quantity supplied responds to changes in the price. Supply of a good is said to be <em>elastic</em> if the quantity supplied responds substantially to changes in the price.</p><p>In most markets, a key determinant of the price elasticity of supply is the <strong>time period</strong> being considered. Supply is usually <em>more elastic in the long run</em> than in the short run.</p><h3><span id="computing-the-price-elasticity-of-supply">Computing The Price Elasticity of Supply</span></h3><p>Economists compute the price elasticity of supply as the percentage change in the quantity supplied divided by the percentage change in the price. That is, <img src="/images/elastic/DraggedImage-7.jpg"></p><h3><span id="the-vary-of-supply-curves">The Vary Of Supply Curves</span></h3><p><img src="/images/elastic/DraggedImage-8.jpg"></p><p><img src="/images/elastic/DraggedImage-9.jpg"></p><h2><span id="three-applications-of-supply-demand-and-elasticity">Three Applications Of Supply, Demand, And Elasticity</span></h2><h3><span id="can-good-news-for-farming-be-bad-news-for-farmers">Can Good News For Farming Be Bad News For Farmers</span></h3><p>The raise of production provided by new farming technology could make farmers worse off. Because the new technic increase the amount of wheat that can be produced on each acre of land, farmers are willing to supply more wheat at any price. In other words, <strong>the supply curve shift to the right</strong> and the demand curve still remain the same, which cause the price of wheat falls.</p><p><img src="/images/elastic/DraggedImage-10.jpg"></p><p>Wheat being an <strong>inelastic good</strong>, the price of wheat falls doesnâ€™t make people buy a lot more wheat. So a decrease in price causes farmersâ€™ total revenue to fall.</p><p>You may wonder why farmers would adopt the new technology. The answer goes to the heart of <strong>how competitive markets work</strong>. Because each farmer is only a small part of the market for wheat, itâ€™s better to use the new technic to produce and sell more wheat at any given price. Yet when all farmers do this, the supply of wheat increases, the price falls, and farmers are worse off.</p><p>It is important to keep in mind that what is good for farmers is not necessarily good for society as a whole. Improvement in farm technology can be bad for farmers because it makes farmers increasingly unnecessary, but it is surely good for consumers who pay less for food.</p><h3><span id="why-did-opec-fail-to-keep-the-price-of-oil-high">Why Did OPEC Fail To Keep The Price Of Oil High?</span></h3><p>The OPEC episode of 1970s and 1980s shows how supply and demand can behave differently in the short run and in the long run. <strong>In the short run</strong>, both the supply and demand for oil are <strong>inelastic</strong>. Supply is inelastic because the quantity of known oil reserves and the capacity for oil extraction cannot be changed quickly. Demand is inelastic because buying habits do not respond immediately to changes in price. Thus, as panel (a) of Figure 8 shows, <em>the short-run supply and demand curves are steep</em>.</p><p><img src="/images/elastic/DraggedImage-11.jpg"></p><p>The situation is very different in the long run. Over long periods of time, producers of oil outside OPEC respond to high prices by increasing oil exploration. Consumers respond with greater conservation. Thus, as panel (b) of Figure 8 shows, <em>the long-run supply and demand curves are more elastic</em>.</p><h3><span id="does-drug-interdiction-increase-or-decrease-drug-related-crime">Does Drug Interdiction Increase Or Decrease Drug-Related Crime?</span></h3><p><img src="/images/elastic/DraggedImage-12.jpg"></p><p>Suppose the government increase the number of federal agents devoted to the war on drugs. When the government stops some drugs from entering the country and arrests more smugglers, it raises the cost of selling drugs and, therefore, reduces the quantity of drugs supplied at any given price. But the <em>demand for drugs is not changed</em>, as panel (a) of Figure 9 shows.</p><p>But in terms of drug-related crime, since the demand for drugs is inelastic, then an increase in price raises total revenue in the drug market. Addicts who already had to steal to support their habits would have an even greater need for quick cash. Thus, <strong>drug interdiction could increase drug-related crime</strong>.</p><p>Rather than trying to reduce the supply of drugs, policymakers might try to reduce the demand by pursuing a policy of <strong>drug education</strong>. Successful drug education has the effects shown in panel (b) of Figure 9. Thus, in contrast to drug interdiction, <strong>drug education can reduce both drug use and drug-related crime</strong>.</p><p>However, the demand for drugs is probably inelastic over short periods, it may be more elastic elastic over longer periods because higher prices would discourage experimentation with drugs among the young and, over time, lead to fewer drug addicts. In this case, <strong>drug interdiction would increase drug-related crime in the short run while decreasing it in the long run</strong>.</p><h2><span id="the-distributional-effects-of-tax">The Distributional Effects of Tax</span></h2><p>Suppose this is the supply and demand curve of the gasoline market of Chicago without tax. The market price will be Â¥3 when there is no tax. So buyers pay Â¥3 to buy one gallon of gasoline and sellers receive Â¥3 for one gallon of gasoline.</p><p><img src="/images/elastic/DraggedImage-13.jpg"></p><p>Suppose the government imposes a tax of Â¥0.5 per gallon of gasoline and suppose the buyer will pay the tax. Then the demand curve will move left because there's a tax more. And that is changing the tax everywhere in the curve. So from any point, vertically in the curve, to the other point, we're going to have a distance of 50 cents. Letâ€™s say the new demand curve generate a new equilibrium at price Â¥2.75. So, what the buyers end up paying is at Â¥2.75, the buyer that goes to the Sellers, plus the 50 cents that goes to the government. So in the end, they're actually paying Â¥3.25 for a gallon of gasoline.</p><p><img src="/images/elastic/DraggedImage.png"></p><p>Now the buyers are paying Â¥3.25. So they are worse off because they have a higher price by Â¥0.25. And the sellers, while they were receiving Â¥3 before, now they're only getting Â¥2.75. So they are worse off by 25 cents too. Well, it looks like, in this particular situation, the buyers are sharing 25 cents, they're paying of the tax and sellers are putting up with 25 cents of the tax. So, <strong>this tax is equally distributed among the buyers and the sellers</strong>. And it doesn't matter if the sellers are the ones sending this tax to the government.</p><table><thead><tr class="header"><th style="text-align: center;"></th><th style="text-align: center;">No Tax</th><th style="text-align: center;">Tax Â¥0.5</th><th style="text-align: center;">Change</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Market Price</td><td style="text-align: center;">Â¥3.00</td><td style="text-align: center;">Â¥2.75</td><td style="text-align: center;">Â¥0.25</td></tr><tr class="even"><td style="text-align: center;">Buyers Pay</td><td style="text-align: center;">Â¥3.00</td><td style="text-align: center;">Â¥3.25</td><td style="text-align: center;">Â¥0.25</td></tr><tr class="odd"><td style="text-align: center;">Sellers Receive</td><td style="text-align: center;">Â¥3.00</td><td style="text-align: center;">Â¥2.75</td><td style="text-align: center;">Â¥0.25</td></tr></tbody></table><p>So what determined the distribution of the tax is which side of the market <em>has the most trouble adjusting to a tax</em>. And in this particular example, we're assuming that both have the same trouble and that is based on the elasticity. And the more inclined the curve is, the more inelastic that side of the market is.</p><p>Let's say the demand curve is like that below and the supply curve is a lot flatter. So this model here makes the assumption that the demand of gasoline is more inelastic than the supply of gasoline.</p><p><img src="/images/elastic/DraggedImage-14.jpg"></p><p>What happened? The market price went down to Â¥2.80. The buyers pays Â¥2.80 to the sellers, but then they pay 50 cents to the government. So they're actually paying effectively Â¥3.30 with this tax. So they're paying 30 cents more than they were paying before per gallon of gasoline. How about the sellers? The sellers were selling it for Â¥3 before. Now, they're getting Â¥2.80 from the buyers, so they're worse off 20 cents. And it's a whole different story, because now, of the 50 cents, 30 cents are shared by the buyers and only 20 cents by the sellers. So <em>the sellers are not sharing as much of the burden of this tax as the buyers are</em>.</p><table><thead><tr class="header"><th style="text-align: center;"></th><th style="text-align: center;">No Tax</th><th style="text-align: center;">Tax Â¥0.5</th><th style="text-align: center;">Change</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Market Price</td><td style="text-align: center;">Â¥3.00</td><td style="text-align: center;">Â¥2.80</td><td style="text-align: center;">Â¥0.20</td></tr><tr class="even"><td style="text-align: center;">Buyers Pay</td><td style="text-align: center;">Â¥3.00</td><td style="text-align: center;">Â¥3.30</td><td style="text-align: center;">Â¥0.30</td></tr><tr class="odd"><td style="text-align: center;">Sellers Receive</td><td style="text-align: center;">Â¥3.00</td><td style="text-align: center;">Â¥2.80</td><td style="text-align: center;">Â¥0.20</td></tr></tbody></table><p>So the seller has a lot more freedom here to adjust to this tax by perhaps charging a higher price to the buyers. The buyers cannot adjust as easily and they will have to put up with most of the burden. So in the end, <strong>the most inelastic side of the market is the one that actually shares most of the burden of the tax</strong> regardless of who send the tax to the government.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;Table of Contents&lt;/strong&gt;&lt;/p&gt;
&lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#the-elasticity-of-demand&quot;&gt;The Elasticity of Demand&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#the-price-elasticity-of-demand-and-its-determinants&quot;&gt;The Price Elasticity of Demand and Its Determinants&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#computing-the-price-elasticity-of-demand&quot;&gt;Computing the Price Elasticity of Demand&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-midpoint-method-a-better-way-to-calculate-percentage-changes-and-elasticities&quot;&gt;The Midpoint Method: A Better Way To Calculate Percentage Changes and Elasticities&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-variety-of-demand-curves&quot;&gt;The Variety of Demand Curves&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#total-revenue-and-the-price-elasticity-of-demand&quot;&gt;Total Revenue and The Price Elasticity of Demand&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#elasticity-and-total-revenue-along-a-linear-demand-curve&quot;&gt;Elasticity and Total Revenue Along A Linear Demand Curve&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#other-demand-elasticities&quot;&gt;Other Demand Elasticities&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-elasticity-of-supply&quot;&gt;The Elasticity Of Supply&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#the-price-elasticity-of-supply-and-its-determinants&quot;&gt;The Price Elasticity of Supply And Its Determinants&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#computing-the-price-elasticity-of-supply&quot;&gt;Computing The Price Elasticity of Supply&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-vary-of-supply-curves&quot;&gt;The Vary Of Supply Curves&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#three-applications-of-supply-demand-and-elasticity&quot;&gt;Three Applications Of Supply, Demand, And Elasticity&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#can-good-news-for-farming-be-bad-news-for-farmers&quot;&gt;Can Good News For Farming Be Bad News For Farmers&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#why-did-opec-fail-to-keep-the-price-of-oil-high&quot;&gt;Why Did OPEC Fail To Keep The Price Of Oil High?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#does-drug-interdiction-increase-or-decrease-drug-related-crime&quot;&gt;Does Drug Interdiction Increase Or Decrease Drug-Related Crime?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#the-distributional-effects-of-tax&quot;&gt;The Distributional Effects of Tax&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- tocstop --&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="å¾®è§‚ç»æµå‹åŸç†" scheme="http://www.52coding.com.cn/tags/%E5%BE%AE%E8%A7%82%E7%BB%8F%E6%B5%8E%E5%9E%8B%E5%8E%9F%E7%90%86/"/>
    
      <category term="elasticity" scheme="http://www.52coding.com.cn/tags/elasticity/"/>
    
      <category term="economic" scheme="http://www.52coding.com.cn/tags/economic/"/>
    
  </entry>
  
  <entry>
    <title>Microeconomics - The Market Forces of Supply and Demand</title>
    <link href="http://www.52coding.com.cn/2019/02/11/The%20Market%20Forces%20of%20Supply%20and%20Demand/"/>
    <id>http://www.52coding.com.cn/2019/02/11/The Market Forces of Supply and Demand/</id>
    <published>2019-02-11T10:28:47.000Z</published>
    <updated>2019-04-12T07:11:40.482Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Table of Contents</strong></p><!-- toc --><ul><li><a href="#markets-and-competition">Markets and Competition</a><ul><li><a href="#what-is-a-market">What Is A Market?</a></li><li><a href="#what-is-competition">What is Competition?</a></li></ul></li><li><a href="#demand">Demand</a><ul><li><a href="#the-demand-curve-the-relationship-between-price-and-quantity-demand">The Demand Curve: The Relationship Between Price and Quantity Demand</a></li><li><a href="#market-demand-vs-individual-demand">Market Demand VS. Individual Demand</a></li><li><a href="#shifts-in-the-demand-curve">Shifts In the Demand Curve</a></li></ul></li><li><a href="#supply">Supply</a><ul><li><a href="#the-supply-curve-the-relationship-between-price-and-quantity-supplied">The Supply Curve: The Relationship Between Price and Quantity Supplied</a></li><li><a href="#market-supply-vs-individual-supply">Market Supply VS. Individual Supply</a></li><li><a href="#shifts-in-the-supply-curve">Shifts In The Supply Curve</a></li></ul></li><li><a href="#supply-and-demand-together">Supply And Demand Together</a><ul><li><a href="#equilibrium">Equilibrium</a></li><li><a href="#three-steps-to-analyzing-changes-in-equilibrium">Three Steps To Analyzing Changes In Equilibrium</a></li></ul></li><li><a href="#conclusion-how-prices-allocate-resources">Conclusion: How prices Allocate Resources</a></li></ul><!-- tocstop --><a id="more"></a><h2><span id="markets-and-competition">Markets and Competition</span></h2><h3><span id="what-is-a-market">What Is A Market?</span></h3><p>A <strong>market</strong> is a group of buyers and sellers of a particular good or service. Buyers decide the demand for the product while sellers decide the supply of the product.</p><h3><span id="what-is-competition">What is Competition?</span></h3><p>Economists use the term <strong>competitive market</strong> to describe a market in which there are so many buyers and so many sellers that each has a negligible impact on the market price.</p><p>Competition has various degrees, from <strong>perfectly competitive</strong> to <strong>monopoly</strong>.</p><p><em>Perfectly competitive</em> requires two characteristics: 1. the goods offered for sale are all exactly the same 2. the buyers and sellers are so numerous that no single buyer or seller has any influence over the market price.</p><p>However, some marketplace has only one seller, such a seller is called a <em>monopoly</em>.</p><h2><span id="demand">Demand</span></h2><p>We begin our study of markets by examining the behavior of buyers. To focus our thinking, letâ€™s keep in mind a particular good â€” ice cream.</p><h3><span id="the-demand-curve-the-relationship-between-price-and-quantity-demand">The Demand Curve: The Relationship Between Price and Quantity Demand</span></h3><p>The <strong>quantity demanded</strong> of any good is the amount of the good that buyers are willing and able to purchase. The relationship of price and quantity demanded follows the <strong>law of demand</strong>: Other things equal, when the price of a good rises, the quantity demanded of the good falls, and when the price falls, the quantity demanded rises. A table that shows the relationship between the price of a good and the quantity demanded is called <strong>demand schedule</strong>.</p><p><img src="/images/IMG_BD7E38AD92C1-1.jpg"></p><p>The graph in Figure 1 uses the numbers from the table to illustrate the law of demand. By convention, the quantity of ice cream demanded is on the horizontal axis. The downward-sloping line relating price and quantity demanded is called the <strong>demand curve</strong>.</p><h3><span id="market-demand-vs-individual-demand">Market Demand VS. Individual Demand</span></h3><p>Figure 1 shows the individual demand of ice-cream. However, most of the time, we want to focus on the <strong>market demand</strong> which is the sum of all individualâ€™s demands.</p><p><img src="/images/market/DraggedImage.jpg"></p><p>Figure 2 shows the Catherineâ€™s demand, Nicholasâ€™s demand as well as the market demand. At each price, the total quantity demand is the sum of Catherineâ€™s quantity demand and Nicholasâ€™s quantity demand. The market demand curve shows how the total quantity demanded of a good varies as the price of the good varies, while all the other factors are held constant.</p><h3><span id="shifts-in-the-demand-curve">Shifts In the Demand Curve</span></h3><p><img src="/images/market/DraggedImage-1.jpg"></p><p>Figure 3 illustrates shifts in the demand. There are many variables that can shift the demand curve. Here are the most important.</p><p><strong>Income</strong> If the demand for a good falls when income falls, the good is called a <strong>normal good</strong>. If the demand for a good rises when income falls, the good is called an <strong>inferior good</strong>, such as bus rides. As your income falls, you are less likely to buy a car or take a cab and more likely to ride a bus.</p><p><strong>Prices of Related Goods</strong> When a fall in the price of one good reduces the demand for another good, the two goods are called <strong>substitutes</strong>, such as ice cream and frozen yogurt, hot dogs and hamburgers. When a fall in the price of one good raises the demand for another good, the two goods are called <strong>complements</strong>, such as gasoline and automobiles, computers and software.</p><p><strong>Tastes</strong> If you like ice cream, you buy more of it. Economists examine what happens when tastes change.</p><p><strong>Expectations</strong> Your expectations about the future may affect your demand for a good or service today.</p><p><strong>Number of Buyers</strong> Market demand depends on the number of buyers.</p><p><strong>Summary</strong> <img src="/images/market/DraggedImage-2.jpg"></p><h2><span id="supply">Supply</span></h2><p>We now turn to the other side of the market and examine the behavior of sellers. Once again, to focus our thinking, letâ€™s consider the market for ice cream.</p><h3><span id="the-supply-curve-the-relationship-between-price-and-quantity-supplied">The Supply Curve: The Relationship Between Price and Quantity Supplied</span></h3><p><strong>Quantity supplied</strong> is the amount of a good that sellers are willing and able to sell. When other things equal, the quantity supplied of a good rises when the price of the good rises, which is called <strong>the law of supply</strong>.</p><p><strong>Supply schedule</strong> is a table that shows the relationship between the price of a good and the quantity supplied. The curve relating price and quantity supplied is called the <strong>supply curve</strong>.</p><p><img src="/images/market/DraggedImage-3.jpg"></p><h3><span id="market-supply-vs-individual-supply">Market Supply VS. Individual Supply</span></h3><p>Just as market demand is the sum of the demands of all buyers, market supply is the sum of the supplies of all sellers. As with demand curves, we sum the individual supply curves <em>horizontally</em> to obtain the market supply curves. <img src="/images/market/DraggedImage-4.jpg"></p><h3><span id="shifts-in-the-supply-curve">Shifts In The Supply Curve</span></h3><p><img src="/images/market/DraggedImage-5.jpg"></p><p>Figure 7 illustrate shifts in the supply curve. There are many variables that can shift the supply curve. Here are some of the most important.</p><p><strong>Input Prices</strong> When the price of one or more inputs rises, producing the good is less profitable, and firms supply less the good.</p><p><strong>Technology</strong> By reducing firmsâ€™ costs, the advanced technology raised the supply of goods.</p><p><strong>Expectations</strong> The amount of good a firm supplies today may depend on its expectations about the future.</p><p><strong>Number of Sellers</strong> In addition to the preceding factors, which influence the behavior of individual sellers, market supply depends on the number of these sellers.</p><p><strong>Summary</strong></p><p><img src="/images/market/DraggedImage-6.jpg"></p><h2><span id="supply-and-demand-together">Supply And Demand Together</span></h2><h3><span id="equilibrium">Equilibrium</span></h3><p>Figure 8 shows the market supply curve and market demand together. The intersection point is called <strong>equilibrium</strong>. Equilibrium is a situation in which the market price has reached the level at which quantity supplied equals quantity demanded. The price that balances quantity supplied and quantity demanded is called <strong>equilibrium</strong>.</p><p><img src="/images/market/DraggedImage-7.jpg"></p><p>At the equilibrium price, the quantity of the good that buyers are willing and able to buy exactly balances the quantity that sellers are willing and able to sell. The actions of buyers and sellers <strong>naturally move markets toward the equilibrium</strong> of supply and demand.</p><p><strong>Law of supply and demand</strong>: The price of any good adjusts to bring the quantity supplied and the quantity demanded for that good into balance.</p><p><img src="/images/market/DraggedImage-8.jpg"></p><h3><span id="three-steps-to-analyzing-changes-in-equilibrium">Three Steps To Analyzing Changes In Equilibrium</span></h3><ol type="1"><li>Decide whether the event shifts the supply or demand curve (or perhaps both).</li><li>Decide in which direction the curve shifts.</li><li>Use the supply-and-demand diagram to see how the shift changes the equilibrium price and quantity.</li></ol><p>Example 1:</p><p><img src="IMG_A9BD8FC2E549-1.jpeg"></p><p>In the ice-cream example, <strong>supply</strong> (which <em>refers to the position of the supply curve</em>) does not change because the weather does not alter firmsâ€™ desire to sell at any given price. Instead, the hot weather alters consumersâ€™ desire to buy at any given price and thereby shifts the demand curve to the right. The increase in demand causes the equilibrium price to rise. When the price rises, the <strong>quantity supplied</strong> rises. This increase in quantity supplied is represented by the <strong>movement along the supply curve</strong>.</p><p>Example 2: Shifts in Both Supply and Demand</p><p><img src="/images/market/DraggedImage-9.jpg"></p><p><strong>Summary</strong></p><p><img src="/images/market/DraggedImage-10.jpg"></p><h2><span id="conclusion-how-prices-allocate-resources">Conclusion: How prices Allocate Resources</span></h2><p>Consider the allocation of beachfront land. Because the amount of this land is limited, not everyone can enjoy the luxury of living by the beach. Who gets this resource? The answer is whoever is <strong>willing and able to pay the price</strong>. The price of beachfront land adjusts until the quantity of land demanded exactly balances the quantity supplied. Thus, in market economies, <strong>prices are the mechanism for rationing scarce resources</strong>.</p><p>Similarly, prices determine who produces each good and how much is produced. If an invisible hand guides market economies, as Adam Smith famously suggested, then the price system is the baton that the invisible hand uses to conduct the economic orchestra.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;Table of Contents&lt;/strong&gt;&lt;/p&gt;
&lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#markets-and-competition&quot;&gt;Markets and Competition&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#what-is-a-market&quot;&gt;What Is A Market?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#what-is-competition&quot;&gt;What is Competition?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#demand&quot;&gt;Demand&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#the-demand-curve-the-relationship-between-price-and-quantity-demand&quot;&gt;The Demand Curve: The Relationship Between Price and Quantity Demand&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#market-demand-vs-individual-demand&quot;&gt;Market Demand VS. Individual Demand&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#shifts-in-the-demand-curve&quot;&gt;Shifts In the Demand Curve&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#supply&quot;&gt;Supply&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#the-supply-curve-the-relationship-between-price-and-quantity-supplied&quot;&gt;The Supply Curve: The Relationship Between Price and Quantity Supplied&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#market-supply-vs-individual-supply&quot;&gt;Market Supply VS. Individual Supply&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#shifts-in-the-supply-curve&quot;&gt;Shifts In The Supply Curve&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#supply-and-demand-together&quot;&gt;Supply And Demand Together&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#equilibrium&quot;&gt;Equilibrium&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#three-steps-to-analyzing-changes-in-equilibrium&quot;&gt;Three Steps To Analyzing Changes In Equilibrium&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#conclusion-how-prices-allocate-resources&quot;&gt;Conclusion: How prices Allocate Resources&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- tocstop --&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="å¾®è§‚ç»æµå‹åŸç†" scheme="http://www.52coding.com.cn/tags/%E5%BE%AE%E8%A7%82%E7%BB%8F%E6%B5%8E%E5%9E%8B%E5%8E%9F%E7%90%86/"/>
    
      <category term="Supply Curve" scheme="http://www.52coding.com.cn/tags/Supply-Curve/"/>
    
      <category term="Demand Curve" scheme="http://www.52coding.com.cn/tags/Demand-Curve/"/>
    
      <category term="Equilibrium" scheme="http://www.52coding.com.cn/tags/Equilibrium/"/>
    
  </entry>
  
  <entry>
    <title>Recognizing Vehicles</title>
    <link href="http://www.52coding.com.cn/2018/12/09/RS%20-%20Recognizing%20Vehicles/"/>
    <id>http://www.52coding.com.cn/2018/12/09/RS - Recognizing Vehicles/</id>
    <published>2018-12-09T11:54:07.000Z</published>
    <updated>2019-04-12T03:28:03.249Z</updated>
    
    <content type="html"><![CDATA[<p>HKUST CSIT5401 Recognition System lecture notes 6. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚</p><p>Vehicle recognition, including detection, tracking and identification, has been a research topic among automotive manufacturers, suppliers and universities for enhancing road safety.</p><p>For example, the <a href="http://www.argo.ce.unipr.it/ARGO/english/index.html" target="_blank" rel="noopener">ARGO</a> project, started in 1996 at the University of Parma and the University of Pavia, Italy, is aimed at developing a system for improving road safety by controlling and supervising the driver activity.</p><a id="more"></a><!-- toc --><ul><li><a href="#lane-detection">Lane Detection</a><ul><li><a href="#canny-edge-detector">Canny edge detector</a></li></ul></li><li><a href="#vehicle-detection-based-on-symmetry">Vehicle Detection based on Symmetry</a></li><li><a href="#visual-saliency-for-detection-and-tracking">Visual Saliency For Detection and Tracking</a></li><li><a href="#application-examples">Application Examples</a></li></ul><!-- tocstop --><h2><span id="lane-detection">Lane Detection</span></h2><p>For vehicle detection and tracking and intelligent transportation systems, lane marking detection is one of the key steps. Lane markings can be detected based on the camera inverse perspective mapping (IPM) and the assumption that the lane markings are represented by almost vertical bright lines of constant width, surrounded by a darker background.</p><p>The lanes can then be detected by using the camera <strong>inverse perspective mapping (IPM)</strong> and the <strong>Canny edge detector</strong>.</p><p><strong>Inverse perspective mapping</strong></p><p><img src="/images/impres.png"></p><p><img src="/images/ipmreason.png"></p><h3><span id="canny-edge-detector">Canny edge detector</span></h3><p><a href="http://en.wikipedia.org/wiki/Canny_edge_detector" target="_blank" rel="noopener">Canny edge detector</a> is one of the most popular detectors of edge pixels. The edge detection process serves to simplify the analysis of images by drastically <strong>reducing the amount of data to be processed</strong>, while at the same time <strong>preserving useful structural information</strong> about object boundaries.</p><p>There are three common criteria relevant to edge detector performance.</p><ul><li>It is important that edges that occur in the image should not be missed and that there be <em>no spurious responses</em>.</li><li>The edge points should be well localized. That is, the distance between the points marked by the detector and the true edge center should be minimized.</li><li>The last requirement is to circumvent the possibility of multiple responses to a single edge.</li></ul><p><img src="/images/cedbalala.jpg"></p><p>In the figure above, (a) is a noisy step edge; (b) is a difference of boxes operator; (c) is the output of filtering by box operator; (d) is the first derivative of Gaussian operator; and (e) is the first derivative of Gaussian applied to the edge.</p><p><img src="/images/cannysd.png"></p><p>The <strong>edge center</strong> is marked as <strong>red circle</strong> at a local maximum in the output of the filter responses. Within the region of the edge, the boxes operator exhibits more local maxima than the Gaussian operator. Therefore, <strong>the Gaussian operator is better</strong> than the boxes operator in this example.</p><p><strong>The three performance criteria</strong></p><ol type="1"><li><p>Good detection â†’ Detection Criterion</p><p>There should be a low probability of failing to mark real edge points, and low probability of falsely marking non-edge points. This is controlled by signal-to-noise ratio: <span class="math display">\[\text{SNR}=\frac{|\int_{-w}^{+w}G(-x)f(x)dx |}{n_0\sqrt{\int_{-w}^{+w}f(x)^2dx}}\]</span></p></li><li><p>Good localization â†’ Localization Criterion</p><p>The points marked as edge points by the operator should be as close as possible to the true edge center. The localization is defined as the reciprocal of <span class="math inline">\(\delta x_0\)</span>: <span class="math display">\[\text{Localization}=\frac{|\int_{-w}^{+w}G(-x)f&#39;(x)dx |}{n_0\sqrt{\int_{-w}^{+w}f&#39;(x)^2dx}}\]</span></p></li><li><p>Only one response to a single edge â†’ Multiple Response Constraint <span class="math display">\[x_{zc}(f)=\pi\left(\frac{\int_{-\infty}^{+\infty}f&#39;(x)^2dx}{\int_{-\infty}^{+\infty}f&#39;&#39;(x)^2dx}\right)^{1/2}\]</span></p></li></ol><p>It is very difficult to find the function <span class="math inline">\(f\)</span> (filter) which maximizes the detection and localization criteria subject to the multiple response constraint. Numerical optimization is therefore used.</p><p>The solution is of the form <span class="math display">\[f(x)=a_1e^{\alpha x}\sin\omega x+a_2e^{\alpha x}\cos\omega x+a_3e^{-\alpha x}\sin\omega x\\+a_4e^{-\alpha x}\cos\omega x+c\]</span> The variables are determined by the non-linear optimization with boundary conditions.</p><p>The numerically estimated optimal edge detector can be approximated by the <strong>first derivative of a Gaussian</strong> G, where <span class="math display">\[G(x)=\exp(-\frac{x^2}{2\sigma^2})\\f(x)=G&#39;(x)=-\frac{x}{\sigma^2}\exp(-\frac{x^2}{2\sigma^2})\]</span> For 2D, the solution proposed by Canny amounts to convolving the initial image with a Gaussian function followed by computation of the derivatives in <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> of the result.</p><p><img src="/images/firstderofgaus.png"></p><p>There are three main steps in the Canny edge detection</p><ol type="1"><li><p>Gradient calculation</p><p>compute <span class="math inline">\(M\)</span>: <span class="math display">\[I_x=\frac{\partial}{\partial x}(I\ast G(x,y))\\I_y=\frac{\partial}{\partial y}(I\ast G(x,y))\\M=\sqrt{I_x^2+I_y^2}\approx |I_x|+|I_y|\]</span></p></li><li><p>Non-maximum suppression</p><p>keep local maximum, set others to zero.</p></li><li><p>Hysteresis thresholding</p><p><img src="/images/hyposisthres.png"></p></li></ol><h2><span id="vehicle-detection-based-on-symmetry">Vehicle Detection based on Symmetry</span></h2><p>Vehicle detection is based on the assumption that the rear or frontal views of the vehicles are generally symmetric; can be characterized by a rectangular bounding box which satisfies specific aspect ratio constraints and is placed in a specific region of the image, e.g., within lanes.</p><p>These features are used to identify vehicles in the image.</p><ol type="1"><li>Area of interest is identified on the basis of road position and perspective constraints.</li><li>This area of interest is searched for possible vertical symmetries. Not only are the gray level symmetries considered, but also vertical and horizontal edge symmetries are considered.</li><li>Step 3: Once the symmetry axis has been detected, the lower part (the two bottom corners) of a rectangular bounding box is detected.</li><li>The top horizontal limit of the vehicle is then searched according to the pre-defined aspect ratio.</li></ol><p><img src="/images/vdbasedonsys.png"></p><p>Vertical and horizontal binary edges can help solve the problems of strong reflection areas in the vehicle images. The analysis of symmetry produces symmetry maps for gray-level intensity, edge (total), horizontal edge, vertical edge and total (combined) symmetry. The symmetry axis can be found from the total symmetry map.</p><p><strong>Bounding box detection</strong></p><p>After detecting the symmetry axis, the width of the symmetrical region is checked for the presence of two corners representing the bottom of the bounding box around the vehicle.</p><p>Once the two corners are detected, the top side of the rectangle box can be detected by searching.</p><p><img src="/images/boundingboxde.png"></p><h2><span id="visual-saliency-for-detection-and-tracking">Visual Saliency For Detection and Tracking</span></h2><p><strong>Visual saliency</strong> refers to the idea that certain parts of a scene are pre-attentively distinctive (pop-out) and create some form of immediate significant visual arousal within the early stages of the <strong>Human Visual System (HVS)</strong>. The figure below is an example.</p><p>In image analysis, an <strong>edge</strong> is a pop-out region (<strong>region of saliency</strong>) since the edge is more visually significant than the other parts of the image.</p><p><img src="/images/vsexamples.png"></p><p>The salient points are literally the points on the object which are almost unique. These points maximize the discrimination between objects. The visual saliency is defined in terms of <strong>local signal complexity</strong>.</p><p><strong>Shannon entropy</strong> of local attributes (called <strong>local entropy</strong>) is <span class="math display">\[H_{D,Rx}(x)=-\sum_{i\in D}P_{D,Rx}(x,d_i)\log_2P_{D,Rx}(x,d_i)\]</span> where <span class="math inline">\(x\)</span> is point location, <span class="math inline">\(Rx\)</span> is local neighborhood at <span class="math inline">\(x\)</span>, <span class="math inline">\(D\)</span> is descriptor (e.g. intensity), and <span class="math inline">\(P_{D,Rx}(x,d_i)\)</span> is histogram value at <span class="math inline">\(x\)</span>.</p><p><img src="/images/entropylsakdjad.jpg"></p><p>Below are sample frames from the processed sequences using a <strong>fixed scale</strong> based on local entropy. Red square boxes represent the most salient icons or parts of the image. The size of the local window or scale and threshold used were selected manually to give the most satisfactory results.</p><p><img src="/images/saliegsdas.png"></p><ul><li>Problem: the scale is fixed and global. For example, the scale is inappropriate for the pedestrians and the road markings in DT sequence.</li><li>Problem: Small salient regions are not picked up. Highly textured regions, e.g., large intensity variation regions, are picked up. For example, trees and bushes in Vicky sequence.</li></ul><p>Therefore, scale is an important and implicit part of the saliency detection problem.</p><p><strong>Scale selection for salient region detection</strong></p><p>Scale is selected based on the scale-space behavior of the saliency of a given feature.</p><p>For each pixel position <span class="math inline">\(x\)</span></p><ul><li><p>For each scale <span class="math inline">\(s\)</span> inside a range between <span class="math inline">\(s_\min\)</span> and <span class="math inline">\(s_\max\)</span> :</p><ul><li><p>Measure the local descriptor values (e.g.,intensity values) within a window of scale <span class="math inline">\(s\)</span>.</p></li><li><p>Estimate the local probability density function (PDF) from this (e.g. using histogram).</p></li><li><p>Calculate the local entropy <span class="math inline">\(H_D\)</span> <span class="math display">\[H_{D}(s,x)=-\sum_{i\in D}P_{D}(s,x,d_i)\log_2P_{D}(s,x,d_i)\]</span></p></li></ul></li><li><p>Select scales for which the entropy is peaked <span class="math display">\[s:\frac{\partial^2H_D(s,x)}{\partial s^2}&lt;0\]</span></p></li><li><p>Detection performance can be further improved if change of histogram is considered.</p></li></ul><p><img src="/images/salenscaleg.png"></p><p><strong>Vehicle Detection by using AdaBoost</strong></p><p>Vehicles can be detected by using <a href="https://www.52coding.com.cn/2018/12/06/RS%20-%20Recognizing%20Faces/#adaboost">AdaBoost</a>.</p><p><img src="/images/vehildabboo.png"></p><p>By using the AdaBoost, vehicles in their lateral view can be detected in real time.</p><p><strong>Vehicle Recognition</strong></p><p>After vehicle detection, the vehicle can be recognition by using PCA and classification methods, e.g., k-NN or Bayesian methods.</p><h2><span id="application-examples">Application Examples</span></h2><p><strong>Vehicle counting in traffic surveillance</strong></p><p><img src="/images/survelleg.png"></p><p><strong>Traffic jam detection and alarming</strong></p><p><img src="/images/trafficjamsdeg.png"></p><p><strong>Abnormal vehicle behavior detection</strong></p><p><img src="/images/abnormaldetec.png"></p><p><strong>Target tracking in night</strong></p><p><img src="/images/targetrackinni.png"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HKUST CSIT5401 Recognition System lecture notes 6. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;p&gt;Vehicle recognition, including detection, tracking and identification, has been a research topic among automotive manufacturers, suppliers and universities for enhancing road safety.&lt;/p&gt;
&lt;p&gt;For example, the &lt;a href=&quot;http://www.argo.ce.unipr.it/ARGO/english/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ARGO&lt;/a&gt; project, started in 1996 at the University of Parma and the University of Pavia, Italy, is aimed at developing a system for improving road safety by controlling and supervising the driver activity.&lt;/p&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Recognition System" scheme="http://www.52coding.com.cn/tags/Recognition-System/"/>
    
      <category term="Canny" scheme="http://www.52coding.com.cn/tags/Canny/"/>
    
      <category term="visual saliency" scheme="http://www.52coding.com.cn/tags/visual-saliency/"/>
    
      <category term="lane detection" scheme="http://www.52coding.com.cn/tags/lane-detection/"/>
    
      <category term="vehicle detection" scheme="http://www.52coding.com.cn/tags/vehicle-detection/"/>
    
  </entry>
  
  <entry>
    <title>Recognizing License Plates</title>
    <link href="http://www.52coding.com.cn/2018/12/08/RS%20-%20Recognizing%20License%20Plates/"/>
    <id>http://www.52coding.com.cn/2018/12/08/RS - Recognizing License Plates/</id>
    <published>2018-12-08T11:54:07.000Z</published>
    <updated>2019-04-12T03:28:00.362Z</updated>
    
    <content type="html"><![CDATA[<p>HKUST CSIT5401 Recognition System lecture notes 5. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚</p><p><a href="http://www.licenseplaterecognition.com/" target="_blank" rel="noopener">License Plate Recognition</a> is an image-processing technology which is used to identify vehicles by their license plates. This technology is used in various security and traffic applications, such as the access-control system, toll payment, parking fee payment, etc.</p><a id="more"></a><p>A number of license plate recognition units are installed in different locations and the passing vehicle plate numbers are matched between the points. The average speed and travel time between these points can be calculated and presented in order to monitor traffic loads. Additionally, the average speed may be used to issue a speeding ticket.</p><!-- toc --><ul><li><a href="#automatic-vehicle-identification-system">Automatic Vehicle Identification System</a></li><li><a href="#license-plate-detection">License Plate Detection</a><ul><li><a href="#global-search">Global Search</a></li><li><a href="#partial-image-analysis">Partial Image Analysis</a></li><li><a href="#sliding-concentric-windows">Sliding Concentric Windows</a></li><li><a href="#adaboost">Adaboost</a></li></ul></li><li><a href="#character-segmentation">Character Segmentation</a></li><li><a href="#character-recognition">Character Recognition</a></li></ul><!-- tocstop --><h2><span id="automatic-vehicle-identification-system">Automatic Vehicle Identification System</span></h2><p>The installation and responses of sensors help to frame a front-view/rear-view of a passing vehicle. <strong>Infra-red sensors</strong> are used for vehicle sensing.</p><p><img src="/images/infredsens.png"></p><p><strong>Anisotropic magneto-resistive (AMR) sensors</strong> for automated vehicle sensing.</p><p><img src="/images/amrsense.png"></p><p><strong>License plate recognition</strong> is generally composed of three steps.</p><ol type="1"><li>Location of the license plate region (License Plate Detection)</li><li>Segmentation of the plate characters (Character Segmentation)</li><li>Recognition of the plate characters (Character Recognition)</li></ol><p>The license plate recognition should operate fast enough to make sure that the system does not miss a single object of interest that moves through the scene.</p><p>With the growth of the computer processing power, the latest developments operate within less than 50ms for plate detection and recognition. It enables the processing of more than 20 frames per second for videos.</p><h2><span id="license-plate-detection">License Plate Detection</span></h2><p>There are several methods for detecting license plate in a vehicle image.</p><ul><li>Global search [Comelli-TVT-95$]$</li><li>Partial image analysis (vertical edge density)[Anagnostopoulos-TITS-08$]$</li><li>Sliding concentric windows [Anagnostopoulos-TITS-06$]$</li><li>AdaBoost [Dlagnekov-04$]$</li></ul><h3><span id="global-search">Global Search</span></h3><p>Comelli et al. presented a system called RITA. RITA can recognize automatically the characters written on the license plate placed on the rear-side of motor vehicles. The goal is to read only the Italian license plates and reject all the others. It is assumed that a Italian license plate is rectangular and the plate contains black characters over a white background.</p><p>The license plate detection algorithm is a <strong>global searching</strong> method because the algorithm picks within the vehicle image globally the area presenting the maximum local contrast based on <strong>gradient analysis</strong>. The picked area possibly corresponds to the rectangle that contains the license plate.</p><p>The algorithm selects the area that presents the <strong>maximum local contrast</strong> that (possibly) corresponds to the rectangle that contains the license plate.</p><p><img src="/images/globalsearch.png"></p><h3><span id="partial-image-analysis">Partial Image Analysis</span></h3><p>The vehicle image can be filtered to extract <strong>vertical edges</strong> and scanned with N-row distance. The number of the existing edges along each scan line is recorded.</p><p>If the number of the edges is greater than a threshold value, the presence of a plate can be assumed.</p><p><img src="/images/piasdsa.png"></p><p>Specifically, if the plate is not found in the first scanning processing, then the algorithm is repeated, reducing the threshold for counting edges or adjusting the threshold for finding vertical edges.</p><h3><span id="sliding-concentric-windows">Sliding Concentric Windows</span></h3><p>An adaptive image segmentation technique, called <strong>sliding concentric windows</strong> (SCW), was proposed for license plate detection. The SCW method was developed to describe the local irregularity in the vehicle image.</p><p>The method uses image statistics such as the standard deviation and the mean for finding possible plate locations.</p><p><img src="/images/slidingwc.png"></p><p>In two concentric windows A and B of different sizes (<span class="math inline">\(2X_1\times 2Y_1\)</span> and <span class="math inline">\(2X_2\times2Y_2\)</span> respectively), which scan the vehicle image from left to right and from top to bottom, the mean or the standard deviation is calculated.</p><p>If the ratio of the statistical measurements in the two windows exceeds a threshold set by the user, then the central pixel of the concentric windows is considered to belong to a license plate. <span class="math display">\[I_{output}=\begin{cases}0 &amp; \text{if }\frac{M_B}{M_A}\leq T,\\1 &amp; \text{if }\frac{M_B}{M_A}&gt; T\end{cases}\]</span> where <span class="math inline">\(M\)</span> is the statistical measurement, eigher mean or standard devation.</p><p>The result is a binary image <span class="math inline">\(I_{output}\)</span>, which eliminates all the redundant regions from the original vehicle image.</p><p>The result binary image is used as a <strong>mask for highlighting the license plate</strong> by computing the product between the binary mask and the input vehicle image. The license plate can then be found in the highlighted image based on the binary mask.</p><p><img src="/images/scwimg.png"></p><h3><span id="adaboost">Adaboost</span></h3><p>Adaptive boosting (AdaBoost) was used in conjunction with the rectangle features for training a strong classifier based on weak classifiers.</p><p>For detecting license plates, a total of 100 rectangle features can be applied to sub-regions sized 45(columns) Ã— 15(rows) pixels being scanned as the expected license plate areas in the original vehicle image.</p><p><img src="/images/recpladaboo.png"></p><p>Within the 100 rectangle features for detection, there are 37 variance based features, 40 x-derivative features, 18 y-derivative features, and 5 mean pixel intensity features.</p><p><img src="/images/plrecoadaboo.png"></p><p>When sliding the search window across the vehicle image to be analyzed, several matches can be found. Clustering method can be used to group detected windows that are close to each other and <strong>use the mean window as the detected location</strong>.</p><h2><span id="character-segmentation">Character Segmentation</span></h2><p>In most systems with a subsequent recognition module, the vertical resolution of the plate vary from 20 to 40 pixels. Prior to character recognition, the detected license plates are enhanced for <strong>improving plate image quality</strong>, e.g., image normalization and histogram equalization.</p><p><img src="/images/characseg.png"></p><p>Given the enhanced detected license plate image, the goal is to <strong>segment each character</strong> in the image. A global threshold can be found to segment the detected license plate. <a href="http://en.wikipedia.org/wiki/Otsu&#39;s_method" target="_blank" rel="noopener">Otsu's method</a> is one of widely used methods for image binarization.</p><p><strong>Otsu's method</strong></p><p>The method is designed for finding optimum global threshold for image binarization and is optimum in the sense that it maximizes the between-class variance.</p><p>There are six steps.</p><ol type="1"><li><p>Compute the normalized histogram of the input image. Denote the components of histogram by <span class="math display">\[p_i=\frac{n_i}{MN}, i=0, 1, ..., L-1\]</span> where <span class="math inline">\(L\)</span> is the number of gray levels; <span class="math inline">\(n_i\)</span> is the number of pixels with intensity <span class="math inline">\(i\)</span>; <span class="math inline">\(M\)</span> is the number of rows; and <span class="math inline">\(N\)</span> is the number of columns.</p></li><li><p>Compute the cumulative sums (the probability that a pixel is assigned to class <span class="math inline">\(C_1\)</span>) <span class="math display">\[P_1(k)=\sum_{i=0}^kp_i\]</span> where <span class="math inline">\(k\)</span> is current threshold for thresholding the input image into two classes <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span>.</p></li><li><p>Compute the cumulative means <span class="math display">\[m(k)=\sum_{i=0}^kip_i,\ k=0,1,...,L-1\]</span></p></li><li><p>Compute the global intensity mean <span class="math display">\[m_G=\sum_{i=0}^{L-1}ip_i\]</span> where <span class="math inline">\(L\)</span> is the number of gray levels.</p></li><li><p>Compute the between-class variance <span class="math display">\[\sigma^2_B(k)=\frac{[m_GP_1(k)-m(k)]^2}{P_1(k)[1-P_1(k)]},\ k=0, 1, ..., L-1\]</span></p></li><li><p>Obtain the Otsu threshold, <span class="math inline">\(k^\ast\)</span>, as the value for <span class="math inline">\(k\)</span> for which the value of <strong>between-class variance is maximum</strong>. If the maximum is not unique, obtain <span class="math inline">\(k^\ast\)</span> by averaging the values of <span class="math inline">\(k\)</span> corresponding to the various maxima detected. <span class="math display">\[\sigma^2_B(k^\ast)=\max_{0\leq k\leq L-2}\sigma^2_B(k)\]</span></p></li></ol><p><img src="/images/otsuresukt.png"></p><p>Global thresholding on the entire image may not always produce useful results due to uneven lighting environment.</p><p><img src="/images/charseg.png"></p><p>Characters can be extracted from the license plate image. Each character can then be segmented by using the thresholding method. Instead of dividing the image into regular blocks, the shape (size) of each block is defined adaptively for each character.</p><p><img src="/images/characsegggg.png"></p><p>Projections of binary edge images are performed. Rows of strings are separated based on the horizontal pixel accumulation. Same for columns of characters.</p><p>After the blocks for characters are defined adaptively, the Otsu's method is applied for each blocks adaptively.</p><p><strong>Maximally stable extremal regions</strong></p><p>Characters can be extracted and segmented by thresholding the image with a variable brightness threshold, and using the enumeration of extremal regions which are stable for a large range of the threshold <span class="math inline">\(T\)</span>.</p><p>Extremal regions are connected components of an image binarized at certain threshold. When the threshold <span class="math inline">\(T\)</span> is increasing/decreasing, the behavior of the extremal regions is used for character classification and segmentation.</p><p><a href="http://en.wikipedia.org/wiki/Maximally_stable_extremal_regions" target="_blank" rel="noopener">Maximally stable extremal regions (MSERs)</a> are usually of arbitrary shape. The MSER detector is stable and invariant to affine transformations, which is useful for handling viewpoint changes.</p><p><img src="/images/msersss.png"></p><p><img src="/images/mseralgo.png"></p><p><img src="/images/mserrrr.png"></p><p><img src="/images/mserapp.png"></p><h2><span id="character-recognition">Character Recognition</span></h2><p>After the characters are segmented, the segmented characters will be matched against a set of pre-defined characters, e.g. ten numerals (zero to nine), alphabets, etc.</p><p>The pre-defined characters usually have single font, fixed character size, and are not rotated heavily. Therefore, pattern/template matching is a suitable technique for character recognition. Templates can be generated in advance for the matching tasks.</p><p><img src="/images/charrecogpatt.png"></p><p>The matching process can be done by computing the <strong>normalized cross-correlation</strong> values for all the translational shifts of each character template over the character block (sub-image).</p><p>The normalized cross-correlation is defined as <span class="math display">\[C_{fg}=\frac{\sum_{m=1}^M\sum_{n=1}^N(f(i,j)-\bar{f})(g(i,j)-\bar{g})}{\sqrt{\sum_{m=1}^M\sum_{n=1}^N(f(i,j)-\bar{f})^2(g(i,j)-\bar{g})^2}}\]</span> where <span class="math inline">\(g\)</span> is shifted template and <span class="math inline">\(f\)</span> is character block.</p><p>More advanced techniques, e.g. <a href="http://en.wikipedia.org/wiki/Shape_context" target="_blank" rel="noopener">shape context</a>, can be used for character recognition. ([Belongie-02, Treiber-10])</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HKUST CSIT5401 Recognition System lecture notes 5. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.licenseplaterecognition.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;License Plate Recognition&lt;/a&gt; is an image-processing technology which is used to identify vehicles by their license plates. This technology is used in various security and traffic applications, such as the access-control system, toll payment, parking fee payment, etc.&lt;/p&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Recognition System" scheme="http://www.52coding.com.cn/tags/Recognition-System/"/>
    
      <category term="Adaboost" scheme="http://www.52coding.com.cn/tags/Adaboost/"/>
    
      <category term="Otsu" scheme="http://www.52coding.com.cn/tags/Otsu/"/>
    
      <category term="MSER" scheme="http://www.52coding.com.cn/tags/MSER/"/>
    
      <category term="sliding concentric windows" scheme="http://www.52coding.com.cn/tags/sliding-concentric-windows/"/>
    
  </entry>
  
  <entry>
    <title>Recognizing Fingerprints</title>
    <link href="http://www.52coding.com.cn/2018/12/07/RS%20-%20Recognizing%20Fingerprints/"/>
    <id>http://www.52coding.com.cn/2018/12/07/RS - Recognizing Fingerprints/</id>
    <published>2018-12-07T13:20:07.000Z</published>
    <updated>2019-04-12T03:27:51.914Z</updated>
    
    <content type="html"><![CDATA[<p>HKUST CSIT5401 Recognition System lecture notes 4. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚</p><!-- toc --><ul><li><a href="#fingerprint-image-acquisition-systems">Fingerprint image acquisition systems</a></li><li><a href="#minutiae">Minutiae</a></li><li><a href="#fingerprint-enhancement">Fingerprint Enhancement</a><ul><li><a href="#normalization">Normalization</a></li><li><a href="#orientation-image-estimation">Orientation Image Estimation</a></li><li><a href="#ridge-frequency-estimation">Ridge Frequency Estimation</a></li><li><a href="#region-mask-estimation">Region mask estimation</a></li><li><a href="#gabor-filter">Gabor Filter*</a></li></ul></li><li><a href="#fingerprint-matching">Fingerprint Matching</a></li><li><a href="#fingercode">FingerCode</a></li></ul><!-- tocstop --><a id="more"></a><h2><span id="fingerprint-image-acquisition-systems">Fingerprint image acquisition systems</span></h2><p><a href="http://en.wikipedia.org/wiki/Fingerprint" target="_blank" rel="noopener">Fingerprint</a> matching (recognition) is the most popular biometric technique used in automatic personal identification. The main reason for the popularity of fingerprints as a form of identification is that the fingerprint of a person is unique and remains invariant with his or her age.</p><p>There are three kinds of sensing devices typically: <strong>optical sensors</strong>, <strong>solid-state sensors</strong> and <strong>ultrasound sensors</strong>.</p><p><strong>Optical sensors</strong></p><p>The finger touches the top side of a glass prism. The left side of the prism is illustrated through a diffused light. The light entering the prism is reflected at the valleys, and absorbed at the ridges. The lack of reflection allows the ridges to be discriminated from the valleys. The light rays exit from the right side of the prism and are focused through a lens onto an image sensor.</p><p><img src="/images/ridgeandvall.png"></p><p><strong>Solid-state sensors</strong></p><p>All silicon-based sensors consist of an array of pixels, each pixel being a tiny sensor itself. The user directly touches the surface of the silicon. The physical information is converted into <strong>electrical signals</strong> by using the capacitive sensor (other kinds of sensor can also be used, e.g., thermal, electric field and piezoelectric).</p><p>The capacitive sensor is a 2D array of micro-capacitor plates embedded in a chip. The other plate of each micro-capacitor is the finger skin itself.</p><p><img src="/images/ssdfinger.png"></p><p>Small electrical charges are created between the surface of the finger and each of the silicon plates when a finger is placed on the chip. The magnitude of these electrical charges depends on the distance between the fingerprint surface and the capacitance plates.</p><p><strong>Ultrasound sensors</strong></p><p>An ultrasound sensor is based on sending acoustic signals toward the fingertip and capturing the echo signal. The echo signal is used to compute the range image of the fingerprint and, subsequently, the ridge structure itself.</p><p><img src="/images/ultrasound.png"></p><h2><span id="minutiae">Minutiae</span></h2><p>An <strong>automatic fingerprint identification system</strong> (AFIS) consists of various processing stages.</p><p><img src="/images/afis.png"></p><p>In AFIS, the high-level structural features (<strong>ridges and valleys</strong>) are extracted from the fingerprint image for the purpose of representation and matching. The ridges and valleys in a fingerprint alternate, flowing in a local constant direction.</p><p><img src="/images/ridandval.png"></p><p>The ridges (or the valleys) exhibit anomalies of various kinds, such as ridge bifurcations, ridge endings, short ridges, and ridge crossovers. These features are called <a href="http://en.wikipedia.org/wiki/Minutiae" target="_blank" rel="noopener">minutiae</a>.</p><p>In a good quality rolled fingerprint image, there are about 70 to 80 minutia points and in a latent fingerprint the number of minutiae is much less (approximately 20 to 30 minutia points). Commercially available fingerprint identification systems typically use <strong>ridge bifurcations</strong> and <strong>ridge endings</strong> as features.</p><p><img src="/images/bifandending.png"></p><ul><li>A ridge ending is defined as the point where a ridge ends abruptly.</li><li>A ridge bifurcation is defined as the point where a ridge diverges into branch ridges.</li></ul><p>A critical step in fingerprint matching is to automatically and reliably <strong>extract minutiae</strong> from the input fingerprint images, which is a difficult task.</p><p><img src="/images/bifandend2.png"></p><h2><span id="fingerprint-enhancement">Fingerprint Enhancement</span></h2><p>Fingerprint images can be of very poor quality. An enhancement algorithm which can improve the clarity of the ridge structure is therefore necessary.</p><p>The flowchart of the fingerprint enhancement algorithm is shown below.</p><p><img src="/images/imgnorflow.png"></p><h3><span id="normalization">Normalization</span></h3><p>A gray-level fingerprint image <span class="math inline">\(I\)</span> is defined as an <span class="math inline">\(N \times N\)</span> matrix. At the <span class="math inline">\(i\)</span> th row and <span class="math inline">\(j\)</span> th column, the intensity of the pixel is <span class="math inline">\(I(i, j)\)</span>. It is assumed that the fingerprint images are scanned at a resolution of 500 dots per inch (dpi), which is the resolution recommended by FBI.</p><p>The mean and variance of a gray-level fingerprint image are defined as</p><p><img src="/images/imgnorma.png"></p><p>An input fingerprint image is normalized so that it has a pre-specified mean <span class="math inline">\(M_0\)</span> and variance <span class="math inline">\(\text{VAR}_0\)</span>.</p><p>The normalized image <span class="math inline">\(G(i,j)\)</span> is defined as <span class="math display">\[G(i,j)=\begin{cases}M_0+\sqrt{\frac{VAR_0(I(i,j)-M)^2}{VAR}} &amp;\text{if }I(i,j)&gt;M\\M_0-\sqrt{\frac{VAR_0(I(i,j)-M)^2}{VAR}}&amp;\text{otherwise}\\\end{cases}\]</span> <img src="/images/imgnor2.png"></p><h3><span id="orientation-image-estimation">Orientation Image Estimation</span></h3><p>The orientation image (field) is estimated from the normalized input fingerprint image. By viewing a fingerprint image as an oriented image, a <strong>least-mean-square orientation estimation</strong> algorithm is used to estimate the local orientation.</p><p>The main steps are as follows.</p><p>[1] Divide the normalized image <span class="math inline">\(G\)</span> into blocks of size <span class="math inline">\(w \times w\)</span>.</p><p>[2] For each block, compute the gradients <span class="math inline">\(I_x\)</span> and <span class="math inline">\(I_y\)</span> at each pixel <span class="math inline">\((i , j)\)</span>.</p><p>[3] Estimate the local orientation of each block centered at pixel <span class="math inline">\((i, j)\)</span> using the following equations. <span class="math display">\[\theta(i,j)=90^o+\frac{1}{2}\text{atan2}\left(\frac{V_1(i,j)}{V_2(i,j)}\right)\]</span> where <span class="math display">\[V_1(i,j)=\sum_{u=i-\frac{w}2}^{i+\frac{w}2}\sum_{v=j-\frac{w}2}^{j+\frac{w}2}2I_x(u,v)I_y(i,v)\\V_2(i,j)=\sum_{u=i-\frac{w}2}^{i+\frac{w}2}\sum_{v=j-\frac{w}2}^{j+\frac{w}2}(I_x(u,v)^2-I_y(u,v)^2)\\-180^oâ‰¤\text{atan2}(x)â‰¤180^o\]</span> [4] Due to the presence of noise, corrupted ridge and valley structures, minutiae, etc. in the input image, the estimated local ridge orientation may not always be correct. The local orientation image can be smoothed by using the low-pass smoothing filter and the concept of continuous vector field.</p><p><img src="/images/orienesti.png"></p><h3><span id="ridge-frequency-estimation">Ridge Frequency Estimation</span></h3><p>The gray levels along ridges and valleys can be modeled as a sinusoidal-shaped wave along a direction normal to the local ridge orientation.</p><p><img src="/images/ridgefreq.jpg"></p><p>Let <span class="math inline">\(G\)</span> be the normalized image and <span class="math inline">\(O\)</span> be the orientation image (field). For estimating the ridge frequency <span class="math inline">\(Î©\)</span> image,</p><ul><li><p>Step 1: divide <span class="math inline">\(G\)</span> into blocks of size <span class="math inline">\(w \times w\)</span>.</p></li><li><p>Step 2: for each block centered at pixel <span class="math inline">\((i, j)\)</span>, compute an oriented window of size <span class="math inline">\(w \times l\)</span> that is defined in the ridge coordinate system <span class="math inline">\((k, d)\)</span>. <img src="/images/ridgesys.png"></p></li><li><p>Step 3: for each block centered at pixel <span class="math inline">\((i, j)\)</span>, compute the x-signature, <span class="math inline">\(X[0], X[1], ..., X[l-1]\)</span>, of the ridges and valleys within the oriented window, where <span class="math display">\[X[k]=\frac{1}w\sum_{d=0}^{w-1}G(u,v)\\u=i+(d-\frac{w}2)\cos O(i,j)+(k+\frac{l}2)\sin O(i,j)\\v=i+(d-\frac{w}2)\sin O(i,j)+(\frac{l}2-k)\cos O(i,j)\]</span> <img src="/images/w2blabla.png"> <img src="/images/orientationdsa.png"></p></li></ul><p>The x-signature forms a discrete sinusoidal-shape wave, which has the same frequency as that of the ridges and valleys in the oriented window. Therefore, the <strong>frequency of ridges and valleys can be estimated from the x-signature</strong>.</p><p>Let <span class="math inline">\(T(i, j)\)</span> be the average number of pixels between two consecutive peaks in the x-signature, then the ridge frequency <span class="math inline">\(Î©(i, j)\)</span> is computed as <span class="math display">\[\Omega(i,j)=\frac{1}{T(i,j)}\]</span></p><h3><span id="region-mask-estimation">Region mask estimation</span></h3><p>A pixel (or a block) in an input fingerprint image can be either in a recoverable region or an unrecoverable region. Classification of pixels into recoverable and unrecoverable categories can be performed based on the assessment of the shape of the wave formed by the local ridges and valleys.</p><p><img src="/images/imgmaskest.png"></p><p>Three features are used to characterize the sinusoidal-shaped wave: amplitude, frequency, and variance.</p><p><img src="/images/imgmaskest2.png"></p><p>Typical fingerprint images where both recoverable and unrecoverable regions were manually labeled can be selected for region mask estimation. The above three features can be computed for each image.</p><p>Using the k-NN and clustering algorithms, each <span class="math inline">\(w \times w\)</span> block in an input fingerprint image can be classified into a recoverable or an unrecoverable block.</p><h3><span id="gabor-filter">Gabor Filter*</span></h3><p>The configurations of parallel ridges and valleys with well-defined frequency and orientation in a fingerprint image provide useful information which helps in removing undesired noise.</p><p>A special (bandpass) filter, namely <strong>Gabor filter</strong>, that is tuned to the corresponding frequency and orientation can efficiently remove the undesired noise and preserve the true ridge and valley structures.</p><p>Gabor filters have both frequency-selective and orientation-selective properties and are used for removing noise and preserving true ridge or valley structures.</p><p>The even-symmetric Gabor filter has the following general form:</p><p><img src="/images/gaborfilter.png"></p><p>The frequency of the filter <span class="math inline">\(f\)</span> is completely determined by the local ridge frequency and the Gabor filter orientation is determined by the local ridge orientation.</p><p><img src="/images/gabororien.png"></p><p>The ridge pixels are assigned a value '1' (white) and the remaining pixels are assigned a value '0' (black) in the resulting binary ridge image.</p><p><img src="/images/imgseg.png"></p><p>Once the ridges are located, <strong>directional smoothing</strong> is applied to smooth the ridges. A 3Ã—7 mask is placed along the orientation field for each window. The mask containing all '1's enables us to count the number of '1's in the mask area.If the count of '1's is more than 25% of the total number of pixels, the ridge point is retained.</p><p><strong>Extracting minutiae</strong></p><p>Locating minutia points in the thinned image is relatively easy.</p><p>A count of the number of 'on' neighbors at a point of interest in a <span class="math inline">\(3\times 3\)</span> window is sufficient for this purpose.</p><ul><li>A ridge end point has only neighbor in the window.</li><li>A ridge bifurcation has at least three neighbors.</li></ul><p>Some post-processing can be performed to further improve detection quality.</p><p><img src="/images/endandbif3.jpg"></p><p><img src="/images/minuextra.png"></p><h2><span id="fingerprint-matching">Fingerprint Matching</span></h2><p>Matching a query fingerprint and a database fingerprint is equivalent to matching their minutia sets. Each database fingerprint minutia, <span class="math inline">\(p\)</span>, is examined to determine whether there is a corresponding query fingerprint minutia, <span class="math inline">\(q\)</span>.</p><p>There are three steps.</p><ol type="1"><li>Registration</li><li>Minutia paring</li><li>Matching score computation</li></ol><p><strong>Registration via Hough Transform</strong></p><p>The input to the registration algorithm consists of two sets of minutia points <span class="math inline">\(P\)</span> and <span class="math inline">\(Q\)</span>. <span class="math inline">\(|P|\)</span> and <span class="math inline">\(|Q|\)</span> represent the sizes of point sets <span class="math inline">\(P\)</span> and <span class="math inline">\(Q\)</span> respectively. <span class="math display">\[P=\{(p_x^1,p_y^1,\alpha^1),...,(p_x^{|P|},p_y^{|P|},\alpha^{|P|})\}\\Q=\{(q_x^1,q_y^1,\beta^1),...,(q_x^{|Q|},q_y^{|Q|},\beta^{|Q|})\}\]</span> Each minutia has three components: x-coordinate, y-coordinate and orientation of the minutia. Each minutia in <span class="math inline">\(P\)</span> is <strong>rotated, scaled and translated</strong> for matching against a minutia in <span class="math inline">\(Q\)</span>.</p><p>The usual <strong>Hough transform</strong> for line detection can be generalized for point matching.</p><p><img src="/images/regishoughtra.png"></p><p>The transform has maximum value of <span class="math inline">\(A\)</span> means that it can match as much points as possible.</p><p><img src="/images/imgregriscomp.png"></p><p><strong>Minutia pairing and score computation</strong></p><p>After minutia registration, the minutiae need to be paired. Two minutiae are said to be paired or matched if their components <span class="math inline">\((x, y,Î¸)\)</span> are equal with some tolerance after registration.</p><p><img src="/images/minutiamatch.png"></p><p>The matching algorithm is based on finding the number of paired minutiae between each database fingerprint and the query fingerprint.</p><p>In order to reduce the amount of computation, the matching algorithm takes into account only those minutiae that fall within a common bounding box. The common bounding box is the intersection of the bounding box for query and reference (database) fingerprints. Once the count of matching minutiae is obtained, a matching score is computed. The matching score is used for deciding the degree of match. Finally, a set of top ten scoring reference fingerprints is obtained as a result of matching.</p><h2><span id="fingercode">FingerCode</span></h2><p><em>FingerCode</em> is a new representation for the fingerprints which yields a <strong>relatively short, fixed length code</strong> suitable for matching as well as storage on a smartcard.</p><p>The matching reduces to finding the <strong>Euclidean distance</strong> between these <em>FingerCodes</em> and hence the matching is very fast and the representation is amenable to indexing.</p><p>The FingerCode partitions the region of interest of the given fingerprint image with respect to a reference point. A feature vector is composed of an ordered enumeration of features extracted from the information contained in each sector specified by the tessellation.</p><p><img src="/images/fingercode1.png"></p><p>The feature elements capture the local information by using the <strong>Gabor filterbank</strong>. The ordered enumeration of the tessellation captures the <strong>invariant global relationships</strong> among the local patterns.</p><p>These features capture both the global pattern of ridges and valleys and the local characteristics. Matching is based on the Euclidean distance between the FingerCodes.</p><p>There are four steps for extracting the FingerCode.</p><ol type="1"><li>Determining the reference point for the fingerprint image.</li><li>Partitioning the region around the reference point.</li><li>Filtering the region of interest in eight different directions using a bank of Gabor filters.</li><li>Computing the <strong>average absolute deviation</strong> (AAD) from the mean of gray values in individual sectors in filtered images to define the <em>FingerCode</em> (the feature vector) for matching.</li></ol><p><strong>Determining the reference point</strong></p><p><img src="/images/fingercode2.png"></p><p>Given an input fingerprint image, there are seven steps for finding the reference point.</p><ol type="1"><li><p>Estimate the orientation field <span class="math inline">\(O\)</span> using a window size of <span class="math inline">\(w\times w\)</span>.</p></li><li><p>Smooth the orientation field.</p></li><li><p>Compute the sine component <span class="math inline">\(E\)</span> of the orientation field <span class="math inline">\(O\)</span>.<br><span class="math display">\[E(i,j)=\sin O(i,j)\]</span></p></li><li><p>Initialize <span class="math inline">\(A\)</span>, a label image used to indicate the reference point.</p></li><li><p>For each pixel <span class="math inline">\(E(i, j)\)</span>, integrate pixel intensities in regions <span class="math inline">\(R_I\)</span> and <span class="math inline">\(R_{II}\)</span>, and assign the corresponding pixels in <span class="math inline">\(A\)</span> according to the value of their difference. <span class="math display">\[A(i,j)=\sum_{R_I}E(i,j)-\sum_{R_{II}}E(i,j)\]</span> <img src="/images/fingercode4.png"></p></li><li><p>Find the maximum value in <span class="math inline">\(A\)</span> and assign its coordinate to the reference point.</p></li><li><p>Repeat steps 1-6 by using a window size <span class="math inline">\(w&#39;\times w&#39;\)</span>, where <span class="math inline">\(w&#39; &lt; w\)</span>, and restrict the search for the reference point in step 6 in a local neighborhood of the detected reference point.</p></li></ol><p>The geometry of regions <span class="math inline">\(R_I\)</span> and <span class="math inline">\(R_{II}\)</span> is designed to capture the maximum curvature in concave ridges.</p><p><img src="/images/fingercode3.png"></p><p><strong>Partitioning the region around the reference point</strong></p><p>Given the detected reference point, the input fingerprint image is partitioned into 80 sectors.</p><p><img src="/images/fingercode5.png"></p><p><strong>Filtering the region of interest</strong></p><p>A minutia point can be viewed as an anomaly in locally parallel ridges and it is the information that is captured by using the Gabor filters.</p><p>Before filtering the fingerprint image, <strong>image normalization</strong> is performed separately for each sector with <span class="math inline">\(M_0\)</span> and <span class="math inline">\(VAR_0\)</span>.</p><p>An even symmetric Gabor filter is given <a href="#gabor-filter*">the Gabor filer setction</a>. The filter frequency <span class="math inline">\(f\)</span> can be set to the average ridge frequency. The average ridge frequency is the reciprocal of the average inter-ridge distance, which is around 10 pixels in a 500 dpi fingerprint image. Eight different values (<span class="math inline">\(0^o\)</span>, <span class="math inline">\(22.5^o\)</span>, <span class="math inline">\(45^o\)</span>, <span class="math inline">\(67.5^o\)</span>, <span class="math inline">\(90^o\)</span>, <span class="math inline">\(112.5^o\)</span>, <span class="math inline">\(135^o\)</span> and <span class="math inline">\(157.5^o\)</span>) are used for the direction Î¸ with respect to the x-axis.</p><p>A fingerprint convolved with a <span class="math inline">\(0^o\)</span>-oriented filter accentuates those ridges which are parallel to the x-axis and smoothes the ridges in the other directions. These eight directional-sensitive filters capture <strong>most of the global ridge directionality information</strong> as well as the <strong>local ridge characteristics</strong> present in a fingerprint.</p><p><img src="/images/fingercode6.png"></p><p><strong>Compute AAD</strong></p><p>Let <span class="math inline">\(F_{iÎ¸}(x, y)\)</span> be the Î¸-direction filtered image for sector <span class="math inline">\(S_i\)</span>. The feature value <span class="math inline">\(V_{iÎ¸}\)</span> is the average absolute deviation (AAD) from the mean which is defined as <span class="math display">\[V_{i\theta}=\frac{1}{n_i}\sum_{(x,y)\in S_i}|F_{i\theta}(x,y)-P_{i\theta}|\]</span> where <span class="math inline">\(P_{i\theta}=\frac{1}{n_i}\sum_{(x,y)\in S_i}F_{i\theta}(x,y)\)</span>; <span class="math inline">\(n_i\)</span> is the number of pixels in <span class="math inline">\(S_i\)</span>.</p><p><img src="/images/fingercode7.png"></p><p>The average absolute deviation of each sector in each of the eight filtered images defines the components of the feature vector. Fingerprint matching is based on finding the <strong>Euclidean distance</strong> between the corresponding <em>FingerCodes</em>.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HKUST CSIT5401 Recognition System lecture notes 4. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#fingerprint-image-acquisition-systems&quot;&gt;Fingerprint image acquisition systems&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#minutiae&quot;&gt;Minutiae&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#fingerprint-enhancement&quot;&gt;Fingerprint Enhancement&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#normalization&quot;&gt;Normalization&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#orientation-image-estimation&quot;&gt;Orientation Image Estimation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ridge-frequency-estimation&quot;&gt;Ridge Frequency Estimation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#region-mask-estimation&quot;&gt;Region mask estimation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gabor-filter&quot;&gt;Gabor Filter*&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#fingerprint-matching&quot;&gt;Fingerprint Matching&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#fingercode&quot;&gt;FingerCode&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- tocstop --&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Recognition System" scheme="http://www.52coding.com.cn/tags/Recognition-System/"/>
    
      <category term="fingerprints" scheme="http://www.52coding.com.cn/tags/fingerprints/"/>
    
      <category term="fingercode" scheme="http://www.52coding.com.cn/tags/fingercode/"/>
    
      <category term="hough transform" scheme="http://www.52coding.com.cn/tags/hough-transform/"/>
    
      <category term="minutiae" scheme="http://www.52coding.com.cn/tags/minutiae/"/>
    
  </entry>
  
  <entry>
    <title>Recognizing Faces</title>
    <link href="http://www.52coding.com.cn/2018/12/06/RS%20-%20Recognizing%20Faces/"/>
    <id>http://www.52coding.com.cn/2018/12/06/RS - Recognizing Faces/</id>
    <published>2018-12-06T14:03:09.000Z</published>
    <updated>2019-04-12T03:27:49.612Z</updated>
    
    <content type="html"><![CDATA[<p>HKUST CSIT5401 Recognition System lecture notes 3. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚</p><!-- toc --><ul><li><a href="#histogram-equalization">Histogram Equalization</a></li><li><a href="#image-pyramid-and-neural-networks">Image Pyramid and Neural Networks</a></li><li><a href="#integral-image">Integral Image</a></li><li><a href="#adaboost">Adaboost</a></li><li><a href="#face-recognition-pca">Face Recognition (PCA)</a></li></ul><!-- tocstop --><a id="more"></a><h2><span id="histogram-equalization">Histogram Equalization</span></h2><p><a href="http://en.wikipedia.org/wiki/Face_detection" target="_blank" rel="noopener">Face detection</a> is the first step in automated face recognition. Its reliability has a major influence on the performance and usability of the entire face recognition system.</p><p>Due to lighting or shadow, intensity can vary significantly in an image. Normalization of pixel intensity helps correct variations in imaging parameters in cameras as well as changes in illumination conditions. One widely used technique is <a href="http://en.wikipedia.org/wiki/Histogram_equalization" target="_blank" rel="noopener">histogram equalization</a>, which is based on image histogram. It helps reduce extreme illumination.</p><p><strong>Image histogram</strong></p><p>It is assumed that there is a digital image with <span class="math inline">\(L\)</span> gray levels <span class="math inline">\(r_k\)</span>. The probability of occurrence of gray level <span class="math inline">\(r_k\)</span> is given by <span class="math display">\[p_r(r_k)=\frac{n_k}{N}\]</span> where <span class="math inline">\(n_k\)</span> is number of pixels with gray level <span class="math inline">\(r_k\)</span>; <span class="math inline">\(N\)</span> is total number of pixels in an image; <span class="math inline">\(k = 0,1,2,...,L-1\)</span>.</p><p><img src="/images/imagehis.png"></p><p>We want an image with equally many pixels at every gray level, or the output intensity approx follows <strong>uniform distribution</strong>.</p><p>That is, a flat histogram, where each gray level, <span class="math inline">\(r_k\)</span>, appears equal number of times, i.e., <span class="math inline">\(N/L\)</span> times.</p><p><img src="/images/imgequ.png"></p><p>Assume that variable <span class="math inline">\(r\)</span> has been normalized between <span class="math inline">\([0,1]\)</span>. The intensity transformation is <span class="math inline">\(s = T(r)\)</span>, such that</p><ul><li><span class="math inline">\(T(r)\)</span> is single-valued and non-decreasing in the interval <span class="math inline">\(0â‰¤râ‰¤1\)</span>.</li><li><span class="math inline">\(0â‰¤T(r)â‰¤1\)</span> for <span class="math inline">\(0â‰¤râ‰¤1\)</span>.</li></ul><p><strong>Histogram equalization transform</strong></p><p>The intensity transformation is the cumulative distribution function (CDF) of <span class="math inline">\(r\)</span>, which is represented by <span class="math display">\[s=T(r)=\int_0^rp_r(w)dw\]</span> The discrete implementation is given by <span class="math display">\[s_k=T(r_k)=\sum_{j=0}^k\frac{n_j}{N}=\sum_{j=0}^kp_r(r_j)\]</span> where <span class="math inline">\(s_k\)</span> is the <strong>output intensity</strong>; <span class="math inline">\(r_k\)</span> is the input intensity; <span class="math inline">\(n_j\)</span> is the number of pixels with gray level <span class="math inline">\(r_j\)</span>.</p><p>Below are some examples:</p><p><img src="/images/hisequeg.png"></p><p><img src="/images/hisequeg2.png"></p><p>Histogram equalization can significantly improve image appearance</p><ul><li>Automatic</li><li>User doesnâ€™t have to perform windowing</li></ul><p>Nice pre-processing step before face detection</p><ul><li>Account for different lighting conditions</li><li>Account for different camera/device properties</li></ul><p>There are two methods for <strong>face detection</strong>:</p><ol type="1"><li>Method using image pyramid and neural networks [Rowley-Baluja-Kanade-98]</li><li>Method using integral image and AdaBoost learning [Viola-Jones-04]</li></ol><h2><span id="image-pyramid-and-neural-networks">Image Pyramid and Neural Networks</span></h2><p>With the neural networks, a classifier may be trained directly using preprocessed and normalized face and nonface training subwindows.</p><p><a href="http://www.cs.cmu.edu/~har/" target="_blank" rel="noopener">Rowley et al</a> use the preprocessed 20x20 subwindows as the input to a neural network. The final decision is made to classify the 20x20 subwindow into face and nonface. The architecture is shown below.</p><p><img src="/images/facepy.png"></p><p>Instead of upright, frontal faces, a <strong>router network</strong> can be trained to process each input window so that orientation can be estimated. Once the orientation is estimated, the input window can be prepared for detector neural network.</p><p><img src="/images/router.png"></p><p><strong>Rowley et al.</strong> proposed two neural networks, as presented in the previous slides. The first one is the router network which is trained to estimate the orientation of an assumed face in the 20x20 sub-window. The second one is the normal frontal, upright face detector. However, it only handles <strong>in-plane rotation</strong>.</p><p><strong>Huang et al.</strong> proposed a multi-view face tree structure for handling both in-plane and <strong>out-of-plane rotations</strong>. Every node corresponds to a strong classifier.</p><p><img src="/images/hung.png"></p><h2><span id="integral-image">Integral Image</span></h2><p><strong>Method using integral image and AdaBoost learning</strong></p><p>The <a href="http://en.wikipedia.org/wiki/Summed_area_table" target="_blank" rel="noopener">integral image</a> <span class="math inline">\(ii(x, y)\)</span> at location <span class="math inline">\((x, y)\)</span> contains the <strong>sum of the pixel intensity values above and to the left</strong> of the location <span class="math inline">\((x, y)\)</span>, inclusive.</p><p>The <span class="math inline">\(ii\)</span> is defined as <span class="math display">\[ii(x,y)=\sum_{x&#39;â‰¤x,y&#39;â‰¤y}i(x&#39;,y&#39;)\]</span> where <span class="math inline">\(ii(x,y)\)</span> is the integral image and <span class="math inline">\(i(x,y)\)</span> is the original input image.</p><p><img src="/images/integralimg.png"></p><p>Using the following pair of recurrences: <span class="math display">\[s(x, y)=s(x, y-1)+i(x,y)\\ii(x,y)=ii(x-1, y)+s(x,y)\]</span> where <span class="math inline">\(s(x,y)\)</span> is the cumulative row sum, <span class="math inline">\(s(x, -1) = 0\)</span>, and <span class="math inline">\(ii(-1, y)=0\)</span>, the integral image can be computed in one pass over the original image.</p><p>Using the integral image, any rectangular sum can be computed in four array references.</p><p><img src="/images/inteeg.png"></p><p><strong>Rectangle features</strong></p><p>The features for face detection are Haar-like functions. There are three kinds of features.</p><p>[1] Two-rectangle feature: The difference between the sum of the pixels within two rectangular regions.</p><p><img src="/images/recfea1.png"></p><p>[2] Three-rectangle feature: The feature is the sum within two outside rectangles subtracted from the sum in a center rectangle.</p><p><img src="/images/recfea2.png"></p><p>[3] Four-rectangle feature: The difference between diagonal pairs of rectangles.</p><p><img src="/images/recfea3.png"></p><p>The rectangle features are sensitive to the presence of edges, bars/lines, and other simple image structures in different scales and at different locations.</p><p>Given that the base resolution of the detector is 24 x 24 pixels, the exhaustive set of rectangle features is quite large, 160,000.</p><p>Given a feature set and a training set of positive and negative images, a classification function must be learned to classify a pattern into either face or non-face.</p><h2><span id="adaboost">Adaboost</span></h2><p>In this work, the classifier is designed based on the assumption that a very small number of features can be combined to form an effective classifier.</p><p>The <a href="http://en.wikipedia.org/wiki/AdaBoost" target="_blank" rel="noopener">AdaBoost</a> learning algorithm is used to boost the classification performance of a simple learning algorithm. The simple learning algorithm is applied to all rectangle features.</p><p>It does this by <strong>combining a collection of weak classification functions</strong> (weak classifiers with relatively high classification error) to form a stronger classifier. The final strong classifier takes the form of <strong>a weighted combination of weak classifiers followed by a threshold</strong>.</p><p>Weak classifier <span class="math inline">\(h_t\)</span> (each classifier compute one rectangle feature): <span class="math display">\[h_t(\vec{x})=\begin{cases}1\ \text{if }\vec{x}\text{ represents a face image }(f_t(\vec{x})&gt;\text{Threshold})\\-1\ \text{otherwise}\end{cases}\\f_t(\vec{x})=\sum_{white} x-\sum_{black} x\]</span> The strong classifier is <span class="math display">\[H(\vec{x})=\text{sgn}\left(\sum_{t=1}^T\alpha_th_t(\vec{x})\right)\]</span> where <span class="math inline">\(\alpha_t\)</span> is weight; and <span class="math inline">\(\text{sgn}(x)\)</span> is sign function: <span class="math display">\[\text{sgn}(x)=\begin{cases} -1,  &amp; \mbox{if }xâ‰¤0 \\1, &amp; \mbox{if }x&gt;0\end{cases}\]</span> <strong>Algorithm</strong></p><p>Given example images and classifications <span class="math inline">\((\vec{x}_i, y_i), i = 1, 2,..., N\)</span>, where <span class="math inline">\(N\)</span> is the total number of images.</p><p>Start with equal weights on each image <span class="math inline">\(\vec{x}_i\)</span>.</p><p>For <span class="math inline">\(t=1, ..., T\)</span>:</p><ul><li><p>Normalize all weights <span class="math inline">\(w_i = \frac{w_i}{\sum_{j=1}^Nw_j}\)</span> such that <span class="math inline">\(\sum_{i=1}^Nw_i=1\)</span>.</p></li><li><p>Select the weak classifier <span class="math inline">\(h_k\)</span> with minimum error: <span class="math display">\[e_k=\sum_{i=1}^Nw_i\left(\frac{1-h_k(\vec{x}_i)y_i}{2}\right)\]</span> where <span class="math inline">\(0â‰¤e_kâ‰¤1\)</span>.</p></li><li><p>Set weight for selected weak classifier <span class="math display">\[\alpha_t=\frac{1}{2}\ln\left(\frac{1-e_k}{e_k}\right)\]</span></p></li><li><p>Reweight the examples (boosting) <span class="math display">\[w_i=w_i\exp(-\alpha_iy_ih_k(\vec{x}_i))\]</span></p></li></ul><p>For the last step, if the weak classifier classify example <span class="math inline">\(i\)</span> correctly, i.e. <span class="math inline">\(h_k(\vec{x}_i)=y_i\)</span>, then the example weight <span class="math inline">\(w_i=w_ie^{-\alpha_t}\)</span> will decrease; if the weak classifier classify example <span class="math inline">\(i\)</span> wrongly, the weight <span class="math inline">\(w_i=w_i^{\alpha_t}\)</span> will increase.</p><p>Values of <span class="math inline">\(T\)</span> can be 200 for <span class="math inline">\(N=10^8\)</span> images and 180,000 filters. Given the above strong classifier, a new image can classified as either face or non-face.</p><h2><span id="face-recognition-pca">Face Recognition (PCA)</span></h2><p>Images of faces often belong to a manifold of intrinsically low dimension. For example, if there are three 3x1 images (see below), then each image has three intensity values. If each intensity value is viewed as a coordinate in a 3D space, then each image can be viewed as a point in a 3D space.</p><p><img src="/images/imgspace.png"></p><p>To represent these points effectively, the number of dimensions can be reduced from three to one. It is the concept of <a href="http://en.wikipedia.org/wiki/Dimension_reduction" target="_blank" rel="noopener">dimensionality reduction</a>.</p><p><a href="http://en.wikipedia.org/wiki/Principal_component_analysis" target="_blank" rel="noopener">Principal component analysis</a> (PCA) is a method for performing dimensionality reduction of high dimensional face images.</p><p><strong>Eigenfaces</strong></p><p>Let us consider a set of <span class="math inline">\(N\)</span> sample images (image vectors) with <span class="math inline">\(m\times n\)</span> dimensions:</p><p><img src="/images/eigenface1.png"></p><p>Each image is represented by a 1D vector with dimensions <span class="math inline">\((m\times n) \times 1\)</span>. The <strong>mean image vector</strong> is given by <span class="math display">\[\vec{x}=\frac{1}{N}\sum_{i=1}^N\begin{bmatrix}x_{i,1}      \\\vdots \\x_{i,mn}\end{bmatrix}\]</span> The <strong>scatter matrix</strong> is given by <span class="math display">\[\vec{S}=[\vec{x_1}-\bar{x}\ \ \vec{x_2}-\bar{x}\ \dots\ \vec{x_N}-\bar{x}]\begin{bmatrix}(\vec{x_1}-\bar{x})^T     \\(\vec{x_2}-\bar{x})^T\\\vdots \\(\vec{x_N}-\bar{x})^T\end{bmatrix}\]</span> The corresponding <span class="math inline">\(t\)</span> eigenvectors with non-zero eigenvalues <span class="math inline">\(\lambda_i\)</span> are <span class="math display">\[\vec{e}_1\ \ \vec{e}_2\ \ \dots\ \ \vec{e}_t\]</span> where <span class="math inline">\(\lambda_1â‰¥\lambda_2â‰¥...â‰¥\lambda_t\)</span>.</p><p>Then the origin image vector can be approximated by <span class="math display">\[\vec{x}_j\approx\bar{x}+\sum_{i=1}^tg_{ji}\vec{e}_i\]</span> where <span class="math inline">\(g_{ji}=(\vec{x}_j-\bar{x})\cdot\vec{e}_i\)</span>.</p><p><img src="/images/egface.png"></p><p>Since the eigenvectors <span class="math inline">\(e\)</span> have the same dimension as the image vectors, the eigenvectors are referred as <a href="http://en.wikipedia.org/wiki/Eigenface" target="_blank" rel="noopener">Eigenfaces</a>. The value of <span class="math inline">\(t\)</span> is usually much smaller than the value of <span class="math inline">\(mn\)</span>. Therefore, the number of dimensions can be reduced significantly.</p><p>For each image <span class="math inline">\(\vec{x}_i\)</span>, the dimension reduced representation is <span class="math display">\[(g_{i1}, g_{i2}, ..., g_{it})\]</span> To detect if the new image <span class="math inline">\(\vec{x}\)</span> with <span class="math inline">\(t\)</span> coefficients <span class="math inline">\((g_1, g_2, ..., g_t)\)</span> is a face: <span class="math display">\[||\vec{x}-(\bar{x}+g_1\vec{e}_1+g_2\vec{e}_2+...+g_t\vec{e}_t)||&lt;\text{Threshold}\]</span> If it is a face, find the closest labeled face based on the nearest neighbor in the <span class="math inline">\(t\)</span>-dimensional space.</p><p><strong>Near-infrared images for face recognition</strong></p><p>Most current face recognition systems are based on face images captured in the visible light spectrum. The infrared imaging system is able to produce face images of good condition regardless of visible lights in the environment.</p><p><img src="/images/infared.png"></p><p><img src="/images/infeared2.png"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HKUST CSIT5401 Recognition System lecture notes 3. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#histogram-equalization&quot;&gt;Histogram Equalization&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#image-pyramid-and-neural-networks&quot;&gt;Image Pyramid and Neural Networks&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#integral-image&quot;&gt;Integral Image&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#adaboost&quot;&gt;Adaboost&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#face-recognition-pca&quot;&gt;Face Recognition (PCA)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- tocstop --&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="PCA" scheme="http://www.52coding.com.cn/tags/PCA/"/>
    
      <category term="Recognition System" scheme="http://www.52coding.com.cn/tags/Recognition-System/"/>
    
      <category term="Face Recognition" scheme="http://www.52coding.com.cn/tags/Face-Recognition/"/>
    
      <category term="histogram equalization" scheme="http://www.52coding.com.cn/tags/histogram-equalization/"/>
    
      <category term="Adaboost" scheme="http://www.52coding.com.cn/tags/Adaboost/"/>
    
  </entry>
  
  <entry>
    <title>Recognizing Irises</title>
    <link href="http://www.52coding.com.cn/2018/12/05/RS%20-%20Recognizing%20Irises/"/>
    <id>http://www.52coding.com.cn/2018/12/05/RS - Recognizing Irises/</id>
    <published>2018-12-05T13:56:09.000Z</published>
    <updated>2019-04-12T03:27:57.922Z</updated>
    
    <content type="html"><![CDATA[<p>HKUST CSIT5401 Recognition System lecture notes 2. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚</p><!-- toc --><ul><li><a href="#introduction">Introduction</a></li><li><a href="#image-acquisition-systems">Image Acquisition Systems</a></li><li><a href="#iris-localization">Iris localization</a></li><li><a href="#pattern-matching">Pattern Matching</a><ul><li><a href="#alignment-registration">Alignment (Registration)</a></li><li><a href="#representation">Representation</a></li><li><a href="#goodness-of-match">Goodness of Match</a></li><li><a href="#decision-fld">Decision (FLD)</a></li></ul></li><li><a href="#hough-transform">Hough Transform</a></li></ul><!-- tocstop --><a id="more"></a><h2><span id="introduction">Introduction</span></h2><p>Face recognition and iris recognition are non-invasive method for verification and identification of people. In particular, the spatial patterns that are apparent in the human iris are highly distinctive to an individual.</p><p><img src="/images/iries.png"></p><p><strong>Schematic diagram of iris recognition</strong></p><p><img src="/images/iries_recog.png"></p><h2><span id="image-acquisition-systems">Image Acquisition Systems</span></h2><p>One of the major challenges of automated iris recognition is to capture a high-quality image of the iris while remaining non-invasive to the human operator.</p><p>There are three concerns while acquiring iris images:</p><ul><li>To support recognition, it is desirable to acquire images of the iris with sufficient resolution and sharpness.</li><li>It is important to have good contrast in the interior iris pattern without resorting to a level of illumination that annoys the operator, i.e., adequate intensity of source constrained by operator comfort with brightness.</li><li>These images must be well framed (i.e., centered) without unduly constraining the operator.</li></ul><p><strong>The Daugman system</strong></p><p>The Daugman system captures images with the iris diameter typically between 100 and 200 pixels from a distance of 15-46cm.</p><p>The system makes use of an LED-based point light source in conjunction with a standard video. By carefully positioning of the point source below the operator, reflections of the light source off eyeglasses can be avoided in the imaged iris.</p><p><img src="/images/daugman.png"></p><p>The Daugman system provides the operator with live video feedback via a tiny liquidcrystal display placed in line with the camera's optics via a beam splitter. This allows the operator to see what the camera is capturing and to adjust his position accordingly.</p><p><strong>The Wildes system</strong></p><p>The Wildes system images the iris with approximately 256 pixels across the diameter from 20cm. The system makes use of a diffused source and polarization in conjunction with a low-light level camera.</p><p>The use of matched <strong>circular polarizer</strong> at the light source and camera essentially eliminates the specular reflection of the light source.</p><p><img src="/images/wildes.png"></p><p>The coupling of a low light level camera with a diffused illumination allows for a level of illumination that is entirely unobjectionable to human operators.</p><p>The relative sizes and positions of the square contours are chosen so that when the eye is in an appropriate position, the squares overlap and appear as one to the operator.</p><h2><span id="iris-localization">Iris localization</span></h2><p><img src="/images/iries_loc.png"></p><p>Image acquisition will capture the iris as part of a larger image that also contains data derived from the immediately surrounding eye region. For example, eyelashes, upper eyelid, lower eyelid and sclera. Therefore, prior to performing iris pattern matching, it is important to <strong>localize</strong> that portion of the acquired image that corresponds to an iris.</p><p><strong>The Wildes system</strong> makes use of the <strong>first derivatives</strong> of image intensity to signal the location of edges that correspond to the borders of the iris.</p><ul><li>Step 1: The image intensity information is converted into binary edge-map.</li><li>Step 2: The edge points vote to particular contour parameter values.</li></ul><p><strong>Step 1</strong></p><p>The edge map is recovered via <strong>gradient-based edge detection</strong>. This operation consists of thresholding the magnitude of the image intensity gradient magnitude. <span class="math inline">\(I\)</span> is the intensity and (x, y) are the image coordinates. <span class="math display">\[\text{Gradient magnitude }|\triangledown G(x, y)\ast I(x, y)|\\\text{2D Gaussian function } G(x, y)=\frac{1}{2\pi\sigma^2}\exp(\frac{(x-x_0)^2+(y-y_0)^2}{2\sigma^2})\]</span> <img src="/images/iris_edge.png"></p><p><strong>Step 2</strong></p><p>The voting procedure is realized via the <a href="#hough-transform">Hough transform</a>. For circular limbic or pupillary boundaries and a set of recovered edge points, a Hough transform is defined as follows.</p><p>Edge points <span class="math inline">\((x_j, y_j)\)</span> for <span class="math inline">\(j = 1, ..., n\)</span>: <span class="math display">\[H(x_c, y_c, r)=\sum_{j=1}^nh(x_j,y_j,x_c,y_c,r)\]</span> where <span class="math display">\[h(x_j, y_j, x_c, y_c, r)=\begin{cases}1, \text{ if }\ g(x_j, y_j, x_c, y_c, r)=0\\0, \text{ otherwise}\end{cases}\\g(x_j, y_j, x_c, y_c, r)=(x_j-x_c)^2+(y_j-y_c)^2-r^2\]</span> For every parameter triple <span class="math inline">\((x_c, y_c, r)\)</span> that represents a circle through the edge point <span class="math inline">\((x_j, y_j)\)</span>, <span class="math display">\[g(x_j, y_j, x_c, y_c, r)=0\]</span> <img src="/images/wildescir.png"></p><p>The parameter triple that <strong>maximizes</strong> the Hough space <span class="math inline">\(H\)</span> is common to the largest number of edge points and is a reasonable choice to represent the contour of interest.</p><hr><p>The limbus and pupil are modeled with <strong>circular contour models</strong>.</p><p><strong>The Daugman system</strong> fits the <strong>circular contours</strong> via gradient ascent on the parameters so as to maximize <span class="math display">\[\left|\frac{\partial}{\partial r}G(r)\ast\oint_{x_c,y_c,r}\frac{I(x,y)}{2\pi r}ds\right|\]</span> where <span class="math inline">\(G(r)=\frac{1}{\sqrt{2\pi}\sigma}\exp(-\frac{(r-r_0)^2}{2\sigma^2})\)</span>; <span class="math inline">\(r_0\)</span> is the center.</p><p>The first part of the equation is to perform Gaussian smoothing; while the second part is computing the average intensity along the circle.</p><p><img src="/images/IMG_66247EE67551-1.jpg"></p><p>In order to incorporate directional tuning of the image derivative, the arc of integration <span class="math inline">\(ds\)</span> is restricted to the left and right quadrants (i.e., near vertical edges) when fitting the <em>limbic boundary</em>.</p><p>This arc is considered over a fuller range when fitting the <em>pupillary boundary</em>.</p><h2><span id="pattern-matching">Pattern Matching</span></h2><p>Having localized the region of an acquired image that corresponds to the iris, the final task is to decide if this pattern matches a previously stored iris pattern.</p><p>There are four steps:</p><ol type="1"><li>Alignment: bringing the newly acquired iris pattern into spatial alignment with a candidate data base entry.</li><li>Representation: choosing a representation of the aligned iris patterns that makes their distinctive patterns apparent.</li><li>Goodness of Match: evaluating the goodness of match between the newly acquired and data base representations.</li><li>Decision: deciding if the newly acquired data and the data base entry were derived from the same iris based on the goodness of match.</li></ol><h3><span id="alignment-registration">Alignment (Registration)</span></h3><p>To make a detailed comparison between two images, it is advantageous to establish a precise correspondence (or matching) between characteristic structures across the pair.</p><p>Both systems (Daugman and Wildes systems) compensate for image shift, scaling and rotation.</p><p><strong>The Daugman system for alignment</strong></p><p>The Daugman system uses <strong>radial scaling</strong> to compensate for overall size as well as a simple model pupil variation based on <strong>linear stretching</strong>.</p><p>The system maps the Cartesian image coordinates <span class="math inline">\((x, y)\)</span> to dimensionless polar image coordinates <span class="math inline">\((r, Î¸)\)</span> according to <span class="math display">\[x(r,\theta)=(1-r)x_p(0,\theta)+rx_l(1,\theta)\\y(r,\theta)=(1-r)y_p(0,\theta)+ry_l(1,\theta)\]</span> <img src="/images/daugalign.png"></p><p><img src="/images/daugali.png"></p><p><strong>The Wildes system for alignment</strong></p><p>The Wildes system uses an <strong>image-registration</strong> technique to compensate for both scaling and rotation.</p><p>This approach geometrically warps a newly acquired image <span class="math inline">\(I_a (x, y)\)</span> into alignment with a selected data base image <span class="math inline">\(I_d (x, y)\)</span> according to a mapping function <span class="math inline">\((u(x, y), v(x, y))\)</span> such that for all <span class="math inline">\((x, y)\)</span>, the image intensity value at <span class="math inline">\((x, y) â€“ (u(x, y), v(x, y))\)</span> is close to that at <span class="math inline">\((x, y)\)</span> at <span class="math inline">\(I_d\)</span>.</p><p>The mapping function is taken to minimize <span class="math display">\[\int_x\int_y\left(I_d(x,y)-I_a(x-u, y-v)\right)^2dxdy\]</span> under the constrains to capture similarity transformation of image coordinates <span class="math inline">\((x,y)\)</span> to <span class="math inline">\((x&#39;=x-u, y&#39;=y-v)\)</span>.</p><p><img src="/images/imgreg.jpg"></p><p><strong>Translation</strong> <span class="math display">\[\vec{x}&#39;=\vec{x}+\vec{d}\]</span> <img src="/images/imgtrans.png"></p><p><strong>Rotation</strong> <span class="math display">\[\vec{x}&#39;=R_\theta\vec{x}\\R_\theta=\begin{pmatrix}\cos\theta &amp; -\sin\theta \\\sin\theta &amp; \cos\theta\end{pmatrix}\]</span> <img src="/images/imgrot.png"></p><p><strong>Rotation + Translation</strong> <span class="math display">\[\vec{x}&#39;=R\vec{x}+\vec{d}\]</span> <strong>Scaling + Translation</strong> <span class="math display">\[\vec{x}&#39;=S\vec{x}+\vec{d}\]</span> <img src="/images/scatra.png"></p><p><strong>Shearing</strong> <span class="math display">\[\vec{x}&#39;=K\vec{x}\\K=\begin{bmatrix}1      &amp; k_{xy}     \\k_{yx}     &amp; 1\end{bmatrix}\]</span> <img src="/images/shearing.png"></p><p><strong>Affine</strong>: translation + rotation + scaling + shearing <span class="math display">\[\vec{x}&#39;=R_\theta S K\vec{x}+\vec{d}\]</span> Example: <span class="math display">\[\begin{bmatrix}x&#39; \\y&#39;\end{bmatrix}=\begin{bmatrix}\cos\theta &amp; -\sin\theta \\\sin\theta &amp; \cos\theta\end{bmatrix}\begin{bmatrix}s_x &amp; 0 \\0 &amp; s_y\end{bmatrix}\begin{bmatrix}1 &amp; k_{xy} \\k_{yx} &amp; 1\end{bmatrix}\begin{bmatrix}x \\y\end{bmatrix}+\begin{bmatrix}d_x \\d_y\end{bmatrix}\]</span></p><h3><span id="representation">Representation</span></h3><p>To represent the iris image for matching, both the Daugman and Wildes systems capture the multiscale information extracted from the image.</p><p>The Wildes system makes use of the Laplacian of Gaussian filters to construct a <strong>Laplacian pyramid</strong>.</p><p>The Laplacian of Gaussian (LoG) filter is given by <span class="math display">\[-\frac{1}{\pi\sigma^4}\left(1-\frac{\rho^2}{2\sigma^2}\right)\exp(-\frac{\rho^2}{2\sigma^2})\]</span> where <span class="math inline">\(\rho\)</span> is radial distance of a point from the filter's center; <span class="math inline">\(\sigma\)</span> is standard deviation.</p><p>A Laplacian pyramid is formed by collecting the LoG filtered images.</p><p><img src="/images/logpra.png"></p><h3><span id="goodness-of-match">Goodness of Match</span></h3><p>The Wildes system uses the <strong>normalized correlation</strong> between the acquired representation and data base representation. In discrete form, the normalized correlation can be defined as follows.</p><p>Let <span class="math inline">\(p_1[i, j]\)</span> and <span class="math inline">\(p_2[i, j]\)</span> be two image arrays of size <span class="math inline">\(n \times m\)</span>.</p><p><img src="/images/gom.png"></p><p>The normal correlation is <span class="math display">\[NC=\frac{\sum_{i=1}^n\sum_{j=1}^m(p_1[i,j]-\mu_1)(p_2[i,j]-\mu_2)}{nm\sigma_1\sigma_2}\]</span> <img src="/images/gompy.png"></p><h3><span id="decision-fld">Decision (FLD)</span></h3><p>The Wildes system combines four estimated normalized correlation values into a single <strong>accept/reject</strong> judgment.</p><p>In this application, the concept of <a href="http://en.wikipedia.org/wiki/Linear_discriminant_analysis" target="_blank" rel="noopener">Fisher's linear discriminant</a> is used for making binary decision. A <strong>weight vector</strong> is found such that <strong>the variance within a class of iris data is minimized</strong> while <strong>the variance between different classes of iris data is maximized</strong> for the transformed samples.</p><p>In iris recognition application, usually there are two classes: <strong>Authentic class (A)</strong> and <strong>Imposter class (I)</strong>.</p><p>To make a binary decision on a line, all points are projected onto the weight vector (or samples are transformed by using the weight vector).</p><p><img src="/images/fld1.png"></p><p>In iris recognition using the Wildes system, all samples are 4-dimensional vectors. Let there be n 4-dimensional samples.</p><p><img src="/images/fld2.png"></p><p>The total within class variance is <span class="math display">\[\vec{S}_w=\vec{S}_i+\vec{S}_a\]</span> Between class variance is <span class="math display">\[\vec{S}_b=(\vec{\mu}_a-\vec{\mu}_i)(\vec{\mu}_a-\vec{\mu}_i)^T\]</span> If all samples are transformed, the ratio of between class variance to total within class variance is <span class="math display">\[\frac{\vec{w}^T\vec{S}_b\vec{w}}{\vec{w}^T\vec{S}_w\vec{w}}\]</span> The ratio is maximized when <span class="math display">\[\vec{w}=\vec{S}_w^{-1}(\vec{\mu}_a-\vec{\mu}_i)\]</span> And the separation point for decision making is <span class="math display">\[\frac{1}{2}\vec{w}^T(\vec{\mu}_a+\vec{\mu}_i)\]</span> Therefore, values above this point will be taken as derived from class <span class="math inline">\(A\)</span>; values below this point will be taken as derived from class <span class="math inline">\(I\)</span>.</p><p><img src="/images/fld3.png"></p><h2><span id="hough-transform">Hough Transform</span></h2><p><strong>Detecting Lines</strong></p><p>Idea: if two edge points <span class="math inline">\((x_i, y_i)\)</span> and <span class="math inline">\((x_j, y_j)\)</span> lie on the same straight line, then they should have the same values of slope and y-intercepts on the xy-plane.</p><p><img src="/images/houghline.png"></p><p><strong>[1]</strong> For a point <span class="math inline">\((x_i,y_i)\)</span>, we set up a straight line equation: <span class="math display">\[y_i=ax_i+b\Leftrightarrow b=(-x_i)a+y_i\]</span> where <span class="math inline">\(a\)</span> = slope, <span class="math inline">\(b\)</span> = y-intercept, <span class="math inline">\(x_i\)</span> and <span class="math inline">\(y_i\)</span> are known and fixed.</p><p><strong>[2]</strong> We subdivide the a axis into <span class="math inline">\(K\)</span> increments between <span class="math inline">\([a_\min,a_\max]\)</span>. For each increment of <span class="math inline">\(a\)</span>, we evaluate the value of <span class="math inline">\(b\)</span>.</p><p><strong>[3]</strong> A relationship between <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> can be plotted in a parameter space, i.e., ab-plane.</p><p><strong>[4]</strong> We partition the parameter space into a number of bins (accumulator cells), and increment the corresponding bin <span class="math inline">\(A(a,b)\)</span> by 1 (<span class="math inline">\(b\)</span> is rounded into the nearest integer).</p><p><img src="/images/houghbin.png"></p><p><strong>[5]</strong> For another point <span class="math inline">\((x_j,y_j)\)</span>, we set up another straight line equation: <span class="math display">\[y_j=ax_j+b\Leftrightarrow b=(-x_j)a+y_j\]</span> <strong>[6]</strong> Similarly, we subdivide the a axis into K increments between <span class="math inline">\([a_\min,a_\max]\)</span>. For each increment of <span class="math inline">\(a\)</span>, we evaluate the value of <span class="math inline">\(b\)</span>. We plot the relationship between <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> in the same parameter space, and update bin values in the discrete parameter space.</p><p><strong>[7]</strong> The bin <span class="math inline">\(A(a,b)\)</span> having the highest count corresponds to the straight line passing through the points <span class="math inline">\((x_i,y_i)\)</span> and <span class="math inline">\((x_j,y_j)\)</span>.</p><p><img src="/images/hough2.png"></p><p><strong>[8]</strong> The same procedure can be applied to all points. The bin <span class="math inline">\(A(a,b)\)</span> having the <strong>highest count</strong> corresponds to the straight line passing through (or passing near) the largest number of points.</p><p>Problem: Values of <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> run from negative infinity to positive infinity. We need infinite number of bins!</p><p>Solution: use normal representation of a line: <span class="math display">\[x\cos(\theta)+y\sin(\theta)=\rho\]</span> <img src="/images/houghnormal.png"></p><p><span class="math inline">\(\theta\)</span> runs from <span class="math inline">\(â€“90^o\)</span> to <span class="math inline">\(90^o\)</span>. <span class="math inline">\(\rho\)</span> runs from <span class="math inline">\(-\sqrt{2}D\)</span> to <span class="math inline">\(\sqrt{2}D\)</span>, where <span class="math inline">\(D\)</span> is the distance between corners in the image (length and width).</p><p><strong>Circle Hough Transform (CHT)</strong></p><p>The Hough transform can be used to determine the parameters of a circle when a number of points that fall on the perimeter are known. A circle with radius <span class="math inline">\(R\)</span> and center <span class="math inline">\((a, b)\)</span> can be described with the parametric equations: <span class="math display">\[x=a+R\cos(\theta)\\y=b+R\sin(\theta)\]</span> When the angle <span class="math inline">\(Î¸\)</span> sweeps through the full 360 degree range the points <span class="math inline">\((x, y)\)</span> trace the perimeter of a circle.</p><p>If the circles in an image are of <strong>known radius</strong> <span class="math inline">\(R\)</span>, then the search can be reduced to 2D. The objective is to find the <span class="math inline">\((a, b)\)</span> coordinates of the centers.</p><p><img src="/images/cht1.png"></p><p>If the <strong>radius is not known</strong>, then the locus of points in parameter space will fall on the surface of a <strong>cone</strong>. Each point <span class="math inline">\((x, y)\)</span> on the perimeter of a circle will produce a cone surface in parameter space. The triplet <span class="math inline">\((a, b, R)\)</span> will correspond to the accumulation cell where the largest number of cone surfaces intersect.</p><p><img src="/images/cone.png">The drawing above illustrates the generation of a conical surface in parameter space for one <span class="math inline">\((x, y)\)</span> point. A circle with a different radius will be constructed at each level, <span class="math inline">\(r\)</span>.</p><p>The search for circles with unknown radius can be conducted by using a three dimensional accumulation matrix.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HKUST CSIT5401 Recognition System lecture notes 2. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#introduction&quot;&gt;Introduction&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#image-acquisition-systems&quot;&gt;Image Acquisition Systems&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#iris-localization&quot;&gt;Iris localization&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#pattern-matching&quot;&gt;Pattern Matching&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#alignment-registration&quot;&gt;Alignment (Registration)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#representation&quot;&gt;Representation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#goodness-of-match&quot;&gt;Goodness of Match&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#decision-fld&quot;&gt;Decision (FLD)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#hough-transform&quot;&gt;Hough Transform&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- tocstop --&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Recognition System" scheme="http://www.52coding.com.cn/tags/Recognition-System/"/>
    
      <category term="Iris" scheme="http://www.52coding.com.cn/tags/Iris/"/>
    
      <category term="FLD" scheme="http://www.52coding.com.cn/tags/FLD/"/>
    
      <category term="Daugman" scheme="http://www.52coding.com.cn/tags/Daugman/"/>
    
      <category term="Wildes" scheme="http://www.52coding.com.cn/tags/Wildes/"/>
    
      <category term="Hough Transform" scheme="http://www.52coding.com.cn/tags/Hough-Transform/"/>
    
  </entry>
  
  <entry>
    <title>Recognizing Image Features and Patterns</title>
    <link href="http://www.52coding.com.cn/2018/12/04/RS%20-%20Recognizing%20Image%20Features%20and%20Patterns/"/>
    <id>http://www.52coding.com.cn/2018/12/04/RS - Recognizing Image Features and Patterns/</id>
    <published>2018-12-04T13:56:09.000Z</published>
    <updated>2019-04-12T03:27:54.554Z</updated>
    
    <content type="html"><![CDATA[<p>HKUST CSIT5401 Recognition System lecture notes 1. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚</p><!-- toc --><ul><li><a href="#laplacian-point-detector">Laplacian Point Detector</a></li><li><a href="#line-detector">Line Detector</a></li><li><a href="#edge-detectors">Edge Detectors</a><ul><li><a href="#gradient-operator">Gradient Operator</a></li><li><a href="#marr-hildreth-edge-detector">Marr-Hildreth Edge Detector</a></li></ul></li><li><a href="#scale-invariant-feature-transform-sift">Scale Invariant Feature Transform (SIFT)</a></li><li><a href="#harris-corner-detector">Harris Corner Detector</a></li></ul><!-- tocstop --><a id="more"></a><h2><span id="laplacian-point-detector">Laplacian Point Detector</span></h2><p>There are three different types of intensity discontinuities in a digital image:</p><ul><li>Point (Isolated Point)</li><li>Line</li><li>Edge (Ideal, Ramp and Roof)</li></ul><p>Intensity discountinuity is detected based on the mask response <span class="math inline">\(R\)</span> within a pre-defined window, e.g. <span class="math inline">\(3\times3\)</span>: <span class="math display">\[R=\sum_{i=1}^9w_iz_i\]</span> where <span class="math inline">\(w_i\)</span> represent weights within a pre-defined window; <span class="math inline">\(z_i\)</span> represent intensity values.</p><p>If <span class="math inline">\(|R|â‰¥T\)</span> , then a point has been detected. This point is the location on which the mask is <strong>centred</strong>, where <span class="math inline">\(T\)</span> is a non-negative threshold.</p><p>The mask below is the <strong>Laplacian mask</strong> for detecting point. Sum of all weights is zero to make sure that there is no response at a flat region (constant intensity region).</p><table><thead><tr class="header"><th style="text-align: center;">1</th><th style="text-align: center;">1</th><th style="text-align: center;">1</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">-8</td><td style="text-align: center;">1</td></tr><tr class="even"><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td></tr></tbody></table><p>The Laplacian is given as (<span class="math inline">\(f\)</span> is input image): <span class="math display">\[\triangledown^2f(x,y)=\frac{\partial^2f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2}\]</span> where <span class="math display">\[\frac{\partial^2f}{\partial x^2}=f(x+1,y)-2f(x,y)+f(x-1,y)\\\frac{\partial^2 f}{\partial y^2}=f(x,y+1)-2f(x,y)+f(x,y-1)\]</span> The discrete implementation of the Laplacian operator is given as: <span class="math display">\[\triangledown^2f(x,y)=f(x+1,y)+f(x-1,y)+f(x,y+1)+f(x,y-1)-4f(x,y)\]</span> Below are several Laplacian masks:</p><p><img src="/images/pd.png"></p><h2><span id="line-detector">Line Detector</span></h2><p>A line is detected when more than one aligned, connected points are detected or, the <strong>response</strong> of line mask <strong>is greater than some threshold</strong>. The below are line masks for detecting lines (1 pixel thick) in 4 different specific directions:</p><p><img src="/images/ld.png"></p><p>If we want to detect a line in a specified direction, then we should use the mask associated with that direction and threshold its output responses.</p><p>If 4 line masks are used, then the final response is equal to the <strong>largest</strong> response among the masks: <span class="math display">\[R = \max\left(|R_{horizontal}|, |R_{45}|, |R_{vertical}|, |R_{-45}|\right)\]</span> Example code (Matlab):</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f = imread(<span class="string">'xxx.png'</span>); <span class="comment">% read image</span></span><br><span class="line">w = [<span class="number">2</span> <span class="number">-1</span> <span class="number">-1</span>; <span class="number">-1</span> <span class="number">2</span> <span class="number">-1</span>; <span class="number">-1</span> <span class="number">-1</span> <span class="number">2</span>]; <span class="comment">% mask</span></span><br><span class="line">g = <span class="built_in">abs</span>(imfilter(double(f),w)); <span class="comment">% mask responses</span></span><br></pre></td></tr></table></figure><h2><span id="edge-detectors">Edge Detectors</span></h2><p>Edge is the boundary of regions. The boundary has meaningful discontinuities in grey intensity level. There are three types of edges: ideal edge (left), ramp edge (middle) and roof edge (right).</p><p><img src="/images/3t.png"></p><p>For an <strong>ideal edge</strong> (step edge, left), an edge is a collection of connected pixels on the region boundary. Ideal edges can occur over the distance of 1 pixel.</p><p><strong>Roof edges</strong> (right) are models of lines through a region, with the base (width) of a roof edge being determined by the thickness and sharpness of the line. In the limit, when its base is 1 pixel wide, a roof edge becomes a 1 pixel thick line running through a region in an image. Roof edges can represent thin features, e.g., roads, line drawings, etc.</p><p>For a <strong>ramp edge</strong> (middle):</p><ul><li>edge point is any point contained in the ramp</li><li>edge length is determined by the length of the ramp</li><li>the slope of the ramp is inversely proportional to the degree of blurring in the edge</li><li>the <strong>first derivative</strong> of the intensity profile is positive at the points of transition into and out of the ramp (we move from left to right)</li><li>the <strong>second derivative</strong> of the intensity profile is positive at the transition associated with the dark side of the edge, and negative at the transition associated with the light side of the edge</li></ul><p><img src="/images/ramp.png"></p><p>The <strong>magnitude of the first derivative</strong> can be used to detect the presence of an edge. The <strong>sign of the second derivative</strong> can be used to determine whether an edge pixel lies on the dark or light side of an edge. The <strong>zero-crossing property</strong> of the second derivative is very useful for <strong>locating</strong> the centres of thick edge.</p><p>However, fairly little noise can have a significant impact on the first and second derivatives used for edge detection in images. <strong>Image smoothing</strong> is commonly used prior to the edge detection so that the estimations of the two derivatives can be more accurate.</p><h3><span id="gradient-operator">Gradient Operator</span></h3><p>The computation of the gradient of an image is based on obtaining the partial derivatives <span class="math inline">\(G_x = \partial f/\partial x\)</span> and <span class="math inline">\(G_y = \partial f/\partial y\)</span> at every pixel location (x,y). The gradient direction and gradient magnitude are <span class="math display">\[\tan^{-1}\left(\frac{G_y}{G_x}\right)\\|\triangledown f|\approx|G_x|+|G_y|\]</span> <img src="/images/z.png"></p><p>The are several ways to approximate the partial derivatives:</p><ul><li>Roberts cross-gradient operators<ul><li><span class="math inline">\(G_x = (z_9-z_5)\)</span></li><li><span class="math inline">\(G_y=(z_8-z_6)\)</span></li></ul></li><li>Prewitt operators<ul><li><span class="math inline">\(G_x=(z_7+z_8+z_9)-(z_1+z_2+z_3)\)</span></li><li><span class="math inline">\(G_y=(z_3+z_6+z_9)-(z_1+z_4+z_7)\)</span></li></ul></li><li>Sobel operators<ul><li><span class="math inline">\(G_x=(z_7+2z_8+z_9)-(z_1+2z_2+z_3)\)</span></li><li><span class="math inline">\(G_y=(z_3+2z_6+z_9)-(z_1+2z_4+z_7)\)</span></li></ul></li></ul><p><img src="/images/ed.png"></p><p>Below are diagonal edge masks for detecting discontinuities in the <strong>diagonal directions</strong>.</p><p><img src="/images/diag.png"></p><h3><span id="marr-hildreth-edge-detector">Marr-Hildreth Edge Detector</span></h3><p>The Laplacian of an image f(x,y) at location (x,y) is defined as <span class="math display">\[\triangledown^2f(x,y)=\frac{\partial^2f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2}\]</span> There are two approximations: <span class="math display">\[\triangledown^2f=4z_5-(z_2+z_4+z_6+z_8)\\\triangledown^2f=8z_5-(z_1+z_2+z_3+z_4+z_6+z_7+z_8+z_9)\]</span> The Laplacian generally is <strong>not</strong> used in its original form for edge detection (based on zero-crossing property) because it is <strong>unacceptably sensitive to noise</strong>. We smooth the image by using a Gaussian blurring function <span class="math inline">\(G(r)\)</span>, where <span class="math inline">\(r\)</span> = radius, before we apply the Laplacian operator: <span class="math display">\[G(r)=\exp(\frac{-r^2}{2\sigma^2})\]</span> The <strong>Laplacian of a Gaussian (LoG)</strong> operator is defined by <span class="math display">\[\text{LoG}(f)=\triangledown^2(f\ast G)=f\ast(\triangledown^2G)\]</span> Using the LoG, the location of edges can be detected reliably based on the zero-crossing values because image noise level is reduced by the Gaussian function.</p><p><strong>Marr-Hildreth algorithm</strong></p><ol type="1"><li><p>Filter the input with an n-by-n Gaussian blurring filter <span class="math inline">\(G(r)\)</span>.</p></li><li><p>Compute the Laplacian of the image resulting from Step 1 using one of the following 3-by-3 masks.</p><p><img src="/images/mha.png"></p></li><li><p>Find the <strong>zero crossings</strong> of the image from Step 2.</p><ol type="1"><li>A zero crossing at a pixel implies that the signs of at least two of its opposing neighboring pixels must be different.</li><li>There are four cases to test: left/right, up/down, and the two diagonals.</li><li>For testing, the signs of the two opposing neighboring pixels must be different and their absolute Laplacian values must be larger than or equal to some threshold.</li><li>If yes, we call the current pixel a zero-crossing pixel.</li></ol></li></ol><p><img src="/images/mhed.png"></p><h2><span id="scale-invariant-feature-transform-sift">Scale Invariant Feature Transform (SIFT)</span></h2><p>SIFT is useful for finding distinctive patches (<strong>keypoints</strong>) in images and transforming keypoints (locations) into <strong>features vectors</strong> for recognition tasks.</p><p>SIFT consists of four steps:</p><ol type="1"><li>Scale-space extrema detection</li><li>Keypoint localization</li><li>Orientation assignment</li><li>Keypoint descriptor</li></ol><p>SIFT feature is</p><ul><li>invariant to image rotation and scale</li><li>partially invariant to change in illumination and 3D camera viewpoint</li></ul><p>The method is a cascade (one step followed by the other step) filtering approach, in which more computationally expensive operations are applied only at locations that pass an initial test.</p><p><strong>[1] Scale-space extrema detection</strong></p><p>Candidate locations are identified by searching for stable features across all scales in the scale space. The <strong>scale space</strong> of an image is defined as <span class="math display">\[L(x,y,\sigma)=G(x,y,\sigma)\ast I(x,y)\\G(x,y,\sigma)=\frac{1}{2\pi\sigma^2}\exp(-\frac{x^2+y^2}{2\sigma^2})\]</span> , where <span class="math inline">\(\ast\)</span> is the convolution operator (filtering operation), the variable-scale Gaussian is <span class="math inline">\(G(x, y, \sigma)\)</span> and the image is <span class="math inline">\(I(s, y)\)</span>.</p><p>The difference between two nearby scales separated by a constant multiplicative factor <span class="math inline">\(k\)</span> is <span class="math display">\[\begin{align}D(x,y,\sigma)&amp;=L(x,y,k\sigma)-L(x,y,\sigma)\\&amp;=\left(G(x,y,k\sigma)-G(x,y,\sigma)\right)\ast I(x,y)\end{align}\]</span> The DoG function provides a close and efficient approximation to the scale-normalized Laplacian of Gaussian (LoG).</p><p><img src="/images/dog.jpg"></p><p>Local <strong>extrema</strong> (maxima and minima) of <span class="math inline">\(D( x, y, Ïƒ)\)</span> are detected by comparing the values of its 26 neighbors, including 9 from the above image, 9 from bottom image and 8 from the current image.It is selected only if the center pixel is larger than <strong>all</strong> of these neighbors (26 neighbors) or smaller than all of them.</p><p><img src="/images/extra.png"></p><p><img src="/images/exdet.png"></p><p><strong>[2] Keypoint localization</strong></p><p>Once a keypoint candidate has been found by comparing a pixel to its neighbors, the next step is to determine whether the keypoint is selected based on <strong>local contrast and localization along edge</strong>. Therefore, the keypoints will be rejected if these points have low contrast.</p><p>All extrema are discarded if <span class="math inline">\(|D(x)|&lt;0.03\)</span> (minimum contrast), where <span class="math inline">\(x\)</span> represents a relative image position with maximum value of <span class="math inline">\(D\)</span>. The keypoints will be rejected if these points are poorly localized along an edge (determined based on the <strong>ratio of principle curvatures</strong>).</p><p><img src="/images/kl.png"></p><p><strong>[3] Orientation assignment</strong></p><p>Each corresponding keypoint in <span class="math inline">\(L\)</span> is assigned a dominant orientation. The keypoint descriptor can be represented relative to this orientation and therefore achieve invariance to image rotation.</p><p>The gradient magnitude and orientation are <span class="math display">\[m(x,y)=\sqrt{(L(x+1,y)-L(x-1,y))^2+(L(x,y+1)-L(x,y-1))^2}\\\theta(x,y)=\tan^{-1}\left(\frac{L(x,y+1)-L(x,y-1)}{L(x+1,y)-L(x-1,y)}\right)\]</span> An <strong>orientation histogram</strong> is formed from the gradient orientations within a region around the keypoint. The orientation histogram has 36 bins covering the 360 degree range of orientations, 10 degrees per bin. Each sample added to the histogram is weighted by its gradient magnitude and by a Gaussian-weighted circular window (with Ïƒ that is 1.5 times that of the scale of the keypoint, and it is related to effective window size). Peak in the orientation histogram corresponds to dominant direction of the local gradients.</p><p><img src="/images/IMG_2E4DF1ED416A-1.jpg"></p><p><strong>[4] Descriptor for local image region</strong></p><p><img src="/images/kd.png"></p><p>For each detected keypoint, a local image descriptor is computed. It is partially invariant to change in illumination and 3D viewpoint.</p><p>In order to achieve orientation invariance, the coordinates and the gradient orientations are rotated relative to the keypoint orientation. A Gaussian weighting function with Ïƒ equal to one half the width of the descriptor window is used to assign a weight to the magnitude of each sample point.</p><p>Each subregion generates an orientation histogram with 8 orientation bins. Therefore, for each keypoint, if <span class="math inline">\(2\times2\)</span> descriptor is used, a feature vector can be formed with <span class="math inline">\(2\times2\times8 = 32\)</span> elements; if <span class="math inline">\(4\times4\)</span> descriptor is used, there will be <span class="math inline">\(4\times4\times8 = 128\)</span> elements in a feature vector. The <strong>optimal</strong> setting is 4x4 subregions and 8 orientation bins (the above picture).</p><p><strong>Feature matching</strong></p><p><img src="/images/IMG_043BB8EF0160-1.jpg"></p><p>Matlab Implementation</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% num = match(image1, image2)</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"><span class="comment">% This function reads two images, finds their SIFT features, and</span></span><br><span class="line"><span class="comment">%   displays lines connecting the matched keypoints.  A match is accepted</span></span><br><span class="line"><span class="comment">%   only if its distance is less than distRatio times the distance to the</span></span><br><span class="line"><span class="comment">%   second closest match.</span></span><br><span class="line"><span class="comment">% It returns the number of matches displayed.</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"><span class="comment">% Example: match('scene.pgm','book.pgm');</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">num</span> = <span class="title">match</span><span class="params">(image1, image2)</span></span></span><br><span class="line"><span class="comment">% Find SIFT keypoints for each image</span></span><br><span class="line">[im1, des1, loc1] = sift(image1);</span><br><span class="line">[im2, des2, loc2] = sift(image2);</span><br><span class="line"><span class="comment">% For efficiency in Matlab, it is cheaper to compute dot products between</span></span><br><span class="line"><span class="comment">%  unit vectors rather than Euclidean distances.  Note that the ratio of</span></span><br><span class="line"><span class="comment">%  angles (acos of dot products of unit vectors) is a close approximation</span></span><br><span class="line"><span class="comment">%  to the ratio of Euclidean distances for small angles.</span></span><br><span class="line"><span class="comment">%</span></span><br><span class="line"><span class="comment">% distRatio: Only keep matches in which the ratio of vector angles from the</span></span><br><span class="line"><span class="comment">%   nearest to second nearest neighbor is less than distRatio.</span></span><br><span class="line">distRatio = <span class="number">0.6</span>;</span><br><span class="line"><span class="comment">% For each descriptor in the first image, select its match to second image.</span></span><br><span class="line">des2t = des2';</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span> : <span class="built_in">size</span>(des1,<span class="number">1</span>)</span><br><span class="line">    dotprods = des1(<span class="built_in">i</span>,:) * des2t; <span class="comment">% compute orientation of des1[i] and des2[j] for all j</span></span><br><span class="line">    [vals, indx] = <span class="built_in">sort</span>(<span class="built_in">acos</span>(dotprods)); <span class="comment">% Take inverse cosine and sort results</span></span><br><span class="line">    <span class="comment">% Check if nearest neighbor has angle less than distRatio times 2nd.</span></span><br><span class="line">    <span class="keyword">if</span> (vals(<span class="number">1</span>) &lt; distRatio * vals(<span class="number">2</span>))</span><br><span class="line">      match(<span class="built_in">i</span>) = indx(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      match(<span class="built_in">i</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><img src="/images/IMG_DAD55EC9C383-1.jpg"></p><h2><span id="harris-corner-detector">Harris Corner Detector</span></h2><p><strong>Basic Idea</strong></p><p>We should easily recognize the point by looking at intensity values within a small window. hifting the window in any direction should yield a large change in appearance.</p><p><img src="/images/cornersad1.png"></p><p>Harris corner detector gives a mathematical approach for determining which case holds.</p><p>Change of intensity for the shift <span class="math inline">\([u, v]\)</span>: <span class="math display">\[E(u,v)=\sum_{x,y}w(x,y)[I(x+u,y+v)-I(x,y)]\]</span> where <span class="math inline">\(w(x,y)\)</span> is window function.</p><p>For nearly constant patches, this will be near 0. For very distinctive patches, this will be larger. Hence... we want patches where <span class="math inline">\(E(u,v)\)</span> is LARGE.</p><p><img src="/images/harriasequ.png"></p><p>For small shifts <span class="math inline">\([u, v]\)</span>, we have a bilinear approximation: <span class="math display">\[E(u,v)\approx [u,v]M[u,v]^T\]</span> where <span class="math inline">\(M\)</span> is a 2x2 matrix computed from image derivatives: <span class="math display">\[M=\sum_{x,y}w(x,y)\begin{bmatrix}I_x^2      &amp; I_xI_y      \\I_xI_y      &amp; I_y^2\end{bmatrix}\]</span> Treat gradient vectors as a set of <span class="math inline">\((dx,dy)\)</span> points with a center of mass defined as being at <span class="math inline">\((0,0)\)</span>. Fit an ellipse to that set of points via scatter matrix.</p><p><img src="/images/harrianaly.png"></p><p><img src="/images/harrrieclips.png"></p><p>Measure of corner response: <span class="math display">\[R=Det(M)-k(Trace(M))^2\]</span> where <span class="math display">\[Det(M)=\lambda_1\lambda_2\\Trace(M)=\lambda_1+\lambda_2\]</span> According to <span class="math inline">\(R\)</span>, we can detect corner:</p><p><img src="/images/harrieres.png"></p><p><span class="math inline">\(R\)</span> depends only on eigenvalues of <span class="math inline">\(M\)</span>. As we can see from figure above,</p><ul><li><span class="math inline">\(R\)</span> is large for a corner.</li><li><span class="math inline">\(R\)</span> is negative with large magnitude for an edge</li><li><span class="math inline">\(|R|\)</span> is small for a flat region</li></ul><p><strong>Harris Corner Detection Algorithm</strong></p><ol type="1"><li><p>Compute <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> derivatives of image: <span class="math display">\[I_x=G_\sigma^x\ast I\\I_y=G_\sigma^y\ast I\]</span></p></li><li><p>Compute products of derivatives at every pixel: <span class="math display">\[I_x^2=I_x\cdot I_x\\I_y^2=I_y\cdot I_y\\I_{xy}=I_x\cdot I_y\]</span></p></li><li><p>Compute the sums of the products of derrivatives at each pixel: <span class="math display">\[S_x^2=G_\sigma&#39;\ast I_x^2\\S_y^2=G_\sigma&#39;\ast I_y^2\\S_{xy}=G_\sigma&#39;\ast I_{xy}\]</span></p></li><li><p>Define at each pixel <span class="math inline">\((x,y)\)</span> the matrix: <span class="math display">\[M(x,y)=\begin{bmatrix}S_x^2(x,y)      &amp; S_{xy}(x,y)      \\S_{xy}(x,y)     &amp; S_y^2(x,y)\end{bmatrix}\]</span></p></li><li><p>Compute the response of the detector at each pixel: <span class="math display">\[R=Det(M)-k(Trace(M))^2\]</span></p></li><li><p>Threshold of value of <span class="math inline">\(R\)</span>. Compute nonmax suppression.</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HKUST CSIT5401 Recognition System lecture notes 1. è¯†åˆ«ç³»ç»Ÿå¤ä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;!-- toc --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#laplacian-point-detector&quot;&gt;Laplacian Point Detector&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#line-detector&quot;&gt;Line Detector&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#edge-detectors&quot;&gt;Edge Detectors&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#gradient-operator&quot;&gt;Gradient Operator&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#marr-hildreth-edge-detector&quot;&gt;Marr-Hildreth Edge Detector&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#scale-invariant-feature-transform-sift&quot;&gt;Scale Invariant Feature Transform (SIFT)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#harris-corner-detector&quot;&gt;Harris Corner Detector&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;!-- tocstop --&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="http://www.52coding.com.cn/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Recognition System" scheme="http://www.52coding.com.cn/tags/Recognition-System/"/>
    
      <category term="Prewitt" scheme="http://www.52coding.com.cn/tags/Prewitt/"/>
    
      <category term="Sobel" scheme="http://www.52coding.com.cn/tags/Sobel/"/>
    
      <category term="Marr-Hildreth Edge Detector" scheme="http://www.52coding.com.cn/tags/Marr-Hildreth-Edge-Detector/"/>
    
      <category term="SIFT" scheme="http://www.52coding.com.cn/tags/SIFT/"/>
    
  </entry>
  
  <entry>
    <title>RL - Deep Deterministic Policy Gradient (DDPG)</title>
    <link href="http://www.52coding.com.cn/2018/11/30/RL%20-%20Deep%20Deterministic%20Policy%20Gradient/"/>
    <id>http://www.52coding.com.cn/2018/11/30/RL - Deep Deterministic Policy Gradient/</id>
    <published>2018-11-30T05:53:09.000Z</published>
    <updated>2019-04-12T03:26:48.527Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://arxiv.org/abs/1509.02971" target="_blank" rel="noopener">Deep Deterministic Policy Gradient (DDPG)</a> æ˜¯ç”± DeepMind çš„ Lillicrap ç­‰äººäº2015å¹´æå‡ºçš„ç®—æ³•ï¼Œå‘è¡¨åœ¨ICLR 2016ä¸Šã€‚DDPG æ˜¯åŸºäº <a href="http://proceedings.mlr.press/v32/silver14.pdf" target="_blank" rel="noopener">DPG</a> ç®—æ³•çš„æ”¹è¿›ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ Actor-critic å’Œ <a href="https://www.52coding.com.cn/2018/11/16/RL%20-%20DQN%20and%20A3C/">DQN</a> çš„ç»“åˆï¼Œå®ƒåŒæ—¶å­¦ä¹ ä¸€ä¸ª Q-function å’Œä¸€ä¸ªç­–ç•¥ï¼ˆpolicyï¼‰ï¼šç”¨ Q-learning çš„æ–¹æ³•å­¦ä¹  Q-functionï¼Œç„¶åç”¨ Q-function æ›´æ–°ç­–ç•¥ã€‚</p><a id="more"></a><h2><span id="dpg">DPG</span></h2><p><a href="http://proceedings.mlr.press/v32/silver14.pdf" target="_blank" rel="noopener">Deterministic Policy Gradient (DPG)</a> æ˜¯æŠŠç­–ç•¥æ¢¯åº¦ï¼ˆpolicy gradientï¼‰ç®—æ³•æ‰©å±•åˆ°ç¡®å®šæ€§ç­–ç•¥ï¼ˆdeterministic policyï¼‰ä¸Šã€‚äº‹å®ä¸Šï¼ŒDPG è¢«è¯æ˜æ˜¯éšæœºç­–ç•¥æ¢¯åº¦ï¼ˆstochastic policy gradientï¼‰çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p><blockquote><p>éšæœºç­–ç•¥æ¢¯åº¦ï¼š <span class="math display">\[\triangledown_\theta J(\pi_\theta)=\mathbb{E}_{s\sim\rho^\pi, a\sim\pi_\theta}[\triangledown_\theta\log\pi_\theta(a|s)Q^\pi(s,a)]\]</span> å…¶ä¸­ï¼Œ<span class="math inline">\(\pi_\theta\)</span> æ˜¯ç”±å‚æ•°ä¸º <span class="math inline">\(\theta\)</span> çš„å‡½æ•°è¿‘ä¼¼çš„ç­–ç•¥ï¼Œ<span class="math inline">\(\rho^\pi\)</span> ä¸ºç­–ç•¥ <span class="math inline">\(\pi_\theta\)</span> çš„çŠ¶æ€åˆ†å¸ƒï¼ˆstate distributionï¼‰ã€‚</p></blockquote><p>å¤§éƒ¨åˆ† model-free çš„å¢å¼ºå­¦ä¹ ç®—æ³•å±äºæ³›åŒ–çš„<a href="https://www.52coding.com.cn/2017/12/07/RL%20-%20Planning%20by%20Dynamic%20Programming/">ç­–ç•¥è¿­ä»£ï¼ˆpolicy iterationï¼‰</a>ç®—æ³•ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸¤æ­¥ï¼šç­–ç•¥è¯„ä¼°ï¼ˆpolicy evaluationï¼‰ å’Œç­–ç•¥æ”¹è¿›ï¼ˆ policy improvementï¼‰ã€‚ç­–ç•¥è¯„ä¼°é€šå¸¸ä½¿ç”¨ <a href="https://www.52coding.com.cn/2017/12/16/RL%20-%20Model-Free%20Prediction/#monte-carlo-learning">Monte-Carlo evaluation</a> æˆ– <a href="https://www.52coding.com.cn/2017/12/16/RL%20-%20Model-Free%20Prediction/#temporal-difference-learning">temporal difference learning</a> æ¥è¿‘ä¼¼ <span class="math inline">\(Q^\pi(s, a)\)</span>ã€‚ç­–ç•¥æ”¹è¿›åˆ™é€šå¸¸é€šè¿‡æœ€å¤§åŒ–è¯„ä¼°çš„ action-value æ¥å¾—åˆ°ï¼š<span class="math inline">\(\mu^{k+1}(s) = \arg\max_aQ^{\mu^k}(s, a)\)</span>ã€‚</p><p>ç„¶è€Œï¼Œåœ¨è¿ç»­çš„åŠ¨ä½œç©ºé—´ï¼ˆcontinuous action spacesï¼‰é‡Œè¿™ç§æœ€å¤§åŒ–å´æ˜¯ä¸å¯è¡Œçš„ã€‚åœ¨ç¦»æ•£çš„åŠ¨ä½œç©ºé—´é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªactionè®¡ç®—ç›¸åº” Q-value ç„¶åè¿›è¡Œæ¯”è¾ƒï¼›ä½†æ˜¯åœ¨è¿ç»­çš„åŠ¨ä½œç©ºé—´ä¸­ï¼Œæˆ‘ä»¬ä¸å¯èƒ½æŠŠæ¯ä¸ªactionçš„ Q-value éƒ½è®¡ç®—å‡ºæ¥å†æ¯”è¾ƒï¼Œè€Œé€šè¿‡å¯¹ Q-function æ±‚å¯¼æ±‚çš„æ–¹å¼è®¡ç®—æœ€å¤§å€¼å¼€é”€åˆå¾ˆå¤§ã€‚æ‰€ä»¥ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å•ç‹¬ç”¨ä¸€ä¸ªå‡½æ•°è¿‘ä¼¼ç­–ç•¥ï¼Œç„¶å<strong>ç”¨ Q-function çš„æ¢¯åº¦æ¥æ”¹è¿›è¯¥ç­–ç•¥</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºæ¯ä¸ªè®¿é—®è¿‡çš„çŠ¶æ€ <span class="math inline">\(s\)</span>ï¼Œç­–ç•¥å‡½æ•°çš„å‚æ•° <span class="math inline">\(\theta^{k+1}\)</span> æ ¹æ® <span class="math inline">\(\triangledown_\theta Q^{\mu_k}(s, \mu_\theta(s))\)</span> æ¥æ›´æ–°ï¼š <span class="math display">\[\begin{align}\theta^{k+1}&amp;=\theta^k+\alpha\mathbb{E}_{s\sim\rho^{\mu^k}}[\triangledown_\theta Q^{\mu^k}(s, \mu_\theta(s))]\\&amp;= \theta^k + \alpha\mathbb{E}_{s\sim\rho^{\mu^k}}[\triangledown_\theta \mu_\theta(s)\triangledown_aQ^{\mu^k}(s, a)|_{a=\mu_\theta(s)}]\end{align}\]</span></p><p>å¯ä»¥è¯æ˜ï¼Œä¸Šè¿°æ›´æ–°ä¹Ÿå±äºç­–ç•¥æ¢¯åº¦ç®—æ³•ï¼Œè¿™å°±æ˜¯DPGç®—æ³•çš„ç­–ç•¥æ›´æ–°å…¬å¼ã€‚</p><h2><span id="ddpg">DDPG</span></h2><p>DDPGæ”¹è¿›äº† Q-function çš„å­¦ä¹ æ–¹å¼ï¼Œè€Œç­–ç•¥ç«¯çš„æ›´æ–°æ–¹å¼å’ŒDPGç›¸åŒï¼Œå³å¦‚å¼(1)æ‰€ç¤ºã€‚åœ¨ DPG ä¸­ï¼ŒQ-function æ˜¯é€šè¿‡ Q-learning çš„æ–¹å¼æ¥å­¦ä¹ çš„ï¼Œè€Œå½“ä½¿ç”¨ç¥ç»ç½‘ç»œæ¥è¿‘ä¼¼ Q-function çš„æ—¶å€™ä¼šå¯¼è‡´è®­ç»ƒä¸ç¨³å®šï¼ŒDDPG åº”ç”¨äº† <a href="https://www.52coding.com.cn/2018/11/16/RL%20-%20DQN%20and%20A3C/#deep-q-network">DQN</a> ä¸­çš„ä¸¤ä¸ªtrickæ¥è§£å†³ä¸ç¨³å®šçš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯<strong>ç»éªŒæ± ï¼ˆreplay bufferï¼‰</strong>å’Œ<strong>ç›®æ ‡ç½‘ç»œï¼ˆtarget networkï¼‰</strong>ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œç»éªŒæ±  <span class="math inline">\(D\)</span> æ¯æ¬¡æ¢ç´¢éƒ½ä¼šå­˜å‚¨å…ƒç»„ <span class="math inline">\((s, a, r, s&#39;, d)\)</span>ï¼Œå…¶ä¸­ <span class="math inline">\(d\)</span> ä¸ºä¸€ä¸ªå¸ƒå°”å˜é‡ï¼Œå¦‚æœ <code>d == True</code>ï¼Œå°±è¡¨æ˜ <span class="math inline">\(s&#39;\)</span> æ˜¯ç»ˆæ­¢çŠ¶æ€ï¼ˆterminal stateï¼‰ã€‚ æ¯æ¬¡æ›´æ–°æ—¶éƒ½ä¼šä»ç»éªŒæ± éšæœºé‡‡æ ·ä¸€æ‰¹æ•°æ®è¿›è¡Œæ›´æ–°ã€‚ç»éªŒæ± çš„å¤§å°æ˜¯ä¸€ä¸ªéœ€è¦å¾®è°ƒçš„è¶…å‚æ•°ï¼šå¦‚æœç»éªŒæ± è¿‡å°çš„è¯ï¼Œä¼šå¯¼è‡´å¯¹æ± å†…æ•°æ®è¿‡æ‹Ÿåˆï¼›å¦‚æœç»éªŒæ± å­˜å‚¨æ‰€æœ‰æ•°æ®çš„è¯ï¼Œåˆä¼šæ”¾æ…¢å­¦ä¹ çš„é€Ÿåº¦ã€‚</p><p>ç›®æ ‡ç½‘ç»œæ˜¯æŒ‡ç”¨å•ç‹¬çš„ç½‘ç»œå‚æ•°æ¥ç”Ÿæˆç›®æ ‡ï¼ˆq-targetï¼‰ï¼Œè®¾ç­–ç•¥å‡½æ•°çš„å‚æ•°ä¸º <span class="math inline">\(\theta\)</span>ï¼ŒQ-function çš„å‚æ•°ä¸º <span class="math inline">\(\phi\)</span>ï¼Œåˆ™å¯¹åº”çš„ç›®æ ‡ç½‘ç»œå‚æ•°ä¸º <span class="math inline">\(\theta_{tag}\)</span> å’Œ <span class="math inline">\(\phi_{tag}\)</span>ï¼Œç”Ÿæˆçš„ç›®æ ‡ä¸ºï¼š <span class="math display">\[r + \gamma(1-d)Q_{\phi_{tag}}(s&#39;, \mu_{\theta_{tag}}(s&#39;))\]</span> æ‰€ä»¥ Q-value ç«¯çš„æ›´æ–°å…¬å¼ä¸ºï¼š <span class="math display">\[\triangledown_\phi \mathbb{E}_{s,a,r,s&#39;,d\sim D}\left[\left(Q(s,a)-(r + \gamma(1-d)Q_{\phi_{tag}}(s&#39;, \mu_{\theta_{tag}}(s&#39;)))\right)^2\right]\]</span> ä¸DQNä¸åŒçš„æ˜¯ï¼ŒDDPGä¸­çš„ç›®æ ‡ç½‘ç»œä½¿ç”¨â€œè½¯æ›´æ–°â€çš„æ–¹å¼ï¼Œå³ç›®æ ‡ç½‘ç»œå¹¶ä¸æ˜¯éš”ä¸€å®šæ—¶é—´åä¸ä¸»ç½‘ç»œåŒæ­¥ï¼Œè€Œæ˜¯æœç€ä¸»ç½‘ç»œç¼“æ…¢ç§»åŠ¨ï¼š <span class="math display">\[\theta_{tag}\leftarrow\tau\theta+(1-\tau)\theta_{tag}\\\phi_{tag}\leftarrow\tau\phi+(1-\tau)\phi_{tag}\]</span> å…¶ä¸­ï¼Œ<span class="math inline">\(\tau \in (0, 1)\)</span> æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œé€šå¸¸å–å€¼æ¥è¿‘ 1ã€‚</p><p>ä¸ºäº†å¢åŠ æ¢ç´¢èƒ½åŠ›ï¼Œè®­ç»ƒæ—¶åœ¨é€‰æ‹©æ¯ä¸ªåŠ¨ä½œçš„æ—¶å€™éƒ½ä¼šåŠ ä¸Šéšæœºå™ªå£° <span class="math inline">\(\mathcal{N}\)</span>ï¼Œè®ºæ–‡ä½œè€…å»ºè®®ä½¿ç”¨æ—¶é—´ç›¸å…³çš„ <a href="https://en.wikipedia.org/wiki/Ornstein%E2%80%93Uhlenbeck_process" target="_blank" rel="noopener">OUå™ªå£°</a>ï¼Œä½†æ˜¯æœ€è¿‘çš„ç ”ç©¶ç»“æœè¡¨æ˜ä½¿ç”¨ä¸ç›¸å…³çš„ã€zero-meançš„é«˜æ–¯å™ªå£°æ•ˆæœä¼šæ›´å¥½ã€‚åŒæ—¶ä¸ºäº†å–å¾—æ›´é«˜è´¨é‡çš„è®­ç»ƒæ•°æ®ï¼Œå™ªå£°å¯ä»¥éšç€è®­ç»ƒè¿‡ç¨‹é€æ­¥å‡å°ã€‚å¦å¤–ï¼Œåœ¨è¯„æµ‹æ—¶åº”å»æ‰å™ªå£°ã€‚</p><p><strong>DDPGç®—æ³•</strong></p><p><img src="/images/ddpg_algo.svg"></p><h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p><strong>ç‰¹ç‚¹</strong></p><ul><li>off-policyç®—æ³•</li><li>åªèƒ½ç”¨äºè¿ç»­çš„åŠ¨ä½œç©ºé—´</li><li>å¯ä»¥çœ‹ä½œæ˜¯æŠŠDQNåº”ç”¨åˆ°è¿ç»­åŠ¨ä½œç©ºé—´</li></ul><h2><span id="references">References</span></h2><p>[1] http://proceedings.mlr.press/v32/silver14.pdf</p><p>[2] https://arxiv.org/abs/1509.02971</p><p>[3] https://spinningup.openai.com/en/latest/algorithms/ddpg.html</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://arxiv.org/abs/1509.02971&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Deep Deterministic Policy Gradient (DDPG)&lt;/a&gt; æ˜¯ç”± DeepMind çš„ Lillicrap ç­‰äººäº2015å¹´æå‡ºçš„ç®—æ³•ï¼Œå‘è¡¨åœ¨ICLR 2016ä¸Šã€‚DDPG æ˜¯åŸºäº &lt;a href=&quot;http://proceedings.mlr.press/v32/silver14.pdf&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;DPG&lt;/a&gt; ç®—æ³•çš„æ”¹è¿›ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ Actor-critic å’Œ &lt;a href=&quot;https://www.52coding.com.cn/2018/11/16/RL%20-%20DQN%20and%20A3C/&quot;&gt;DQN&lt;/a&gt; çš„ç»“åˆï¼Œå®ƒåŒæ—¶å­¦ä¹ ä¸€ä¸ª Q-function å’Œä¸€ä¸ªç­–ç•¥ï¼ˆpolicyï¼‰ï¼šç”¨ Q-learning çš„æ–¹æ³•å­¦ä¹  Q-functionï¼Œç„¶åç”¨ Q-function æ›´æ–°ç­–ç•¥ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="Reinforcement Learning" scheme="http://www.52coding.com.cn/tags/Reinforcement-Learning/"/>
    
      <category term="å¢å¼ºå­¦ä¹ " scheme="http://www.52coding.com.cn/tags/%E5%A2%9E%E5%BC%BA%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Policy Gradient" scheme="http://www.52coding.com.cn/tags/Policy-Gradient/"/>
    
      <category term="DPG" scheme="http://www.52coding.com.cn/tags/DPG/"/>
    
      <category term="DDPG" scheme="http://www.52coding.com.cn/tags/DDPG/"/>
    
      <category term="DQN" scheme="http://www.52coding.com.cn/tags/DQN/"/>
    
  </entry>
  
  <entry>
    <title>RL - Proximal Policy Optimization (PPO)</title>
    <link href="http://www.52coding.com.cn/2018/11/25/RL%20-%20PPO/"/>
    <id>http://www.52coding.com.cn/2018/11/25/RL - PPO/</id>
    <published>2018-11-25T14:00:09.000Z</published>
    <updated>2019-04-12T03:27:35.929Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://arxiv.org/abs/1707.06347" target="_blank" rel="noopener">Proximal Policy Optimization (PPO, PPO-Clip, PPO-Penalty)</a> æ˜¯ç”±<a href="https://www.52coding.com.cn/2018/11/22/RL%20-%20TRPO/">TRPO</a>çš„ä½œè€…Schulmanç­‰äººäº2017å¹´æå‡ºçš„ç­–ç•¥æ¢¯åº¦ç±»ç®—æ³•ã€‚PPOç®—æ³•çš„æ€è·¯å’ŒTRPOä¸€è‡´ï¼Œéƒ½æ˜¯æƒ³åœ¨ä¼˜åŒ–æ—¶é‡‡å–å°½å¯èƒ½å¤§çš„æ­¥å¹…ä½†åˆä¸èƒ½å¤ªå¤§ä»¥è‡³äºäº§ç”Ÿå´©åã€‚ç›¸æ¯”äºæ¯”TRPOï¼ŒPPOå®ç°èµ·æ¥æ›´ç®€å•ï¼Œæ³›åŒ–èƒ½åŠ›æ›´å¼ºï¼Œå¯ä»¥ä½¿ç”¨éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰è¿›è¡Œä¼˜åŒ–ã€‚</p><a id="more"></a><h2><span id="èƒŒæ™¯">èƒŒæ™¯</span></h2><p>PPOçš„èƒŒæ™¯ä¸<a href="https://www.52coding.com.cn/2018/11/22/RL%20-%20TRPO/#èƒŒæ™¯">TRPOçš„èƒŒæ™¯</a>ä¸€è‡´ï¼Œæœ€ç»ˆTRPOæ¨å¯¼å‡ºå¦‚ä¸‹çš„å¸¦çº¦æŸä¼˜åŒ–é—®é¢˜ï¼š <span class="math display">\[\max_{\theta}\mathbb{E}_t[\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{old}}(a_t|s_t)}A_t]\\\text{subject to }\mathbb{E}_t[\text{KL}[\pi_{\theta_{old}}(\cdot|s_t), \pi_\theta(\cdot|s_t)]]\]</span> ä»¤ <span class="math inline">\(r_t(\theta) = \frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{old}}(a_t|s_t)}\)</span> ä¸ºæ–°æ—§ç­–ç•¥çš„æ¦‚ç‡æ¯”ï¼ˆæ˜“çŸ¥ <span class="math inline">\(r_t(\theta_{old}) = 1\)</span>ï¼‰ã€‚TRPOæœ€å¤§åŒ–çš„æ›¿ä»£ç›®æ ‡ï¼ˆsurrogate objectiveï¼‰å¯ä»¥å†™ä¸ºå¦‚ä¸‹å½¢å¼ï¼š <span class="math display">\[L^{CPI}(\theta)=\mathbb{E}_t[\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{old}}(a_t|s_t)}A_t]=\mathbb{E}_t[r_t(\theta)A_t]\]</span> å¦‚æœä¸åŠ çº¦æŸçš„è¯ï¼Œç›´æ¥ä¼˜åŒ–è¯¥ç›®æ ‡ä¼šäº§ç”Ÿå·¨å¤§çš„æ›´æ–°ï¼Œå¯¼è‡´æ›´æ–°ä¸ç¨³å®šç”šè‡³å´©æºƒã€‚æ‰€ä»¥éœ€è¦è€ƒè™‘ä¸€ç§æƒ©ç½šæ–¹æ³•ï¼Œä½¿ <span class="math inline">\(r_t(\theta)\)</span> æ¥è¿‘ <span class="math inline">\(1\)</span>ã€‚</p><h2><span id="ppo-clip">PPO-Clip</span></h2><p>PPO-Clipçš„ç›®æ ‡å‡½æ•°ä¸ºï¼š <span class="math display">\[L^{CLIP}(\theta)=\mathbb{E}_t[\min(r_t(\theta)A_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon)A_t)]\]</span> å…¶ä¸­ <span class="math inline">\(\epsilon\)</span> ä¸ºè¶…å‚æ•°æ§åˆ¶æˆªæ–­ç‡ï¼Œå–å€¼é€šå¸¸æ¯”è¾ƒå°ï¼ˆ0.2å·¦å³ï¼‰ã€‚</p><p>ä¸Šè¿°ç›®æ ‡å‡½æ•°çš„ç¬¬ä¸€é¡¹ä¸ <span class="math inline">\(L^{CPI}\)</span> ä¸€è‡´ï¼Œç¬¬äºŒé¡¹åˆ™æ˜¯ä¸ºäº†é™åˆ¶æ›´æ–°å¹…åº¦ï¼ˆæ–½åŠ æƒ©ç½šï¼‰ï¼Œæ§åˆ¶ <span class="math inline">\(r_t(\theta) \in [1-\epsilon, 1+\epsilon]\)</span>ã€‚å¯è§ <span class="math inline">\(L^{CLIP}(\theta)\)</span> æ˜¯ <span class="math inline">\(L^{CPI}(\theta)\)</span> çš„ä¸€ä¸ªä¸‹ç•Œã€‚</p><p><img src="/images/lclip.png"></p><p>ä¸Šå›¾æ˜¾ç¤ºäº† <span class="math inline">\(\text{clip}\)</span> å‡½æ•°çš„å·¥ä½œæ–¹å¼ï¼š</p><ul><li>å½“ <span class="math inline">\(A &gt; 0\)</span> æ—¶ï¼Œå¦‚æœæƒ³ä½¿ç›®æ ‡å‡½æ•°å–å¾—æ›´å¤§çš„å€¼ï¼Œå°±éœ€è¦å¢å¤§ <span class="math inline">\(\pi_\theta(a_t|s_t)\)</span> çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å¢å¤§ <span class="math inline">\(r_t(\theta)\)</span> ã€‚ä½†æ˜¯å¼ä¸­çš„ <span class="math inline">\(\min\)</span> å‡½æ•°é™åˆ¶äº† <span class="math inline">\(r_t(\theta)\)</span> æœ€å¤§å–åˆ° <span class="math inline">\(1+\epsilon\)</span>ï¼Œæ‰€ä»¥æ–°ç­–ç•¥å†è¿œç¦»æ—§ç­–ç•¥ï¼ˆ<span class="math inline">\(r_t(\theta)\)</span> ç»§ç»­å¢å¤§ï¼‰å¹¶ä¸ä¼šå¸¦æ¥æ›´å¤šåœ°å¥½å¤„ã€‚</li><li>å½“ <span class="math inline">\(A &lt; 0\)</span> æ—¶ï¼Œå¦‚æœæƒ³ä½¿ç›®æ ‡å‡½æ•°å–å¾—æ›´å¤§çš„å€¼ï¼Œå°±éœ€è¦å‡å° <span class="math inline">\(\pi_\theta(a_t|s_t)\)</span> çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å‡å° <span class="math inline">\(r_t(\theta)\)</span> ã€‚ä½†æ˜¯å¼ä¸­çš„ <span class="math inline">\(\min\)</span> å‡½æ•°é™åˆ¶äº† <span class="math inline">\(r_t(\theta)\)</span> æœ€å°å–åˆ° <span class="math inline">\(1-\epsilon\)</span>ï¼Œæ‰€ä»¥æ–°ç­–ç•¥å†è¿œç¦»æ—§ç­–ç•¥ï¼ˆ<span class="math inline">\(r_t(\theta)\)</span> ç»§ç»­å‡å°ï¼‰å¹¶ä¸ä¼šå¸¦æ¥æ›´å¤šåœ°å¥½å¤„ã€‚</li></ul><p>åœ¨å®ç°ä¸­ï¼Œç›®æ ‡å‡½æ•°é€šå¸¸ä½¿ç”¨æ›´ç®€å•çš„å½¢å¼ï¼š <span class="math display">\[L^{CLIP}(s, a, \theta_k, \theta)=\min(\frac{\pi_\theta(a|s)}{\pi_{\theta_{k}}(a|s)}A^{\pi_{\theta_k}}(s, a), g(\epsilon, A^{\pi_{\theta_k}}(s, a)))\]</span> å…¶ä¸­ï¼Œ <span class="math display">\[g(\epsilon, A^{\pi_{\theta_k}}(s, a))=\begin{cases} (1+\epsilon)A,  &amp; \mbox{if }A â‰¥0 \\(1-\epsilon)A, &amp; \mbox{if }A&lt;0\end{cases}\]</span></p><blockquote><p>æ³¨ï¼šå³ä¾¿å¯¹ <span class="math inline">\(r_t(\theta)\)</span> åŠ ä¸Šæˆªæ–­ï¼Œæ–°ç­–ç•¥ä»æŸ“æœ‰å¯èƒ½åç¦»æ—§ç­–ç•¥å¾ˆè¿œï¼Œä¸è¿‡æœ‰å¾ˆå¤štrickæ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚å…¶ä¸­ä¸€ä¸ªç‰¹åˆ«ç®€å•çš„å¤„ç†æ–¹å¼å°±æ˜¯ï¼šå¦‚æœæ–°ç­–ç•¥å’Œæ—§ç­–ç•¥çš„å¹³å‡KLè·ç¦»å¤§äºæŸä¸ªé˜ˆå€¼ï¼Œåˆ™åœæ­¢è¿›è¡Œæ›´æ–°ï¼ˆ<strong>early stopping</strong>ï¼‰ã€‚</p></blockquote><p>ç›¸æ¯”äºTRPOï¼Œç”±äºæ²¡æœ‰äº†KLçº¦æŸï¼ŒPPOå¯ä»¥ç”¨SGDæ¥è¿›è¡Œä¼˜åŒ–ï¼Œå®ç°ç®€å•å¾ˆå¤šã€‚</p><p><strong>PPO-Clipç®—æ³•</strong></p><p><img src="/images/ppo_algo.svg"></p><h2><span id="ppo-penalty">PPO-Penalty</span></h2><p>è¿™ç§æ–¹æ³•ä½¿ç”¨KLè·ç¦»ä½œä¸ºæƒ©ç½šé¡¹ï¼Œå…³é”®åœ¨äºæ±‚å‡ºèƒ½å¤Ÿè‡ªé€‚åº”å¤šç§ä»»åŠ¡çš„æƒ©ç½šå› å­ <span class="math inline">\(\beta\)</span>ã€‚ç®—æ³•çš„é€»è¾‘ä¸ºï¼Œåœ¨æ¯æ¬¡ç­–ç•¥è¿›è¡Œæ›´æ–°æ—¶ï¼š</p><ul><li><p>ä½¿ç”¨SGDä¼˜åŒ–ç›®æ ‡å‡½æ•°ï¼š <span class="math display">\[L^{KLPEN}(\theta)=\mathbb{E}_t\left[\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{old}}(a_t|s_t)}A_t-\beta\cdot\text{KL}[\pi_{old}(a_t|s_t), \pi_\theta(a_t|s_t)]\right]\]</span></p></li><li><p>è®¡ç®— <span class="math inline">\(d = \mathbb{E}\left[\text{KL}[\pi_{\theta_{old}}(\cdot|s_t), \pi_\theta(\cdot|s_t)]\right]\)</span></p><ul><li>å¦‚æœ <span class="math inline">\(d &lt; d_{targ}/1.5\)</span>ï¼Œåˆ™ <span class="math inline">\(\beta \leftarrow \beta/2\)</span></li><li>å¦‚æœ <span class="math inline">\(d &gt; d_{targ} \times 1.5\)</span>ï¼Œåˆ™ <span class="math inline">\(\beta \leftarrow\beta \times 2\)</span></li></ul><p>å…¶ä¸­ï¼Œ<span class="math inline">\(d_{targ}\)</span> ä¸ºè¶…å‚æ•°ã€‚</p></li></ul><blockquote><p>æ³¨ï¼šPPO-Penalty æ²¡æœ‰ PPO-Clip æ•ˆæœå¥½ã€‚</p></blockquote><h2><span id="å®éªŒå’Œæ€»ç»“">å®éªŒå’Œæ€»ç»“</span></h2><p><strong>ç‰¹ç‚¹</strong></p><ul><li>è®­ç»ƒç¨³å®š</li><li>é€šè¿‡é™åˆ¶ <span class="math inline">\(r_t(\theta)\)</span> æ¥æ‰¾åˆ°å°½å¯èƒ½å¤§çš„å¹¶ä¸”åˆç†çš„æ­¥é•¿</li><li>on-policy ç®—æ³•</li><li>å¯ç”¨äºç¦»æ•£å’Œè¿ç»­çš„åŠ¨ä½œç©ºé—´</li><li>ç›¸æ¯”äºTRPOï¼ŒPPOå®ç°ç®€å•ï¼Œæ•ˆæœæ›´å¥½</li></ul><p><strong>å®éªŒæ€§èƒ½</strong></p><p>åœ¨å¤§éƒ¨åˆ† MuJoCo ç¯å¢ƒä¸­å¼ºäºå…¶ä»–ç­–ç•¥æ¢¯åº¦ç±»ç®—æ³•ï¼Œåœ¨Atariç¯å¢ƒä¸­ï¼Œè¡¨ç°ä»…æ¬¡äºACERï¼Œä½†æ˜¯å­¦ä¹ é€Ÿåº¦ä¼˜äºACERã€‚</p><p><img src="/images/ppo_mujoco.png"></p><p><img src="/images/ppo_atari.png"></p><h3><span id="ä»£ç ">ä»£ç </span></h3><p>è‡ªå·±ä¹Ÿå®ç°äº†ä¸€ä¸‹PPO-Clipç®—æ³•ï¼Œä»£ç åœ¨<a href="https://github.com/NeymarL/Pacman-RL/blob/master/src/ppo.py" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†åœ¨ OpenAI <a href="https://gym.openai.com/" target="_blank" rel="noopener">Gym</a> ä¸Šçš„ <code>MsPacman-ram-v0</code> ç¯å¢ƒä¸Šçš„æµ‹è¯•ç»“æœï¼š</p><p><img src="/images/ppo_pacman.png"></p><p><img src="/images/sample1.gif"></p><p><img src="/images/sample2.gif"></p><h2><span id="references">References</span></h2><p>[1] https://arxiv.org/abs/1707.06347</p><p>[2] https://spinningup.openai.com/en/latest/algorithms/ppo.html</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://arxiv.org/abs/1707.06347&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Proximal Policy Optimization (PPO, PPO-Clip, PPO-Penalty)&lt;/a&gt; æ˜¯ç”±&lt;a href=&quot;https://www.52coding.com.cn/2018/11/22/RL%20-%20TRPO/&quot;&gt;TRPO&lt;/a&gt;çš„ä½œè€…Schulmanç­‰äººäº2017å¹´æå‡ºçš„ç­–ç•¥æ¢¯åº¦ç±»ç®—æ³•ã€‚PPOç®—æ³•çš„æ€è·¯å’ŒTRPOä¸€è‡´ï¼Œéƒ½æ˜¯æƒ³åœ¨ä¼˜åŒ–æ—¶é‡‡å–å°½å¯èƒ½å¤§çš„æ­¥å¹…ä½†åˆä¸èƒ½å¤ªå¤§ä»¥è‡³äºäº§ç”Ÿå´©åã€‚ç›¸æ¯”äºæ¯”TRPOï¼ŒPPOå®ç°èµ·æ¥æ›´ç®€å•ï¼Œæ³›åŒ–èƒ½åŠ›æ›´å¼ºï¼Œå¯ä»¥ä½¿ç”¨éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰è¿›è¡Œä¼˜åŒ–ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="Reinforcement Learning" scheme="http://www.52coding.com.cn/tags/Reinforcement-Learning/"/>
    
      <category term="å¢å¼ºå­¦ä¹ " scheme="http://www.52coding.com.cn/tags/%E5%A2%9E%E5%BC%BA%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Policy Gradient" scheme="http://www.52coding.com.cn/tags/Policy-Gradient/"/>
    
      <category term="PPO" scheme="http://www.52coding.com.cn/tags/PPO/"/>
    
  </entry>
  
  <entry>
    <title>RL - Trust Region Policy Optimization (TRPO)</title>
    <link href="http://www.52coding.com.cn/2018/11/22/RL%20-%20TRPO/"/>
    <id>http://www.52coding.com.cn/2018/11/22/RL - TRPO/</id>
    <published>2018-11-22T09:10:09.000Z</published>
    <updated>2019-04-12T03:27:40.560Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://arxiv.org/abs/1502.05477" target="_blank" rel="noopener">Trust Region Policy Optimization (TRPO)</a>ç®—æ³•æ˜¯ç”±ä¼¯å…‹åˆ©å¤§å­¦çš„Schulmanç­‰äººäº2015å¹´æå‡ºçš„ç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradientsï¼‰ç®—æ³•ã€‚TRPOé€šè¿‡æœ€å¤§åŒ–æ–°ç­–ç•¥ç›¸å¯¹äºå½“å‰ç­–ç•¥çš„ä¼˜åŠ¿æ¥ä¿è¯æ¯æ¬¡æ›´æ–°éƒ½æ˜¯å•è°ƒé€’å¢çš„ï¼ˆç¨³å®šï¼‰ï¼ŒåŒæ—¶æ‰¾åˆ°å°½å¯èƒ½å¤§çš„æ›´æ–°æ­¥å¹…ã€‚ç®—æ³•æ¨å¯¼å‡ºçš„æœ€ç»ˆç»“æœæ˜¯åœ¨KLçº¦æŸä¸‹æœ€å¤§åŒ–æ›¿ä»£ä¼˜åŠ¿å‡½æ•°ã€‚</p><a id="more"></a><h2><span id="èƒŒæ™¯">èƒŒæ™¯</span></h2><p>è€ƒè™‘ç»å…¸çš„ MDP<span class="math inline">\(&lt;S, A, P, r, \rho_0, \gamma&gt;\)</span>ï¼Œå…¶ä¸­ <span class="math inline">\(S\)</span> æ˜¯æ‰€æœ‰çŠ¶æ€ï¼ˆstateï¼‰çš„é›†åˆï¼Œ<span class="math inline">\(A\)</span> æ˜¯æ‰€æœ‰åŠ¨ä½œï¼ˆactionï¼‰çš„é›†åˆï¼Œ<span class="math inline">\(P: S\times A\times S \rightarrow \mathbb{R}\)</span> æ˜¯è½¬ç§»æ¦‚ç‡åˆ†å¸ƒï¼Œ<span class="math inline">\(r\)</span> æ˜¯å¥–åŠ±ï¼ˆrewardï¼‰å‡½æ•°ï¼Œ<span class="math inline">\(\rho_0\)</span> æ˜¯åˆå§‹çŠ¶æ€ï¼ˆ<span class="math inline">\(s_0\)</span>ï¼‰åˆ†å¸ƒï¼Œ<span class="math inline">\(\gamma\)</span> æ˜¯æŠ˜æ‰£å› å­ï¼ˆ discount factorï¼‰ã€‚</p><p>å®šä¹‰ <span class="math inline">\(\pi\)</span> ä¸ºä¸€ä¸ªéšæœºç­–ç•¥ï¼š<span class="math inline">\(\pi: S\times A\rightarrow [0, 1]\)</span>ï¼Œå®šä¹‰ <span class="math inline">\(\eta(\pi)\)</span> æ¥è¡¡é‡ç­–ç•¥ <span class="math inline">\(\pi\)</span> çš„å¥½åï¼š <span class="math display">\[\eta(\pi)=\mathbb{E}_{s_0, a_0, ...\sim\pi}[\sum_{t=0}^\infty\gamma^tr(s_t)]\]</span> æ¥ç€å®šä¹‰ state-action value function <span class="math inline">\(Q_\pi\)</span>, value function <span class="math inline">\(V_\pi\)</span>, ä¼˜åŠ¿å‡½æ•°ï¼ˆadvantage functionï¼‰<span class="math inline">\(A_\pi\)</span>: <span class="math display">\[Q_\pi(s_t, a_t) = \mathbb{E}_{s_{t+1}, a_{t+1}, ...\sim\pi}[\sum_{l=0}^\infty\gamma^lr_{s_{t+l}}]\]</span></p><p><span class="math display">\[V_\pi(s_t) =\mathbb{E}_{a_t, s_{t+1}, ...\sim\pi}[\sum_{l=0}^\infty\gamma^lr_{s_{t+l}}]\]</span></p><p><span class="math display">\[A_\pi(s, a) = Q_\pi(s, a) - V_\pi(s)\]</span></p><p>ç„¶åå¯ä»¥é€šè¿‡ä¸‹å¼æ¥è¡¡é‡ç­–ç•¥ <span class="math inline">\(\tilde{\pi}\)</span> ç›¸å¯¹äºç­–ç•¥ <span class="math inline">\(\pi\)</span> çš„ä¼˜åŠ¿ï¼ˆè¯æ˜è¯¦è§è®ºæ–‡ï¼‰ï¼š <span class="math display">\[\begin{align}\eta(\tilde{\pi})&amp;=\eta(\pi)+\mathbb{E}_{s_0, a_0, ...\sim\color{red}{\tilde{\pi}}}[\sum_{t=0}^\infty\gamma^tA_\pi(s_t,a_t)]\\&amp;= \eta(\pi)+\sum_s\color{red}{\rho_\tilde{\pi}(s)}\sum_a\tilde{\pi}(a|s)A_\pi(s, a)\end{align}\]</span> å…¶ä¸­ <span class="math inline">\(\rho_\pi\)</span> ä¸ºç­–ç•¥ <span class="math inline">\(\pi\)</span> çš„æŠ˜æ‰£è®¿é—®é¢‘ç‡ï¼ˆdiscounted visitation frequencyï¼‰ï¼š <span class="math display">\[\rho_\pi(s) = P(s_0=s)+\gamma P(s_1=s) + \gamma^2 P(s_2=s)+...\]</span> é€šè¿‡ä¸Šå¼å¯çŸ¥ï¼Œåªè¦æ¯ä¸ªçŠ¶æ€ <span class="math inline">\(s\)</span> çš„æœŸæœ›ä¼˜åŠ¿éè´Ÿï¼Œå³ <span class="math inline">\(\sum_a\tilde{\pi}(a|s)A_\pi(s, a)&gt;0\)</span>ï¼Œå°±å¯ä»¥ä¿è¯æ›´æ–°æ˜¯å•è°ƒéé€’å‡çš„ï¼Œè¿™å…¶å®å°±æ˜¯ç»å…¸çš„<a href="https://www.52coding.com.cn/2017/12/07/RL%20-%20Planning%20by%20Dynamic%20Programming/">ç­–ç•¥è¿­ä»£ï¼ˆpolicy iterationï¼‰</a>çš„æ›´æ–°æ–¹å¼ã€‚ç„¶è€Œï¼Œç”±äº <span class="math inline">\(\rho_\tilde{\pi}(s)\)</span> çš„å­˜åœ¨ï¼Œå¯¼è‡´ç›´æ¥ä¼˜åŒ–ä¸Šå¼å¾ˆå›°éš¾ï¼Œæ‰€ä»¥å¼•å…¥ä¸€ä¸ª<strong>æ›¿ä»£ä¼˜åŠ¿</strong>ï¼ˆsurrogate advantageï¼‰ï¼š <span class="math display">\[\begin{align}L_\pi(\tilde{\pi})&amp;=\eta(\pi)+\sum_s\color{red}{\rho_\pi(s)}\sum_a\tilde{\pi}(a|s)A_\pi(s, a)\\\end{align}\]</span> ç»è¿‡ä¸€ç³»åˆ—æ¨å¯¼ï¼Œå¯ä»¥å¾—åˆ°ç­–ç•¥ <span class="math inline">\(\tilde{\pi}\)</span> çš„ä¼˜åŠ¿ä¸‹ç•Œï¼š <span class="math display">\[\eta(\tilde{\pi})â‰¥L_\pi(\tilde{\pi})-C\cdot D_{KL}^\max(\pi, \tilde{\pi})\]</span> å…¶ä¸­ï¼Œ<span class="math inline">\(C=\frac{4\epsilon\gamma}{(1-\gamma)^2}\)</span>ï¼Œ<span class="math inline">\(D_{KL}^\max\)</span> æ˜¯æœ€å¤§çš„KLæ•£åº¦ã€‚</p><p>è¿™é‡Œç›¸å½“äºå¯¹ä¼˜åŒ–ç›®æ ‡ <span class="math inline">\(L_\pi(\tilde{\pi})\)</span> è¿›è¡Œäº†æƒ©ç½šï¼Œæƒ©ç½šå› å­ä¸º <span class="math inline">\(C\)</span>ï¼Œæƒ©ç½šé¡¹ä¸ºKLæ•£åº¦ï¼Œç›®çš„æ˜¯é™åˆ¶æ–°æ—§ç­–ç•¥çš„å·®è·ã€‚é€šè¿‡æœ€å¤§åŒ–ä¸Šè¿°å…¬å¼ï¼Œå°±èƒ½æœ€å¤§åŒ–æ–°ç­–ç•¥ <span class="math inline">\(\tilde{\pi}\)</span> æ‰€å¾—åˆ°çš„å¥–åŠ±ï¼ŒåŒæ—¶åˆä¸ä¼šç¦»æ—§ç­–ç•¥ <span class="math inline">\(\pi\)</span> å¤ªè¿œï¼ˆå¯¼è‡´å¯¹å½“å‰æ•°æ®è¿‡æ‹Ÿåˆï¼‰ï¼Œç®—æ³•å¦‚ä¸‹ï¼š</p><p><img src="/images/IMG_1925FD469BD9-1.jpeg"></p><h2><span id="trpo">TRPO</span></h2><p>ç”±äºDeep RLéƒ½æ˜¯ä½¿ç”¨å‚æ•°ä¸º <span class="math inline">\(\theta\)</span> çš„ç¥ç»ç½‘ç»œæ¥æ‹Ÿåˆç­–ç•¥ <span class="math inline">\(\pi_\theta\)</span>ï¼Œä¸ºäº†ä½¿å…¬å¼æ›´ç®€æ´ï¼ŒæŠŠç®—æ³•1ä¸­å…¬å¼çš„ <span class="math inline">\(\pi\)</span> æ›¿æ¢æˆ <span class="math inline">\(\theta\)</span>: <span class="math display">\[\theta = \arg\max_{\theta}[L(\theta_{old}, \theta)-C\cdot D_{KL}^\max(\theta_{old}|| \theta)]\]</span> å…¶ä¸­ï¼Œ <span class="math display">\[\begin{align}L(\theta_{old}, \theta) &amp;= \sum_s\rho_{\theta_{old}}(s)\sum_a\pi_\theta(a|s)A_{\theta_{old}}(s,a) \\&amp;= \mathbb{E}_{s,a\sim\pi_{\theta_{old}}}[\frac{\pi_\theta(a|s)}{\pi_{\theta_{old}}(a|s)}A_{\theta_{old}}(s,a)]\end{align}\]</span> TRPOæ˜¯ç®—æ³•1çš„è¿‘ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼šTRPOæ²¡æœ‰ä½¿ç”¨æƒ©ç½šé¡¹ <span class="math inline">\(C\)</span>ï¼Œè€Œæ˜¯ä½¿ç”¨ KLæ•£åº¦çº¦æŸï¼ˆi.e. trust region constraintï¼‰ï¼š <span class="math display">\[\theta = \arg\max_\theta L(\theta_{old}, \theta)\\\text{ s.t. }\bar{D}_{KL}(\theta||\theta_{old})â‰¤\delta\]</span> å…¶ä¸­ï¼Œ<span class="math inline">\(\bar{D}_{KL}\)</span> æ˜¯å¹³å‡KLæ•£åº¦ï¼š <span class="math display">\[\bar{D}_{KL}(\theta||\theta_{old})=\mathbb{E}_{s\sim\pi_{\theta_{old}}}[D_{KL}(\pi_{\theta}(\cdot|s)||\pi_{\theta_{old}}(\cdot|s))]\]</span> ç„¶è€Œä¸Šé¢çš„å¸¦çº¦æŸä¼˜åŒ–ä¹Ÿå¹¶éå®¹æ˜“ï¼Œæ‰€ä»¥TRPOå¯¹ä¸Šå¼è¿›è¡Œäº†ä¸€äº›è¿‘ä¼¼ï¼Œå¯¹ç›®æ ‡å‡½æ•°å’Œçº¦æŸè¿›è¡Œæ³°å‹’å±•å¼€å¯ä»¥å¾—åˆ°ï¼š <span class="math display">\[L(\theta_{old}, \theta) \approx g^T(\theta-\theta_{old})\]</span></p><p><span class="math display">\[\bar{D}_{KL}(\theta||\theta_{old})\approx \frac{1}{2}(\theta-\theta_{old})^TH(\theta-\theta_{old})\]</span></p><p>å…¶ä¸­ï¼Œ<span class="math inline">\(g\)</span> æ˜¯æ›¿ä»£å‡½æ•°çš„æ¢¯åº¦åœ¨ <span class="math inline">\(\theta=\theta_{old}\)</span> å¤„çš„å€¼ï¼Œå‡‘å·§çš„æ˜¯ï¼Œå®ƒå’Œç­–ç•¥æ¢¯åº¦çš„å€¼æ­£å¥½ç›¸ç­‰ï¼š<span class="math inline">\(g = \triangledown_\theta J(\pi_\theta)|_{\theta_{old}}\)</span>ï¼›<span class="math inline">\(H\)</span> æ˜¯å¯¹äº <span class="math inline">\(\theta\)</span> çš„æµ·æ£®çŸ©é˜µï¼ˆHessian matrixï¼‰ã€‚</p><p>äºæ˜¯å¾—åˆ°å¦‚ä¸‹çš„è¿‘ä¼¼ä¼˜åŒ–é—®é¢˜ï¼š <span class="math display">\[\theta_{k+1}=\arg\max_\theta g^T(\theta-\theta_k)\\\text{s.t. }\frac{1}{2}(\theta-\theta_k)^TH(\theta-\theta_k)â‰¤\delta\]</span> é€šè¿‡æ‹‰æ ¼æœ—æ—¥æ³•æ±‚è§£ä¸Šè¿°çº¦æŸä¼˜åŒ–é—®é¢˜å¾—ï¼š <span class="math display">\[\theta_{k+1}=\theta_k+\sqrt{\frac{2\delta}{g^TH^{-1}g}}H^{-1}g\]</span> è¿™ä¸ªå°±æ˜¯ <a href="https://papers.nips.cc/paper/2073-a-natural-policy-gradient.pdf" target="_blank" rel="noopener">Natural Policy Gradient</a> çš„æ›´æ–°å…¬å¼ã€‚ä¸è¿‡ï¼Œç”±äºæ³°å‹’è¿‘ä¼¼å¼•å…¥äº†è¯¯å·®ï¼Œä¸Šå¼çš„è§£å¯èƒ½ä¸æ»¡è¶³ KL çº¦æŸï¼Œæ‰€ä»¥ TRPO å¢åŠ äº†ä¸€ä¸ªçº¿æ€§æœç´¢ï¼ˆbacktracking line searchï¼‰ï¼š <span class="math display">\[\theta_{k+1}=\theta_k+\alpha^j\sqrt{\frac{2\delta}{g^TH^{-1}g}}H^{-1}g\]</span> å…¶ä¸­ï¼Œ<span class="math inline">\(\alpha\in(0,1)\)</span> æ˜¯å›æº¯ç³»æ•°ï¼ˆbacktracking coefficientï¼‰ï¼Œ<span class="math inline">\(j\)</span> æ˜¯æœ€å°çš„éè´Ÿæ•´æ•°ä½¿å¾— <span class="math inline">\(\pi_{\theta_{k+1}}\)</span> æ»¡è¶³ KL çº¦æŸå¹¶ä¸”äº§ç”Ÿ<strong>æ­£</strong>çš„æ›¿ä»£ä¼˜åŠ¿ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è®­ç»ƒè¿›æ­¥æ˜¯å•è°ƒçš„ã€‚</p><p>æœ€åï¼Œè®¡ç®—å’Œå­˜å‚¨ <span class="math inline">\(H^{-1}\)</span> çš„å¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œå°¤å…¶æ˜¯ç¥ç»ç½‘ç»œçš„å‚æ•°åŠ¨ä¸åŠ¨å°±å‡ Mã€‚TRPO ä½¿ç”¨<a href="https://www.wikiwand.com/en/Conjugate_gradient_method" target="_blank" rel="noopener">å…±è½­æ¢¯åº¦æ³•ï¼ˆconjugate gradientï¼‰</a>æ¥è§£ <span class="math inline">\(Hx = g\)</span>ï¼Œè¿™æ ·å°±ä¸ç”¨ç›´æ¥è®¡ç®—å’Œå­˜å‚¨ <span class="math inline">\(H\)</span>ã€‚</p><p>æœ€ç»ˆçš„æ›´æ–°å…¬å¼ä¸ºï¼š <span class="math display">\[\theta_{k+1}=\theta_k+\alpha^j\sqrt{\frac{2\delta}{\hat{x}^TH\hat{x}}}\hat{x}\]</span> å…¶ä¸­ï¼Œ <span class="math display">\[\begin{align}\hat{x}&amp;\approx H^{-1}g &amp; \text{(using conjugate gradient)}\end{align}\]</span></p><p><span class="math display">\[H\hat{x} = \triangledown_\theta((\triangledown_\theta\bar{D}_{KL}(\theta||\theta_k))^T\hat{x})\]</span></p><p><strong>TRPOç®—æ³•</strong></p><p><img src="/images/trpo.svg"></p><h2><span id="performance">Performance</span></h2><p><strong>TRPOçš„ä¸€äº›ç‰¹ç‚¹</strong></p><ul><li>ä¿è¯æ¯æ¬¡æ›´æ–°åœ¨å½“å‰è®­ç»ƒæ•°æ®ä¸Šéƒ½æ˜¯è¿›æ­¥çš„ï¼Œè®­ç»ƒè¿‡ç¨‹æ›´åŠ ç¨³å®š</li><li>é€šè¿‡æ»¡è¶³KLçº¦æŸæ¥æ‰¾å°½å¯èƒ½å¤§çš„æ­¥é•¿</li><li>on-policy ç®—æ³•</li><li>å¯ç”¨äºç¦»æ•£å’Œè¿ç»­çš„åŠ¨ä½œç©ºé—´</li><li>ç®—æ³•è¾ƒä¸ºå¤æ‚</li></ul><p><strong>å®éªŒæ€§èƒ½</strong></p><p>åœ¨æ¨¡æ‹Ÿæœºå™¨äººèµ°è·¯ã€æ¸¸æ³³ç­‰ä»»åŠ¡ä¸­å–å¾—äº†åœ¨å½“æ—¶ä¸é”™çš„æ•ˆæœï¼›åœ¨é€šè¿‡è§†é¢‘è¾“å…¥ç©Atariæ¸¸æˆçš„ä»»åŠ¡ä¸­è¡¨ç°ä¸å¦‚DQNç­‰æ–¹æ³•ã€‚</p><p><img src="/images/trpo_per.jpg"></p><p>ä¸‹å›¾æ˜¯æˆ‘åœ¨ OpenAI <a href="https://gym.openai.com/" target="_blank" rel="noopener">Gym</a> çš„ <code>Walker2d-v2</code> å’Œ <code>MsPacman-ram-v0</code> ä¸­æµ‹è¯•çš„ç»“æœã€‚</p><p><img src="/images/walker.png"></p><p><img src="/images/pacman.png"></p><h2><span id="references">References</span></h2><p>[1] https://arxiv.org/abs/1502.05477</p><p>[2] https://spinningup.openai.com/en/latest/algorithms/trpo.html</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://arxiv.org/abs/1502.05477&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Trust Region Policy Optimization (TRPO)&lt;/a&gt;ç®—æ³•æ˜¯ç”±ä¼¯å…‹åˆ©å¤§å­¦çš„Schulmanç­‰äººäº2015å¹´æå‡ºçš„ç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradientsï¼‰ç®—æ³•ã€‚TRPOé€šè¿‡æœ€å¤§åŒ–æ–°ç­–ç•¥ç›¸å¯¹äºå½“å‰ç­–ç•¥çš„ä¼˜åŠ¿æ¥ä¿è¯æ¯æ¬¡æ›´æ–°éƒ½æ˜¯å•è°ƒé€’å¢çš„ï¼ˆç¨³å®šï¼‰ï¼ŒåŒæ—¶æ‰¾åˆ°å°½å¯èƒ½å¤§çš„æ›´æ–°æ­¥å¹…ã€‚ç®—æ³•æ¨å¯¼å‡ºçš„æœ€ç»ˆç»“æœæ˜¯åœ¨KLçº¦æŸä¸‹æœ€å¤§åŒ–æ›¿ä»£ä¼˜åŠ¿å‡½æ•°ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="åšå®¢" scheme="http://www.52coding.com.cn/categories/%E5%8D%9A%E5%AE%A2/"/>
    
    
      <category term="Reinforcement Learning" scheme="http://www.52coding.com.cn/tags/Reinforcement-Learning/"/>
    
      <category term="å¢å¼ºå­¦ä¹ " scheme="http://www.52coding.com.cn/tags/%E5%A2%9E%E5%BC%BA%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Policy Gradient" scheme="http://www.52coding.com.cn/tags/Policy-Gradient/"/>
    
      <category term="TRPO" scheme="http://www.52coding.com.cn/tags/TRPO/"/>
    
  </entry>
  
</feed>
