<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  

<!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-71540601-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-71540601-1');
</script>

  <meta charset="utf-8">
  
  <!-- if (config.subtitle) {
    title.push(config.subtitle);
  } -->
  <title>
    PyTorchæºç æµ…æ(5)ï¼šPythonæ‰©å±• | NIUHE
  </title>

  
  <meta name="author" content="NIUHE">
  

  
  <meta name="description" content="NIUHEçš„åšå®¢">
  

  
  <meta name="keywords" content="ç¼–ç¨‹,è¯»ä¹¦,å­¦ä¹ ç¬”è®°">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  
  <meta property="og:title" content="PyTorchæºç æµ…æ(5)ï¼šPythonæ‰©å±•">
  

  <meta property="og:site_name" content="NIUHE">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/icon.png" type="image/png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="NIUHE" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <script type="text/javascript" src="/js/social-share.min.js"></script>
  <script type="text/javascript" src="/js/search.js"></script>
  <script type="text/javascript" src="/js/jquery.min.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="blog">
    <div class="content">

      <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">NIUHE</a>
    </h1>
    <p class="site-description">æ—¥ã€…ç§ãŸã¡ãŒè¿‡ã”ã—ã¦ã„ã‚‹æ—¥å¸¸ã¨ã„ã†ã®ã¯ã€å®Ÿã¯å¥‡è¿¹ã®è¿ç¶šãªã®ã‹ã‚‚ã—ã‚Œã‚“ãª</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">åšå®¢</a></li>
      
        <li><a href="/notes">ç¬”è®°</a></li>
      
        <li><a href="/archives">å½’æ¡£</a></li>
      
        <li><a href="/tags">æ ‡ç­¾</a></li>
      
        <li><a href="/search">æœç´¢</a></li>
      
        <li><a href="/about">å…³äº</a></li>
      
    </ul>
  </nav>
</header>

      <main class="site-main posts-loop">
        <article>

  
  
  <h3 class="article-title"><span>
      PyTorchæºç æµ…æ(5)ï¼šPythonæ‰©å±•</span></h3>
  
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/05/05/PyTorch5/" rel="bookmark">
        <time class="entry-date published" datetime="2019-05-05T07:58:01.000Z">
          2019-05-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
      <p>è¿™ç¯‡æ˜¯æœ¬ç³»åˆ—æœ€åä¸€ç¯‡åšå®¢äº†ï¼Œä»‹ç»ä¸€ä¸‹å‰é¢çš„C++ä»£ç æ€ä¹ˆä¸Pythonäº¤äº’ï¼Œæˆ–è€…è¯´Pythoné‡Œæ€ä¹ˆè°ƒç”¨C++ä»£ç è¿›è¡Œé«˜æ•ˆçš„è®¡ç®—ã€‚é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹é¢„å¤‡çŸ¥è¯†ï¼Œæ—¢Pythonçš„Cæ‰©å±•é€šå¸¸æ€ä¹ˆå†™ï¼›ç„¶åä»¥æ¯”è¾ƒæ ¸å¿ƒçš„æ•°æ®ç»“æ„ Tensor å’Œ Storage ä¸ºä¾‹çœ‹ä¸€ä¸‹å®ƒä»¬æ€ä¹ˆè½¬æ¢ä¸ºPythonç±»å‹çš„ï¼›æœ€åç¨å¸¦ç‚¹å„¿Pythonè‡ªå¾®åˆ†å‡½æ•°çš„å®ç°ã€‚</p>
<a id="more"></a>
<p><strong>ç›®å½•</strong></p>
<!-- toc -->
<ul>
<li><a href="#pythonçš„ccæ‰©å±•">Pythonçš„C/C++æ‰©å±•</a>
<ul>
<li><a href="#æ‰©å±•æ¨¡å—">æ‰©å±•æ¨¡å—</a></li>
<li><a href="#è‡ªå®šä¹‰pythonç±»å‹">è‡ªå®šä¹‰Pythonç±»å‹</a></li>
</ul></li>
<li><a href="#torch_c">torch._C</a>
<ul>
<li><a href="#storage">Storage</a></li>
<li><a href="#tensor">Tensor</a></li>
<li><a href="#nn">NN</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<h2><span id="pythonçš„ccæ‰©å±•">Pythonçš„C/C++æ‰©å±•</span></h2>
<h3><span id="æ‰©å±•æ¨¡å—">æ‰©å±•æ¨¡å—</span></h3>
<p>å¯¹äºç®€å•çš„Cä»£ç ï¼Œæ„å»ºä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•æ¨¡å—æ˜¯å¾ˆå®¹æ˜“çš„ã€‚<code>C/C++</code>éƒ¨åˆ†åŸºæœ¬ä¸Šåªéœ€è¦åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li><p>åŒ…å«å¤´æ–‡ä»¶<code>Python.h</code></p></li>
<li><p>æ­£ç¡®çš„å£°æ˜å‡½æ•°ï¼Œå³</p>
<ul>
<li><p>å‡½æ•°å¿…é¡»æ˜¯<code>static</code></p></li>
<li><p>è¿”å›ç±»å‹å¿…é¡»æ˜¯<code>PyObject *</code></p></li>
<li><p>å‚æ•°åˆ—è¡¨å¿…é¡»æ˜¯<code>PyObject *self, PyObject *args</code></p></li>
</ul></li>
<li><p>å®šä¹‰ä¸€ä¸ªMethod Tableï¼ŒæŠŠæ¨¡å—éœ€è¦åŒ…æ‹¬çš„å‡½æ•°éƒ½æ”¾è¿›å»</p></li>
<li><p>å®šä¹‰æ¨¡å—å’Œåˆå§‹åŒ–å‡½æ•°</p></li>
</ul>
<p>ä¸¾ä¸ªğŸŒ°ï¼Œä¸‹é¢çš„ä»£ç æ„å»ºäº†ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå‡½æ•°çš„Pythonæ¨¡å—ï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯æ±‚æœ€å¤§å…¬çº¦æ•°ï¼ˆ<code>py_gcd</code>ï¼‰:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Python.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æŠŠæ™®é€šCè¯­è¨€å®ç°çš„gcd()å°è£…æˆPythonå¯ä»¥è°ƒç”¨çš„å‡½æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PyObject *<span class="title">py_gcd</span><span class="params">(PyObject *self, PyObject *args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x, y, result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ä» args é‡Œè§£æå®é™…å‚æ•° */</span></span><br><span class="line">  <span class="keyword">if</span> (!PyArg_ParseTuple(args,<span class="string">"ii"</span>, &amp;x, &amp;y)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* è°ƒç”¨æ™®é€šCè¯­è¨€å®ç°çš„gcd() */</span></span><br><span class="line">  result = gcd(x,y);</span><br><span class="line">  <span class="comment">/* æŠŠ int è½¬åŒ–ä¸º PyObject* */</span></span><br><span class="line">  <span class="keyword">return</span> Py_BuildValue(<span class="string">"i"</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰æ¨¡å—çš„ method table */</span></span><br><span class="line"><span class="keyword">static</span> PyMethodDef SampleMethods[] = &#123;</span><br><span class="line">  &#123;<span class="string">"gcd"</span>,  py_gcd, METH_VARARGS, <span class="string">"Greatest common divisor"</span>&#125;,</span><br><span class="line">  &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰æ¨¡å—ç»“æ„ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyModuleDef</span> <span class="title">samplemodule</span> = &#123;</span></span><br><span class="line">  PyModuleDef_HEAD_INIT,</span><br><span class="line">  <span class="string">"sample"</span>,           <span class="comment">/* name of module */</span></span><br><span class="line">  <span class="string">"A sample module"</span>,  <span class="comment">/* Doc string (may be NULL) */</span></span><br><span class="line">  <span class="number">-1</span>,                 <span class="comment">/* Size of per-interpreter state or -1 */</span></span><br><span class="line">  SampleMethods       <span class="comment">/* Method table */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨¡å—åˆå§‹åŒ–å‡½æ•° */</span></span><br><span class="line"><span class="function">PyMODINIT_FUNC <span class="title">PyInit_sample</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> PyModule_Create(&amp;samplemodule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“ç»†èŠ‚å°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥å‚è€ƒä¸‹é¢çš„é“¾æ¥ã€‚</p>
<p>è¦ç»‘å®šè¿™ä¸ªæ‰©å±•æ¨¡å—ï¼Œåƒä¸‹é¢è¿™æ ·åˆ›å»ºä¸€ä¸ª <code>setup.py</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setup.py</span></span><br><span class="line"><span class="keyword">from</span> distutils.core <span class="keyword">import</span> setup, Extension</span><br><span class="line"></span><br><span class="line">setup(name=<span class="string">'sample'</span>,</span><br><span class="line">      ext_modules=[</span><br><span class="line">        Extension(<span class="string">'sample'</span>,</span><br><span class="line">                  [<span class="string">'pysample.c'</span>],</span><br><span class="line">                  include_dirs = [<span class="string">'/some/dir'</span>],</span><br><span class="line">                  define_macros = [(<span class="string">'FOO'</span>,<span class="string">'1'</span>)],</span><br><span class="line">                  undef_macros = [<span class="string">'BAR'</span>],</span><br><span class="line">                  library_dirs = [<span class="string">'/usr/local/lib'</span>],</span><br><span class="line">                  libraries = [<span class="string">'sample'</span>]</span><br><span class="line">                  )</span><br><span class="line">        ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ„å»ºæœ€ç»ˆçš„å‡½æ•°åº“ï¼Œåªéœ€ç®€å•çš„ä½¿ç”¨ <code>python3 buildlib.py build_ext --inplace</code> å‘½ä»¤å³å¯ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ªåå­—å« <code>sample.so</code> çš„å…±äº«åº“ï¼Œå½“è¢«ç¼–è¯‘åï¼Œä½ å°±èƒ½å°†å®ƒä½œä¸ºä¸€ä¸ªæ¨¡å—å¯¼å…¥è¿›æ¥äº†ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sample</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sample.gcd(<span class="number">35</span>, <span class="number">42</span>)</span><br><span class="line"><span class="number">7</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨ï¼šè¿™éƒ¨åˆ†ä¸»è¦å‚è€ƒ<a href="https://python3-cookbook.readthedocs.io/zh_CN/latest/c15/p02_write_simple_c_extension_module.html" target="_blank" rel="noopener">Python3-Cookbook</a>.</p>
</blockquote>
<h3><span id="è‡ªå®šä¹‰pythonç±»å‹">è‡ªå®šä¹‰Pythonç±»å‹</span></h3>
<p>åœ¨Pythonä»£ç ä¸­å¦‚æœè¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ç±»ä½¿ç”¨<code>class</code>å…³é”®å­—å³å¯ï¼Œä½†æ˜¯åœ¨Cä»£ç ä¸­å°±æ²¡é‚£ä¹ˆæ–¹ä¾¿äº†ã€‚é¦–å…ˆç®€å•ä»‹ç»ä¸‹Pythonä¸­çš„ç±»å‹ã€‚åœ¨Pythonä¸­ä¸€åˆ‡çš†å¯¹è±¡ï¼ŒPythonä¸­æœ‰ä¸¤ç§å¯¹è±¡ï¼š</p>
<ul>
<li><p>ä¸€ç§æ˜¯ç±»å‹å¯¹è±¡ï¼ˆclasså¯¹è±¡ï¼‰ï¼šè¡¨ç¤ºPythonå®šä¹‰çš„ç±»å‹ï¼Œä¾‹å¦‚<code>int, str, object</code>ç­‰ï¼›</p></li>
<li><p>å¦ä¸€ç§æ˜¯å®ä¾‹å¯¹è±¡ï¼ˆinstanceå¯¹è±¡ï¼‰ï¼šè¡¨ç¤ºç”±classå¯¹è±¡åˆ›å»ºçš„å®ä¾‹ã€‚</p></li>
</ul>
<p>Pythonä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç›´æ¥æˆ–è€…é—´æ¥ç»§æ‰¿<code>object</code>ï¼Œç„¶å<code>object</code>åˆæ˜¯<code>type</code>ç±»å‹ã€‚Pythonå¯¹è±¡çš„Cè¯­è¨€å®ç°ä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†è¡¨ç¤ºå®ä¾‹å¯¹è±¡ï¼Œå­˜å‚¨å¯¹è±¡å®é™…çš„æ•°æ®ï¼›å¦ä¸€éƒ¨åˆ†æ˜¯ç±»å‹å¯¹è±¡ï¼Œå­˜å‚¨å¯¹è±¡çš„å…ƒæ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡ªå®šä¹‰ç±»å‹ä¹Ÿè¦å®ç°è¿™ä¸¤éƒ¨åˆ†ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®ä¾‹å¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line">    <span class="comment">/* ç±»å‹å®é™…çš„æ•°æ®åœ¨è¿™é‡Œå®šä¹‰ */</span></span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">&#125; noddy_NoddyObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç±»å‹å¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">static</span> PyTypeObject noddy_NoddyType = &#123;</span><br><span class="line">    PyVarObject_HEAD_INIT(<span class="literal">NULL</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="string">"noddy.Noddy"</span>,             <span class="comment">/*tp_name*/</span></span><br><span class="line">    <span class="keyword">sizeof</span>(noddy_NoddyObject), <span class="comment">/*tp_basicsize*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_itemsize*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_dealloc*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_print*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_getattr*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_setattr*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_compare*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_repr*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_number*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_sequence*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_mapping*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_hash */</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_call*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_str*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_getattro*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_setattro*/</span></span><br><span class="line">    <span class="number">0</span>,                         <span class="comment">/*tp_as_buffer*/</span></span><br><span class="line">    Py_TPFLAGS_DEFAULT,        <span class="comment">/*tp_flags*/</span></span><br><span class="line">    <span class="string">"Noddy objects"</span>,           <span class="comment">/*tp_doc*/</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååˆ›å»ºä¸€ä¸ªæ–°æ‰©å±•æ¨¡å—ï¼Œå¹¶å®Œæˆåˆå§‹åŒ–ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®šä¹‰æ¨¡å—çš„ method table */</span></span><br><span class="line"><span class="keyword">static</span> PyMethodDef noddy_methods[] = &#123;</span><br><span class="line">    &#123;<span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨¡å—åˆå§‹åŒ–å‡½æ•° */</span></span><br><span class="line"><span class="function">PyMODINIT_FUNC <span class="title">initnoddy</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyObject* m;</span><br><span class="line">    <span class="comment">/* tp_new ç›¸å½“äºPythoné‡Œçš„ __new__ */</span></span><br><span class="line">    noddy_NoddyType.tp_new = PyType_GenericNew;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (PyType_Ready(&amp;noddy_NoddyType) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    m = Py_InitModule3(<span class="string">"noddy"</span>, noddy_methods,</span><br><span class="line">                       <span class="string">"Example module"</span>);</span><br><span class="line"></span><br><span class="line">    Py_INCREF(&amp;noddy_NoddyType);</span><br><span class="line">    <span class="comment">/* å‘æ¨¡å—æ·»åŠ ç±»å‹ */</span></span><br><span class="line">    PyModule_AddObject(m, <span class="string">"Noddy"</span>, (PyObject*)&amp;noddy_NoddyType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨ï¼šè¿™éƒ¨åˆ†ä»‹ç»çš„æ¯”è¾ƒç®€ç•¥ï¼Œè¯¦ç»†è¯·å‚è€ƒ <a href="http://www.xefan.com/archives/84091.html" class="uri" target="_blank" rel="noopener">http://www.xefan.com/archives/84091.html</a>.</p>
</blockquote>
<h2><span id="torch_c">torch._C</span></h2>
<p>æœ‰äº†ä¸Šé¢çš„é¢„å¤‡çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½çœ‹ATenè¿˜æœ‰autogradç­‰æ¨¡å—çš„ä»£ç æ˜¯æ€ä¹ˆå¯¼å…¥Pythonäº†ã€‚æ„å»ºPythonæ‰©å±•æ¨¡å—çš„ä»£ç åœ¨ <code>torch/csrc/Module.cpp</code> é‡Œï¼Œä¸»è¦éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/* method table */</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;PyMethodDef&gt; methods;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–æ¨¡å— */</span></span><br><span class="line"><span class="function">PyObject* <span class="title">initModule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  HANDLE_TH_ERRORS</span><br><span class="line">  THInferNumThreads();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å‘ method table æ·»åŠ å‡½æ•° */</span></span><br><span class="line">  THPUtils_addPyMethodDefs(methods, TorchMethods);</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, DataLoaderMethods);</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, </span><br><span class="line">                           torch::autograd::python_functions());</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, </span><br><span class="line">                       torch::multiprocessing::python_functions());</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* æ„å»º torch._C æ¨¡å— */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PY_MAJOR_VERSION == 2</span></span><br><span class="line">  ASSERT_TRUE(<span class="keyword">module</span> = Py_InitModule(<span class="string">"torch._C"</span>, methods.data()));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyModuleDef</span> <span class="title">torchmodule</span> = &#123;</span></span><br><span class="line">      PyModuleDef_HEAD_INIT, <span class="string">"torch._C"</span>, <span class="literal">nullptr</span>, <span class="number">-1</span>, </span><br><span class="line">      methods.data()</span><br><span class="line">  &#125;;</span><br><span class="line">  ASSERT_TRUE(<span class="keyword">module</span> = PyModule_Create(&amp;torchmodule));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* å„ç§åˆå§‹åŒ– */</span></span><br><span class="line">  ASSERT_TRUE(THPWrapper_init(<span class="keyword">module</span>));</span><br><span class="line">  ...</span><br><span class="line">  torch::autograd::initNNFunctions(<span class="keyword">module</span>);     <span class="comment">// åˆå§‹åŒ–è‡ªå¾®åˆ†ç›¸å…³API</span></span><br><span class="line">  torch::autograd::init_legacy_variable(<span class="keyword">module</span>);<span class="comment">// åˆå§‹åŒ–Tensorç±»å‹</span></span><br><span class="line">  torch::python::init_bindings(<span class="keyword">module</span>);         <span class="comment">// åˆå§‹åŒ–NNç›¸å…³å‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_CUDA</span></span><br><span class="line">  torch::cuda::initModule(<span class="keyword">module</span>);              <span class="comment">// åˆå§‹åŒ–CUDAæ¨¡å—</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">/* åˆå§‹åŒ–å„ç§Storageç±»å‹ */</span></span><br><span class="line">  ASSERT_TRUE(THPDoubleStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPFloatStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPHalfStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPLongStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPIntStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPShortStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPCharStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPByteStorage_init(<span class="keyword">module</span>));</span><br><span class="line">  ASSERT_TRUE(THPBoolStorage_init(<span class="keyword">module</span>));</span><br><span class="line"> </span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">module</span>;</span><br><span class="line">  END_HANDLE_TH_ERRORS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸºæœ¬ä¸Šæ‰€æœ‰C/C++å®ç°çš„APIéƒ½è¢«ç»‘å®šåœ¨ <code>torch._C</code> æ‰©å±•æ¨¡å—ä¸­ï¼Œä¸‹é¢ä»¥Storageå’ŒTensorä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ <code>torch.Storage</code>å’Œ<code>torch.Tensor</code> ç±»å‹çš„ç»‘å®šæ–¹æ³•ï¼Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯å®ƒä»¬ä¸¤ä¸ªçš„ç»‘å®šæ–¹å¼åŒºåˆ«è¿˜æŒºå¤§çš„ã€‚</p>
<h3><span id="storage">Storage</span></h3>
<p>ä»ä¸Šé¢çš„ <code>initModule()</code> å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢æœ‰è®¸å¤šåˆå§‹åŒ–å„ç§Storageç±»å‹çš„ä»£ç ï¼Œå®ƒä»¬çš„ç›®çš„å°±æ˜¯åˆ›å»ºå„ç§Storageç±»å‹ï¼Œå¦‚ <code>torch._C._FloatStorageBase</code>, <code>torch._C._LongStorageBase</code>ç­‰ï¼Œè€Œ <code>torch.FloatStorage</code> ç­‰ç±»å‹æ˜¯ä»Pythonç«¯åˆ›å»ºçš„ï¼Œç»§æ‰¿è‡ª <code>torch._C._FloatStorageBase</code> ç­‰ç±»å‹ï¼Œè¿™éƒ¨åˆ†ä»£ç å¯ä»¥åœ¨<code>torch/__init__.py</code>ä¸­æ‰¾åˆ°ã€‚</p>
<p>å›åˆ°ç»‘å®šè¿‡ç¨‹ï¼Œ<code>THPDoubleStorage_init()</code> ç­‰å‡½æ•°å…¶å®æ˜¯ç”¨CèŒƒå¼ç”Ÿæˆçš„ï¼Œå’Œ<a href="https://www.52coding.com.cn/2019/05/05/PyTorch1/">ç¬¬ä¸€ç¯‡</a>é‡Œçš„THåº“ä¸­ç”¨çš„æ–¹æ³•ä¸€æ ·ã€‚å®ƒå®é™…è°ƒç”¨çš„å‡½æ•°æ˜¯ <code>bool THPStorage_(init)(PyObject *module)</code>ï¼Œå®ç° <code>torch/csrc/generic/Storage.cpp</code>é‡Œï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ä¸åŒç±»å‹å±•å¼€ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">THPStorage_</span><span class="params">(init)</span><span class="params">(PyObject *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;PyMethodDef&gt; methods;</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, THPStorage_(methods));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> THD_GENERIC_FILE</span></span><br><span class="line">  THPUtils_addPyMethodDefs(methods, THPStorage_(sharingMethods));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ç»‘å®šç±»æ–¹æ³• */</span></span><br><span class="line">  THPStorageType.tp_methods = methods.data();</span><br><span class="line">  <span class="comment">/* ç»‘å®šç±»æˆå‘˜ */</span></span><br><span class="line">  THPStorageType.tp_members = THPStorage_(members);</span><br><span class="line">  <span class="keyword">if</span> (PyType_Ready(&amp;THPStorageType) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  Py_INCREF(&amp;THPStorageType);</span><br><span class="line">  <span class="comment">/* å‘æ¨¡å—æ·»åŠ  THPStorage ç±»å‹ */</span></span><br><span class="line">  PyModule_AddObject(<span class="keyword">module</span>, THPStorageBaseStr, </span><br><span class="line">                     (PyObject*)&amp;THPStorageType);</span><br><span class="line">  THPStorage_(initCopyMethods)();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–äº† <code>THPStorageType</code> ç±»å‹å¹¶æ·»åŠ åˆ°<code>torch._C</code>æ¨¡å—ä¸­ï¼Œè¯¥ç±»å‹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®ä¾‹å¯¹è±¡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THPStorage</span> &#123;</span></span><br><span class="line">  PyObject_HEAD</span><br><span class="line">  <span class="comment">/* THWStorage ä¸ºå®å®šä¹‰ï¼Œä¼šè½¬æ¢ä¸º THxxxStorage */</span></span><br><span class="line">  THWStorage *cdata;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç±»å‹å¯¹è±¡ */</span></span><br><span class="line">PyTypeObject THPStorageType = &#123;</span><br><span class="line">  PyVarObject_HEAD_INIT(<span class="literal">nullptr</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="string">"torch._C."</span> THPStorageBaseStr,         <span class="comment">/* tp_name */</span></span><br><span class="line">  <span class="keyword">sizeof</span>(THPStorage),                    <span class="comment">/* tp_basicsize */</span></span><br><span class="line">  <span class="number">0</span>,                                     <span class="comment">/* tp_itemsize */</span></span><br><span class="line">  (destructor)THPStorage_(dealloc),      <span class="comment">/* tp_dealloc */</span></span><br><span class="line">  ...</span><br><span class="line">  THPStorage_(pynew),                    <span class="comment">/* tp_new */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Pythoné‡Œç±»å‹çš„åå­—ç”± <code>tp_name</code> åŸŸç¡®å®šï¼Œä¹Ÿå°±æ˜¯ <code>&quot;torch._C.&quot; THPStorageBaseStr</code>ï¼Œåè€…ä¸€çœ‹å°±æ˜¯å®å®šä¹‰ï¼Œå®ƒå±•å¼€åä¼šå˜æˆ <code>_xxxStorageBase</code>ï¼Œå…¶ä¸­<code>xxx</code>ä¸ºå„ç§ç±»å‹ï¼Œæ‰€ä»¥æœ€åå°±å˜æˆäº† <code>torch._C._FloatStorageBase</code> ç­‰ç±»å‹ã€‚</p>
<h3><span id="tensor">Tensor</span></h3>
<p><code>torch.Tensor</code>çš„å®ç°å°±ä¸<code>torch.Storage</code> ä¸ä¸€æ ·äº†ï¼Œå› ä¸ºATençš„å­˜åœ¨ï¼Œç»‘å®šçš„è¯ä¹Ÿæ˜¯ç»‘å®šATené‡Œçš„Tensorï¼Œä¸ä¼šç»‘å®šTHTensorã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œå°±æ˜¯Pythoné‡Œçš„Tensorå’ŒVariableåˆå¹¶äº†ï¼Œæ‰€ä»¥<code>torch.Tensor</code>ç›´æ¥å’Œ <code>autograd::Variable</code> ç»‘å®šåœ¨ä¸€èµ·äº†ã€‚ä¸è¿‡å‡†ç¡®æ¥è¯´æ˜¯ <code>torch._C._TensorBase</code> å’Œ <code>autograd::Variable</code> ç»‘å®šåœ¨ä¸€èµ·äº†ï¼Œè€Œ <code>torch.Tensor</code> ç»§æ‰¿è‡ª <code>torch._C._TensorBase</code>ã€‚</p>
<p>ç»‘å®šçš„ä»£ç åœ¨ <code>torch/csrc/autograd/python_variable.cpp</code>ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// python_variable.h</span></span><br><span class="line"><span class="comment">/* å®ä¾‹å¯¹è±¡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THPVariable</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line">    <span class="comment">// Payload</span></span><br><span class="line">    torch::autograd::Variable cdata;</span><br><span class="line">    PyObject* backward_hooks = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// python_variable.cpp</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">/* ç±»å‹å¯¹è±¡ */</span></span><br><span class="line">PyTypeObject THPVariableType = &#123;</span><br><span class="line">  PyVarObject_HEAD_INIT(<span class="literal">nullptr</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="string">"torch._C._TensorBase"</span>,                <span class="comment">/* tp_name */</span></span><br><span class="line">  <span class="keyword">sizeof</span>(THPVariable),                   <span class="comment">/* tp_basicsize */</span></span><br><span class="line">  <span class="number">0</span>,                                     <span class="comment">/* tp_itemsize */</span></span><br><span class="line">  (destructor)THPVariable_dealloc,       <span class="comment">/* tp_dealloc */</span></span><br><span class="line">  ...</span><br><span class="line">  THPVariable_pynew                      <span class="comment">/* tp_new */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–ç±»å‹ */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">THPVariable_initModule</span><span class="params">(PyObject *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* è·å– method table */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;PyMethodDef&gt; methods;</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, </span><br><span class="line">                           torch::autograd::variable_methods);</span><br><span class="line">  THPUtils_addPyMethodDefs(methods, extra_methods);</span><br><span class="line">  <span class="comment">/* ç»‘å®šç±»æ–¹æ³• */</span></span><br><span class="line">  THPVariableType.tp_methods = methods.data();</span><br><span class="line">  <span class="keyword">if</span> (PyType_Ready(&amp;THPVariableType) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  Py_INCREF(&amp;THPVariableType);</span><br><span class="line">  <span class="comment">/* å‘æ¨¡å—ä¸­æ·»åŠ ç±»å‹ */</span></span><br><span class="line">  PyModule_AddObject(<span class="keyword">module</span>, <span class="string">"_TensorBase"</span>, </span><br><span class="line">                     (PyObject *)&amp;THPVariableType);</span><br><span class="line">  torch::autograd::initTorchFunctions(<span class="keyword">module</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„åˆ°ï¼Œè¿™é‡Œåªç»‘å®šäº† <code>_TensorBase</code> ä¸€ç§ç±»å‹ï¼Œè€Œä¸åƒStorageé‚£æ ·åˆ©ç”¨å®æŠŠå„ç§ç±»å‹çš„StorageBaseéƒ½å®šä¹‰äº†ã€‚</p>
<p>å…¶ä»–ç±»å‹çš„Tensorï¼Œå¦‚ <code>torch.FloatTensor</code> ç­‰åœ¨ <code>torch/tensor/python_tensor.cpp</code> ä¸­çš„ <code>initialize_python_bindings()</code> å‡½æ•°é‡ŒåŠ¨æ€ç»‘å®šï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initialize_python_bindings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* æŠŠATené‡Œçš„Tensorç±»å‹è½¬åŒ–ä¸ºPythoné‡Œçš„PyTypeObject */</span></span><br><span class="line">  initialize_aten_types(tensor_types);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* åˆå§‹åŒ–ä¸Šé¢è½¬åŒ–æ¥çš„PyTypeObject */</span></span><br><span class="line">  py_initialize_metaclass(metaclass);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è·å– torch.Tensor çš„æ‰€æœ‰æ–¹æ³• */</span></span><br><span class="line">  <span class="keyword">auto</span> tensor_dict = get_tensor_dict();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* æŠŠtorch.Tensorçš„æ–¹æ³•å¤åˆ¶ç»™æ¯ä¸ªç±»å‹ï¼Œå¦‚torch.FloatTensorç­‰ */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; tensor_type : tensor_types) &#123;</span><br><span class="line">    py_initialize_tensor_type(tensor_type.py_type, </span><br><span class="line">                              tensor_type.name, tensor_dict.get());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å‘torchæ¨¡å—ç»‘å®šè¿™äº›å„ç§ç±»å‹çš„Tensor */</span></span><br><span class="line">  py_bind_tensor_types(tensor_types);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è®¾ç½® torch.Tensor çš„é»˜è®¤ç±»å‹ä¸º torch.FloatTensor */</span></span><br><span class="line">  set_default_tensor_type(at::globalContext().getVariableType(</span><br><span class="line">    at::Backend::CPU, at::kFloat));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ç”±Pythonè°ƒç”¨ï¼Œè°ƒç”¨çš„ä»£ç åœ¨ <code>torch/__init__.py</code> ä¸­ï¼ˆ<code>_C._initExtension()</code>ï¼‰ã€‚è°ƒç”¨æ—¶ <code>torch.Tensor</code> å·²ç»å®šä¹‰ï¼Œè¿™ä¸ªå‡½æ•°è¦åšçš„å°±æ˜¯å®šä¹‰å…¶ä»–Tensorç±»å‹ï¼Œç„¶åæŠŠTensorç±»å‹çš„æ–¹æ³•ç›´æ¥æ‹·è´ç»™å®ƒä»¬ï¼Œæœ€ååœ¨è®¾ç½®ä¸€ä¸‹é»˜è®¤ç±»å‹çš„Tensorã€‚ä¸ºä»€ä¹ˆæ•°æ®ç±»å‹ä¸åŒå´å¯ä»¥ç›´æ¥æ‹·è´ï¼Ÿå› ä¸º <code>at::Tensor</code> å¯ä»¥é’ˆå¯¹ä¸åŒæ•°æ®ç±»å‹è°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œç±»å‹å¤šæ€å·²ç»åœ¨ATenå†…éƒ¨å®ç°äº†ã€‚</p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒTensor ç»‘å®šçš„æ–¹æ³•æ¥è‡ª <code>torch::autograd::variable_methods</code>ï¼Œè¿™ä¸ªåˆ—è¡¨åœ¨ <code>csrc/autograd/generated/python_variable_methods.cpp</code> ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PyMethodDef variable_methods[] = &#123;</span><br><span class="line">  &#123;<span class="string">"__add__"</span>, (PyCFunction)THPVariable_add, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__radd__"</span>, (PyCFunction)THPVariable_add, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__iadd__"</span>, (PyCFunction)THPVariable_add_, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__rmul__"</span>, (PyCFunction)THPVariable_mul, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__mul__"</span>, (PyCFunction)THPVariable_mul, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__imul__"</span>, (PyCFunction)THPVariable_mul_, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"__sub__"</span>, (PyCFunction)THPVariable_sub, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"addcmul"</span>, (PyCFunction)THPVariable_addcmul, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»æ–‡ä»¶è·¯å¾„å¯ä»¥çœ‹å‡ºè¿™ä¹Ÿæ˜¯æ ¹æ® <code>derivatives.yaml</code> è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œæ‹¿ <code>addcmul</code> ä¸¾ä¸ªä¾‹å­çœ‹çœ‹è¿™äº›å‡½æ•°çš„å®ç°æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PyObject * <span class="title">THPVariable_addcmul</span><span class="params">(PyObject* self_, PyObject* args, PyObject* kwargs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HANDLE_TH_ERRORS</span><br><span class="line">  <span class="function"><span class="keyword">static</span> PythonArgParser <span class="title">parser</span><span class="params">(&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"addcmul(Scalar value, Tensor tensor1, Tensor tensor2)|deprecated"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"addcmul(Tensor tensor1, Tensor tensor2, *, Scalar value=1)"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;, <span class="comment">/*traceable=*/</span><span class="literal">true</span>)</span></span>;</span><br><span class="line">  <span class="comment">/* è·å–autograd::Variableå®ä¾‹ */</span></span><br><span class="line">  <span class="keyword">auto</span>&amp; self = <span class="keyword">reinterpret_cast</span>&lt;THPVariable*&gt;(self_)-&gt;cdata;</span><br><span class="line">  <span class="comment">/* è§£æå‡½æ•°å‚æ•° */</span></span><br><span class="line">  ParsedArgs&lt;<span class="number">4</span>&gt; parsed_args;</span><br><span class="line">  <span class="keyword">auto</span> r = parser.parse(args, kwargs, parsed_args);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è°ƒç”¨ dispatch */</span></span><br><span class="line">  <span class="keyword">if</span> (r.idx == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> wrap(dispatch_addcmul(self, r.scalar(<span class="number">0</span>), r.tensor(<span class="number">1</span>), r.tensor(<span class="number">2</span>)));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.idx == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> wrap(dispatch_addcmul(self, r.tensor(<span class="number">0</span>), r.tensor(<span class="number">1</span>), r.scalar(<span class="number">2</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  Py_RETURN_NONE;</span><br><span class="line">  END_HANDLE_TH_ERRORS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆå‡½æ•°è°ƒç”¨äº† <code>dispatch_addcmul()</code> è¿›è¡Œä¸‹ä¸€æ­¥è®¡ç®—ï¼Œè¯¥å‡½æ•°åœ¨åŒæ–‡ä»¶å¤¹çš„ <code>python_variable_methods_dispatch.h</code> ï¼Œå¯è§è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> Tensor <span class="title">dispatch_addcmul</span><span class="params">(Tensor &amp; self, Scalar value, <span class="keyword">const</span> Tensor &amp; tensor1, <span class="keyword">const</span> Tensor &amp; tensor2)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* é‡Šæ”¾GILé” */</span></span><br><span class="line">  AutoNoGIL no_gil;</span><br><span class="line">  <span class="comment">/* è°ƒç”¨ autograd::Variable.addcmul */</span></span><br><span class="line">  <span class="keyword">return</span> self.addcmul(tensor1, tensor2, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°é¦–å…ˆè·å–äº†GILé”ï¼Œç„¶åè°ƒç”¨C++å‰ç«¯ <code>Variable.addcmul()</code> è¿›è¡Œè®¡ç®—ï¼Œç”±äºåè€…å®ç°äº†è‡ªåŠ¨å¾®åˆ†ï¼Œæ‰€ä»¥Pythonè°ƒç”¨ä¹Ÿå…·æœ‰è‡ªåŠ¨å¾®åˆ†åŠŸèƒ½ã€‚ä¸ºä»€ä¹ˆè¦é‡Šæ”¾GILé”ï¼Ÿå› ä¸ºè¿™æ ·æ‰èƒ½ä½¿å…¶ä¸Pythonè§£é‡Šå™¨ä¸­çš„å…¶ä»–è¿›ç¨‹ä¸€èµ·æ­£ç¡®çš„æ‰§è¡Œã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒPython Tensorçš„æ–¹æ³•çš„å°è£…æ€è·¯æ˜¯ï¼š</p>
<ul>
<li>ç”Ÿæˆdispatchç³»åˆ—å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºé‡Šæ”¾GILé”ï¼Œç„¶åè°ƒç”¨Variableçš„å¯¹åº”å®ç°</li>
<li>ç”Ÿæˆå¯è¢«Pythonè°ƒç”¨çš„APIï¼Œè¯¥å‡½æ•°è§£æPythonå‚æ•°ï¼Œå¹¶è°ƒç”¨dispatchç³»åˆ—å‡½æ•°è¿›è¡Œå®é™…è®¡ç®—</li>
</ul>
<h3><span id="nn">NN</span></h3>
<p>ç¥ç»ç½‘ç»œçš„éƒ¨åˆ†å‡½æ•°ä¹Ÿæœ‰éƒ¨åˆ†å‡½æ•°æ˜¯ç›´æ¥ä» ATen ç»‘å®šè€Œæ¥ï¼Œç»‘å®šåˆ° <code>torch._C._nn</code> æ¨¡å—ä¸­ï¼Œä»£ç åœ¨ <code>csrc/autograd/generate/python_nn_functions.cpp</code> ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> PyMethodDef nn_functions[] = &#123;</span><br><span class="line">  &#123;<span class="string">"_parse_to"</span>, (PyCFunction)THPVariable__parse_to, METH_VARARGS | METH_KEYWORDS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_avg_pool2d"</span>, (PyCFunction)THPVariable_adaptive_avg_pool2d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_avg_pool3d"</span>, (PyCFunction)THPVariable_adaptive_avg_pool3d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_max_pool2d"</span>, (PyCFunction)THPVariable_adaptive_max_pool2d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"adaptive_max_pool3d"</span>, (PyCFunction)THPVariable_adaptive_max_pool3d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"avg_pool2d"</span>, (PyCFunction)THPVariable_avg_pool2d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"avg_pool3d"</span>, (PyCFunction)THPVariable_avg_pool3d, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"binary_cross_entropy"</span>, (PyCFunction)THPVariable_binary_cross_entropy, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"elu"</span>, (PyCFunction)THPVariable_elu, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"elu_"</span>, (PyCFunction)THPVariable_elu_, METH_VARARGS | METH_KEYWORDS, <span class="literal">NULL</span>&#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> initNNFunctions(PyObject* <span class="keyword">module</span>) &#123;</span><br><span class="line">#<span class="keyword">if</span> PY_MAJOR_VERSION == <span class="number">2</span></span><br><span class="line">  PyObject* nn = Py_InitModule(<span class="string">"torch._C._nn"</span>, nn_functions);</span><br><span class="line">  Py_XINCREF(nn);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyModuleDef</span> <span class="title">def</span> = &#123;</span></span><br><span class="line">     PyModuleDef_HEAD_INIT,</span><br><span class="line">     <span class="string">"torch._C._nn"</span>,</span><br><span class="line">     <span class="literal">NULL</span>,</span><br><span class="line">     <span class="number">-1</span>,</span><br><span class="line">     nn_functions</span><br><span class="line">  &#125;;</span><br><span class="line">  PyObject* nn = PyModule_Create(&amp;def);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (!nn) &#123;</span><br><span class="line">    <span class="keyword">throw</span> python_error();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (PyModule_AddObject(<span class="keyword">module</span>, <span class="string">"_nn"</span>, nn) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> python_error();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢æœ‰pooling, loss, convç­‰ç›¸å…³å‡½æ•°ï¼Œä¾›Pythoné‡Œçš„<code>nn.functional</code>è°ƒç”¨ã€‚</p>
<p>æ­¤å¤–ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨Pythonä¸­è‡ªå®šä¹‰çš„è‡ªå¾®åˆ†çš„å‡½æ•°ï¼ŒPythoné‡Œä¹Ÿå®ç°äº†ä¸Šä¸€ç¯‡å¯¹åº”çš„Functionï¼š<code>torch.autograd.Function</code>ã€‚ç»§æ‰¿å®ƒï¼Œé‡è½½ <code>forward()</code> å’Œ <code>backward()</code> æ–¹æ³•å°±å¯ä»¥ç”¨Pythonå®ç°è‡ªå®šä¹‰çš„è‡ªå¾®åˆ†å‡½æ•°ï¼Œè¯¦è§<a href="https://pytorch.org/docs/stable/notes/extending.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚</p>
<p><code>torch.autograd.Function</code> çš„å®šä¹‰åœ¨ <code>torch/autograd/function.py</code> ä¸­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Function</span><span class="params">(with_metaclass<span class="params">(FunctionMeta, _C._FunctionBase, _ContextMethodMixin, _HookMixin)</span>)</span>:</span></span><br><span class="line">    <span class="comment"># only for backward compatibility</span></span><br><span class="line">    __call__ = _C._FunctionBase._do_forward</span><br><span class="line"></span><br><span class="line">    <span class="comment"># for the tracer</span></span><br><span class="line">    is_traceable = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(ctx, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span><span class="params">(ctx, *grad_outputs)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br></pre></td></tr></table></figure>
<p>å®ƒç»§æ‰¿è‡ª <code>torch._C.FunctionBase</code>ï¼Œè¯¥ç±»å‹åœ¨ <code>csrc/autograd/python_function.cpp</code>ä¸­ç»‘å®šï¼Œå®ç°çš„é€»è¾‘å’Œ <code>autograd::Function</code> ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨å‰å‘è®¡ç®—æ—¶å»ºç«‹åå‘è®¡ç®—å›¾ï¼Œè¿™é‡Œå°±ä¸è¯»èµ˜è¿°äº†ã€‚ç»‘å®šéƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">THPFunction</span> &#123;</span></span><br><span class="line">    PyObject_HEAD</span><br><span class="line"></span><br><span class="line">    PyObject *needs_input_grad;</span><br><span class="line">    PyObject *to_save;</span><br><span class="line">    PyObject *non_differentiable;</span><br><span class="line">    PyObject *dirty_tensors;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;torch::autograd::VariableInfo&gt; output_info;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;torch::autograd::VariableInfo&gt; input_info;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;torch::autograd::SavedVariable&gt; saved_variables;</span><br><span class="line">    <span class="comment">// For each input, true if the input is a THPVariable</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; is_variable_input;</span><br><span class="line">    <span class="keyword">char</span> has_freed_buffers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* PyFunctionç»§æ‰¿è‡ªFunctionï¼Œå®é™…è°ƒç”¨æœ€ç»ˆè½¬å‘åˆ°Functionä¸­ */</span></span><br><span class="line">    torch::autograd::PyFunction cdata;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyGetSetDef</span> <span class="title">THPFunction_properties</span>[] = &#123;</span></span><br><span class="line">  &#123;<span class="string">"saved_tensors"</span>, (getter)THPFunction_saved_tensors, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"saved_variables"</span>, (getter)THPFunction_saved_variables, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="string">"next_functions"</span>, (getter)THPFunction_next_functions, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  ...</span><br><span class="line">  &#123;<span class="literal">nullptr</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyMethodDef</span> <span class="title">THPFunction_methods</span>[] = &#123;</span></span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"apply"</span>, (PyCFunction)THPFunction_apply, METH_CLASS | METH_VARARGS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"_do_forward"</span>, (PyCFunction)THPFunction_do_forward, METH_VARARGS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"_do_backward"</span>, (PyCFunction)THPFunction_do_backward, METH_VARARGS, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"_register_hook_dict"</span>, (PyCFunction)THPFunction__register_hook_dict, METH_O, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;(<span class="keyword">char</span>*)<span class="string">"register_hook"</span>, (PyCFunction)THPFunction_register_hook, METH_O, <span class="literal">nullptr</span>&#125;,</span><br><span class="line">  &#123;<span class="literal">nullptr</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PyTypeObject THPFunctionType = &#123;</span><br><span class="line">  PyVarObject_HEAD_INIT(<span class="literal">nullptr</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="string">"torch._C._FunctionBase"</span>,              <span class="comment">/* tp_name */</span></span><br><span class="line">  <span class="keyword">sizeof</span>(THPFunction),                   <span class="comment">/* tp_basicsize */</span></span><br><span class="line">  <span class="number">0</span>,                                     <span class="comment">/* tp_itemsize */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">THPFunction_initModule</span><span class="params">(PyObject *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (PyType_Ready(&amp;THPFunctionType) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  Py_INCREF(&amp;THPFunctionType);</span><br><span class="line">  PyModule_AddObject(<span class="keyword">module</span>, <span class="string">"_FunctionBase"</span>, </span><br><span class="line">                     (PyObject *)&amp;THPFunctionType);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li><p><code>THPFunction</code> = <code>_C._FunctionBase</code></p></li>
<li><p>Pythonçš„<code>autograd.Function</code>ç»§æ‰¿è‡ªä¸Šé¢å®ç°è‡ªåŠ¨å¾®åˆ†</p></li>
</ul>
<p>å®Œ</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">ä¸Šä¸€ç¯‡ï¼š<a href="https://www.52coding.com.cn/2019/05/05/PyTorch4/">Autograd</a></th>
<th style="text-align: right;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

      
      

      <span class="post-categories">
        <i class="icon-categories"></i>
        <a href="/categories/åšå®¢/">åšå®¢</a>
      </span>
      

      
      

      <span class="post-tags">
        <i class="icon-tags"></i>
        <a href="/tags/C/">C++</a><a href="/tags/PyTorch/">PyTorch</a><a href="/tags/Pythonæ‰©å±•/">Pythonæ‰©å±•</a>
      </span>
      

    </div>

    
  </div>
</article>

<div class="social-share"></div>
<script type="text/javascript">
  var $config = {
    image: "icon.png",
  };
  socialShare('.social-share-cs', $config);
</script>



<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
<div id="lv-container" data-id="city" data-uid="MTAyMC80MTI4MC8xNzgyOA==">
	<script type="text/javascript">
		(function (d, s) {
			var j, e = d.getElementsByTagName(s)[0];

			if (typeof LivereTower === 'function') {
				return;
			}

			j = d.createElement(s);
			j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
			j.async = true;

			e.parentNode.insertBefore(j, e);
		})(document, 'script');
	</script>
	<noscript> ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
</div>
<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->


      </main>

      <footer class="site-footer">
  <p class="site-info">
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    <br>
    
    &copy;
    2019
    NIUHE <a href="https://github.com/NeymarL" target="_blank"><i class="fab fa-github"></i></a>
    
  </p>
</footer>
      
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        processEscapes: true
      }
    });
  </script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
        tex2jax: {
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
  </script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
          var all = MathJax.Hub.getAllJax(), i;
          for(i=0; i < all.length; i += 1) {
              all[i].SourceElement().parentNode.className += ' has-jax';
          }
      });
  </script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

      <script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
    </div>
  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>

</html>